<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ehtim.imaging.imager_utils &mdash; ehtim 1.2.3 documentation</title><link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../../" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/language_data.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> ehtim
          </a>
              <div class="version">
                1.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../image.html">Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../array.html">Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../obsdata.html">Obsdata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../movie.html">Movie</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../imager.html">Imager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../calibration.html">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../scattering.html">Scattering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../statistics.html">Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../survey.html">Survey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../vex.html">Vex</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ehtim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>ehtim.imaging.imager_utils</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ehtim.imaging.imager_utils</h1><div class="highlight"><pre>
<span></span><span class="c1"># imager_utils.py</span>
<span class="c1"># General imager functions for total intensity VLBI data</span>
<span class="c1">#</span>
<span class="c1">#    Copyright (C) 2018 Andrew Chael</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>


<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span>

<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="kn">import</span> <span class="nn">ehtim.image</span> <span class="k">as</span> <span class="nn">image</span>
<span class="kn">import</span> <span class="nn">ehtim.observing.obs_helpers</span> <span class="k">as</span> <span class="nn">obsh</span>
<span class="kn">import</span> <span class="nn">ehtim.const_def</span> <span class="k">as</span> <span class="nn">ehc</span>


<span class="c1">##################################################################################################</span>
<span class="c1"># Constants &amp; Definitions</span>
<span class="c1">##################################################################################################</span>

<span class="n">NORM_REGULARIZER</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># ANDREW TODO change this default in the future</span>

<span class="n">MAXLS</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># maximum number of line searches in L-BFGS-B</span>
<span class="n">NHIST</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># number of steps to store for hessian approx</span>
<span class="n">MAXIT</span> <span class="o">=</span> <span class="mi">100</span>  <span class="c1"># maximum number of iterations</span>
<span class="n">STOP</span> <span class="o">=</span> <span class="mf">1.e-8</span>  <span class="c1"># convergence criterion</span>

<span class="n">DATATERMS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">,</span> <span class="s1">&#39;bs&#39;</span><span class="p">,</span> <span class="s1">&#39;amp&#39;</span><span class="p">,</span> <span class="s1">&#39;cphase&#39;</span><span class="p">,</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">,</span>
             <span class="s1">&#39;camp&#39;</span><span class="p">,</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">,</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">,</span> <span class="s1">&#39;logamp&#39;</span><span class="p">]</span>
<span class="n">REGULARIZERS</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;gs&#39;</span><span class="p">,</span> <span class="s1">&#39;tv&#39;</span><span class="p">,</span> <span class="s1">&#39;tvlog&#39;</span><span class="p">,</span><span class="s1">&#39;tv2&#39;</span><span class="p">,</span> <span class="s1">&#39;tv2log&#39;</span><span class="p">,</span><span class="s1">&#39;l1w&#39;</span><span class="p">,</span> <span class="s1">&#39;lA&#39;</span><span class="p">,</span> <span class="s1">&#39;patch&#39;</span><span class="p">,</span> <span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="s1">&#39;compact&#39;</span><span class="p">,</span> <span class="s1">&#39;compact2&#39;</span><span class="p">,</span> <span class="s1">&#39;rgauss&#39;</span><span class="p">]</span>

<span class="n">nit</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># global variable to track the iteration number in the plotting callback</span>

<span class="c1">##################################################################################################</span>
<span class="c1"># Total Intensity Imager</span>
<span class="c1">##################################################################################################</span>


<div class="viewcode-block" id="imager_func"><a class="viewcode-back" href="../../../imager.html#ehtim.imaging.imager_utils.imager_func">[docs]</a><span class="k">def</span> <span class="nf">imager_func</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">InitIm</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span>
                <span class="n">d1</span><span class="o">=</span><span class="s1">&#39;vis&#39;</span><span class="p">,</span> <span class="n">d2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">d3</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">alpha_d1</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha_d2</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">alpha_d3</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span>
                <span class="n">s1</span><span class="o">=</span><span class="s1">&#39;simple&#39;</span><span class="p">,</span> <span class="n">s2</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">s3</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">alpha_s1</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha_s2</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">alpha_s3</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                   <span class="n">alpha_flux</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span> <span class="n">alpha_cm</span><span class="o">=</span><span class="mi">500</span><span class="p">,</span>
                <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Run a general interferometric imager. Only works directly on the image&#39;s primary polarization.</span>

<span class="sd">       Args:</span>
<span class="sd">           Obsdata (Obsdata): The Obsdata object with VLBI data</span>
<span class="sd">           InitIm (Image): The Image object with the initial image for the minimization</span>
<span class="sd">           Prior (Image): The Image object with the prior image</span>
<span class="sd">           flux (float): The total flux of the output image in Jy</span>

<span class="sd">           d1 (str): The first data term; options are &#39;vis&#39;, &#39;bs&#39;, &#39;amp&#39;, &#39;cphase&#39;, &#39;cphase_diag&#39; &#39;camp&#39;, &#39;logcamp&#39;, &#39;logcamp_diag&#39;</span>
<span class="sd">           d2 (str): The second data term; options are &#39;vis&#39;, &#39;bs&#39;, &#39;amp&#39;, &#39;cphase&#39;, &#39;cphase_diag&#39; &#39;camp&#39;, &#39;logcamp&#39;, &#39;logcamp_diag&#39;</span>
<span class="sd">           d3 (str): The third data term; options are &#39;vis&#39;, &#39;bs&#39;, &#39;amp&#39;, &#39;cphase&#39;, &#39;cphase_diag&#39; &#39;camp&#39;, &#39;logcamp&#39;, &#39;logcamp_diag&#39;</span>

<span class="sd">           s1 (str): The first regularizer; options are &#39;simple&#39;, &#39;gs&#39;, &#39;tv&#39;, &#39;tv2&#39;, &#39;l1&#39;, &#39;patch&#39;,&#39;compact&#39;,&#39;compact2&#39;,&#39;rgauss&#39;</span>
<span class="sd">           s2 (str): The second regularizer; options are &#39;simple&#39;, &#39;gs&#39;, &#39;tv&#39;, &#39;tv2&#39;,&#39;l1&#39;, &#39;patch&#39;,&#39;compact&#39;,&#39;compact2&#39;,&#39;rgauss&#39;</span>
<span class="sd">           s3 (str): The third regularizer; options are &#39;simple&#39;, &#39;gs&#39;, &#39;tv&#39;, &#39;tv2&#39;,&#39;l1&#39;, &#39;patch&#39;,&#39;compact&#39;,&#39;compact2&#39;,&#39;rgauss&#39;</span>

<span class="sd">           alpha_d1 (float): The first data term weighting</span>
<span class="sd">           alpha_d2 (float): The second data term weighting</span>
<span class="sd">           alpha_d2 (float): The third data term weighting</span>

<span class="sd">           alpha_s1 (float): The first regularizer term weighting</span>
<span class="sd">           alpha_s2 (float): The second regularizer term weighting</span>
<span class="sd">           alpha_s3 (float): The third regularizer term weighting</span>

<span class="sd">           alpha_flux (float): The weighting for the total flux constraint</span>
<span class="sd">           alpha_cm (float): The weighting for the center of mass constraint</span>

<span class="sd">           maxit (int): Maximum number of minimizer iterations</span>
<span class="sd">           stop (float): The convergence criterion</span>
<span class="sd">           clipfloor (float): The Jy/pixel level above which prior image pixels are varied</span>

<span class="sd">           grads (bool): If True, analytic gradients are used</span>
<span class="sd">           logim (bool): If True, uses I = exp(I&#39;) change of variables</span>
<span class="sd">           norm_reg (bool): If True, normalizes regularizer terms</span>
<span class="sd">           norm_init (bool): If True, normalizes initial image to given total flux</span>
<span class="sd">           show_updates (bool): If True, displays the progress of the minimizer</span>

<span class="sd">           weighting (str): &#39;natural&#39; or &#39;uniform&#39;</span>
<span class="sd">           debias (bool): if True then apply debiasing to amplitudes/closure amplitudes</span>
<span class="sd">           systematic_noise (float): a fractional systematic noise tolerance to add to thermal sigmas</span>
<span class="sd">           snrcut (float): a  snr cutoff for including data in the chi^2 sum</span>
<span class="sd">           beam_size (float): beam size in radians for normalizing the regularizers</span>

<span class="sd">           maxset (bool):  if True, use maximal set instead of minimal for closure quantities</span>
<span class="sd">           systematic_cphase_noise (float): a value in degrees to add to the closure phase sigmas</span>
<span class="sd">           cp_uv_min (float): flag baselines shorter than this before forming closure quantities</span>

<span class="sd">           ttype (str): The Fourier transform type; options are &#39;fast&#39;, &#39;direct&#39;, &#39;nfft&#39;</span>
<span class="sd">           fft_pad_factor (float): The FFT will pre-pad the image by this factor x the original size</span>
<span class="sd">           order (int): Interpolation order for sampling the FFT</span>
<span class="sd">           conv_func (str): The convolving function for gridding; options are &#39;gaussian&#39;, &#39;pill&#39;, and &#39;cubic&#39;</span>
<span class="sd">           p_rad (int): The pixel radius for the convolving function in gridding for FFTs</span>

<span class="sd">       Returns:</span>
<span class="sd">           Image: Image object with result</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># some kwarg default values</span>
    <span class="n">maxit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxit&#39;</span><span class="p">,</span> <span class="n">MAXIT</span><span class="p">)</span>
    <span class="n">stop</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;stop&#39;</span><span class="p">,</span> <span class="n">STOP</span><span class="p">)</span>
    <span class="n">clipfloor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;clipfloor&#39;</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
    <span class="n">ttype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="s1">&#39;direct&#39;</span><span class="p">)</span>

    <span class="n">grads</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;grads&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">logim</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;logim&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">norm_init</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;norm_init&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">show_updates</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;show_updates&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="n">beam_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_size&#39;</span><span class="p">,</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">res</span><span class="p">())</span>
    <span class="n">kwargs</span><span class="p">[</span><span class="s1">&#39;beam_size&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">beam_size</span>

    <span class="c1"># Make sure data and regularizer options are ok</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">d1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">d2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Must have at least one data term!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">s1</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">s2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Must have at least one regularizer term!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">((</span><span class="n">d1</span> <span class="ow">in</span> <span class="n">DATATERMS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">d1</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="p">((</span><span class="n">d2</span> <span class="ow">in</span> <span class="n">DATATERMS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">d2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid data term: valid data terms are: &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">DATATERMS</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="p">((</span><span class="n">s1</span> <span class="ow">in</span> <span class="n">REGULARIZERS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s1</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span><span class="ow">not</span> <span class="p">((</span><span class="n">s2</span> <span class="ow">in</span> <span class="n">REGULARIZERS</span><span class="p">)</span> <span class="ow">or</span> <span class="n">s2</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Invalid regularizer: valid regularizers are: &quot;</span> <span class="o">+</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">REGULARIZERS</span><span class="p">))</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span> <span class="o">!=</span> <span class="n">InitIm</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">!=</span> <span class="n">InitIm</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">!=</span> <span class="n">InitIm</span><span class="o">.</span><span class="n">ydim</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Initial image does not match dimensions of the prior image!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">InitIm</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="n">Prior</span><span class="o">.</span><span class="n">polrep</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Initial image pol. representation does not match pol. representation of the prior image!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">logim</span> <span class="ow">and</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pol_prim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">]):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span>
            <span class="s2">&quot;Cannot image Stokes Q,U,or V with log image transformation! Set logim=False in imager_func&quot;</span><span class="p">)</span>

    <span class="n">pol</span> <span class="o">=</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pol_prim</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating </span><span class="si">%s</span><span class="s2"> image...&quot;</span> <span class="o">%</span> <span class="n">pol</span><span class="p">)</span>

    <span class="c1"># Catch scale and dimension problems</span>
    <span class="n">imsize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">])</span> <span class="o">*</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span>
    <span class="n">uvmax</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span>
    <span class="n">uvmin</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">imsize</span>
    <span class="n">uvdists</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;uvdist&#39;</span><span class="p">)[</span><span class="s1">&#39;uvdist&#39;</span><span class="p">]</span>
    <span class="n">maxbl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">uvdists</span><span class="p">)</span>
    <span class="n">minbl</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">uvdists</span><span class="p">[</span><span class="n">uvdists</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
    <span class="n">maxamp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">unpack</span><span class="p">(</span><span class="s1">&#39;amp&#39;</span><span class="p">)[</span><span class="s1">&#39;amp&#39;</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">uvmax</span> <span class="o">&lt;</span> <span class="n">maxbl</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning! Pixel Spacing is larger than smallest spatial wavelength!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uvmin</span> <span class="o">&gt;</span> <span class="n">minbl</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning! Field of View is smaller than largest nonzero spatial wavelength!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flux</span> <span class="o">&gt;</span> <span class="mf">1.2</span><span class="o">*</span><span class="n">maxamp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning! Specified flux is &gt; 120</span><span class="si">% o</span><span class="s2">f maximum visibility amplitude!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">flux</span> <span class="o">&lt;</span> <span class="o">.</span><span class="mi">8</span><span class="o">*</span><span class="n">maxamp</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning! Specified flux is &lt; 80</span><span class="si">% o</span><span class="s2">f maximum visibility amplitude!&quot;</span><span class="p">)</span>

    <span class="c1"># Define embedding mask</span>
    <span class="n">embed_mask</span> <span class="o">=</span> <span class="n">Prior</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&gt;</span> <span class="n">clipfloor</span>

    <span class="c1"># Normalize prior image to total flux and limit imager range to prior values &gt; clipfloor</span>
    <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="n">norm_init</span><span class="p">):</span>
        <span class="n">nprior</span> <span class="o">=</span> <span class="n">Prior</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">embed_mask</span><span class="p">]</span>
        <span class="n">ninit</span> <span class="o">=</span> <span class="n">InitIm</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">embed_mask</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">nprior</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">*</span> <span class="n">Prior</span><span class="o">.</span><span class="n">imvec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">imvec</span><span class="p">)[</span><span class="n">embed_mask</span><span class="p">]))[</span><span class="n">embed_mask</span><span class="p">]</span>
        <span class="n">ninit</span> <span class="o">=</span> <span class="p">(</span><span class="n">flux</span> <span class="o">*</span> <span class="n">InitIm</span><span class="o">.</span><span class="n">imvec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">InitIm</span><span class="o">.</span><span class="n">imvec</span><span class="p">)[</span><span class="n">embed_mask</span><span class="p">]))[</span><span class="n">embed_mask</span><span class="p">]</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">nprior</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;clipfloor too large: all prior pixels have been clipped!&quot;</span><span class="p">)</span>

    <span class="c1"># Get data and fourier matrices for the data terms</span>
    <span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">A1</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="p">(</span><span class="n">data2</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">A2</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="p">(</span><span class="n">data3</span><span class="p">,</span> <span class="n">sigma3</span><span class="p">,</span> <span class="n">A3</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Define the chi^2 and chi^2 gradient</span>
    <span class="k">def</span> <span class="nf">chisq1</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">chisq</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">embed_mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chisq1grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">chisqgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A1</span><span class="p">,</span> <span class="n">data1</span><span class="p">,</span> <span class="n">sigma1</span><span class="p">,</span> <span class="n">d1</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">embed_mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">chisq2</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">chisq</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">embed_mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chisq2grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">chisqgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">sigma2</span><span class="p">,</span> <span class="n">d2</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">embed_mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="k">def</span> <span class="nf">chisq3</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">chisq</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">sigma3</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">embed_mask</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">chisq3grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">chisqgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">data3</span><span class="p">,</span> <span class="n">sigma3</span><span class="p">,</span> <span class="n">d3</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">embed_mask</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">c</span>

    <span class="c1"># Define the regularizer and regularizer gradient</span>
    <span class="k">def</span> <span class="nf">reg1</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizer</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reg1grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizergrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">s1</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reg2</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizer</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reg2grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizergrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">s2</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reg3</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizer</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">s3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">reg3grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizergrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">s3</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Define constraint functions</span>
    <span class="k">def</span> <span class="nf">flux_constraint</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizer</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">flux_constraint_grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizergrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="s2">&quot;flux&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cm_constraint</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizer</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="s2">&quot;cm&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">cm_constraint_grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">regularizergrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="s2">&quot;cm&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="c1"># Define the objective function and gradient</span>
    <span class="k">def</span> <span class="nf">objfunc</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">logim</span><span class="p">:</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">datterm</span> <span class="o">=</span> <span class="n">alpha_d1</span> <span class="o">*</span> <span class="p">(</span><span class="n">chisq1</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_d2</span> <span class="o">*</span> \
            <span class="p">(</span><span class="n">chisq2</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_d3</span> <span class="o">*</span> <span class="p">(</span><span class="n">chisq3</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">regterm</span> <span class="o">=</span> <span class="n">alpha_s1</span> <span class="o">*</span> <span class="n">reg1</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_s2</span> <span class="o">*</span> <span class="n">reg2</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_s3</span> <span class="o">*</span> <span class="n">reg3</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">conterm</span> <span class="o">=</span> <span class="n">alpha_flux</span> <span class="o">*</span> <span class="n">flux_constraint</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_cm</span> <span class="o">*</span> <span class="n">cm_constraint</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">datterm</span> <span class="o">+</span> <span class="n">regterm</span> <span class="o">+</span> <span class="n">conterm</span>

    <span class="k">def</span> <span class="nf">objgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">logim</span><span class="p">:</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">datterm</span> <span class="o">=</span> <span class="n">alpha_d1</span> <span class="o">*</span> <span class="n">chisq1grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_d2</span> <span class="o">*</span> \
            <span class="n">chisq2grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_d3</span> <span class="o">*</span> <span class="n">chisq3grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">regterm</span> <span class="o">=</span> <span class="n">alpha_s1</span> <span class="o">*</span> <span class="n">reg1grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_s2</span> <span class="o">*</span> \
            <span class="n">reg2grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_s3</span> <span class="o">*</span> <span class="n">reg3grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">conterm</span> <span class="o">=</span> <span class="n">alpha_flux</span> <span class="o">*</span> <span class="n">flux_constraint_grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">alpha_cm</span> <span class="o">*</span> <span class="n">cm_constraint_grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">grad</span> <span class="o">=</span> <span class="n">datterm</span> <span class="o">+</span> <span class="n">regterm</span> <span class="o">+</span> <span class="n">conterm</span>

        <span class="c1"># chain rule term for change of variables</span>
        <span class="k">if</span> <span class="n">logim</span><span class="p">:</span>
            <span class="n">grad</span> <span class="o">*=</span> <span class="n">imvec</span>

        <span class="k">return</span> <span class="n">grad</span>

    <span class="c1"># Define plotting function for each iteration</span>
    <span class="k">global</span> <span class="n">nit</span>
    <span class="n">nit</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">plotcur</span><span class="p">(</span><span class="n">im_step</span><span class="p">):</span>
        <span class="k">global</span> <span class="n">nit</span>
        <span class="k">if</span> <span class="n">logim</span><span class="p">:</span>
            <span class="n">im_step</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">im_step</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">show_updates</span><span class="p">:</span>
            <span class="n">chi2_1</span> <span class="o">=</span> <span class="n">chisq1</span><span class="p">(</span><span class="n">im_step</span><span class="p">)</span>
            <span class="n">chi2_2</span> <span class="o">=</span> <span class="n">chisq2</span><span class="p">(</span><span class="n">im_step</span><span class="p">)</span>
            <span class="n">chi2_3</span> <span class="o">=</span> <span class="n">chisq3</span><span class="p">(</span><span class="n">im_step</span><span class="p">)</span>
            <span class="n">s_1</span> <span class="o">=</span> <span class="n">reg1</span><span class="p">(</span><span class="n">im_step</span><span class="p">)</span>
            <span class="n">s_2</span> <span class="o">=</span> <span class="n">reg2</span><span class="p">(</span><span class="n">im_step</span><span class="p">)</span>
            <span class="n">s_3</span> <span class="o">=</span> <span class="n">reg3</span><span class="p">(</span><span class="n">im_step</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">embed_mask</span><span class="p">)):</span>
                <span class="n">im_step</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">im_step</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">)</span>
            <span class="n">plot_i</span><span class="p">(</span><span class="n">im_step</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">nit</span><span class="p">,</span> <span class="p">{</span><span class="n">d1</span><span class="p">:</span> <span class="n">chi2_1</span><span class="p">,</span> <span class="n">d2</span><span class="p">:</span> <span class="n">chi2_2</span><span class="p">,</span> <span class="n">d3</span><span class="p">:</span> <span class="n">chi2_3</span><span class="p">},</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;i: </span><span class="si">%d</span><span class="s2"> chi2_1: </span><span class="si">%0.2f</span><span class="s2"> chi2_2: </span><span class="si">%0.2f</span><span class="s2"> chi2_3: </span><span class="si">%0.2f</span><span class="s2"> s_1: </span><span class="si">%0.2f</span><span class="s2"> s_2: </span><span class="si">%0.2f</span><span class="s2"> s_3: </span><span class="si">%0.2f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span>
                <span class="n">nit</span><span class="p">,</span> <span class="n">chi2_1</span><span class="p">,</span> <span class="n">chi2_2</span><span class="p">,</span> <span class="n">chi2_3</span><span class="p">,</span> <span class="n">s_1</span><span class="p">,</span> <span class="n">s_2</span><span class="p">,</span> <span class="n">s_3</span><span class="p">))</span>
        <span class="n">nit</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="c1"># Generate and the initial image</span>
    <span class="k">if</span> <span class="n">logim</span><span class="p">:</span>
        <span class="n">xinit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">ninit</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">xinit</span> <span class="o">=</span> <span class="n">ninit</span>

    <span class="c1"># Print stats</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial S_1: </span><span class="si">%f</span><span class="s2"> S_2: </span><span class="si">%f</span><span class="s2"> S_3: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">reg1</span><span class="p">(</span><span class="n">ninit</span><span class="p">),</span> <span class="n">reg2</span><span class="p">(</span><span class="n">ninit</span><span class="p">),</span> <span class="n">reg3</span><span class="p">(</span><span class="n">ninit</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial Chi^2_1: </span><span class="si">%f</span><span class="s2"> Chi^2_2: </span><span class="si">%f</span><span class="s2"> Chi^2_3: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">chisq1</span><span class="p">(</span><span class="n">ninit</span><span class="p">),</span> <span class="n">chisq2</span><span class="p">(</span><span class="n">ninit</span><span class="p">),</span> <span class="n">chisq3</span><span class="p">(</span><span class="n">ninit</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Initial Objective Function: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">objfunc</span><span class="p">(</span><span class="n">xinit</span><span class="p">)))</span>

    <span class="k">if</span> <span class="n">d1</span> <span class="ow">in</span> <span class="n">DATATERMS</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total Data 1: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data1</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">d2</span> <span class="ow">in</span> <span class="n">DATATERMS</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total Data 2: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data2</span><span class="p">)))</span>
    <span class="k">if</span> <span class="n">d3</span> <span class="ow">in</span> <span class="n">DATATERMS</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total Data 3: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data3</span><span class="p">)))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Total Pixel #: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Clipped Pixel #: &quot;</span><span class="p">,</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ninit</span><span class="p">)))</span>
    <span class="nb">print</span><span class="p">()</span>
    <span class="n">plotcur</span><span class="p">(</span><span class="n">xinit</span><span class="p">)</span>

    <span class="c1"># Minimize</span>
    <span class="n">optdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="n">maxit</span><span class="p">,</span> <span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;maxcor&#39;</span><span class="p">:</span> <span class="n">NHIST</span><span class="p">,</span>
               <span class="s1">&#39;gtol&#39;</span><span class="p">:</span> <span class="n">stop</span><span class="p">,</span> <span class="s1">&#39;maxls&#39;</span><span class="p">:</span> <span class="n">MAXLS</span><span class="p">}</span>  <span class="c1"># minimizer dict params</span>
    <span class="n">tstart</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">grads</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objfunc</span><span class="p">,</span> <span class="n">xinit</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span> <span class="n">jac</span><span class="o">=</span><span class="n">objgrad</span><span class="p">,</span>
                           <span class="n">options</span><span class="o">=</span><span class="n">optdict</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">plotcur</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">objfunc</span><span class="p">,</span> <span class="n">xinit</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;L-BFGS-B&#39;</span><span class="p">,</span>
                           <span class="n">options</span><span class="o">=</span><span class="n">optdict</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="n">plotcur</span><span class="p">)</span>

    <span class="n">tstop</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="c1"># Format output</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
    <span class="k">if</span> <span class="n">logim</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">x</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">embed_mask</span><span class="p">)):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">)</span>

    <span class="n">outim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span>
                        <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
                        <span class="n">rf</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                        <span class="n">polrep</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span>
                        <span class="n">mjd</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">time</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>

    <span class="c1"># copy over other polarizations</span>
    <span class="n">outim</span><span class="o">.</span><span class="n">copy_pol_images</span><span class="p">(</span><span class="n">InitIm</span><span class="p">)</span>

    <span class="c1"># Print stats</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;time: </span><span class="si">%f</span><span class="s2"> s&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">tstop</span> <span class="o">-</span> <span class="n">tstart</span><span class="p">))</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;J: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">res</span><span class="o">.</span><span class="n">fun</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Final Chi^2_1: </span><span class="si">%f</span><span class="s2"> Chi^2_2: </span><span class="si">%f</span><span class="s2">  Chi^2_3: </span><span class="si">%f</span><span class="s2">&quot;</span> <span class="o">%</span>
          <span class="p">(</span><span class="n">chisq1</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">embed_mask</span><span class="p">]),</span> <span class="n">chisq2</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">embed_mask</span><span class="p">]),</span> <span class="n">chisq3</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="n">embed_mask</span><span class="p">])))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">res</span><span class="o">.</span><span class="n">message</span><span class="p">)</span>

    <span class="c1"># Return Image object</span>
    <span class="k">return</span> <span class="n">outim</span></div>

<span class="c1">##################################################################################################</span>
<span class="c1"># Wrapper Functions</span>
<span class="c1">##################################################################################################</span>


<span class="k">def</span> <span class="nf">chisq</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the chi^2 for the appropriate dtype</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DATATERMS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chisq</span>

    <span class="k">if</span> <span class="n">ttype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="s1">&#39;nfft&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Possible ttype values are &#39;fast&#39;, &#39;direct&#39;!, &#39;nfft!&#39;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_vis</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_amp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logamp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_bs</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_cphase</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_cphase_diag</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_camp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logcamp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logcamp_diag</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;fast&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cphase_diag&#39;</span><span class="p">,</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">]:</span>
            <span class="n">vis_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">fft_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_vis_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_amp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logamp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_bs_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_cphase_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_cphase_diag_fft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_camp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logcamp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logcamp_diag_fft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;nfft&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_vis_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_amp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logamp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_bs_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_cphase_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_cphase_diag_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_camp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logcamp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="n">chisq</span> <span class="o">=</span> <span class="n">chisq_logcamp_diag_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the chi^2 gradient for the appropriate dtype</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">mask</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">DATATERMS</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">chisqgrad</span>

    <span class="k">if</span> <span class="n">ttype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="s1">&#39;nfft&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Possible ttype values are &#39;fast&#39;, &#39;direct&#39;, &#39;nfft&#39;!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_vis</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_amp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logamp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_bs</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_cphase</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_cphase_diag</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_camp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logcamp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logcamp_diag</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;fast&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cphase_diag&#39;</span><span class="p">,</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">]:</span>
            <span class="n">vis_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">fft_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_vis_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_amp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logamp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_bs_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_cphase_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_cphase_diag_fft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_camp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logcamp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logcamp_diag_fft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;nfft&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_vis_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_amp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logamp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_bs_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_cphase_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_cphase_diag_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_camp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logcamp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad_logcamp_diag_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="ow">and</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">chisqgrad</span> <span class="o">=</span> <span class="n">chisqgrad</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">chisqgrad</span>


<span class="k">def</span> <span class="nf">regularizer</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the regularizer value</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">norm_reg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;norm_reg&#39;</span><span class="p">,</span> <span class="n">NORM_REGULARIZER</span><span class="p">)</span>
    <span class="n">beam_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_size&#39;</span><span class="p">,</span> <span class="n">psize</span><span class="p">)</span>
    <span class="n">alpha_A</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha_A&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epsilon_tv&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;flux&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sflux</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;cm&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">scm</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">ssimple</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;l1&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sl1</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;l1w&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sl1w</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;lA&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">slA</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">beam_size</span><span class="p">,</span> <span class="n">alpha_A</span><span class="p">,</span> <span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;gs&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sgs</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;patch&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">spatch</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;tv&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">stv</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span><span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;tvlog&quot;</span><span class="p">:</span> 
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">clipfloor</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="n">xdim</span><span class="o">*</span><span class="n">ydim</span>
        <span class="n">logvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">logflux</span> <span class="o">=</span> <span class="n">npix</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flux</span><span class="o">/</span><span class="n">npix</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">stv</span><span class="p">(</span><span class="n">logvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">logflux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span><span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;tv2&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">stv2</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;tv2log&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>      
        <span class="n">npix</span> <span class="o">=</span> <span class="n">xdim</span><span class="o">*</span><span class="n">ydim</span>
        <span class="n">logvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">logflux</span> <span class="o">=</span> <span class="n">npix</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flux</span><span class="o">/</span><span class="n">npix</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">stv2</span><span class="p">(</span><span class="n">logvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">logflux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;compact&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">scompact</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;compact2&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">scompact2</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;rgauss&quot;</span><span class="p">:</span>
        <span class="c1"># additional key words for gaussian regularizer</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">PA</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PA&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sgauss</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">major</span><span class="o">=</span><span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="o">=</span><span class="n">minor</span><span class="p">,</span> <span class="n">PA</span><span class="o">=</span><span class="n">PA</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">regularizergrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">stype</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the regularizer gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">norm_reg</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;norm_reg&#39;</span><span class="p">,</span> <span class="n">NORM_REGULARIZER</span><span class="p">)</span>
    <span class="n">beam_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;beam_size&#39;</span><span class="p">,</span> <span class="n">psize</span><span class="p">)</span>
    <span class="n">alpha_A</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;alpha_A&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
    <span class="n">epsilon</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;epsilon_tv&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;flux&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sfluxgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;cm&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">scmgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;simple&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">ssimplegrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;l1&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sl1grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;l1w&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sl1wgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;lA&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">slAgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">beam_size</span><span class="p">,</span> <span class="n">alpha_A</span><span class="p">,</span> <span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;gs&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sgsgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;patch&quot;</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">spatchgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nprior</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;tv&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">stvgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span>
                     <span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;tvlog&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">clipfloor</span><span class="o">=</span><span class="n">epsilon</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="n">xdim</span><span class="o">*</span><span class="n">ydim</span>
        <span class="n">logvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">logflux</span> <span class="o">=</span> <span class="n">npix</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flux</span><span class="o">/</span><span class="n">npix</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">stvgrad</span><span class="p">(</span><span class="n">logvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">logflux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span><span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">epsilon</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">imvec</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>        
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;tv2&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">stv2grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;tv2log&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="n">xdim</span><span class="o">*</span><span class="n">ydim</span>
        <span class="n">logvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">logflux</span> <span class="o">=</span> <span class="n">npix</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">flux</span><span class="o">/</span><span class="n">npix</span><span class="p">))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">stv2grad</span><span class="p">(</span><span class="n">logvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">logflux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="n">beam_size</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">/</span> <span class="n">imvec</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>        
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;compact&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">scompactgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;compact2&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">scompact2grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">norm_reg</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">stype</span> <span class="o">==</span> <span class="s2">&quot;rgauss&quot;</span><span class="p">:</span>
        <span class="c1"># additional key words for gaussian regularizer</span>
        <span class="n">major</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;major&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">minor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;minor&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="n">PA</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;PA&#39;</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">invert</span><span class="p">(</span><span class="n">mask</span><span class="p">)):</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">embed</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="o">-</span><span class="n">sgauss_grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">PA</span><span class="p">)</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">s</span>


<span class="k">def</span> <span class="nf">chisqdata</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">dtype</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigma, and matrices for the appropriate dtype</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ttype</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;ttype&#39;</span><span class="p">,</span> <span class="s1">&#39;direct&#39;</span><span class="p">)</span>
    <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ttype</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;fast&#39;</span><span class="p">,</span> <span class="s1">&#39;direct&#39;</span><span class="p">,</span> <span class="s1">&#39;nfft&#39;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Possible ttype values are &#39;fast&#39;, &#39;direct&#39;, &#39;nfft&#39;!&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_vis</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_amp</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_bs</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_cphase</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_cphase_diag</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_camp</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_logcamp</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_logcamp_diag</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;fast&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_vis_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_amp_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_bs_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_cphase_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_cphase_diag_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_camp_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_logcamp_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_logcamp_diag_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;nfft&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;vis&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_vis_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;amp&#39;</span> <span class="ow">or</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logamp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_amp_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;bs&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_bs_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_cphase_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;cphase_diag&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_cphase_diag_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;camp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_camp_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_logcamp_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">dtype</span> <span class="o">==</span> <span class="s1">&#39;logcamp_diag&#39;</span><span class="p">:</span>
            <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span> <span class="o">=</span> <span class="n">chisqdata_logcamp_diag_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="c1">##################################################################################################</span>
<span class="c1"># DFT Chi-squared and Gradient Functions</span>
<span class="c1">##################################################################################################</span>

<span class="k">def</span> <span class="nf">chisq_vis</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrix</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibility chi-squared&quot;&quot;&quot;</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrix</span><span class="p">,</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">samples</span><span class="o">-</span><span class="n">vis</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>

<span class="k">def</span> <span class="nf">chisqgrad_vis</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrix</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the visibility chi-squared&quot;&quot;&quot;</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrix</span><span class="p">,</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">wdiff</span> <span class="o">=</span> <span class="p">(</span><span class="n">vis</span> <span class="o">-</span> <span class="n">samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrix</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="n">wdiff</span><span class="p">))</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_amp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibility Amplitudes (normalized) chi-squared&quot;&quot;&quot;</span>

    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">imvec</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">amp</span> <span class="o">-</span> <span class="n">amp_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqgrad_amp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the amplitude chi-squared&quot;&quot;&quot;</span>

    <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i1</span><span class="p">)</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="p">((</span><span class="n">amp</span> <span class="o">-</span> <span class="n">amp_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">amp_samples</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">i1</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_bs</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">bis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bispectrum chi-squared&quot;&quot;&quot;</span>

    <span class="n">bisamples</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">bis</span> <span class="o">-</span> <span class="n">bisamples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bis</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_bs</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">bis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the bispectrum chi-squared&quot;&quot;&quot;</span>

    <span class="n">bisamples</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span>
                 <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>

    <span class="n">wdiff</span> <span class="o">=</span> <span class="p">((</span><span class="n">bis</span> <span class="o">-</span> <span class="n">bisamples</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
           <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt2</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> 
           <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt3</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">out</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">bis</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_cphase</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closure Phases (normalized) chi-squared&quot;&quot;&quot;</span>
    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphase</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">i1</span> <span class="o">*</span> <span class="n">i2</span> <span class="o">*</span> <span class="n">i3</span><span class="p">)</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">clphase</span><span class="o">-</span><span class="n">clphase_samples</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_cphase</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the closure phase chi-squared&quot;&quot;&quot;</span>
    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphase</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">i1</span> <span class="o">*</span> <span class="n">i2</span> <span class="o">*</span> <span class="n">i3</span><span class="p">)</span>

    <span class="n">pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">clphase</span> <span class="o">-</span> <span class="n">clphase_samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">i1</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">i2</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">i3</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt2</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt3</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_cphase_diag</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">clphase_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalized closure phases (normalized) chi-squared&quot;&quot;&quot;</span>
    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">A3_diag</span> <span class="o">=</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iA</span><span class="p">,</span> <span class="n">A3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">A3_diag</span><span class="p">):</span>
        <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">*</span>
                                   <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A3</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>
        <span class="n">clphase_diag_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">],</span> <span class="n">clphase_samples</span><span class="p">))</span>
    <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag_samples</span><span class="p">)</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">clphase_diag</span><span class="o">-</span><span class="n">clphase_diag_samples</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">chisq</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_cphase_diag</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">clphase_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the diagonalized closure phase chi-squared&quot;&quot;&quot;</span>
    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="n">clphase_diag</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">A3_diag</span> <span class="o">=</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iA</span><span class="p">,</span> <span class="n">A3</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">A3_diag</span><span class="p">):</span>

        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
        <span class="n">i3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A3</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
        <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">i1</span> <span class="o">*</span> <span class="n">i2</span> <span class="o">*</span> <span class="n">i3</span><span class="p">)</span>
        <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">],</span> <span class="n">clphase_samples</span><span class="p">)</span>

        <span class="n">clphase_diag_measured</span> <span class="o">=</span> <span class="n">clphase_diag</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span>
        <span class="n">clphase_diag_sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span>

        <span class="n">term1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">clphase_diag_measured</span><span class="o">-</span><span class="n">clphase_diag_samples</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="n">clphase_diag_sigma</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)),</span> <span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span><span class="o">/</span><span class="n">i1</span><span class="p">)),</span> <span class="n">A3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">clphase_diag_measured</span><span class="o">-</span><span class="n">clphase_diag_samples</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="n">clphase_diag_sigma</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)),</span> <span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span><span class="o">/</span><span class="n">i2</span><span class="p">)),</span> <span class="n">A3</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">clphase_diag_measured</span><span class="o">-</span><span class="n">clphase_diag_samples</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="n">clphase_diag_sigma</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)),</span> <span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span><span class="o">/</span><span class="n">i3</span><span class="p">)),</span> <span class="n">A3</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">deriv</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">+</span> <span class="n">term3</span><span class="p">)</span>

    <span class="n">deriv</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">deriv</span>


<span class="k">def</span> <span class="nf">chisq_camp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closure Amplitudes (normalized) chi-squared&quot;&quot;&quot;</span>

    <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">i1</span> <span class="o">*</span> <span class="n">i2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">i3</span> <span class="o">*</span> <span class="n">i4</span><span class="p">))</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">clamp</span> <span class="o">-</span> <span class="n">clamp_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clamp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_camp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the closure amplitude chi-squared&quot;&quot;&quot;</span>

    <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">i1</span> <span class="o">*</span> <span class="n">i2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">i3</span> <span class="o">*</span> <span class="n">i4</span><span class="p">))</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="p">((</span><span class="n">clamp</span> <span class="o">-</span> <span class="n">clamp_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">clamp_samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pp</span><span class="o">/</span><span class="n">i1</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pp</span><span class="o">/</span><span class="n">i2</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span><span class="o">/</span><span class="n">i3</span>
    <span class="n">pt4</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span><span class="o">/</span><span class="n">i4</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
           <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt2</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
           <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt3</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
           <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt4</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">out</span> <span class="o">*=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clamp</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_logcamp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">log_clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log Closure Amplitudes (normalized) chi-squared&quot;&quot;&quot;</span>

    <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>
    <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>
    <span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>
    <span class="n">a4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>

    <span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">log_clamp</span> <span class="o">-</span> <span class="n">samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_logcamp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">log_clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the Log closure amplitude chi-squared&quot;&quot;&quot;</span>

    <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">i4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">Amatrices</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i1</span><span class="p">))</span> <span class="o">+</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i2</span><span class="p">))</span> <span class="o">-</span> 
                         <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i3</span><span class="p">))</span> <span class="o">-</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i4</span><span class="p">)))</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="n">log_clamp</span> <span class="o">-</span> <span class="n">log_clamp_samples</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">/</span> <span class="n">i1</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">/</span> <span class="n">i2</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span> <span class="o">/</span> <span class="n">i3</span>
    <span class="n">pt4</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span> <span class="o">/</span> <span class="n">i4</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt1</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span>
           <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt2</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span>
           <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt3</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span>
           <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pt4</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_logcamp_diag</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">log_clamp_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalized log closure amplitudes (normalized) chi-squared&quot;&quot;&quot;</span>

    <span class="n">log_clamp_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">A4_diag</span> <span class="o">=</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">iA</span><span class="p">,</span> <span class="n">A4</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">A4_diag</span><span class="p">):</span>

        <span class="n">a1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>
        <span class="n">a2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>
        <span class="n">a3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>
        <span class="n">a4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">imvec</span><span class="p">))</span>

        <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a1</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a2</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a3</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">a4</span><span class="p">)</span>
        <span class="n">log_clamp_diag_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">],</span> <span class="n">log_clamp_samples</span><span class="p">))</span>

    <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag_samples</span><span class="p">)</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">log_clamp_diag</span> <span class="o">-</span> <span class="n">log_clamp_diag_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">/=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_logcamp_diag</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">Amatrices</span><span class="p">,</span> <span class="n">log_clamp_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the diagonalized log closure amplitude chi-squared&quot;&quot;&quot;</span>

    <span class="n">A4_diag</span> <span class="o">=</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">Amatrices</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">iA</span><span class="p">,</span> <span class="n">A4</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">A4_diag</span><span class="p">):</span>

        <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
        <span class="n">i2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
        <span class="n">i3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
        <span class="n">i4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A4</span><span class="p">[</span><span class="mi">3</span><span class="p">],</span> <span class="n">imvec</span><span class="p">)</span>
        <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i2</span><span class="p">))</span> <span class="o">-</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i3</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i4</span><span class="p">))</span>
        <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">],</span> <span class="n">log_clamp_samples</span><span class="p">)</span>

        <span class="n">log_clamp_diag_measured</span> <span class="o">=</span> <span class="n">log_clamp_diag</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span>
        <span class="n">log_clamp_diag_sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span>

        <span class="n">term1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(((</span><span class="n">log_clamp_diag_measured</span><span class="o">-</span><span class="n">log_clamp_diag_samples</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="n">log_clamp_diag_sigma</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)),</span> <span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span><span class="o">/</span><span class="n">i1</span><span class="p">)),</span> <span class="n">A4</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(((</span><span class="n">log_clamp_diag_measured</span><span class="o">-</span><span class="n">log_clamp_diag_samples</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="n">log_clamp_diag_sigma</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)),</span> <span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span><span class="o">/</span><span class="n">i2</span><span class="p">)),</span> <span class="n">A4</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">term3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(((</span><span class="n">log_clamp_diag_measured</span><span class="o">-</span><span class="n">log_clamp_diag_samples</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="n">log_clamp_diag_sigma</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)),</span> <span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span><span class="o">/</span><span class="n">i3</span><span class="p">)),</span> <span class="n">A4</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">term4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(((</span><span class="n">log_clamp_diag_measured</span><span class="o">-</span><span class="n">log_clamp_diag_samples</span><span class="p">)</span> <span class="o">/</span>
                               <span class="p">(</span><span class="n">log_clamp_diag_sigma</span><span class="o">**</span><span class="mf">2.0</span><span class="p">)),</span> <span class="p">(</span><span class="n">tform_mats</span><span class="p">[</span><span class="n">iA</span><span class="p">]</span><span class="o">/</span><span class="n">i4</span><span class="p">)),</span> <span class="n">A4</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">deriv</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">term1</span> <span class="o">+</span> <span class="n">term2</span> <span class="o">-</span> <span class="n">term3</span> <span class="o">-</span> <span class="n">term4</span><span class="p">)</span>

    <span class="n">deriv</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">)))</span>

    <span class="k">return</span> <span class="n">deriv</span>


<span class="k">def</span> <span class="nf">chisq_logamp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log Visibility Amplitudes (normalized) chi-squared&quot;&quot;&quot;</span>

    <span class="c1"># to lowest order the variance on the logarithm of a quantity x is</span>
    <span class="c1"># sigma^2_log(x) = sigma^2/x^2</span>
    <span class="n">logsigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">amp</span>

    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">imvec</span><span class="p">))</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp_samples</span><span class="p">))</span><span class="o">/</span><span class="n">logsigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span>

<span class="k">def</span> <span class="nf">chisqgrad_logamp</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the Log amplitude chi-squared&quot;&quot;&quot;</span>

    <span class="c1"># to lowest order the variance on the logarithm of a quantity x is</span>
    <span class="c1"># sigma^2_log(x) = sigma^2/x^2</span>
    <span class="n">logsigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">amp</span>

    <span class="n">i1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">imvec</span><span class="p">)</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">i1</span><span class="p">)</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp_samples</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="n">logsigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">i1</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">pp</span><span class="p">,</span> <span class="n">A</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span>

<span class="c1">##################################################################################################</span>
<span class="c1"># FFT Chi-squared and Gradient Functions</span>
<span class="c1">##################################################################################################</span>


<span class="k">def</span> <span class="nf">chisq_vis_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibility chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">samples</span><span class="o">-</span><span class="n">vis</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_vis_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the visibility chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>

    <span class="c1"># samples and gradient FT</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">wdiff_vec</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vis</span> <span class="o">-</span> <span class="n">samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">wdiff_vec</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff_arr</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevant cells and flatten</span>
    <span class="c1"># TODO or is x&lt;--&gt;y??</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                           <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_amp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibility amplitude chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">))</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">amp_samples</span><span class="o">-</span><span class="n">amp</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_amp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the amplitude chi-kernesquared</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>

    <span class="c1"># samples</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># gradient FT</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span>
    <span class="n">wdiff_vec</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">amp</span> <span class="o">-</span> <span class="n">amp_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">amp_samples</span><span class="p">)</span> <span class="o">/</span>
                 <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">samples</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span> <span class="o">*</span> <span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">wdiff_vec</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff_arr</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevent cells and flatten</span>
    <span class="c1"># TODO or is x&lt;--&gt;y??</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                           <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_bs_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">bis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bispectrum chi-squared from fft&quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">bisamples</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;bs&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">bis</span> <span class="o">-</span> <span class="n">bisamples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bis</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">chisqgrad_bs_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">bis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the amplitude chi-squared</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>

    <span class="n">v1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">bisamples</span> <span class="o">=</span> <span class="n">v1</span><span class="o">*</span><span class="n">v2</span><span class="o">*</span><span class="n">v3</span>

    <span class="n">wdiff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">bis</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">bis</span> <span class="o">-</span> <span class="n">bisamples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="p">(</span><span class="n">v2</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="p">(</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="p">(</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">pt3</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevant cells and flatten</span>
    <span class="c1"># TODO or is x&lt;--&gt;y??</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                           <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_cphase_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closure Phases (normalized) chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphase</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;bs&quot;</span><span class="p">))</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">clphase</span><span class="o">-</span><span class="n">clphase_samples</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_cphase_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the closure phase chi-squared from fft&quot;&quot;&quot;</span>

    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphase</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>

    <span class="c1"># sample visibilities and closure phases</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">v2</span><span class="o">*</span><span class="n">v3</span><span class="p">)</span>

    <span class="n">pref</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">clphase</span> <span class="o">-</span> <span class="n">clphase_samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">pt3</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevant cells and flatten</span>
    <span class="c1"># TODO or is x&lt;--&gt;y??</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                           <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_cphase_diag_fft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clphase_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalized closure phases (normalized) chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">A3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A3</span>
    <span class="n">vis_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">fft_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;bs&quot;</span><span class="p">))</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tform_mat</span> <span class="ow">in</span> <span class="n">tform_mats</span><span class="p">:</span>
        <span class="n">clphase_samples_here</span> <span class="o">=</span> <span class="n">clphase_samples</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>
        <span class="n">clphase_diag_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">,</span> <span class="n">clphase_samples_here</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)</span>

    <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag_samples</span><span class="p">)</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">clphase_diag</span><span class="o">-</span><span class="n">clphase_diag_samples</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">chisq</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_cphase_diag_fft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clphase_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the closure phase chi-squared from fft&quot;&quot;&quot;</span>

    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">A3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A3</span>
    <span class="n">vis_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">fft_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A3</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># sample visibilities and closure phases</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">v2</span><span class="o">*</span><span class="n">v3</span><span class="p">)</span>

    <span class="c1"># gradient vec stuff</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">clphase_samples</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tform_mat</span> <span class="ow">in</span> <span class="n">tform_mats</span><span class="p">:</span>

        <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">,</span> <span class="n">clphase_samples</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)])</span>
        <span class="n">clphase_diag_measured</span> <span class="o">=</span> <span class="n">clphase_diag</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>
        <span class="n">clphase_diag_sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase_diag_measured</span><span class="p">)):</span>
            <span class="n">pref</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">tform_mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
                <span class="n">clphase_diag_measured</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">clphase_diag_samples</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">clphase_diag_sigma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">pt3</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevant cells and flatten</span>
    <span class="n">deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                             <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">deriv</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">deriv</span>


<span class="k">def</span> <span class="nf">chisq_camp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closure Amplitudes (normalized) chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">clamp_samples</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;camp&quot;</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">clamp</span> <span class="o">-</span> <span class="n">clamp_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clamp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_camp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the closure amplitude chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>

    <span class="c1"># sampled visibility and closure amplitudes</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">v3</span> <span class="o">*</span> <span class="n">v4</span><span class="p">))</span>

    <span class="c1"># gradient components</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clamp</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">clamp</span> <span class="o">-</span> <span class="n">clamp_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">clamp_samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pp</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pp</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span><span class="o">/</span><span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt4</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span><span class="o">/</span><span class="n">v4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">pt3</span><span class="p">,</span> <span class="n">pt4</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevant cells and flatten</span>
    <span class="c1"># TODO or is x&lt;--&gt;y??</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                           <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_logcamp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">log_clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closure Amplitudes (normalized) chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s1">&#39;camp&#39;</span><span class="p">))</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">log_clamp</span> <span class="o">-</span> <span class="n">log_clamp_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_logcamp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">log_clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the closure amplitude chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>

    <span class="c1"># sampled visibility and closure amplitudes</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>

    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">v3</span> <span class="o">*</span> <span class="n">v4</span><span class="p">)))</span>

    <span class="c1"># gradient components</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">log_clamp</span> <span class="o">-</span> <span class="n">log_clamp_samples</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">/</span> <span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">/</span> <span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span> <span class="o">/</span> <span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt4</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span> <span class="o">/</span> <span class="n">v4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">pt3</span><span class="p">,</span> <span class="n">pt4</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevant cells and flatten</span>
    <span class="c1"># TODO or is x&lt;--&gt;y??</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                           <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_logcamp_diag_fft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">log_clamp_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalized log closure amplitudes (normalized) chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log_clamp_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">A4</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A4</span>
    <span class="n">vis_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">fft_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A4</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s1">&#39;camp&#39;</span><span class="p">))</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tform_mat</span> <span class="ow">in</span> <span class="n">tform_mats</span><span class="p">:</span>
        <span class="n">log_clamp_samples_here</span> <span class="o">=</span> <span class="n">log_clamp_samples</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>
        <span class="n">log_clamp_diag_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">,</span> <span class="n">log_clamp_samples_here</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)</span>
    <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag_samples</span><span class="p">)</span>

    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">log_clamp_diag</span> <span class="o">-</span> <span class="n">log_clamp_diag_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">/=</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_logcamp_diag_fft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">log_clamp_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the diagonalized log closure amplitude chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log_clamp_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">A4</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A4</span>
    <span class="n">vis_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">fft_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A4</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># sampled visibility and closure amplitudes</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="p">[</span><span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]],</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">v3</span> <span class="o">*</span> <span class="n">v4</span><span class="p">)))</span>

    <span class="c1"># gradient vec stuff</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">log_clamp_samples</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tform_mat</span> <span class="ow">in</span> <span class="n">tform_mats</span><span class="p">:</span>

        <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">,</span> <span class="n">log_clamp_samples</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)])</span>
        <span class="n">log_clamp_diag_measured</span> <span class="o">=</span> <span class="n">log_clamp_diag</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>
        <span class="n">log_clamp_diag_sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp_diag_measured</span><span class="p">)):</span>
            <span class="n">pref</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">tform_mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> \
                <span class="p">(</span><span class="n">log_clamp_diag_measured</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_clamp_diag_samples</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> \
                <span class="p">(</span><span class="n">log_clamp_diag_sigma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pref</span> <span class="o">/</span> <span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pref</span> <span class="o">/</span> <span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="o">-</span><span class="n">pref</span> <span class="o">/</span> <span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt4</span> <span class="o">=</span> <span class="o">-</span><span class="n">pref</span> <span class="o">/</span> <span class="n">v4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">pt1</span><span class="p">,</span> <span class="n">pt2</span><span class="p">,</span> <span class="n">pt3</span><span class="p">,</span> <span class="n">pt4</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevant cells and flatten</span>
    <span class="n">deriv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                             <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>
    <span class="n">deriv</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">deriv</span>


<span class="k">def</span> <span class="nf">chisq_logamp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibility amplitude chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># to lowest order the variance on the logarithm of a quantity x is</span>
    <span class="c1"># sigma^2_log(x) = sigma^2/x^2</span>
    <span class="n">logsigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">amp</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">))</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp_samples</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span><span class="o">/</span><span class="n">logsigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_logamp_fft</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the amplitude chi-kernesquared</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="n">A</span>

    <span class="c1"># samples</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">sampler</span><span class="p">(</span><span class="n">vis_arr</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">sample_type</span><span class="o">=</span><span class="s2">&quot;vis&quot;</span><span class="p">)</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># gradient FT</span>
    <span class="n">logsigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">amp</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">sampler_info_list</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pulsefac</span>
    <span class="n">wdiff_vec</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp_samples</span><span class="p">)))</span> <span class="o">/</span>
                 <span class="p">(</span><span class="n">logsigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">samples</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span> <span class="o">*</span> <span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">wdiff_arr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gridder</span><span class="p">([</span><span class="n">wdiff_vec</span><span class="p">],</span> <span class="n">gridder_info_list</span><span class="p">)</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">wdiff_arr</span><span class="p">)))</span>
    <span class="n">grad_arr</span> <span class="o">=</span> <span class="n">grad_arr</span> <span class="o">*</span> <span class="p">(</span><span class="n">im_info</span><span class="o">.</span><span class="n">npad</span> <span class="o">*</span> <span class="n">im_info</span><span class="o">.</span><span class="n">npad</span><span class="p">)</span>

    <span class="c1"># extract relevent cells and flatten</span>
    <span class="c1"># TODO or is x&lt;--&gt;y??</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">grad_arr</span><span class="p">[</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvalx2</span><span class="p">,</span>
                           <span class="n">im_info</span><span class="o">.</span><span class="n">padvaly1</span><span class="p">:</span><span class="o">-</span><span class="n">im_info</span><span class="o">.</span><span class="n">padvaly2</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="k">return</span> <span class="n">out</span>

<span class="c1">##################################################################################################</span>
<span class="c1"># NFFT Chi-squared and Gradient Functions</span>
<span class="c1">##################################################################################################</span>


<span class="k">def</span> <span class="nf">chisq_vis_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibility chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft object</span>
    <span class="n">nfft_info</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transform</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">samples</span><span class="o">-</span><span class="n">vis</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_vis_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the visibility chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft object</span>
    <span class="n">nfft_info</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transform</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">wdiff_vec</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">vis</span> <span class="o">-</span> <span class="n">samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">wdiff_vec</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">grad</span>


<span class="k">def</span> <span class="nf">chisq_amp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibility amplitude chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get nfft object</span>
    <span class="n">nfft_info</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transform</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">amp_samples</span><span class="o">-</span><span class="n">amp</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_amp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the amplitude chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft object</span>
    <span class="n">nfft_info</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transform</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">wdiff_vec</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">amp</span> <span class="o">-</span> <span class="n">amp_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">samples</span><span class="p">)</span> <span class="o">/</span>
                 <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">amp_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">wdiff_vec</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_bs_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">bis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bispectrum chi-squared from fft&quot;&quot;&quot;</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">bisamples</span> <span class="o">=</span> <span class="n">samples1</span><span class="o">*</span><span class="n">samples2</span><span class="o">*</span><span class="n">samples3</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(((</span><span class="n">bis</span> <span class="o">-</span> <span class="n">bisamples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">bis</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_bs_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">bis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the amplitude chi-squared from the nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">bisamples</span> <span class="o">=</span> <span class="n">v1</span><span class="o">*</span><span class="n">v2</span><span class="o">*</span><span class="n">v3</span>
    <span class="n">wdiff</span> <span class="o">=</span> <span class="o">-</span><span class="mf">1.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">bis</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">bis</span> <span class="o">-</span> <span class="n">bisamples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="p">(</span><span class="n">v2</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="p">(</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v3</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="n">wdiff</span> <span class="o">*</span> <span class="p">(</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt1</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt2</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt3</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">out1</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">+</span> <span class="n">out3</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_cphase_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closure Phases (normalized) chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphase</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">samples1</span><span class="o">*</span><span class="n">samples2</span><span class="o">*</span><span class="n">samples3</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">clphase</span><span class="o">-</span><span class="n">clphase_samples</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_cphase_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the closure phase chi-squared from nfft&quot;&quot;&quot;</span>

    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphase</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">v2</span><span class="o">*</span><span class="n">v3</span><span class="p">)</span>
    <span class="n">pref</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">clphase</span> <span class="o">-</span> <span class="n">clphase_samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt1</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">((</span><span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt2</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">((</span><span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt3</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">((</span><span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">out1</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">+</span> <span class="n">out3</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_cphase_diag_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clphase_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalized closure phases (normalized) chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">A3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">samples1</span><span class="o">*</span><span class="n">samples2</span><span class="o">*</span><span class="n">samples3</span><span class="p">)</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tform_mat</span> <span class="ow">in</span> <span class="n">tform_mats</span><span class="p">:</span>
        <span class="n">clphase_samples_here</span> <span class="o">=</span> <span class="n">clphase_samples</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>
        <span class="n">clphase_diag_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">,</span> <span class="n">clphase_samples_here</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)</span>

    <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag_samples</span><span class="p">)</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">))</span> <span class="o">*</span> \
        <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">clphase_diag</span><span class="o">-</span><span class="n">clphase_diag_samples</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_cphase_diag_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clphase_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the diagonalized closure phase chi-squared from nfft&quot;&quot;&quot;</span>

    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>

    <span class="n">A3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A3</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A3</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="n">clphase_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v1</span><span class="o">*</span><span class="n">v2</span><span class="o">*</span><span class="n">v3</span><span class="p">)</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">clphase_samples</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tform_mat</span> <span class="ow">in</span> <span class="n">tform_mats</span><span class="p">:</span>

        <span class="n">clphase_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">,</span> <span class="n">clphase_samples</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)])</span>
        <span class="n">clphase_diag_measured</span> <span class="o">=</span> <span class="n">clphase_diag</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>
        <span class="n">clphase_diag_sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase_diag_measured</span><span class="p">)):</span>
            <span class="n">pref</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span> <span class="o">+=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">tform_mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span>
                <span class="n">clphase_diag_measured</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">clphase_diag_samples</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">clphase_diag_sigma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="n">pref</span><span class="o">/</span><span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt1</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">((</span><span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt2</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">((</span><span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt3</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">((</span><span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">deriv</span> <span class="o">=</span> <span class="n">out1</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">+</span> <span class="n">out3</span>
    <span class="n">deriv</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">deriv</span>


<span class="k">def</span> <span class="nf">chisq_camp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Closure Amplitudes (normalized) chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info4</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">plan4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples4</span> <span class="o">=</span> <span class="n">plan4</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac4</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">samples1</span><span class="o">*</span><span class="n">samples2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">samples3</span><span class="o">*</span><span class="n">samples4</span><span class="p">))</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">clamp</span> <span class="o">-</span> <span class="n">clamp_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clamp</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_camp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the closure amplitude chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info4</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">plan4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">plan4</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac4</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">v3</span> <span class="o">*</span> <span class="n">v4</span><span class="p">))</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">clamp</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">clamp</span> <span class="o">-</span> <span class="n">clamp_samples</span><span class="p">)</span> <span class="o">*</span> <span class="n">clamp_samples</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pp</span><span class="o">/</span><span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pp</span><span class="o">/</span><span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span><span class="o">/</span><span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt4</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span><span class="o">/</span><span class="n">v4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt1</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt2</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt3</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt4</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">out1</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">+</span> <span class="n">out3</span> <span class="o">+</span> <span class="n">out4</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_logcamp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">log_clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Log Closure Amplitudes (normalized) chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info4</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">plan4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples4</span> <span class="o">=</span> <span class="n">plan4</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac4</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples2</span><span class="p">))</span> <span class="o">-</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples3</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples4</span><span class="p">)))</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">log_clamp</span> <span class="o">-</span> <span class="n">log_clamp_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_logcamp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">log_clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the log closure amplitude chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info4</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">plan4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">plan4</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac4</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">v3</span> <span class="o">*</span> <span class="n">v4</span><span class="p">)))</span>

    <span class="n">pp</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">log_clamp</span> <span class="o">-</span> <span class="n">log_clamp_samples</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">/</span> <span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">/</span> <span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span> <span class="o">/</span> <span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt4</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span> <span class="o">/</span> <span class="n">v4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt1</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt2</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt3</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt4</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">out1</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">+</span> <span class="n">out3</span> <span class="o">+</span> <span class="n">out4</span>
    <span class="k">return</span> <span class="n">out</span>


<span class="k">def</span> <span class="nf">chisq_logcamp_diag_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">log_clamp_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Diagonalized log closure amplitudes (normalized) chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log_clamp_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">A4</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info4</span> <span class="o">=</span> <span class="n">A4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">plan4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples4</span> <span class="o">=</span> <span class="n">plan4</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac4</span>

    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples1</span><span class="p">))</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples2</span><span class="p">))</span> <span class="o">-</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples3</span><span class="p">))</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples4</span><span class="p">)))</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">tform_mat</span> <span class="ow">in</span> <span class="n">tform_mats</span><span class="p">:</span>
        <span class="n">log_clamp_samples_here</span> <span class="o">=</span> <span class="n">log_clamp_samples</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>
        <span class="n">log_clamp_diag_samples</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">,</span> <span class="n">log_clamp_samples_here</span><span class="p">))</span>
        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)</span>

    <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag_samples</span><span class="p">)</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">log_clamp_diag</span> <span class="o">-</span> <span class="n">log_clamp_diag_samples</span><span class="p">)</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> \
        <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_logcamp_diag_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">log_clamp_diag</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the diagonalized log closure amplitude chi-squared from fft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">log_clamp_diag</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>

    <span class="n">A4</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># get nfft objects</span>
    <span class="n">nfft_info1</span> <span class="o">=</span> <span class="n">A4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac1</span> <span class="o">=</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info2</span> <span class="o">=</span> <span class="n">A4</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">plan2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac2</span> <span class="o">=</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info3</span> <span class="o">=</span> <span class="n">A4</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
    <span class="n">plan3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac3</span> <span class="o">=</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="n">nfft_info4</span> <span class="o">=</span> <span class="n">A4</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
    <span class="n">plan4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac4</span> <span class="o">=</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transforms</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">plan1</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac1</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">plan2</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac2</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">plan3</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac3</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">plan4</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac4</span>

    <span class="n">log_clamp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">v1</span> <span class="o">*</span> <span class="n">v2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">v3</span> <span class="o">*</span> <span class="n">v4</span><span class="p">)))</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">pp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">log_clamp_samples</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">tform_mat</span> <span class="ow">in</span> <span class="n">tform_mats</span><span class="p">:</span>

        <span class="n">log_clamp_diag_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">,</span> <span class="n">log_clamp_samples</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)])</span>
        <span class="n">log_clamp_diag_measured</span> <span class="o">=</span> <span class="n">log_clamp_diag</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>
        <span class="n">log_clamp_diag_sigma</span> <span class="o">=</span> <span class="n">sigma</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp_diag_measured</span><span class="p">)):</span>
            <span class="n">pp</span><span class="p">[</span><span class="n">count</span><span class="p">:</span><span class="n">count</span><span class="o">+</span><span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)]</span> <span class="o">+=</span> <span class="o">-</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">tform_mat</span><span class="p">[</span><span class="n">j</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> \
                <span class="p">(</span><span class="n">log_clamp_diag_measured</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">-</span> <span class="n">log_clamp_diag_samples</span><span class="p">[</span><span class="n">j</span><span class="p">])</span> <span class="o">/</span> \
                <span class="p">(</span><span class="n">log_clamp_diag_sigma</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">+=</span> <span class="nb">len</span><span class="p">(</span><span class="n">tform_mat</span><span class="p">)</span>

    <span class="n">pt1</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">/</span> <span class="n">v1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac1</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt2</span> <span class="o">=</span> <span class="n">pp</span> <span class="o">/</span> <span class="n">v2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac2</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt3</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span> <span class="o">/</span> <span class="n">v3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac3</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">pt4</span> <span class="o">=</span> <span class="o">-</span><span class="n">pp</span> <span class="o">/</span> <span class="n">v4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span> <span class="o">*</span> <span class="n">pulsefac4</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>

    <span class="c1"># Setup and perform the inverse FFT</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt1</span>
    <span class="n">plan1</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan1</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info1</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan2</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt2</span>
    <span class="n">plan2</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan2</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info2</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan3</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt3</span>
    <span class="n">plan3</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan3</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info3</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">plan4</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">pt4</span>
    <span class="n">plan4</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan4</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info4</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="n">deriv</span> <span class="o">=</span> <span class="n">out1</span> <span class="o">+</span> <span class="n">out2</span> <span class="o">+</span> <span class="n">out3</span> <span class="o">+</span> <span class="n">out4</span>
    <span class="n">deriv</span> <span class="o">*=</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">log_clamp_diag</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">deriv</span>


<span class="k">def</span> <span class="nf">chisq_logamp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Visibility log amplitude chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft object</span>
    <span class="n">nfft_info</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transform</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac</span>

    <span class="c1"># to lowest order the variance on the logarithm of a quantity x is</span>
    <span class="c1"># sigma^2_log(x) = sigma^2/x^2</span>
    <span class="n">logsigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">amp</span>

    <span class="c1"># compute chi^2</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>
    <span class="n">chisq</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp_samples</span><span class="p">)</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span><span class="o">/</span><span class="n">logsigma</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">chisq</span>


<span class="k">def</span> <span class="nf">chisqgrad_logamp_nfft</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">A</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The gradient of the log amplitude chi-squared from nfft</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get nfft object</span>
    <span class="n">nfft_info</span> <span class="o">=</span> <span class="n">A</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">plan</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">plan</span>
    <span class="n">pulsefac</span> <span class="o">=</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">pulsefac</span>

    <span class="c1"># compute uniform --&gt; nonuniform transform</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span><span class="o">.</span><span class="n">T</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">trafo</span><span class="p">()</span>
    <span class="n">samples</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">*</span><span class="n">pulsefac</span>
    <span class="n">amp_samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">samples</span><span class="p">)</span>

    <span class="c1"># gradient vec for adjoint FT</span>
    <span class="n">logsigma</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="n">amp</span>
    <span class="n">wdiff_vec</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mf">2.0</span><span class="o">/</span><span class="nb">len</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">amp_samples</span><span class="p">)))</span> <span class="o">/</span>
                 <span class="p">(</span><span class="n">logsigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">/</span> <span class="n">samples</span><span class="o">.</span><span class="n">conj</span><span class="p">())</span> <span class="o">*</span> <span class="n">pulsefac</span><span class="o">.</span><span class="n">conj</span><span class="p">()</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">wdiff_vec</span>
    <span class="n">plan</span><span class="o">.</span><span class="n">adjoint</span><span class="p">()</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">((</span><span class="n">plan</span><span class="o">.</span><span class="n">f_hat</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">T</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">xdim</span><span class="o">*</span><span class="n">nfft_info</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">out</span>


<span class="c1">##################################################################################################</span>
<span class="c1"># Regularizer and Gradient Functions</span>
<span class="c1">##################################################################################################</span>

<span class="k">def</span> <span class="nf">sflux</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Total flux constraint</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">-</span> <span class="n">flux</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">sfluxgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Total flux constraint gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">-</span> <span class="n">flux</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span> <span class="o">/</span> <span class="n">norm</span>


<span class="k">def</span> <span class="nf">scm</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Center-of-mass constraint</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">beam_size</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">psize</span><span class="o">*</span><span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">embed_mask</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">psize</span><span class="o">*</span><span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">embed_mask</span><span class="p">]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="o">*</span><span class="n">xx</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">scmgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">embed_mask</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Center-of-mass constraint gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">beam_size</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">nx</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="n">ny</span><span class="o">//</span><span class="mi">2</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">psize</span><span class="o">*</span><span class="n">xx</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">embed_mask</span><span class="p">]</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">psize</span><span class="o">*</span><span class="n">yy</span><span class="o">.</span><span class="n">flatten</span><span class="p">()[</span><span class="n">embed_mask</span><span class="p">]</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="o">*</span><span class="n">xx</span><span class="p">)</span><span class="o">*</span><span class="n">xx</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span><span class="o">*</span><span class="n">yy</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">ssimple</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple entropy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">entropy</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imvec</span><span class="o">/</span><span class="n">priorvec</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">entropy</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">ssimplegrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Simple entropy gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">entropygrad</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imvec</span><span class="o">/</span><span class="n">priorvec</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">entropygrad</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">sl1</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;L1 norm regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># l1 = -np.sum(np.abs(imvec - priorvec))</span>
    <span class="n">l1</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">l1</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">sl1grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;L1 norm gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="c1"># l1grad = -np.sign(imvec - priorvec)</span>
    <span class="n">l1grad</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l1grad</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">sl1w</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">EP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Weighted L1 norm regularizer a la SMILI</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># should be ok?</span>
        <span class="c1"># This is SMILI normalization</span>
        <span class="c1"># norm = np.sum((np.sqrt(priorvec**2 + epsilon) + epsilon)/np.sqrt(priorvec**2 + epsilon))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">num</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">imvec</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">priorvec</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">+</span> <span class="n">epsilon</span>

    <span class="n">l1w</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">num</span><span class="o">/</span><span class="n">denom</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">l1w</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">sl1wgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">EP</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Weighted L1 norm gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>  <span class="c1"># should be ok?</span>
        <span class="c1"># This is SMILI normalization</span>
        <span class="c1"># norm = np.sum((np.sqrt(priorvec**2 + epsilon) + epsilon)/np.sqrt(priorvec**2 + epsilon))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">num</span> <span class="o">=</span> <span class="n">imvec</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">imvec</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">denom</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">priorvec</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span> <span class="o">+</span> <span class="n">epsilon</span>

    <span class="n">l1wgrad</span> <span class="o">=</span> <span class="o">-</span> <span class="n">num</span> <span class="o">/</span> <span class="n">denom</span>
    <span class="k">return</span> <span class="n">l1wgrad</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">fA</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">I_ref</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha_A</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to take imvec to itself in the limit alpha_A -&gt; 0</span>
<span class="sd">       and to a binary representation in the limit alpha_A -&gt; infinity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">alpha_A</span><span class="p">)</span><span class="o">/</span><span class="n">alpha_A</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">alpha_A</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span><span class="o">/</span><span class="n">I_ref</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">fAgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">I_ref</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">alpha_A</span><span class="o">=</span><span class="mf">1.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Function to take imvec to itself in the limit alpha_A -&gt; 0</span>
<span class="sd">       and to a binary representation in the limit alpha_A -&gt; infinity</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">alpha_A</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">I_ref</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">alpha_A</span><span class="o">/</span><span class="mf">2.0</span><span class="o">*</span><span class="n">imvec</span><span class="o">/</span><span class="n">I_ref</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">slA</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha_A</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;l_A regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The appropriate I_ref is something like the total flux divided by the # of pixels per beam</span>
    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="n">I_ref</span> <span class="o">=</span> <span class="n">flux</span>

    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm_l1</span> <span class="o">=</span> <span class="mf">1.0</span>                  <span class="c1"># as alpha_A -&gt;0</span>
        <span class="n">norm_l0</span> <span class="o">=</span> <span class="p">(</span><span class="n">beam_size</span><span class="o">/</span><span class="n">psize</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># as alpha_A -&gt;\infty</span>
        <span class="n">weight_l1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">alpha_A</span><span class="p">)</span>
        <span class="n">weight_l0</span> <span class="o">=</span> <span class="n">alpha_A</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm_l1</span> <span class="o">*</span> <span class="n">weight_l1</span> <span class="o">+</span> <span class="n">norm_l0</span> <span class="o">*</span> <span class="n">weight_l0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">weight_l0</span> <span class="o">+</span> <span class="n">weight_l1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">fA</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">I_ref</span><span class="p">,</span> <span class="n">alpha_A</span><span class="p">))</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">slAgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">alpha_A</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;l_A gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># The appropriate I_ref is something like the total flux divided by the # of pixels per beam</span>
    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="n">I_ref</span> <span class="o">=</span> <span class="n">flux</span>

    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm_l1</span> <span class="o">=</span> <span class="mf">1.0</span>                  <span class="c1"># as alpha_A -&gt;0</span>
        <span class="n">norm_l0</span> <span class="o">=</span> <span class="p">(</span><span class="n">beam_size</span><span class="o">/</span><span class="n">psize</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>  <span class="c1"># as alpha_A -&gt;\infty</span>
        <span class="n">weight_l1</span> <span class="o">=</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">alpha_A</span><span class="p">)</span>
        <span class="n">weight_l0</span> <span class="o">=</span> <span class="n">alpha_A</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">norm_l1</span> <span class="o">*</span> <span class="n">weight_l1</span> <span class="o">+</span> <span class="n">norm_l0</span> <span class="o">*</span> <span class="n">weight_l0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">weight_l0</span> <span class="o">+</span> <span class="n">weight_l1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">fAgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">I_ref</span><span class="p">,</span> <span class="n">alpha_A</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">sgs</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gull-skilling entropy</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">entropy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span> <span class="o">-</span> <span class="n">priorvec</span> <span class="o">-</span> <span class="n">imvec</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imvec</span><span class="o">/</span><span class="n">priorvec</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">entropy</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">sgsgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gull-Skilling gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">entropygrad</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imvec</span><span class="o">/</span><span class="n">priorvec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">entropygrad</span><span class="o">/</span><span class="n">norm</span>

<span class="c1"># TODO: epsilon is 0 by default for backwards compatibilitys</span>
<span class="k">def</span> <span class="nf">stv</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Total variation regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">*</span><span class="n">psize</span> <span class="o">/</span> <span class="n">beam_size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
    <span class="n">impad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">im_l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">im_l1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">im_l2</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>

<span class="c1"># TODO: epsilon is 0 by default for backwards compatibility</span>
<span class="k">def</span> <span class="nf">stvgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">epsilon</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Total variation gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">*</span><span class="n">psize</span> <span class="o">/</span> <span class="n">beam_size</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
    <span class="n">impad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">im_l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># rotate images</span>
    <span class="n">im_r1l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span>  <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_l1r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># add together terms and return</span>
    <span class="n">g1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_l1</span> <span class="o">-</span> <span class="n">im_l2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_l1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_l2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_r1</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_r1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">im_r1l2</span> <span class="o">-</span> <span class="n">im_r1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>
    <span class="n">g3</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_r2</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_r2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">im_l1r2</span> <span class="o">-</span> <span class="n">im_r2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">epsilon</span><span class="p">)</span>

    <span class="c1"># mask the first row column gradient terms that don&#39;t exist</span>
    <span class="n">mask1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mask1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mask2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">g2</span><span class="p">[</span><span class="n">mask1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">g3</span><span class="p">[</span><span class="n">mask2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># add terms together and return</span>
    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">g1</span> <span class="o">+</span> <span class="n">g2</span> <span class="o">+</span> <span class="n">g3</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">stv2</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Squared Total variation regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">psize</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">beam_size</span><span class="o">**</span><span class="mi">4</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
    <span class="n">impad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">im_l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">im_l1</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">im_l2</span> <span class="o">-</span> <span class="n">im</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">stv2grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Squared Total variation gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">psize</span><span class="o">**</span><span class="mi">4</span> <span class="o">*</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">beam_size</span><span class="o">**</span><span class="mi">4</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>
    <span class="n">impad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span> <span class="n">constant_values</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">im_l1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_l2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_r1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">im_r2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">impad</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="n">ny</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">:</span><span class="n">nx</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">g1</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_l1</span> <span class="o">-</span> <span class="n">im_l2</span><span class="p">)</span>
    <span class="n">g2</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_r1</span><span class="p">)</span>
    <span class="n">g3</span> <span class="o">=</span> <span class="p">(</span><span class="n">im</span> <span class="o">-</span> <span class="n">im_r2</span><span class="p">)</span>

    <span class="c1"># mask the first row column gradient terms that don&#39;t exist</span>
    <span class="n">mask1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mask2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">mask1</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">mask2</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">g2</span><span class="p">[</span><span class="n">mask1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">g3</span><span class="p">[</span><span class="n">mask2</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># add together terms and return</span>
    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">g1</span> <span class="o">+</span> <span class="n">g2</span> <span class="o">+</span> <span class="n">g3</span><span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">spatch</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Patch prior regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="mf">0.5</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">imvec</span> <span class="o">-</span> <span class="n">priorvec</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">spatchgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">priorvec</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Patch prior gradient</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="p">(</span><span class="n">imvec</span> <span class="o">-</span> <span class="n">priorvec</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>

<span class="c1"># TODO FIGURE OUT NORMALIZATIONS FOR COMPACT 1 &amp; 2 REGULARIZERS</span>


<span class="k">def</span> <span class="nf">scompact</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;I r^2 source size regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">*</span> <span class="p">(</span><span class="n">beam_size</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">-</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">-</span> <span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">xxpsize</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">psize</span>
    <span class="n">yypsize</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">*</span> <span class="n">psize</span>

    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span> <span class="o">*</span> <span class="n">xxpsize</span><span class="p">))</span><span class="o">/</span><span class="n">flux</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span> <span class="o">*</span> <span class="n">yypsize</span><span class="p">))</span><span class="o">/</span><span class="n">flux</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span> <span class="o">*</span> <span class="p">((</span><span class="n">xxpsize</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yypsize</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">scompactgrad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gradient for I r^2 source size regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span> <span class="o">*</span> <span class="n">beam_size</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">-</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">-</span> <span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">xxpsize</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">psize</span>
    <span class="n">yypsize</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">*</span> <span class="n">psize</span>

    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span> <span class="o">*</span> <span class="n">xxpsize</span><span class="p">))</span><span class="o">/</span><span class="n">flux</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span> <span class="o">*</span> <span class="n">yypsize</span><span class="p">))</span><span class="o">/</span><span class="n">flux</span>

    <span class="n">term1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span> <span class="o">*</span> <span class="p">((</span><span class="n">xxpsize</span> <span class="o">-</span> <span class="n">x0</span><span class="p">))))</span>
    <span class="n">term2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span> <span class="o">*</span> <span class="p">((</span><span class="n">yypsize</span> <span class="o">-</span> <span class="n">y0</span><span class="p">))))</span>

    <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">xxpsize</span><span class="o">*</span><span class="n">term1</span> <span class="o">-</span> <span class="mi">2</span><span class="o">*</span><span class="n">yypsize</span><span class="o">*</span><span class="n">term2</span> <span class="o">+</span> <span class="p">(</span><span class="n">xxpsize</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">yypsize</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">grad</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">scompact2</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;I^2r^2 source size regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">beam_size</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">-</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">-</span> <span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">xxpsize</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">psize</span>
    <span class="n">yypsize</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">*</span> <span class="n">psize</span>

    <span class="n">out</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">xxpsize</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yypsize</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">return</span> <span class="n">out</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">scompact2grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">nx</span><span class="p">,</span> <span class="n">ny</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">norm_reg</span><span class="o">=</span><span class="n">NORM_REGULARIZER</span><span class="p">,</span> <span class="n">beam_size</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gradient for I^2r^2 source size regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">beam_size</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">beam_size</span> <span class="o">=</span> <span class="n">psize</span>
    <span class="k">if</span> <span class="n">norm_reg</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="n">flux</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">beam_size</span><span class="o">**</span><span class="mi">2</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">norm</span> <span class="o">=</span> <span class="mi">1</span>

    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">ny</span><span class="p">,</span> <span class="n">nx</span><span class="p">)</span>

    <span class="n">xx</span><span class="p">,</span> <span class="n">yy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">nx</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ny</span><span class="p">))</span>
    <span class="n">xx</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">-</span> <span class="p">(</span><span class="n">nx</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">-</span> <span class="p">(</span><span class="n">ny</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">xxpsize</span> <span class="o">=</span> <span class="n">xx</span> <span class="o">*</span> <span class="n">psize</span>
    <span class="n">yypsize</span> <span class="o">=</span> <span class="n">yy</span> <span class="o">*</span> <span class="n">psize</span>

    <span class="n">grad</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2</span><span class="o">*</span><span class="n">im</span><span class="o">*</span><span class="p">(</span><span class="n">xxpsize</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">yypsize</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">grad</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="n">norm</span>


<span class="k">def</span> <span class="nf">sgauss</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">PA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gaussian source size regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># major, minor and PA are all in radians</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">PA</span>

    <span class="c1"># eigenvalues of covariance matrix</span>
    <span class="n">lambda1</span> <span class="o">=</span> <span class="n">minor</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
    <span class="n">lambda2</span> <span class="o">=</span> <span class="n">major</span><span class="o">**</span><span class="mf">2.</span><span class="o">/</span><span class="p">(</span><span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>

    <span class="c1"># now compute covariance matrix elements from user inputs</span>
    <span class="n">sigxx_prime</span> <span class="o">=</span> <span class="n">lambda1</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">sigyy_prime</span> <span class="o">=</span> <span class="n">lambda1</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">sigxy_prime</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambda2</span> <span class="o">-</span> <span class="n">lambda1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>

    <span class="c1"># we get the dimensions and image vector</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">)</span>
    <span class="n">xlist</span><span class="p">,</span> <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">xdim</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ydim</span><span class="p">))</span>
    <span class="n">xlist</span> <span class="o">=</span> <span class="n">xlist</span> <span class="o">-</span> <span class="p">(</span><span class="n">xdim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">ylist</span> <span class="o">=</span> <span class="n">ylist</span> <span class="o">-</span> <span class="p">(</span><span class="n">ydim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">xx</span> <span class="o">=</span> <span class="n">xlist</span> <span class="o">*</span> <span class="n">psize</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">ylist</span> <span class="o">*</span> <span class="n">psize</span>

    <span class="c1"># the centroid parameters</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yy</span><span class="o">*</span><span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="c1"># we calculate the elements of the covariance matrix</span>
    <span class="n">sigxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="n">sigyy</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="n">sigxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>

    <span class="c1"># We calculate the regularizer #this line was CHANGED</span>
    <span class="n">rgauss</span> <span class="o">=</span> <span class="o">-</span><span class="p">((</span><span class="n">sigxx</span> <span class="o">-</span> <span class="n">sigxx_prime</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="p">(</span><span class="n">sigyy</span> <span class="o">-</span> <span class="n">sigyy_prime</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">sigxy</span> <span class="o">-</span> <span class="n">sigxy_prime</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="c1"># normalization will need to be redone, right now requires alpha~1000</span>
    <span class="n">rgauss</span> <span class="o">=</span> <span class="n">rgauss</span><span class="o">/</span><span class="p">(</span><span class="n">major</span><span class="o">**</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">minor</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">rgauss</span>


<span class="k">def</span> <span class="nf">sgauss_grad</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">major</span><span class="p">,</span> <span class="n">minor</span><span class="p">,</span> <span class="n">PA</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Gradient for Gaussian source size regularizer</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># major, minor and PA are all in radians</span>
    <span class="n">phi</span> <span class="o">=</span> <span class="n">PA</span>

    <span class="c1"># computing eigenvalues of the covariance matrix</span>
    <span class="n">lambda1</span> <span class="o">=</span> <span class="p">(</span><span class="n">minor</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>
    <span class="n">lambda2</span> <span class="o">=</span> <span class="p">(</span><span class="n">major</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">8.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span>

    <span class="c1"># now compute covariance matrix elements from user inputs</span>

    <span class="n">sigxx_prime</span> <span class="o">=</span> <span class="n">lambda1</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">sigyy_prime</span> <span class="o">=</span> <span class="n">lambda1</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span> <span class="o">+</span> <span class="n">lambda2</span><span class="o">*</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>
    <span class="n">sigxy_prime</span> <span class="o">=</span> <span class="p">(</span><span class="n">lambda2</span> <span class="o">-</span> <span class="n">lambda1</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span>

    <span class="c1"># we get the dimensions and image vector</span>
    <span class="n">im</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">xdim</span><span class="p">,</span> <span class="n">ydim</span><span class="p">)</span>
    <span class="n">xlist</span><span class="p">,</span> <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="n">xdim</span><span class="p">),</span> <span class="nb">range</span><span class="p">(</span><span class="n">ydim</span><span class="p">))</span>
    <span class="n">xlist</span> <span class="o">=</span> <span class="n">xlist</span> <span class="o">-</span> <span class="p">(</span><span class="n">xdim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>
    <span class="n">ylist</span> <span class="o">=</span> <span class="n">ylist</span> <span class="o">-</span> <span class="p">(</span><span class="n">ydim</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span>

    <span class="n">xx</span> <span class="o">=</span> <span class="n">xlist</span> <span class="o">*</span> <span class="n">psize</span>
    <span class="n">yy</span> <span class="o">=</span> <span class="n">ylist</span> <span class="o">*</span> <span class="n">psize</span>

    <span class="c1"># the centroid parameters</span>
    <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">xx</span><span class="o">*</span><span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">yy</span><span class="o">*</span><span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="c1"># we calculate the elements of the covariance matrix of the image</span>
    <span class="n">sigxx</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="n">sigyy</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
    <span class="n">sigxy</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>

    <span class="c1"># now we compute the gradients of all quantities</span>
    <span class="c1"># gradient of centroid</span>
    <span class="n">dx0</span> <span class="o">=</span> <span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>
    <span class="n">dy0</span> <span class="o">=</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="c1"># gradients of covariance matrix elements</span>
    <span class="n">dxx</span> <span class="o">=</span> <span class="p">(((</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">dx0</span><span class="o">*</span><span class="n">im</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigxx</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="n">dyy</span> <span class="o">=</span> <span class="p">(((</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">**</span><span class="mf">2.</span> <span class="o">-</span> <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">dx0</span><span class="o">*</span><span class="n">im</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigyy</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="n">dxy</span> <span class="o">=</span> <span class="p">(((</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span> <span class="o">-</span> <span class="p">(</span><span class="n">yy</span> <span class="o">-</span> <span class="n">y0</span><span class="p">)</span><span class="o">*</span><span class="n">dx0</span><span class="o">*</span><span class="n">im</span> <span class="o">-</span> <span class="p">(</span><span class="n">xx</span> <span class="o">-</span> <span class="n">x0</span><span class="p">)</span><span class="o">*</span><span class="n">dy0</span><span class="o">*</span><span class="n">im</span><span class="p">)</span> <span class="o">-</span> <span class="n">sigxy</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">)</span>

    <span class="c1"># gradient of the regularizer #this line was CHANGED</span>
    <span class="n">drgauss</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">sigxx</span> <span class="o">-</span> <span class="n">sigxx_prime</span><span class="p">)</span><span class="o">*</span><span class="n">dxx</span> <span class="o">+</span>
               <span class="mf">2.</span><span class="o">*</span><span class="p">(</span><span class="n">sigyy</span> <span class="o">-</span> <span class="n">sigyy_prime</span><span class="p">)</span><span class="o">*</span><span class="n">dyy</span> <span class="o">+</span>
               <span class="mf">4.</span><span class="o">*</span><span class="p">(</span><span class="n">sigxy</span> <span class="o">-</span> <span class="n">sigxy_prime</span><span class="p">)</span><span class="o">*</span><span class="n">dxy</span><span class="p">)</span>

    <span class="c1"># normalization will need to be redone, right now requires alpha~1000</span>
    <span class="n">drgauss</span> <span class="o">=</span> <span class="n">drgauss</span><span class="o">/</span><span class="p">(</span><span class="n">major</span><span class="o">**</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">minor</span><span class="o">**</span><span class="mf">2.</span><span class="p">)</span>

    <span class="k">return</span> <span class="o">-</span><span class="n">drgauss</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>


<span class="c1">##################################################################################################</span>
<span class="c1"># Chi^2 Data functions</span>
<span class="c1">##################################################################################################</span>
<span class="k">def</span> <span class="nf">apply_systematic_noise_snrcut</span><span class="p">(</span><span class="n">data_arr</span><span class="p">,</span> <span class="n">systematic_noise</span><span class="p">,</span> <span class="n">snrcut</span><span class="p">,</span> <span class="n">pol</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;apply systematic noise to VISIBILITIES or AMPLITUDES</span>
<span class="sd">       data_arr should have fields &#39;t1&#39;,&#39;t2&#39;,&#39;u&#39;,&#39;v&#39;,&#39;vis&#39;,&#39;amp&#39;,&#39;sigma&#39;</span>

<span class="sd">       returns: (uv, vis, amp, sigma)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">amp_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">etype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">sig_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>

    <span class="n">t1</span> <span class="o">=</span> <span class="n">data_arr</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span>
    <span class="n">t2</span> <span class="o">=</span> <span class="n">data_arr</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="n">data_arr</span><span class="p">[</span><span class="n">etype</span><span class="p">]</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">data_arr</span><span class="p">[</span><span class="n">atype</span><span class="p">]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">data_arr</span><span class="p">[</span><span class="n">vtype</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">amp</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;c16&#39;</span><span class="p">)</span>

    <span class="n">snrmask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">amp</span><span class="o">/</span><span class="n">sigma</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">snrcut</span>

    <span class="k">if</span> <span class="nb">type</span><span class="p">(</span><span class="n">systematic_noise</span><span class="p">)</span> <span class="ow">is</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="n">sys_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">)):</span>
            <span class="k">if</span> <span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">systematic_noise</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">t1sys</span> <span class="o">=</span> <span class="n">systematic_noise</span><span class="p">[</span><span class="n">t1</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t1sys</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">if</span> <span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="ow">in</span> <span class="n">systematic_noise</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">t2sys</span> <span class="o">=</span> <span class="n">systematic_noise</span><span class="p">[</span><span class="n">t2</span><span class="p">[</span><span class="n">i</span><span class="p">]]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t2sys</span> <span class="o">=</span> <span class="mf">0.</span>

            <span class="k">if</span> <span class="n">t1sys</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">t2sys</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">sys_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sys_level</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">t1sys</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t2sys</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">sys_level</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">systematic_noise</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">t1</span><span class="p">))</span>

    <span class="n">mask</span> <span class="o">=</span> <span class="n">sys_level</span> <span class="o">&gt;=</span> <span class="mf">0.</span>
    <span class="n">mask</span> <span class="o">=</span> <span class="n">snrmask</span> <span class="o">*</span> <span class="n">mask</span>

    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">([</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sys_level</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">amp</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">vis</span> <span class="o">=</span> <span class="n">vis</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">amp</span> <span class="o">=</span> <span class="n">amp</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span>
    <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">data_arr</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">data_arr</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))[</span><span class="n">mask</span><span class="p">]</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_vis</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, and fourier matrix for visibilities</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">systematic_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">amp_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">etype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">sig_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">etype</span><span class="p">],</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">)</span>
    <span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">apply_systematic_noise_snrcut</span><span class="p">(</span><span class="n">data_arr</span><span class="p">,</span> <span class="n">systematic_noise</span><span class="p">,</span> <span class="n">snrcut</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># make fourier matrix</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_amp</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, and fourier matrix for visibility amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">systematic_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">amp_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">etype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">sig_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">etype</span><span class="p">],</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed amplitude table in amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span>

    <span class="c1"># apply systematic noise and SNR cut</span>
    <span class="c1"># TODO -- after pre-computed??</span>
    <span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">apply_systematic_noise_snrcut</span><span class="p">(</span><span class="n">data_arr</span><span class="p">,</span> <span class="n">systematic_noise</span><span class="p">,</span> <span class="n">snrcut</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># make fourier matrix</span>
    <span class="n">A</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_bs</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;return the data, sigmas, and fourier matrices for bispectra</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="c1"># systematic_noise = kwargs.get(&#39;systematic_noise&#39;,0.)</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">biarr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">bispectra</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed bispectrum table in cphase chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed bispectrum table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">biarr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">biarr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_tri_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">biarr</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">bi</span> <span class="o">=</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;bispec&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;sigmab&#39;</span><span class="p">]</span>

    <span class="c1"># add systematic noise</span>
    <span class="c1"># sigma = np.linalg.norm([biarr[&#39;sigmab&#39;], systematic_noise*np.abs(biarr[&#39;bispec&#39;])], axis=0)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># make fourier matrices</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
         <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_cphase</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, and fourier matrices for closure phases</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">uv_min</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cp_uv_min&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">systematic_cphase_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_cphase_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_phases</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span>
                                      <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">uv_min</span><span class="o">=</span><span class="n">uv_min</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO precomputed with not Stokes I</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed cphase table in cphase chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed closure phase table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_tri_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clphasearr</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;cphase&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;sigmacp&#39;</span><span class="p">]</span>

    <span class="c1"># add systematic cphase noise (in DEGREES)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">([</span><span class="n">sigma</span><span class="p">,</span> <span class="n">systematic_cphase_noise</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># make fourier matrices</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
          <span class="p">)</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A3</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_cphase_diag</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, and fourier matrices for diagonalized closure phases</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">uv_min</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cp_uv_min&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_phases_diag</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">,</span> <span class="n">uv_min</span><span class="o">=</span><span class="n">uv_min</span><span class="p">)</span>

    <span class="c1"># loop over timestamps</span>
    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">A3_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clphasearr</span><span class="p">):</span>

        <span class="c1"># get diagonalized closure phases and errors</span>
        <span class="n">clphase_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cphase&#39;</span><span class="p">])</span>
        <span class="n">sigma_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sigmacp&#39;</span><span class="p">])</span>

        <span class="c1"># get uv arrays</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="n">u2</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="n">u3</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">v3</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># compute Fourier matrices</span>
        <span class="n">A3</span> <span class="o">=</span> <span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
              <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
              <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
              <span class="p">)</span>
        <span class="n">A3_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A3</span><span class="p">)</span>

        <span class="c1"># get transformation matrix for this timestamp</span>
        <span class="n">tform_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

    <span class="c1"># combine Fourier and transformation matrices into tuple for outputting</span>
    <span class="n">Amatrices</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A3_diag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_diag</span><span class="p">),</span> <span class="n">Amatrices</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_camp</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, and fourier matrices for closure amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>

    <span class="c1"># unpack data &amp; mask low snr points</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_amplitudes</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                        <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;camp&#39;</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed closure amplitude table in closure amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed closure amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clamparr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_quad_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clamparr</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;camp&#39;</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clamp</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;camp&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">]</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># make fourier matrices</span>
    <span class="n">A4</span> <span class="o">=</span> <span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv4</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
          <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A4</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_logcamp</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, and fourier matrices for log closure amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>

    <span class="c1"># unpack data &amp; mask low snr points</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_amplitudes</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                        <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;logcamp&#39;</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed log closure amplitude table in log closure amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed log closure amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clamparr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_quad_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clamparr</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;logcamp&#39;</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clamp</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;camp&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">]</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># make fourier matrices</span>
    <span class="n">A4</span> <span class="o">=</span> <span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
          <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv4</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
          <span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A4</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_logcamp_diag</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, and fourier matrices for diagonalized log closure amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

    <span class="c1"># unpack data &amp; mask low snr points</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_log_amplitudes_diag</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>

    <span class="c1"># loop over timestamps</span>
    <span class="n">clamp_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">A4_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clamparr</span><span class="p">):</span>

        <span class="c1"># get diagonalized log closure amplitudes and errors</span>
        <span class="n">clamp_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;camp&#39;</span><span class="p">])</span>
        <span class="n">sigma_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">])</span>

        <span class="c1"># get uv arrays</span>
        <span class="n">u1</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">v1</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="n">u2</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">v2</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="n">u3</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">v3</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="n">u4</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">v4</span> <span class="o">=</span> <span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>
        <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u4</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v4</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

        <span class="c1"># compute Fourier matrices</span>
        <span class="n">A4</span> <span class="o">=</span> <span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
              <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
              <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">),</span>
              <span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv4</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">mask</span><span class="o">=</span><span class="n">mask</span><span class="p">)</span>
              <span class="p">)</span>
        <span class="n">A4_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">A4</span><span class="p">)</span>

        <span class="c1"># get transformation matrix for this timestamp</span>
        <span class="n">tform_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

    <span class="c1"># combine Fourier and transformation matrices into tuple for outputting</span>
    <span class="n">Amatrices</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">A4_diag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clamp_diag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_diag</span><span class="p">),</span> <span class="n">Amatrices</span><span class="p">)</span>

<span class="c1">##################################################################################################</span>
<span class="c1"># FFT Chi^2 Data functions</span>
<span class="c1">##################################################################################################</span>


<span class="k">def</span> <span class="nf">chisqdata_vis_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, uv points, and FFT info for visibilities</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">systematic_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">conv_func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_func&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_CONV_FUNC_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_INTERP_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">amp_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">etype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">sig_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">etype</span><span class="p">],</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">)</span>
    <span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">apply_systematic_noise_snrcut</span><span class="p">(</span><span class="n">data_arr</span><span class="p">,</span> <span class="n">systematic_noise</span><span class="p">,</span> <span class="n">snrcut</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># prepare image and fft info objects</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">im_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ImInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
    <span class="n">gs_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span>
        <span class="n">im_info</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sampler_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_amp_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, uv points, and FFT info for visibility amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">systematic_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">conv_func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_func&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_CONV_FUNC_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_INTERP_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">amp_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">etype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">sig_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">etype</span><span class="p">],</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed amplitude table in amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span>

    <span class="c1"># apply systematic noise</span>
    <span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">apply_systematic_noise_snrcut</span><span class="p">(</span><span class="n">data_arr</span><span class="p">,</span> <span class="n">systematic_noise</span><span class="p">,</span> <span class="n">snrcut</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># prepare image and fft info objects</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">im_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ImInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
    <span class="n">gs_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span>
                                                 <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sampler_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_bs_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, uv points, and FFT info for bispectra</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="c1"># systematic_noise = kwargs.get(&#39;systematic_noise&#39;,0.)</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">conv_func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_func&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_CONV_FUNC_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_INTERP_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">biarr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">bispectra</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed bispectrum table in cphase chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed bispectrum table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">biarr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">biarr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_tri_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">biarr</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">bi</span> <span class="o">=</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;bispec&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;sigmab&#39;</span><span class="p">]</span>

    <span class="c1"># add systematic noise</span>
    <span class="c1"># sigma = np.linalg.norm([biarr[&#39;sigmab&#39;], systematic_noise*np.abs(biarr[&#39;bispec&#39;])], axis=0)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># prepare image and fft info objects</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">im_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ImInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
    <span class="n">gs_info1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sampler_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_cphase_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, uv points, and FFT info for closure phases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">uv_min</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cp_uv_min&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">systematic_cphase_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_cphase_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">conv_func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_func&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_CONV_FUNC_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_INTERP_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_phases</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span>
                                      <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">uv_min</span><span class="o">=</span><span class="n">uv_min</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO precomputed with not Stokes I</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed cphase table in cphase chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed closure phase table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_tri_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clphasearr</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;cphase&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;sigmacp&#39;</span><span class="p">]</span>

    <span class="c1"># add systematic cphase noise (in DEGREES)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">([</span><span class="n">sigma</span><span class="p">,</span> <span class="n">systematic_cphase_noise</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># prepare image and fft info objects</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">im_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ImInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
    <span class="n">gs_info1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sampler_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_cphase_diag_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, uv points, and FFT info for diagonalized closure phases</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">uv_min</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cp_uv_min&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">conv_func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_func&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_CONV_FUNC_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_INTERP_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_phases_diag</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">,</span> <span class="n">uv_min</span><span class="o">=</span><span class="n">uv_min</span><span class="p">)</span>

    <span class="c1"># loop over timestamps</span>
    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clphasearr</span><span class="p">):</span>

        <span class="c1"># get diagonalized closure phases and errors</span>
        <span class="n">clphase_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cphase&#39;</span><span class="p">])</span>
        <span class="n">sigma_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sigmacp&#39;</span><span class="p">])</span>

        <span class="c1"># get u and v values</span>
        <span class="n">u1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

        <span class="c1"># get transformation matrix for this timestamp</span>
        <span class="n">tform_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

    <span class="c1"># fix formatting of arrays</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u3</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span>

    <span class="c1"># get uv arrays</span>
    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># prepare image and fft info objects</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">im_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ImInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
    <span class="n">gs_info1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sampler_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span><span class="p">)</span>

    <span class="c1"># combine Fourier and transformation matrices into tuple for outputting</span>
    <span class="n">Amatrices</span> <span class="o">=</span> <span class="p">(</span><span class="n">A3</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_diag</span><span class="p">),</span> <span class="n">Amatrices</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_camp_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, uv points, and FFT info for closure amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">conv_func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_func&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_CONV_FUNC_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_INTERP_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_amplitudes</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                        <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;camp&#39;</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed closure amplitude table in closure amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed closure amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clamparr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_quad_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clamparr</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;camp&#39;</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clamp</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;camp&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">]</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># prepare image and fft info objects</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">im_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ImInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
    <span class="n">gs_info1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv4</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sampler_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info4</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info4</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_logcamp_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, uv points, and FFT info for log closure amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">conv_func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_func&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_CONV_FUNC_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_INTERP_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_amplitudes</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                        <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;logcamp&#39;</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed log closure amplitude table in log closure amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed log closure amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clamparr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_quad_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clamparr</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;logcamp&#39;</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clamp</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;camp&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">]</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># prepare image and fft info objects</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">im_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ImInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
    <span class="n">gs_info1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv4</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sampler_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info4</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info4</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span><span class="p">)</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_logcamp_diag_fft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the data, sigmas, uv points, and FFT info for diagonalized log closure amplitudes</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">conv_func</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;conv_func&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_CONV_FUNC_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>
    <span class="n">order</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;order&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_INTERP_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data &amp; mask low snr points</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_log_amplitudes_diag</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                             <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>

    <span class="c1"># loop over timestamps</span>
    <span class="n">clamp_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u4</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clamparr</span><span class="p">):</span>

        <span class="c1"># get diagonalized log closure amplitudes and errors</span>
        <span class="n">clamp_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;camp&#39;</span><span class="p">])</span>
        <span class="n">sigma_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">])</span>

        <span class="c1"># get u and v values</span>
        <span class="n">u1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

        <span class="c1"># get transformation matrix for this timestamp</span>
        <span class="n">tform_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

    <span class="c1"># fix formatting of arrays</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u3</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span>
    <span class="n">u4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u4</span><span class="p">)</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v4</span><span class="p">)</span>

    <span class="c1"># get uv arrays</span>
    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u4</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v4</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># prepare image and fft info objects</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">im_info</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ImInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">)</span>
    <span class="n">gs_info1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv1</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv2</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv3</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>
    <span class="n">gs_info4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">make_gridder_and_sampler_info</span><span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">uv4</span><span class="p">,</span>
                                                  <span class="n">conv_func</span><span class="o">=</span><span class="n">conv_func</span><span class="p">,</span> <span class="n">p_rad</span><span class="o">=</span><span class="n">p_rad</span><span class="p">,</span> <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">)</span>

    <span class="n">sampler_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">gs_info4</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="n">gridder_info_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">gs_info1</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info2</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info3</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">gs_info4</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_info</span><span class="p">,</span> <span class="n">sampler_info_list</span><span class="p">,</span> <span class="n">gridder_info_list</span><span class="p">)</span>

    <span class="c1"># combine Fourier and transformation matrices into tuple for outputting</span>
    <span class="n">Amatrices</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clamp_diag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_diag</span><span class="p">),</span> <span class="n">Amatrices</span><span class="p">)</span>

<span class="c1">##################################################################################################</span>
<span class="c1"># NFFT Chi^2 Data functions</span>
<span class="c1">##################################################################################################</span>


<span class="k">def</span> <span class="nf">chisqdata_vis_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the visibilities, sigmas, uv points, and nfft info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NFFT doesn&#39;t work with odd image dimensions!&quot;</span><span class="p">)</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">systematic_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">amp_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">etype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">sig_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">etype</span><span class="p">],</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">)</span>
    <span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">apply_systematic_noise_snrcut</span><span class="p">(</span><span class="n">data_arr</span><span class="p">,</span> <span class="n">systematic_noise</span><span class="p">,</span> <span class="n">snrcut</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># get NFFT info</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">vis</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_amp_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the amplitudes, sigmas, uv points, and nfft info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NFFT doesn&#39;t work with odd image dimensions!&quot;</span><span class="p">)</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">systematic_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">atype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">amp_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">etype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">sig_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">unpack</span><span class="p">([</span><span class="s1">&#39;t1&#39;</span><span class="p">,</span> <span class="s1">&#39;t2&#39;</span><span class="p">,</span> <span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">,</span> <span class="n">vtype</span><span class="p">,</span> <span class="n">atype</span><span class="p">,</span> <span class="n">etype</span><span class="p">],</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed amplitude table in amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">data_arr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">amp</span>

    <span class="c1"># apply systematic noise</span>
    <span class="p">(</span><span class="n">uv</span><span class="p">,</span> <span class="n">vis</span><span class="p">,</span> <span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">=</span> <span class="n">apply_systematic_noise_snrcut</span><span class="p">(</span><span class="n">data_arr</span><span class="p">,</span> <span class="n">systematic_noise</span><span class="p">,</span> <span class="n">snrcut</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># get NFFT info</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">amp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_bs_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the bispectra, sigmas, uv points, and nfft info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NFFT doesn&#39;t work with odd image dimensions!&quot;</span><span class="p">)</span>

    <span class="c1"># unpack keyword args</span>
    <span class="c1"># systematic_noise = kwargs.get(&#39;systematic_noise&#39;,0.) </span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">biarr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">bispectra</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed bispectrum table in cphase chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed bispectrum table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">biarr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">bispec</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">biarr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_tri_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">biarr</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">bi</span> <span class="o">=</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;bispec&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">biarr</span><span class="p">[</span><span class="s1">&#39;sigmab&#39;</span><span class="p">]</span>

    <span class="c1"># add systematic noise</span>
    <span class="c1"># sigma = np.linalg.norm([biarr[&#39;sigmab&#39;], systematic_noise*np.abs(biarr[&#39;bispec&#39;])], axis=0)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># get NFFT info</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv1</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv2</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv3</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">A3</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">bi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_cphase_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the closure phases, sigmas, uv points, and nfft info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NFFT doesn&#39;t work with odd image dimensions!&quot;</span><span class="p">)</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">uv_min</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cp_uv_min&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">systematic_cphase_noise</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;systematic_cphase_noise&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_phases</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span>
                                      <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">uv_min</span><span class="o">=</span><span class="n">uv_min</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO precomputed with not Stokes I</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed cphase table in cphase chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed closure phase table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">cphase</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_tri_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clphasearr</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clphase</span> <span class="o">=</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;cphase&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clphasearr</span><span class="p">[</span><span class="s1">&#39;sigmacp&#39;</span><span class="p">]</span>

    <span class="c1"># add systematic cphase noise (in DEGREES)</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">([</span><span class="n">sigma</span><span class="p">,</span> <span class="n">systematic_cphase_noise</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># get NFFT info</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv1</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv2</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv3</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">A3</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">clphase</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_cphase_diag_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the diagonalized closure phases, sigmas, uv points, and nfft info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NFFT doesn&#39;t work with odd image dimensions!&quot;</span><span class="p">)</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="n">uv_min</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cp_uv_min&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">clphasearr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_phases_diag</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">,</span> <span class="n">uv_min</span><span class="o">=</span><span class="n">uv_min</span><span class="p">)</span>

    <span class="c1"># loop over timestamps</span>
    <span class="n">clphase_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clphasearr</span><span class="p">):</span>

        <span class="c1"># get diagonalized closure phases and errors</span>
        <span class="n">clphase_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;cphase&#39;</span><span class="p">])</span>
        <span class="n">sigma_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sigmacp&#39;</span><span class="p">])</span>

        <span class="c1"># get u and v values</span>
        <span class="n">u1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

        <span class="c1"># get transformation matrix for this timestamp</span>
        <span class="n">tform_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

    <span class="c1"># fix formatting of arrays</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u3</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span>

    <span class="c1"># get uv arrays</span>
    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># get NFFT info</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv1</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv2</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv3</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">A3</span><span class="p">]</span>

    <span class="c1"># combine Fourier and transformation matrices into tuple for outputting</span>
    <span class="n">Amatrices</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clphase_diag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_diag</span><span class="p">),</span> <span class="n">Amatrices</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_camp_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the closure amplitudes, sigmas, uv points, and nfft info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NFFT doesn&#39;t work with odd image dimensions!&quot;</span><span class="p">)</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_amplitudes</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                        <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;camp&#39;</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed closure amplitude table in closure amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed closure amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">camp</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clamparr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_quad_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clamparr</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;camp&#39;</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clamp</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;camp&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">]</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># get NFFT info</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv1</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv2</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv3</span><span class="p">)</span>
    <span class="n">A4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv4</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">A4</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_logcamp_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the log closure amplitudes, sigmas, uv points, and nfft info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NFFT doesn&#39;t work with odd image dimensions!&quot;</span><span class="p">)</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">weighting</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;weighting&#39;</span><span class="p">,</span> <span class="s1">&#39;natural&#39;</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="ow">or</span> <span class="n">pol</span> <span class="o">!=</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_amplitudes</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span>
                                        <span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;logcamp&#39;</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># TODO -- pre-computed  with not stokes I?</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Using pre-computed log closure amplitude table in log closure amplitude chi^2!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">type</span><span class="p">(</span><span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span><span class="p">)</span> <span class="ow">in</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">recarray</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;pre-computed log closure amplitude table is not a numpy rec array!&quot;</span><span class="p">)</span>
        <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">logcamp</span>
        <span class="c1"># reduce to a minimal set</span>
        <span class="k">if</span> <span class="n">count</span> <span class="o">!=</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
            <span class="n">clamparr</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">reduce_quad_minimal</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">clamparr</span><span class="p">,</span> <span class="n">ctype</span><span class="o">=</span><span class="s1">&#39;logcamp&#39;</span><span class="p">)</span>

    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v1&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v2&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v3&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;u4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;v4&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">clamp</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;camp&#39;</span><span class="p">]</span>
    <span class="n">sigma</span> <span class="o">=</span> <span class="n">clamparr</span><span class="p">[</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">]</span>

    <span class="c1"># data weighting</span>
    <span class="k">if</span> <span class="n">weighting</span> <span class="o">==</span> <span class="s1">&#39;uniform&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">median</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sigma</span><span class="p">))</span>

    <span class="c1"># get NFFT info</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv1</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv2</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv3</span><span class="p">)</span>
    <span class="n">A4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv4</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">A4</span><span class="p">]</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">clamp</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">A</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">chisqdata_logcamp_diag_nfft</span><span class="p">(</span><span class="n">Obsdata</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Return the diagonalized log closure amplitudes, sigmas, uv points, and nfft info</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span> <span class="o">%</span> <span class="mi">2</span> <span class="ow">or</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span> <span class="o">%</span> <span class="mi">2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;NFFT doesn&#39;t work with odd image dimensions!&quot;</span><span class="p">)</span>

    <span class="c1"># unpack keyword args</span>
    <span class="n">maxset</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;maxset&#39;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">maxset</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;max&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">count</span> <span class="o">=</span> <span class="s1">&#39;min&#39;</span>

    <span class="n">snrcut</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;snrcut&#39;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
    <span class="n">debias</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;debias&#39;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
    <span class="n">fft_pad_factor</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;fft_pad_factor&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">FFT_PAD_DEFAULT</span><span class="p">)</span>
    <span class="n">p_rad</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;p_rad&#39;</span><span class="p">,</span> <span class="n">ehc</span><span class="o">.</span><span class="n">GRIDDER_P_RAD_DEFAULT</span><span class="p">)</span>

    <span class="c1"># unpack data &amp; mask low snr points</span>
    <span class="n">vtype</span> <span class="o">=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">vis_poldict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
    <span class="n">clamparr</span> <span class="o">=</span> <span class="n">Obsdata</span><span class="o">.</span><span class="n">c_log_amplitudes_diag</span><span class="p">(</span><span class="n">vtype</span><span class="o">=</span><span class="n">vtype</span><span class="p">,</span> <span class="n">count</span><span class="o">=</span><span class="n">count</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">,</span> <span class="n">snrcut</span><span class="o">=</span><span class="n">snrcut</span><span class="p">)</span>

    <span class="c1"># loop over timestamps</span>
    <span class="n">clamp_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">sigma_diag</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">tform_mats</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">u4</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ic</span><span class="p">,</span> <span class="n">cl</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">clamparr</span><span class="p">):</span>

        <span class="c1"># get diagonalized log closure amplitudes and errors</span>
        <span class="n">clamp_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;camp&#39;</span><span class="p">])</span>
        <span class="n">sigma_diag</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;sigmaca&#39;</span><span class="p">])</span>

        <span class="c1"># get u and v values</span>
        <span class="n">u1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v1</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v2</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v3</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">u4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">2</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>
        <span class="n">v4</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">3</span><span class="p">][:,</span> <span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

        <span class="c1"># get transformation matrix for this timestamp</span>
        <span class="n">tform_mats</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cl</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">))</span>

    <span class="c1"># fix formatting of arrays</span>
    <span class="n">u1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u1</span><span class="p">)</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v1</span><span class="p">)</span>
    <span class="n">u2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u2</span><span class="p">)</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span>
    <span class="n">u3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u3</span><span class="p">)</span>
    <span class="n">v3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v3</span><span class="p">)</span>
    <span class="n">u4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">u4</span><span class="p">)</span>
    <span class="n">v4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">(</span><span class="n">v4</span><span class="p">)</span>

    <span class="c1"># get uv arrays</span>
    <span class="n">uv1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v1</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v2</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv3</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v3</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>
    <span class="n">uv4</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">u4</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">v4</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)))</span>

    <span class="c1"># get NFFT info</span>
    <span class="n">npad</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">fft_pad_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">)))</span>
    <span class="n">A1</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv1</span><span class="p">)</span>
    <span class="n">A2</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv2</span><span class="p">)</span>
    <span class="n">A3</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv3</span><span class="p">)</span>
    <span class="n">A4</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">NFFTInfo</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="n">npad</span><span class="p">,</span> <span class="n">p_rad</span><span class="p">,</span> <span class="n">uv4</span><span class="p">)</span>
    <span class="n">A</span> <span class="o">=</span> <span class="p">[</span><span class="n">A1</span><span class="p">,</span> <span class="n">A2</span><span class="p">,</span> <span class="n">A3</span><span class="p">,</span> <span class="n">A4</span><span class="p">]</span>

    <span class="c1"># combine Fourier and transformation matrices into tuple for outputting</span>
    <span class="n">Amatrices</span> <span class="o">=</span> <span class="p">(</span><span class="n">A</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tform_mats</span><span class="p">))</span>

    <span class="k">return</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">clamp_diag</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sigma_diag</span><span class="p">),</span> <span class="n">Amatrices</span><span class="p">)</span>

<span class="c1">##################################################################################################</span>
<span class="c1"># Restoring ,Embedding, and Plotting Functions</span>
<span class="c1">##################################################################################################</span>


<span class="k">def</span> <span class="nf">plot_i</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">Prior</span><span class="p">,</span> <span class="n">nit</span><span class="p">,</span> <span class="n">chi2_dict</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Plot the total intensity image at each iteration</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">cmap</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;cmap&#39;</span><span class="p">,</span> <span class="s1">&#39;afmhot&#39;</span><span class="p">)</span>
    <span class="n">interpolation</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;interpolation&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">)</span>
    <span class="n">pol</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;pol&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)</span>
    <span class="n">scale</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;scale&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">dynamic_range</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dynamic_range&#39;</span><span class="p">,</span> <span class="mf">1.e5</span><span class="p">)</span>
    <span class="n">gamma</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;dynamic_range&#39;</span><span class="p">,</span> <span class="o">.</span><span class="mi">5</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">pause</span><span class="p">(</span><span class="mf">1.e-6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

    <span class="n">imarr</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping values less than 0&#39;</span><span class="p">)</span>
            <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping values less than 0&#39;</span><span class="p">)</span>
            <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span><span class="o">/</span><span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cmap</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interpolation</span><span class="p">)</span>
    <span class="n">xticks</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">ehc</span><span class="o">.</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
    <span class="n">yticks</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="n">Prior</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">Prior</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="n">ehc</span><span class="o">.</span><span class="n">RADPERAS</span><span class="o">/</span><span class="mf">1e-6</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Relative RA ($\mu$as)&#39;</span><span class="p">)</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Relative Dec ($\mu$as)&#39;</span><span class="p">)</span>
    <span class="n">plotstr</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; : step: </span><span class="si">%i</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="n">nit</span>
    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">chi2_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
        <span class="n">plotstr</span> <span class="o">+=</span> <span class="sa">r</span><span class="s2">&quot;$\chi^2_{</span><span class="si">%s</span><span class="s2">}$: </span><span class="si">%0.2f</span><span class="s2">  &quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">chi2_dict</span><span class="p">[</span><span class="n">key</span><span class="p">])</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="n">plotstr</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">18</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">embed</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">mask</span><span class="p">,</span> <span class="n">clipfloor</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">randomfloor</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Embeds a 1d image array into the size of boolean embed mask</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">mask</span><span class="p">))</span>

    <span class="c1"># Here&#39;s a much faster version than before</span>
    <span class="n">out</span><span class="p">[</span><span class="n">mask</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span> <span class="o">=</span> <span class="n">im</span>

    <span class="c1">#if clipfloor != 0.0:</span>
    <span class="k">if</span> <span class="n">randomfloor</span><span class="p">:</span>  <span class="c1"># prevent total variation gradient singularities</span>
        <span class="n">out</span><span class="p">[(</span><span class="n">mask</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span> <span class="o">=</span> <span class="n">clipfloor</span> <span class="o">*</span> \
            <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">size</span><span class="o">=</span><span class="nb">len</span><span class="p">((</span><span class="n">mask</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()[</span><span class="mi">0</span><span class="p">])))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">out</span><span class="p">[(</span><span class="n">mask</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">nonzero</span><span class="p">()]</span> <span class="o">=</span> <span class="n">clipfloor</span>

    <span class="k">return</span> <span class="n">out</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Andrew Chael.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>