<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ehtim.model &mdash; ehtim 1.2.6 documentation</title>
      <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../_static/doctools.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> ehtim
          </a>
              <div class="version">
                1.2.6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../image.html">Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../array.html">Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../obsdata.html">Obsdata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../movie.html">Movie</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../imager.html">Imager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../calibration.html">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scattering.html">Scattering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../statistics.html">Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../survey.html">Survey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vex.html">Vex</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ehtim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>ehtim.model</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ehtim.model</h1><div class="highlight"><pre>
<span></span><span class="c1"># model.py</span>
<span class="c1"># an interferometric model class</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.special</span> <span class="k">as</span> <span class="nn">sps</span>
<span class="kn">import</span> <span class="nn">scipy.integrate</span> <span class="k">as</span> <span class="nn">integrate</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">interpolate</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="kn">import</span> <span class="nn">ehtim.observing.obs_simulate</span> <span class="k">as</span> <span class="nn">simobs</span>
<span class="kn">import</span> <span class="nn">ehtim.observing.pulses</span>

<span class="kn">from</span> <span class="nn">ehtim.const_def</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">ehtim.observing.obs_helpers</span> <span class="kn">import</span> <span class="o">*</span>
<span class="c1">#from ehtim.modeling.modeling_utils import *</span>

<span class="kn">import</span> <span class="nn">ehtim.image</span> <span class="k">as</span> <span class="nn">image</span>

<span class="kn">from</span> <span class="nn">ehtim.const_def</span> <span class="kn">import</span> <span class="o">*</span>

<span class="n">LINE_THICKNESS</span> <span class="o">=</span> <span class="mi">2</span> <span class="c1"># Thickness of 1D models on the image, in pixels</span>
<span class="n">FOV_DEFAULT</span> <span class="o">=</span> <span class="mf">100.</span><span class="o">*</span><span class="n">RADPERUAS</span>
<span class="n">NPIX_DEFAULT</span> <span class="o">=</span> <span class="mi">256</span>
<span class="n">COMPLEX_BASIS</span> <span class="o">=</span> <span class="s1">&#39;abs-arg&#39;</span> <span class="c1"># Basis for representing (most) complex quantities: &#39;abs-arg&#39; or &#39;re-im&#39;</span>

<span class="c1">###########################################################################################################################################</span>
<span class="c1">#Model object</span>
<span class="c1">###########################################################################################################################################</span>

<div class="viewcode-block" id="model_params"><a class="viewcode-back" href="../../model.html#ehtim.model.model_params">[docs]</a><span class="k">def</span> <span class="nf">model_params</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">model_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the ordered list of model parameters for a specified model type. This order must match that of the gradient function, sample_1model_grad_uv.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;re-im&#39;</span><span class="p">:</span>
        <span class="n">complex_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_re&#39;</span><span class="p">,</span><span class="s1">&#39;_im&#39;</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;abs-arg&#39;</span><span class="p">:</span>
        <span class="n">complex_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_abs&#39;</span><span class="p">,</span><span class="s1">&#39;_arg&#39;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;COMPLEX_BASIS &#39;</span> <span class="o">+</span> <span class="n">COMPLEX_BASIS</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>

    <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Function to add polarimetric parameters; these must be added before stretch parameters</span>
    <span class="k">def</span> <span class="nf">add_pol</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">fit_pol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mring&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">)</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>            
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;betapol&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                    <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;betapol&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">fit_cpol</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">model_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mring&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])):</span>
                    <span class="k">if</span> <span class="n">j</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;betacpol0&#39;</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;betacpol&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;betacpol&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;FWHM&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">,</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">,</span><span class="s1">&#39;PA&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;crescent&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span> <span class="s1">&#39;fr&#39;</span><span class="p">,</span> <span class="s1">&#39;fo&#39;</span><span class="p">,</span> <span class="s1">&#39;ff&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_crescent&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;fr&#39;</span><span class="p">,</span> <span class="s1">&#39;fo&#39;</span><span class="p">,</span> <span class="s1">&#39;ff&#39;</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ring&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_ring&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span><span class="s1">&#39;stretch&#39;</span><span class="p">,</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_ring&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_thick_ring&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">,</span><span class="s1">&#39;stretch&#39;</span><span class="p">,</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;mring&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_mring&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">add_pol</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretch&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>            
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_floor&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;ff&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>            
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">add_pol</span><span class="p">()</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_Gfloor&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;ff&#39;</span><span class="p">,</span><span class="s1">&#39;FWHM&#39;</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>            
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">add_pol</span><span class="p">()</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_thick_mring&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">add_pol</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretch&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_thick_mring_floor&#39;</span><span class="p">:</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">,</span><span class="s1">&#39;ff&#39;</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">add_pol</span><span class="p">()</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretch&#39;</span><span class="p">)</span>
        <span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model &#39;</span> <span class="o">+</span> <span class="n">model_init</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; not recognized.&#39;</span><span class="p">)</span>
        <span class="n">params</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">return</span> <span class="n">params</span></div>

<div class="viewcode-block" id="default_prior"><a class="viewcode-back" href="../../model.html#ehtim.model.default_prior">[docs]</a><span class="k">def</span> <span class="nf">default_prior</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span><span class="n">model_params</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">fit_pol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fit_cpol</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Return the default model prior and transformation for a specified model type</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;re-im&#39;</span><span class="p">:</span>
        <span class="n">complex_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_re&#39;</span><span class="p">,</span><span class="s1">&#39;_im&#39;</span><span class="p">]</span>
        <span class="n">complex_priors</span>  <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">0.5</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">}]</span>
        <span class="n">complex_priors2</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}]</span>
    <span class="k">elif</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;abs-arg&#39;</span><span class="p">:</span>
        <span class="n">complex_labels</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;_abs&#39;</span><span class="p">,</span><span class="s1">&#39;_arg&#39;</span><span class="p">]</span>
        <span class="c1"># Note: angle range here must match np.angle(). Need to properly define wrapped distributions</span>
        <span class="n">complex_priors</span>  <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">0.5</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}]</span> 
        <span class="n">complex_priors2</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}]</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;COMPLEX_BASIS &#39;</span> <span class="o">+</span> <span class="n">COMPLEX_BASIS</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>

    <span class="n">prior</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">},</span> 
             <span class="s1">&#39;x0&#39;</span><span class="p">:{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">},</span> 
             <span class="s1">&#39;y0&#39;</span><span class="p">:{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">}}</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;crescent&#39;</span><span class="p">:</span> 
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_crescent&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ring&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_ring&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_ring&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_thick_ring&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;mring&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_mring&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_floor&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_Gfloor&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_thick_mring&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">}</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_thick_mring_floor&#39;</span><span class="p">:</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mi">1</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])):</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;beta&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;positive&#39;</span><span class="p">,</span><span class="s1">&#39;transform&#39;</span><span class="p">:</span><span class="s1">&#39;log&#39;</span><span class="p">}</span>
        <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;none&#39;</span><span class="p">}</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model not recognized!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">fit_pol</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mring&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">}</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="mf">0.0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>            
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;betapol&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;betapol&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">fit_cpol</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">model_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mring&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
            <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">model_params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])):</span>
                <span class="k">if</span> <span class="n">j</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;betacpol&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;betacpol&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">j</span><span class="p">)</span> <span class="o">+</span> <span class="n">complex_labels</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">complex_priors2</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">prior</span><span class="p">[</span><span class="s1">&#39;betacpol0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;prior_type&#39;</span><span class="p">:</span><span class="s1">&#39;flat&#39;</span><span class="p">,</span><span class="s1">&#39;min&#39;</span><span class="p">:</span><span class="o">-</span><span class="mf">1.0</span><span class="p">,</span><span class="s1">&#39;max&#39;</span><span class="p">:</span><span class="mf">1.0</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">prior</span></div>

<span class="k">def</span> <span class="nf">stretch_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">x_stretch</span> <span class="o">=</span> <span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">])</span>
               <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">y_stretch</span> <span class="o">=</span> <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
               <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">x_stretch</span><span class="p">,</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">y_stretch</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">stretch_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">params</span><span class="p">):</span>
    <span class="n">u_stretch</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">])</span>
               <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="n">v_stretch</span> <span class="o">=</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">))</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">u_stretch</span><span class="p">,</span><span class="n">v_stretch</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">):</span>
    <span class="c1"># Return the scaling factor for models with constant fractional polarization</span>

    <span class="k">if</span> <span class="n">model_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mring&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># mring models have polarization information specified differently than a constant scaling factor</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">])</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">return</span> <span class="mf">0.0</span>

<span class="k">def</span> <span class="nf">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="mf">1.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">):</span>   
    <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">))</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">]:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not implemented!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span> <span class="o">&lt;</span> <span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">:</span>
        <span class="n">sigma</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> 
               <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span>
        <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span>
        <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">])</span> <span class="o">*</span> 
               <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                      <span class="o">-</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]))</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">)</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">:</span>
        <span class="c1"># Note: the exact form of a blurred disk requires numeric integration</span>

        <span class="c1"># This is the peak brightness of the blurred disk</span>
        <span class="n">I_peak</span> <span class="o">=</span> <span class="mf">4.0</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">**</span><span class="p">(</span><span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1"># Constant prefactor</span>
        <span class="n">prefac</span> <span class="o">=</span> <span class="mf">32.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> 

        <span class="k">def</span> <span class="nf">f</span><span class="p">(</span><span class="n">r</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">integrate</span><span class="o">.</span><span class="n">quad</span><span class="p">(</span><span class="k">lambda</span> <span class="n">rp</span><span class="p">:</span> 
                <span class="n">prefac</span> <span class="o">*</span> <span class="n">rp</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="o">-</span><span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">rp</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">r</span> <span class="o">*</span> <span class="n">rp</span><span class="p">)</span> <span class="p">)</span> 
                <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">ive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mf">8.0</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">rp</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">),</span> 
                <span class="mi">0</span><span class="p">,</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span><span class="p">,</span> <span class="n">limit</span><span class="o">=</span><span class="mi">1000</span><span class="p">,</span> <span class="n">epsabs</span><span class="o">=</span><span class="n">I_peak</span><span class="o">/</span><span class="mf">1e9</span><span class="p">,</span> <span class="n">epsrel</span><span class="o">=</span><span class="mf">1.0e-6</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">f</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="c1"># For images, it&#39;s much quicker to do the 1-D problem and interpolate</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">ndim</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">r_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">r_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
            <span class="n">r_list</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">r_min</span><span class="p">,</span> <span class="n">r_max</span><span class="p">,</span> <span class="nb">int</span><span class="p">((</span><span class="n">r_max</span><span class="o">-</span><span class="n">r_min</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="mi">20</span><span class="p">))</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">r_list</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">ravel</span><span class="p">(</span><span class="n">r</span><span class="p">))</span><span class="o">/</span><span class="mi">2</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">r</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">:</span> 
                <span class="n">f</span> <span class="o">=</span> <span class="n">interpolate</span><span class="o">.</span><span class="n">interp1d</span><span class="p">(</span><span class="n">r_list</span><span class="p">,</span> <span class="n">f</span><span class="p">(</span><span class="n">r_list</span><span class="p">),</span> <span class="n">kind</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">f</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;crescent&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">params0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span>   <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>    <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]}</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)}</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span> 
        <span class="n">val</span> <span class="o">-=</span> <span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_crescent&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">params0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span>   <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]}</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)}</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span> 
        <span class="n">val</span> <span class="o">-=</span> <span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ring&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">*</span><span class="n">LINE_THICKNESS</span><span class="p">)</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize</span><span class="o">*</span><span class="n">LINE_THICKNESS</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">psize</span><span class="o">*</span><span class="n">LINE_THICKNESS</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_ring&#39;</span><span class="p">:</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">ive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;mring&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]))</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">*</span><span class="n">LINE_THICKNESS</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">beta_factor</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize</span><span class="o">*</span><span class="n">LINE_THICKNESS</span><span class="o">/</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">+</span> <span class="n">psize</span><span class="o">*</span><span class="n">LINE_THICKNESS</span><span class="o">/</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]))</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">((</span><span class="n">x</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">z</span> <span class="o">=</span> <span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span> <span class="o">*</span> <span class="n">r</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">ive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">ive</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">ive</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">ive</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">phi</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">ive</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">phi</span><span class="p">)</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Note: not all polarizations accounted for yet (need RR, RL, LR, LL; do these by calling for linear combinations of I, Q, U, V)!</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="mf">4.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="p">(</span><span class="n">r</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="mf">4.</span><span class="p">)</span> <span class="o">+</span> <span class="n">z</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">beta_factor</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_floor&#39;</span><span class="p">:</span>
        <span class="n">val</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_Gfloor&#39;</span><span class="p">:</span>
        <span class="n">val</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;stretched&#39;</span><span class="p">:</span>
        <span class="n">params_stretch</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params_stretch</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">/=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">sample_1model_xy</span><span class="p">(</span><span class="o">*</span><span class="n">stretch_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">params</span><span class="p">),</span> <span class="n">model_type</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">params_stretch</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model &#39;</span> <span class="o">+</span> <span class="n">model_type</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">*</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">jonesdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Define the various lists</span>
        <span class="n">fr1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr1&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 1</span>
        <span class="n">fr2</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr2&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 2</span>
        <span class="n">DR1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR1&#39;</span><span class="p">]</span> <span class="c1"># Right leakage term of site 1</span>
        <span class="n">DL1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL1&#39;</span><span class="p">]</span> <span class="c1"># Left leakage term of site 1</span>
        <span class="n">DR2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR2&#39;</span><span class="p">])</span> <span class="c1"># Right leakage term of site 2</span>
        <span class="n">DL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL2&#39;</span><span class="p">])</span> <span class="c1"># Left leakage term of site 2</span>
        <span class="c1"># Sample the model without leakage</span>
        <span class="n">RR</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RR&#39;</span><span class="p">)</span>
        <span class="n">RL</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RL&#39;</span><span class="p">)</span>
        <span class="n">LR</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LR&#39;</span><span class="p">)</span>
        <span class="n">LL</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LL&#39;</span><span class="p">)</span>
        <span class="c1"># Apply the Jones matrices</span>
        <span class="n">RRp</span> <span class="o">=</span> <span class="n">RR</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">))</span>
        <span class="n">RLp</span> <span class="o">=</span> <span class="n">RL</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">))</span>
        <span class="n">LRp</span> <span class="o">=</span> <span class="n">LR</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">))</span>
        <span class="n">LLp</span> <span class="o">=</span> <span class="n">LL</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">))</span>
        <span class="c1"># Return the specified polarization</span>
        <span class="k">if</span>   <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RRp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RLp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">LRp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">LLp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">+</span> <span class="n">LLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">+</span> <span class="n">RLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span><span class="n">j</span><span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">-</span> <span class="n">RLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">-</span> <span class="n">LLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="n">RLp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">sample_1model_uv</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">sample_1model_uv</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">]:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not implemented!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span>
        <span class="n">u_maj</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">v</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span>
        <span class="n">u_min</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">v</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">u_maj</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">u_min</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="c1">#Add a small offset to avoid issues with division by zero</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-10</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="c1">#Add a small offset to avoid issues with division by zero</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-10</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))))</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;crescent&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">params0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span>   <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>    <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]}</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)}</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> 
        <span class="n">val</span> <span class="o">-=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_crescent&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">params0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span>   <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]}</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)}</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> 
        <span class="n">val</span> <span class="o">-=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ring&#39;</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_ring&#39;</span><span class="p">:</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;mring&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
        <span class="c1"># Flip the baseline sign to match eht-imaging conventions</span>
        <span class="n">phi</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
        <span class="c1"># Flip the baseline sign to match eht-imaging conventions</span>
        <span class="n">phi</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">val</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta_factor</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_floor&#39;</span><span class="p">:</span>
        <span class="n">val</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_Gfloor&#39;</span><span class="p">:</span>
        <span class="n">val</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;stretched&#39;</span><span class="p">:</span>
        <span class="n">params_stretch</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>        
        <span class="n">params_stretch</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">params_stretch</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="o">*</span><span class="n">stretch_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">params</span><span class="p">),</span> <span class="n">model_type</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">params_stretch</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> 
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model &#39;</span> <span class="o">+</span> <span class="n">model_type</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">*</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Gradient of the visibility function, (dV/du, dV/dv)</span>
    <span class="c1"># This function makes it convenient to, e.g., compute gradients of stretched images and to compute the model centroid</span>

    <span class="k">if</span> <span class="n">jonesdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Define the various lists</span>
        <span class="n">fr1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr1&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 1</span>
        <span class="n">fr2</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr2&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 2</span>
        <span class="n">DR1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR1&#39;</span><span class="p">]</span> <span class="c1"># Right leakage term of site 1</span>
        <span class="n">DL1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL1&#39;</span><span class="p">]</span> <span class="c1"># Left leakage term of site 1</span>
        <span class="n">DR2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR2&#39;</span><span class="p">])</span> <span class="c1"># Right leakage term of site 2</span>
        <span class="n">DL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL2&#39;</span><span class="p">])</span> <span class="c1"># Left leakage term of site 2</span>
        <span class="c1"># Sample the model without leakage</span>
        <span class="n">RR</span> <span class="o">=</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
        <span class="n">RL</span> <span class="o">=</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RL&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
        <span class="n">LR</span> <span class="o">=</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LR&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
        <span class="n">LL</span> <span class="o">=</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LL&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">u</span><span class="p">))</span>
        <span class="c1"># Apply the Jones matrices</span>
        <span class="n">RRp</span> <span class="o">=</span> <span class="p">(</span><span class="n">RR</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">)))</span>
        <span class="n">RLp</span> <span class="o">=</span> <span class="p">(</span><span class="n">RL</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">)))</span>
        <span class="n">LRp</span> <span class="o">=</span> <span class="p">(</span><span class="n">LR</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">)))</span>
        <span class="n">LLp</span> <span class="o">=</span> <span class="p">(</span><span class="n">LL</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">)))</span>
        <span class="c1"># Return the specified polarization</span>
        <span class="k">if</span>   <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RRp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RLp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">LRp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">LLp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">+</span> <span class="n">LLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">+</span> <span class="n">RLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span><span class="n">j</span><span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">-</span> <span class="n">RLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">-</span> <span class="n">LLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="n">RLp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">]:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not implemented!&#39;</span><span class="p">)</span>

    <span class="n">vis</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span> 
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span><span class="p">])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">:</span> 
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">vis</span><span class="p">])</span>                          
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span> 
        <span class="n">u_maj</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">v</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span>
        <span class="n">u_min</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">v</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u_maj</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u_min</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u_maj</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u_min</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">]))</span> <span class="o">*</span> <span class="n">vis</span><span class="p">])</span>       
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span> 
        <span class="c1"># Take care of the degenerate origin point by a small offset</span>
        <span class="c1">#v += (u==0.)*(v==0.)*1e-10</span>
        <span class="n">uvdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">uvdist</span>
        <span class="n">bessel_deriv</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>  <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">vis</span> 
                            <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">bessel_deriv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                          <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">vis</span> 
                            <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">bessel_deriv</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">:</span> 
        <span class="c1"># Take care of the degenerate origin point by a small offset</span>
        <span class="c1">#u += (u==0.)*(v==0.)*1e-10</span>
        <span class="n">uvdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">uvdist</span>
        <span class="n">blur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">bessel_deriv</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">vis</span> 
                            <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">bessel_deriv</span> <span class="o">*</span> <span class="n">blur</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                         <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">vis</span> 
                            <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">bessel_deriv</span> <span class="o">*</span> <span class="n">blur</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;crescent&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">params0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span>   <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>    <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]}</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)}</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> 
        <span class="n">val</span> <span class="o">-=</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_crescent&#39;</span><span class="p">:</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">params0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span>   <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]}</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)}</span>
        <span class="n">val</span> <span class="o">=</span>  <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> 
        <span class="n">val</span> <span class="o">-=</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ring&#39;</span><span class="p">:</span>
        <span class="c1"># Take care of the degenerate origin point by a small offset</span>
        <span class="n">u</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span>
        <span class="n">uvdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">uvdist</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span> 
                            <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span> 
                            <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_ring&#39;</span><span class="p">:</span>
        <span class="n">uvdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="c1">#Add a small offset to avoid issues with division by zero</span>
        <span class="n">uvdist</span> <span class="o">+=</span> <span class="p">(</span><span class="n">uvdist</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-10</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">uvdist</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">vis</span> 
                        <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
                                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                          <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">vis</span> 
                        <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span>
                                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;mring&#39;</span><span class="p">:</span> 
        <span class="c1"># Take care of the degenerate origin point by a small offset</span>
        <span class="n">u</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
        <span class="c1"># Flip the baseline sign to match eht-imaging conventions</span>
        <span class="n">phi</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">uvdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">dphidu</span> <span class="o">=</span>  <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span> 
        <span class="n">dphidv</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span><span class="o">/</span><span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span> 
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">uvdist</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="n">beta_factor_u</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">beta_factor_v</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beta_factor_u</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">beta_factor_v</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span>
            <span class="n">beta_factor_u</span> <span class="o">=</span> <span class="p">(</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">beta_factor_v</span> <span class="o">=</span> <span class="p">(</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_factor_u</span> <span class="o">=</span> <span class="n">beta_factor_v</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> 
                 <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span> 
                    <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta_factor_u</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                 <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span> 
                    <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta_factor_v</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">:</span>
        <span class="c1"># Take care of the degenerate origin point by a small offset</span>
        <span class="n">u</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
        <span class="c1"># Flip the baseline sign to match eht-imaging conventions</span>
        <span class="n">phi</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">uvdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">dphidu</span> <span class="o">=</span>  <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">dphidv</span> <span class="o">=</span> <span class="o">-</span><span class="n">u</span><span class="o">/</span><span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">uvdist</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="n">beta_factor_u</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">beta_factor_v</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>

        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beta_factor_u</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">beta_factor_v</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span>
            <span class="n">beta_factor_u</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidu</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
            <span class="n">beta_factor_v</span> <span class="o">=</span> <span class="p">(</span><span class="mf">0.0</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="n">dphidv</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                    <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_factor_u</span> <span class="o">=</span> <span class="n">beta_factor_v</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> 
                 <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">u</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">vis</span> 
                    <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta_factor_u</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                 <span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span> <span class="o">*</span> <span class="n">vis</span> 
                    <span class="o">+</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">beta_factor_v</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> <span class="p">])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_floor&#39;</span><span class="p">:</span>
        <span class="n">val</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_Gfloor&#39;</span><span class="p">:</span>
        <span class="n">val</span>  <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">+=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;stretched&#39;</span><span class="p">:</span>
        <span class="c1"># Take care of the degenerate origin point by a small offset</span>
        <span class="n">u</span> <span class="o">+=</span> <span class="p">(</span><span class="n">u</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="p">(</span><span class="n">v</span><span class="o">==</span><span class="mf">0.</span><span class="p">)</span><span class="o">*</span><span class="mf">1e-10</span>
        <span class="n">params_stretch</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>        
        <span class="n">params_stretch</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">params_stretch</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="p">(</span><span class="n">u_stretch</span><span class="p">,</span> <span class="n">v_stretch</span><span class="p">)</span> <span class="o">=</span> <span class="n">stretch_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        
        <span class="c1"># First calculate the gradient of the unshifted but stretched image</span>
        <span class="n">grad0</span> <span class="o">=</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u_stretch</span><span class="p">,</span> <span class="n">v_stretch</span><span class="p">,</span> <span class="n">model_type</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">params_stretch</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span>
        <span class="n">grad</span>  <span class="o">=</span> <span class="n">grad0</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.0</span>
        <span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">])</span>
                  <span class="o">+</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])))</span>
        <span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                  <span class="o">+</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">((</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])))</span>

        <span class="c1"># Add the gradient term from the shift</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u_stretch</span><span class="p">,</span> <span class="n">v_stretch</span><span class="p">,</span> <span class="n">model_type</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">params_stretch</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> 
        <span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vis</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> 
        <span class="n">grad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+=</span> <span class="n">vis</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> 

        <span class="n">val</span> <span class="o">=</span> <span class="n">grad</span>              
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model &#39;</span> <span class="o">+</span> <span class="n">model_type</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="mf">0.0</span>
    <span class="k">return</span> <span class="n">val</span> <span class="o">*</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_1model_grad_leakage_uv_re</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">hand</span><span class="p">,</span> <span class="n">jonesdict</span><span class="p">):</span>
    <span class="c1"># Convenience function to calculate the gradient with respect to the real part of a specified site/hand leakage</span>

    <span class="c1"># Define the various lists</span>
    <span class="n">fr1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr1&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 1</span>
    <span class="n">fr2</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr2&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 2</span>
    <span class="n">DR1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR1&#39;</span><span class="p">]</span> <span class="c1"># Right leakage term of site 1</span>
    <span class="n">DL1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL1&#39;</span><span class="p">]</span> <span class="c1"># Left leakage term of site 1</span>
    <span class="n">DR2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR2&#39;</span><span class="p">])</span> <span class="c1"># Right leakage term of site 2</span>
    <span class="n">DL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL2&#39;</span><span class="p">])</span> <span class="c1"># Left leakage term of site 2</span>
    <span class="c1"># Sample the model without leakage</span>
    <span class="n">RR</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RR&#39;</span><span class="p">)</span>
    <span class="n">RL</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RL&#39;</span><span class="p">)</span>
    <span class="n">LR</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LR&#39;</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LL&#39;</span><span class="p">)</span>

    <span class="c1"># Figure out which terms to include in the gradient</span>
    <span class="n">DR1mask</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">hand</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span>
    <span class="n">DR2mask</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">hand</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span>
    <span class="n">DL1mask</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">hand</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span>
    <span class="n">DL2mask</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">hand</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span>

    <span class="c1"># These are the leakage gradient terms</span>
    <span class="n">RRp</span> <span class="o">=</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DR2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1mask</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">))</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DR2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">))</span>
    <span class="n">RLp</span> <span class="o">=</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1mask</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">))</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DL2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">))</span>
    <span class="n">LRp</span> <span class="o">=</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1mask</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">))</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DR2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">))</span>
    <span class="n">LLp</span> <span class="o">=</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DL2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1mask</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">))</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DL2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">))</span>

    <span class="c1"># Return the specified polarization</span>
    <span class="k">if</span>   <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RRp</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RLp</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">LRp</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">LLp</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">+</span> <span class="n">LLp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">+</span> <span class="n">RLp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span><span class="n">j</span><span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">-</span> <span class="n">RLp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">-</span> <span class="n">LLp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="n">RLp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_1model_grad_leakage_uv_im</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">hand</span><span class="p">,</span> <span class="n">jonesdict</span><span class="p">):</span>
    <span class="c1"># Convenience function to calculate the gradient with respect to the imaginary part of a specified site/hand leakage</span>
    <span class="c1"># The tricky thing here is the conjugation of the second leakage site, flipping the sign of the gradient</span>

    <span class="c1"># Define the various lists</span>
    <span class="n">fr1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr1&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 1</span>
    <span class="n">fr2</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr2&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 2</span>
    <span class="n">DR1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR1&#39;</span><span class="p">]</span> <span class="c1"># Right leakage term of site 1</span>
    <span class="n">DL1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL1&#39;</span><span class="p">]</span> <span class="c1"># Left leakage term of site 1</span>
    <span class="n">DR2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR2&#39;</span><span class="p">])</span> <span class="c1"># Right leakage term of site 2</span>
    <span class="n">DL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL2&#39;</span><span class="p">])</span> <span class="c1"># Left leakage term of site 2</span>
    <span class="c1"># Sample the model without leakage</span>
    <span class="n">RR</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RR&#39;</span><span class="p">)</span>
    <span class="n">RL</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RL&#39;</span><span class="p">)</span>
    <span class="n">LR</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LR&#39;</span><span class="p">)</span>
    <span class="n">LL</span> <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LL&#39;</span><span class="p">)</span>

    <span class="c1"># Figure out which terms to include in the gradient</span>
    <span class="n">DR1mask</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">hand</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span>
    <span class="n">DR2mask</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">hand</span> <span class="o">==</span> <span class="s1">&#39;R&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span>
    <span class="n">DL1mask</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">hand</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;t1&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span>
    <span class="n">DL2mask</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">+</span> <span class="p">(</span><span class="n">hand</span> <span class="o">==</span> <span class="s1">&#39;L&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;t2&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="n">site</span><span class="p">)</span>

    <span class="c1"># These are the leakage gradient terms</span>
    <span class="n">RRp</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">-</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DR2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1mask</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">))</span> <span class="o">-</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DR2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">)))</span>
    <span class="n">RLp</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">-</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1mask</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">))</span> <span class="o">-</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DL2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">)))</span>
    <span class="n">LRp</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">-</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1mask</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">))</span> <span class="o">-</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DR2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">)))</span>
    <span class="n">LLp</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="o">-</span><span class="n">LR</span> <span class="o">*</span> <span class="n">DL2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1mask</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">))</span> <span class="o">-</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DL2mask</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">)))</span>

    <span class="c1"># Return the specified polarization</span>
    <span class="k">if</span>   <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RRp</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">RLp</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">LRp</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="k">return</span> <span class="n">LLp</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">+</span> <span class="n">LLp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">+</span> <span class="n">RLp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span><span class="n">j</span><span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">-</span> <span class="n">RLp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">-</span> <span class="n">LLp</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>  <span class="k">return</span> <span class="n">RLp</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Gradient of the model for each model parameter </span>

    <span class="k">if</span> <span class="n">jonesdict</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Define the various lists</span>
        <span class="n">fr1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr1&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 1</span>
        <span class="n">fr2</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;fr2&#39;</span><span class="p">]</span> <span class="c1"># Field rotation of site 2</span>
        <span class="n">DR1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR1&#39;</span><span class="p">]</span> <span class="c1"># Right leakage term of site 1</span>
        <span class="n">DL1</span> <span class="o">=</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL1&#39;</span><span class="p">]</span> <span class="c1"># Left leakage term of site 1</span>
        <span class="n">DR2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DR2&#39;</span><span class="p">])</span> <span class="c1"># Right leakage term of site 2</span>
        <span class="n">DL2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;DL2&#39;</span><span class="p">])</span> <span class="c1"># Left leakage term of site 2</span>
        <span class="c1"># Sample the gradients without leakage</span>
        <span class="n">RR</span> <span class="o">=</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RR&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
        <span class="n">RL</span> <span class="o">=</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RL&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
        <span class="n">LR</span> <span class="o">=</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
        <span class="n">LL</span> <span class="o">=</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LL&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
        <span class="c1"># Apply the Jones matrices</span>
        <span class="n">RRp</span> <span class="o">=</span> <span class="p">(</span><span class="n">RR</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">)))</span>
        <span class="n">RLp</span> <span class="o">=</span> <span class="p">(</span><span class="n">RL</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DR1</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">)))</span>
        <span class="n">LRp</span> <span class="o">=</span> <span class="p">(</span><span class="n">LR</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">LL</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DR2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">+</span><span class="n">fr2</span><span class="p">)))</span>
        <span class="n">LLp</span> <span class="o">=</span> <span class="p">(</span><span class="n">LL</span> <span class="o">+</span> <span class="n">LR</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr2</span><span class="p">)</span> <span class="o">+</span> <span class="n">RL</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="n">fr1</span><span class="p">)</span> <span class="o">+</span> <span class="n">RR</span> <span class="o">*</span> <span class="n">DL1</span> <span class="o">*</span> <span class="n">DL2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="n">j</span><span class="o">*</span><span class="p">(</span><span class="n">fr1</span><span class="o">-</span><span class="n">fr2</span><span class="p">)))</span>
        <span class="c1"># Return the specified polarization</span>
        <span class="k">if</span>   <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">RRp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">RLp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">LRp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="n">grad</span> <span class="o">=</span> <span class="n">LLp</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>  <span class="n">grad</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">+</span> <span class="n">LLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>  <span class="n">grad</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">+</span> <span class="n">RLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>  <span class="n">grad</span> <span class="o">=</span> <span class="mf">0.5</span><span class="n">j</span><span class="o">*</span> <span class="p">(</span><span class="n">LRp</span> <span class="o">-</span> <span class="n">RLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>  <span class="n">grad</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">RRp</span> <span class="o">-</span> <span class="n">LLp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">:</span>  <span class="n">grad</span> <span class="o">=</span> <span class="n">RLp</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>
        <span class="c1"># If necessary, add the gradient components from the leakage terms</span>
        <span class="c1"># Each leakage term has two corresponding gradient terms: d/dRe and d/dIm. </span>
        <span class="k">if</span> <span class="n">fit_leakage</span><span class="p">:</span>
            <span class="c1"># &#39;leakage_fit&#39; is a list of tuples [site, &#39;R&#39; or &#39;L&#39;] denoting the fitted leakage terms</span>
            <span class="k">for</span> <span class="p">(</span><span class="n">site</span><span class="p">,</span> <span class="n">hand</span><span class="p">)</span> <span class="ow">in</span> <span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;leakage_fit&#39;</span><span class="p">]:</span>
                <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">grad</span><span class="p">,</span> <span class="n">sample_1model_grad_leakage_uv_re</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">hand</span><span class="p">,</span> <span class="n">jonesdict</span><span class="p">),</span> <span class="n">sample_1model_grad_leakage_uv_im</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">,</span> <span class="n">site</span><span class="p">,</span> <span class="n">hand</span><span class="p">,</span> <span class="n">jonesdict</span><span class="p">)])</span>

        <span class="k">return</span> <span class="n">grad</span>

    <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
        <span class="k">return</span>   <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="o">-</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="o">-</span><span class="n">u</span><span class="p">,</span> <span class="o">-</span><span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;P&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)))</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">]:</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span> <span class="o">+</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span> <span class="o">-</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Polarization &#39;</span> <span class="o">+</span> <span class="n">pol</span> <span class="o">+</span> <span class="s1">&#39; not implemented!&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span> <span class="c1"># F0, x0, y0</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                 <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                 <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">:</span> <span class="c1"># F0, FWHM, x0, y0</span>
        <span class="n">gauss</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">gauss</span><span class="p">,</span>
                         <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">gauss</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">gauss</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">gauss</span><span class="p">])</span>                          
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span> <span class="c1"># F0, FWHM_maj, FWHM_min, PA, x0, y0</span>
        <span class="n">u_maj</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">v</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span>
        <span class="n">u_min</span> <span class="o">=</span> <span class="n">u</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="n">v</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;PA&#39;</span><span class="p">])</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="p">((</span><span class="n">u_maj</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">u_min</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                         <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u_maj</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                         <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">u_min</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                         <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">u_maj</span> <span class="o">*</span> <span class="n">u_min</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vis</span><span class="p">])</span>    
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span> <span class="c1"># F0, d, x0, y0</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="c1">#Add a small offset to avoid issues with division by zero</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-10</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                         <span class="o">-</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> <span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vis</span><span class="p">])</span> 
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">:</span> <span class="c1"># F0, d, alpha, x0, y0</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="c1">#Add a small offset to avoid issues with division by zero</span>
        <span class="n">z</span> <span class="o">+=</span> <span class="p">(</span><span class="n">z</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1e-10</span>
        <span class="n">blur</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">*</span> <span class="n">blur</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                         <span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="mf">2.0</span><span class="o">/</span><span class="n">z</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">blur</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span>
                         <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vis</span><span class="p">])</span>  
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;crescent&#39;</span><span class="p">:</span> <span class="c1">#[&#39;F0&#39;,&#39;d&#39;, &#39;fr&#39;, &#39;fo&#39;, &#39;phi&#39;,&#39;x0&#39;,&#39;y0&#39;]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span> 
        <span class="n">fr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">params0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span>   <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span>    <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]}</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)}</span>

        <span class="n">grad0</span> <span class="o">=</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="n">fit_leakage</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
        <span class="n">grad1</span> <span class="o">=</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;disk&#39;</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="n">fit_leakage</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>

        <span class="c1"># Add the derivatives one by one</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># F0</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">grad0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">grad1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>

        <span class="c1"># d</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">fr</span><span class="o">*</span><span class="n">grad1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fr</span><span class="p">)</span> <span class="o">*</span> <span class="n">fo</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>  <span class="p">)</span>

        <span class="c1"># fr</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">grad1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">fo</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span> 

        <span class="c1"># fo</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span> 

        <span class="c1"># ff</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> 

        <span class="c1"># phi</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span> <span class="p">)</span> 

        <span class="c1"># x0, y0</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> 
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span> 

        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;blurred_crescent&#39;</span><span class="p">:</span> <span class="c1">#[&#39;F0&#39;,&#39;d&#39;,&#39;alpha&#39;,&#39;fr&#39;, &#39;fo&#39;, &#39;phi&#39;,&#39;x0&#39;,&#39;y0&#39;]</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;phi&#39;</span><span class="p">]</span>
        <span class="n">fr</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fr&#39;</span><span class="p">]</span>
        <span class="n">fo</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;fo&#39;</span><span class="p">]</span>
        <span class="n">ff</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span>
        <span class="n">r</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">2.</span>
        <span class="n">params0</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span>   <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">],</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">],</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]}</span>
        <span class="n">params1</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">],</span> <span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">],</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">),</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)}</span>

        <span class="n">grad0</span> <span class="o">=</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params0</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="n">fit_leakage</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
        <span class="n">grad1</span> <span class="o">=</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params1</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="n">fit_leakage</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>

        <span class="c1"># Add the derivatives one by one</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># F0</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mf">1.0</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">grad0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">*</span><span class="n">grad1</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="p">)</span>

        <span class="c1"># d</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">fr</span><span class="o">*</span><span class="n">grad1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">fr</span><span class="p">)</span> <span class="o">*</span> <span class="n">fo</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>  <span class="p">)</span>

        <span class="c1"># alpha</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="p">)</span> 

        <span class="c1"># fr</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">grad1</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="n">r</span> <span class="o">*</span> <span class="n">fo</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span> 

        <span class="c1"># fo</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="o">-</span><span class="n">r</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span> 

        <span class="c1"># ff</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="o">-</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">ff</span><span class="p">)</span><span class="o">*</span><span class="n">fr</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="p">)</span> 

        <span class="c1"># phi</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="o">-</span><span class="n">r</span><span class="o">*</span><span class="p">(</span><span class="mi">1</span><span class="o">-</span><span class="n">fr</span><span class="p">)</span><span class="o">*</span><span class="n">fo</span><span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">phi</span><span class="p">)</span> <span class="o">*</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span> <span class="p">)</span> 

        <span class="c1"># x0, y0</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="p">)</span> 
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">grad0</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad1</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="p">)</span> 

        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ring&#39;</span><span class="p">:</span> <span class="c1"># F0, d, x0, y0</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span> 
                <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span> 
                 <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])),</span> 
                 <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))])</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_ring&#39;</span><span class="p">:</span> <span class="c1"># F0, d, alpha, x0, y0</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
               <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                         <span class="o">-</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
                            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
                            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))),</span>
                         <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span>
                          <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vis</span><span class="p">])</span>    
    <span class="k">elif</span> <span class="n">model_type</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;mring&#39;</span><span class="p">,</span><span class="s1">&#39;thick_mring&#39;</span><span class="p">]:</span> <span class="c1"># F0, d, [alpha], x0, y0, beta1_re/abs, beta1_im/arg, beta2_re/abs, beta2_im/arg, ...</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">v</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span><span class="o">*</span><span class="n">u</span><span class="p">)</span>
        <span class="c1"># Flip the baseline sign to match eht-imaging conventions</span>
        <span class="n">phi</span> <span class="o">+=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">uvdist</span> <span class="o">=</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;d&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">uvdist</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">:</span>
            <span class="n">alpha_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">4.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha_factor</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Only one of the beta_lists will affect the measurement and have non-zero gradients. Figure out which:</span>
        <span class="c1"># These are for the derivatives wrt diameter</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> 
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>  <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span>  <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span> <span class="o">+</span> <span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>  <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span>  <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">)],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">uvdist</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span> 
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">]</span>          <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>  <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span>  <span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
               <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span> <span class="o">*</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="o">-</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="o">-</span><span class="n">m</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span> <span class="n">z</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">uvdist</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">]))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">beta_factor</span> <span class="o">=</span> <span class="mf">0.0</span>
            
        <span class="n">vis</span>  <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="p">[</span> <span class="mf">1.0</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span><span class="p">,</span> 
                 <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha_factor</span> <span class="o">*</span> <span class="n">beta_factor</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))]</span>
        <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">:</span>
            <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">))</span> <span class="o">*</span> <span class="n">uvdist</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">vis</span><span class="p">)</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">vis</span><span class="p">)</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">pol</span><span class="o">==</span><span class="s1">&#39;I&#39;</span><span class="p">:</span>
            <span class="c1"># Add derivatives of the beta terms </span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">])</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">beta_grad_re</span> <span class="o">=</span>      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha_factor</span> <span class="o">*</span> <span class="p">(</span>
                   <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="o">+</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> 
                   <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
                <span class="n">beta_grad_im</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha_factor</span> <span class="o">*</span> <span class="p">(</span>
                   <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> 
                   <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
                <span class="k">if</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;re-im&#39;</span><span class="p">:</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_re</span><span class="p">)</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_im</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;abs-arg&#39;</span><span class="p">:</span>
                    <span class="n">beta_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">beta_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_re</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_grad_im</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">))</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">beta_abs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta_grad_re</span> <span class="o">+</span> <span class="n">beta_abs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta_grad_im</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;COMPLEX_BASIS &#39;</span> <span class="o">+</span> <span class="n">COMPLEX_BASIS</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="p">[</span><span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list&#39;</span><span class="p">]))]</span>

        <span class="k">if</span> <span class="n">pol</span><span class="o">==</span><span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="n">fit_pol</span><span class="p">:</span>
            <span class="c1"># Add derivatives of the beta_pol terms </span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">,(</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">):</span>
                <span class="n">beta_grad_re</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha_factor</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span> 
                <span class="n">beta_grad_im</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">beta_grad_re</span>
                <span class="k">if</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;re-im&#39;</span><span class="p">:</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_re</span><span class="p">)</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_im</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;abs-arg&#39;</span><span class="p">:</span>
                    <span class="n">beta_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">+</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">beta_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">][</span><span class="n">m</span><span class="o">+</span><span class="p">(</span><span class="n">num_coeff</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">//</span><span class="mi">2</span><span class="p">])</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_re</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_grad_im</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">))</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">beta_abs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta_grad_re</span> <span class="o">+</span> <span class="n">beta_abs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta_grad_im</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;COMPLEX_BASIS &#39;</span> <span class="o">+</span> <span class="n">COMPLEX_BASIS</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">!=</span><span class="s1">&#39;P&#39;</span> <span class="ow">and</span> <span class="n">fit_pol</span><span class="p">:</span>
            <span class="p">[</span><span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">]))]</span>

        <span class="k">if</span> <span class="n">pol</span><span class="o">==</span><span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="n">fit_cpol</span><span class="p">:</span>
            <span class="c1"># Add derivatives of the beta_cpol terms </span>
            <span class="n">num_coeff</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span> <span class="o">-</span> <span class="mi">1</span>
            
            <span class="c1"># First do the beta0 mode (real)</span>
            <span class="n">beta_grad_re</span> <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha_factor</span> <span class="o">*</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="mi">0</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span>  
            <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_re</span><span class="p">)</span>

            <span class="c1"># Now do the remaining modes (complex)</span>
            <span class="k">for</span> <span class="n">m</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">num_coeff</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
                <span class="n">beta_grad_re</span> <span class="o">=</span>      <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha_factor</span> <span class="o">*</span> <span class="p">(</span>
                   <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="o">+</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> 
                   <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
                <span class="n">beta_grad_im</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">alpha_factor</span> <span class="o">*</span> <span class="p">(</span>
                   <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span> <span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> <span class="o">-</span> <span class="n">sps</span><span class="o">.</span><span class="n">jv</span><span class="p">(</span><span class="o">-</span><span class="n">m</span><span class="p">,</span> <span class="n">z</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">m</span> <span class="o">*</span> <span class="p">(</span><span class="n">phi</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span><span class="p">))</span> 
                   <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span> 
                <span class="k">if</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;re-im&#39;</span><span class="p">:</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_re</span><span class="p">)</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_im</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">COMPLEX_BASIS</span> <span class="o">==</span> <span class="s1">&#39;abs-arg&#39;</span><span class="p">:</span>
                    <span class="n">beta_abs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span>
                    <span class="n">beta_arg</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">][</span><span class="n">m</span><span class="p">])</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">beta_grad_re</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">+</span> <span class="n">beta_grad_im</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">))</span>
                    <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="o">-</span><span class="n">beta_abs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta_grad_re</span> <span class="o">+</span> <span class="n">beta_abs</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beta_arg</span><span class="p">)</span> <span class="o">*</span> <span class="n">beta_grad_im</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;COMPLEX_BASIS &#39;</span> <span class="o">+</span> <span class="n">COMPLEX_BASIS</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">!=</span><span class="s1">&#39;V&#39;</span> <span class="ow">and</span> <span class="n">fit_cpol</span><span class="p">:</span>
            <span class="p">[</span><span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">grad</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">)]</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_floor&#39;</span><span class="p">:</span> <span class="c1"># F0, d, [alpha], ff, x0, y0, beta1_re/abs, beta1_im/arg, beta2_re/abs, beta2_im/arg, ...</span>
        <span class="c1"># We need to stich together the two gradients for the mring and the disk; we also need to add the gradient for the floor fraction ff</span>
        <span class="n">grad_mring</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
        <span class="n">grad_disk</span>  <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;blurred_disk&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>

        <span class="c1"># mring: F0, d, alpha, x0, y0, beta1_re/abs, beta1_im/arg, beta2_re/abs, beta2_im/arg, ...</span>
        <span class="c1"># disk:  F0, d, alpha, x0, y0</span>

        <span class="c1"># Here are derivatives for F0, d, and alpha</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
            <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">+</span> <span class="n">grad_disk</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="c1"># Here is the derivative for ff</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad_disk</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad_mring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]))</span> <span class="p">)</span>

        <span class="c1"># Now the derivatives for x0 and y0</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">grad_disk</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">grad_disk</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span>

        <span class="c1"># Add remaining gradients for the mring</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">)):</span>
            <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;thick_mring_Gfloor&#39;</span><span class="p">:</span> <span class="c1"># F0, d, [alpha], ff, FWHM, x0, y0, beta1_re/abs, beta1_im/arg, beta2_re/abs, beta2_im/arg, ...</span>
        <span class="c1"># We need to stich together the two gradients for the mring and the gaussian; we also need to add the gradient for the floor fraction ff</span>
        <span class="n">grad_mring</span> <span class="o">=</span> <span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;thick_mring&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
        <span class="n">grad_gauss</span>  <span class="o">=</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>

        <span class="c1"># mring: F0, d, alpha, x0, y0, beta1_re/abs, beta1_im/arg, beta2_re/abs, beta2_im/arg, ...</span>
        <span class="c1"># gauss: F0, [d, alpha] FWHM, x0, y0</span>

        <span class="n">grad</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">grad_gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="c1"># Here are derivatives for F0 </span>

        <span class="c1"># Here are derivatives for d, and alpha </span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="c1"># Here is the derivative for ff</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;F0&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">grad_gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="n">grad_mring</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="p">(</span><span class="mf">1.0</span> <span class="o">-</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;ff&#39;</span><span class="p">]))</span> <span class="p">)</span>

        <span class="c1"># Now the derivatives for FWHM</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_gauss</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

        <span class="c1"># Now the derivatives for x0 and y0</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">+</span> <span class="n">grad_gauss</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span> <span class="o">+</span> <span class="n">grad_gauss</span><span class="p">[</span><span class="mi">3</span><span class="p">])</span>

        <span class="c1"># Add remaining gradients for the mring</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">,</span><span class="nb">len</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">)):</span>
            <span class="n">grad</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">grad_mring</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">grad</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">model_type</span><span class="p">[:</span><span class="mi">9</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;stretched&#39;</span><span class="p">:</span>
        <span class="c1"># Start with the model visibility</span>
        <span class="n">vis</span>  <span class="o">=</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>

        <span class="c1"># Next, calculate the gradient wrt model parameters other than stretch and stretch_PA</span>
        <span class="c1"># These are the same as the gradient of the unstretched model on stretched baselines</span>
        <span class="n">params_stretch</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">params_stretch</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="n">params_stretch</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        <span class="p">(</span><span class="n">u_stretch</span><span class="p">,</span> <span class="n">v_stretch</span><span class="p">)</span> <span class="o">=</span> <span class="n">stretch_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span><span class="n">v</span><span class="p">,</span><span class="n">params</span><span class="p">)</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="p">(</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u_stretch</span><span class="p">,</span> <span class="n">v_stretch</span><span class="p">,</span> <span class="n">model_type</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">params_stretch</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span>
                <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">])))</span>

        <span class="c1"># Add the gradient terms for the centroid</span>
        <span class="n">grad</span><span class="p">[</span><span class="n">model_params</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;x0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">u</span> <span class="o">*</span> <span class="n">vis</span>
        <span class="n">grad</span><span class="p">[</span><span class="n">model_params</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">)</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;y0&#39;</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">v</span> <span class="o">*</span> <span class="n">vis</span>

        <span class="c1"># Now calculate the gradient with respect to stretch and stretch PA</span>
        <span class="n">grad_uv</span> <span class="o">=</span> <span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u_stretch</span><span class="p">,</span> <span class="n">v_stretch</span><span class="p">,</span> <span class="n">model_type</span><span class="p">[</span><span class="mi">10</span><span class="p">:],</span> <span class="n">params_stretch</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span>
        <span class="n">grad_stretch</span> <span class="o">=</span> <span class="n">grad_uv</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">*</span> <span class="mf">0.0</span> 
        <span class="n">grad_stretch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">grad_uv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]))</span>
                          <span class="o">+</span> <span class="n">grad_uv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])))</span>
        <span class="n">grad_stretch</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span>

        <span class="n">grad_stretch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span> <span class="n">grad_uv</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span> <span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">]))</span>
                          <span class="o">+</span> <span class="n">grad_uv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch&#39;</span><span class="p">]</span> <span class="o">-</span> <span class="mf">1.0</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="o">-</span><span class="n">v</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="n">u</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">])))</span>
        <span class="n">grad_stretch</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="p">(</span><span class="n">u</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;x0&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="n">v</span> <span class="o">*</span> <span class="n">params</span><span class="p">[</span><span class="s1">&#39;y0&#39;</span><span class="p">]))</span>

        <span class="n">val</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grad</span><span class="p">,</span> <span class="n">grad_stretch</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Model &#39;</span> <span class="o">+</span> <span class="n">model_type</span> <span class="o">+</span> <span class="s1">&#39; not recognized!&#39;</span><span class="p">)</span>
        <span class="n">val</span> <span class="o">=</span> <span class="mf">0.0</span>

    <span class="n">grad</span> <span class="o">=</span> <span class="n">val</span> <span class="o">*</span> <span class="n">get_const_polfac</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">fit_pol</span> <span class="ow">or</span> <span class="n">fit_cpol</span><span class="p">)</span> <span class="ow">and</span> <span class="n">model_type</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s1">&#39;mring&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="c1"># Add gradient contributions for models that have constant polarization</span>
        <span class="k">if</span> <span class="n">fit_pol</span><span class="p">:</span>
            <span class="c1"># Add gradient wrt pol_frac if the polarization is P, otherwise ignore</span>
            <span class="n">grad_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">grad_params</span><span class="p">[</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">grad</span><span class="p">,</span> <span class="p">(</span><span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">grad_params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)])</span>

            <span class="c1"># Add gradient wrt pol_evpa if the polarization is P, otherwise ignore</span>
            <span class="n">grad_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">grad_params</span><span class="p">[</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">]</span> <span class="o">*=</span> <span class="mi">2</span><span class="n">j</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">grad</span><span class="p">,</span> <span class="p">(</span><span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;P&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">grad_params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)])</span>
        <span class="k">if</span> <span class="n">fit_cpol</span><span class="p">:</span>
            <span class="c1"># Add gradient wrt cpol_frac</span>
            <span class="n">grad_params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">params</span><span class="p">)</span>
            <span class="n">grad_params</span><span class="p">[</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
            <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span><span class="n">grad</span><span class="p">,</span> <span class="p">(</span><span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">)</span> <span class="o">*</span> <span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">model_type</span><span class="p">,</span> <span class="n">grad_params</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)])</span>

    <span class="k">return</span> <span class="n">grad</span>

<span class="k">def</span> <span class="nf">sample_model_xy</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="mf">1.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sample_1model_xy</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span><span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">sample_model_uv</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">sample_1model_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">)))</span>

<span class="k">def</span> <span class="nf">sample_model_graduv_uv</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Gradient of a sum of models wrt (u,v)</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">sample_1model_graduv_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">sample_model_grad_uv</span><span class="p">(</span><span class="n">models</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># Gradient of a sum of models for each parameter</span>
    <span class="k">if</span> <span class="n">fit_leakage</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="n">fit_leakage</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Need to sum the leakage contributions</span>
        <span class="n">allgrad</span> <span class="o">=</span> <span class="p">[</span><span class="n">sample_1model_grad_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="n">fit_leakage</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))]</span>
        <span class="n">n_leakage</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">jonesdict</span><span class="p">[</span><span class="s1">&#39;leakage_fit&#39;</span><span class="p">])</span><span class="o">*</span><span class="mi">2</span>
        <span class="n">grad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">allgrad</span><span class="p">[</span><span class="n">j</span><span class="p">][:</span><span class="o">-</span><span class="n">n_leakage</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))])</span>
        <span class="n">grad_leakage</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">allgrad</span><span class="p">[</span><span class="n">j</span><span class="p">][</span><span class="o">-</span><span class="n">n_leakage</span><span class="p">:]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">models</span><span class="p">))],</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">grad</span><span class="p">,</span> <span class="n">grad_leakage</span><span class="p">])</span>

<div class="viewcode-block" id="blur_circ_1model"><a class="viewcode-back" href="../../model.html#ehtim.model.blur_circ_1model">[docs]</a><span class="k">def</span> <span class="nf">blur_circ_1model</span><span class="p">(</span><span class="n">model_type</span><span class="p">,</span> <span class="n">params</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Blur a single model, returning new model type and associated parameters</span>

<span class="sd">       Args:</span>
<span class="sd">            fwhm (float) : Full width at half maximum of the kernel (radians)</span>

<span class="sd">       Returns:</span>
<span class="sd">            (dict) : Dictionary with new &#39;model_type&#39; and new &#39;params&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">model_type_blur</span> <span class="o">=</span> <span class="n">model_type</span>
    <span class="n">params_blur</span> <span class="o">=</span> <span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;point&#39;</span><span class="p">:</span>
        <span class="n">model_type_blur</span> <span class="o">=</span> <span class="s1">&#39;circ_gauss&#39;</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;circ_gauss&#39;</span><span class="p">:</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;FWHM&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fwhm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;gauss&#39;</span><span class="p">:</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fwhm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fwhm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="k">elif</span> <span class="s1">&#39;thick&#39;</span> <span class="ow">in</span> <span class="n">model_type</span> <span class="ow">or</span> <span class="s1">&#39;blurred&#39;</span> <span class="ow">in</span> <span class="n">model_type</span><span class="p">:</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">fwhm</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;disk&#39;</span><span class="p">:</span>
        <span class="n">model_type_blur</span> <span class="o">=</span> <span class="s1">&#39;blurred_&#39;</span> <span class="o">+</span> <span class="n">model_type</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;crescent&#39;</span><span class="p">:</span>
        <span class="n">model_type_blur</span> <span class="o">=</span> <span class="s1">&#39;blurred_&#39;</span> <span class="o">+</span> <span class="n">model_type</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;ring&#39;</span> <span class="ow">or</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;mring&#39;</span><span class="p">:</span>
        <span class="n">model_type_blur</span> <span class="o">=</span> <span class="s1">&#39;thick_&#39;</span> <span class="o">+</span> <span class="n">model_type</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm</span>
    <span class="k">elif</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_ring&#39;</span> <span class="ow">or</span> <span class="n">model_type</span> <span class="o">==</span> <span class="s1">&#39;stretched_mring&#39;</span><span class="p">:</span>
        <span class="n">model_type_blur</span> <span class="o">=</span> <span class="s1">&#39;stretched_thick_&#39;</span> <span class="o">+</span> <span class="n">model_type</span><span class="p">[</span><span class="mi">10</span><span class="p">:]</span>
        <span class="n">params_blur</span><span class="p">[</span><span class="s1">&#39;alpha&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fwhm</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;A blurred &quot;</span> <span class="o">+</span> <span class="n">model_type</span> <span class="o">+</span> <span class="s2">&quot; is not yet a supported model!&quot;</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="p">{</span><span class="s1">&#39;model_type&#39;</span><span class="p">:</span><span class="n">model_type_blur</span><span class="p">,</span> <span class="s1">&#39;params&#39;</span><span class="p">:</span><span class="n">params_blur</span><span class="p">}</span></div>

<div class="viewcode-block" id="Model"><a class="viewcode-back" href="../../model.html#ehtim.model.Model">[docs]</a><span class="k">class</span> <span class="nc">Model</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;A model with analytic representations in the image and visibility domains.</span>

<span class="sd">       Attributes:</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ra</span><span class="o">=</span><span class="n">RA_DEFAULT</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="n">DEC_DEFAULT</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">polrep</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                       <span class="n">rf</span><span class="o">=</span><span class="n">RF_DEFAULT</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">SOURCE_DEFAULT</span><span class="p">,</span>
                       <span class="n">mjd</span><span class="o">=</span><span class="n">MJD_DEFAULT</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;A model with analytic representations in the image and visibility domains.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># The model is a sum of component models, each defined by a tag and associated parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span> <span class="o">=</span>  <span class="s1">&#39;I&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span>   <span class="o">=</span> <span class="s1">&#39;stokes&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:{</span><span class="s1">&#39;models&#39;</span><span class="p">:[],</span><span class="s1">&#39;params&#39;</span><span class="p">:[]},</span><span class="s1">&#39;Q&#39;</span><span class="p">:{</span><span class="s1">&#39;models&#39;</span><span class="p">:[],</span><span class="s1">&#39;params&#39;</span><span class="p">:[]},</span><span class="s1">&#39;U&#39;</span><span class="p">:{</span><span class="s1">&#39;models&#39;</span><span class="p">:[],</span><span class="s1">&#39;params&#39;</span><span class="p">:[]},</span><span class="s1">&#39;V&#39;</span><span class="p">:{</span><span class="s1">&#39;models&#39;</span><span class="p">:[],</span><span class="s1">&#39;params&#39;</span><span class="p">:[]}}</span>

        <span class="c1"># Save the image metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span>  <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">time</span> <span class="o">%</span> <span class="mi">24</span><span class="p">)</span><span class="o">/</span><span class="mi">24</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span> <span class="o">%</span> <span class="mi">24</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">][</span><span class="s1">&#39;models&#39;</span><span class="p">]</span>

    <span class="nd">@models</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">][</span><span class="s1">&#39;models&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model_list</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>

    <span class="nd">@params</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">params</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">param_list</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">][</span><span class="s1">&#39;params&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_list</span>

<div class="viewcode-block" id="Model.copy"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a copy of the Model object.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Model): copy of the Model.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">ra</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">,</span><span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span><span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span><span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span><span class="n">time</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">copy</span><span class="p">())</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.switch_polrep"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.switch_polrep">[docs]</a>    <span class="k">def</span> <span class="nf">switch_polrep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polrep_out</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim_out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new model with the polarization representation changed</span>
<span class="sd">           Args:</span>
<span class="sd">               polrep_out (str):  the polrep of the output data</span>
<span class="sd">               pol_prim_out (str): The default image: I,Q,U or V for Stokes, RR,LL,LR,RL for circ</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Model): new Model object with potentially different polrep</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Note: this currently does nothing, but it is put here for compatibility with functions such as selfcal</span>
        <span class="k">if</span> <span class="n">polrep_out</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span><span class="s1">&#39;circ&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;polrep_out must be either &#39;stokes&#39; or &#39;circ&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pol_prim_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">polrep_out</span><span class="o">==</span><span class="s1">&#39;stokes&#39;</span><span class="p">:</span> <span class="n">pol_prim_out</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">elif</span> <span class="n">polrep_out</span><span class="o">==</span><span class="s1">&#39;circ&#39;</span><span class="p">:</span> <span class="n">pol_prim_out</span> <span class="o">=</span> <span class="s1">&#39;RR&#39;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span></div>

<div class="viewcode-block" id="Model.N_models"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.N_models">[docs]</a>    <span class="k">def</span> <span class="nf">N_models</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the number of model components</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (int): number of model components</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.total_flux"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.total_flux">[docs]</a>    <span class="k">def</span> <span class="nf">total_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return the total flux of the model in Jy.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : model total flux (Jy)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span></div>

<div class="viewcode-block" id="Model.blur_circ"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.blur_circ">[docs]</a>    <span class="k">def</span> <span class="nf">blur_circ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Return a new model, equal to the current one convolved with a circular Gaussian kernel</span>

<span class="sd">           Args:</span>
<span class="sd">                fwhm (float) : Full width at half maximum of the kernel (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model) : Blurred model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="p">)):</span>
            <span class="n">blur_model</span> <span class="o">=</span> <span class="n">blur_circ_1model</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">],</span> <span class="n">fwhm</span><span class="p">)</span>
            <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">blur_model</span><span class="p">[</span><span class="s1">&#39;model_type&#39;</span><span class="p">]</span>
            <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">blur_model</span><span class="p">[</span><span class="s1">&#39;params&#39;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_point"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_point">[docs]</a>    <span class="k">def</span> <span class="nf">add_point</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a point source model.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the point source (Jy)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;point&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_circ_gauss"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_circ_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">add_circ_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a circular Gaussian model.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the Gaussian (Jy)</span>
<span class="sd">               FWHM (float): The FWHM of the Gaussian (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;circ_gauss&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;FWHM&#39;</span><span class="p">:</span><span class="n">FWHM</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_gauss"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">add_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">FWHM_maj</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">FWHM_min</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">PA</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add an anisotropic Gaussian model.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the Gaussian (Jy)</span>
<span class="sd">               FWHM_maj (float): The FWHM of the Gaussian major axis (radians)</span>
<span class="sd">               FWHM_min (float): The FWHM of the Gaussian minor axis (radians)</span>
<span class="sd">               PA (float): Position angle of the major axis, east of north (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;gauss&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;FWHM_maj&#39;</span><span class="p">:</span><span class="n">FWHM_maj</span><span class="p">,</span><span class="s1">&#39;FWHM_min&#39;</span><span class="p">:</span><span class="n">FWHM_min</span><span class="p">,</span><span class="s1">&#39;PA&#39;</span><span class="p">:</span><span class="n">PA</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_disk"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_disk">[docs]</a>    <span class="k">def</span> <span class="nf">add_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a circular disk model.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the disk (Jy)</span>
<span class="sd">               d (float): The diameter (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;disk&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_blurred_disk"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_blurred_disk">[docs]</a>    <span class="k">def</span> <span class="nf">add_blurred_disk</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a circular disk model that is blurred with a circular Gaussian kernel.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the disk (Jy)</span>
<span class="sd">               d (float): The diameter (radians)</span>
<span class="sd">               alpha (float): The blurring (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;blurred_disk&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_crescent"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_crescent">[docs]</a>    <span class="k">def</span> <span class="nf">add_crescent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">fo</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ff</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a crescent model.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the disk (Jy)</span>
<span class="sd">               d (float): The diameter (radians)</span>
<span class="sd">               fr (float): Fractional radius of the inner subtracted disk with respect to the radius of the outer disk</span>
<span class="sd">               fo (float): Fractional offset of the inner disk from the center of the outer disk</span>
<span class="sd">               ff (float): Fractional brightness of the inner disk</span>
<span class="sd">               phi (float): angle of offset of the inner disk</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;crescent&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;fr&#39;</span><span class="p">:</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;fo&#39;</span><span class="p">:</span><span class="n">fo</span><span class="p">,</span> <span class="s1">&#39;ff&#39;</span><span class="p">:</span><span class="n">ff</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">:</span><span class="n">phi</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span> <span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span> <span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span> <span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_blurred_crescent"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_blurred_crescent">[docs]</a>    <span class="k">def</span> <span class="nf">add_blurred_crescent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">fr</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">fo</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">ff</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">phi</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a circular disk model that is blurred with a circular Gaussian kernel.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the disk (Jy)</span>
<span class="sd">               d (float): The diameter (radians)</span>
<span class="sd">               alpha (float) :The blurring (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               fr (float): Fractional radius of the inner subtracted disk with respect to the radius of the outer disk</span>
<span class="sd">               fo (float): Fractional offset of the inner disk from the center of the outer disk</span>
<span class="sd">               ff (float): Fractional brightness of the inner disk</span>
<span class="sd">               phi (float): angle of offset of the inner disk</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;blurred_crescent&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span> <span class="s1">&#39;fr&#39;</span><span class="p">:</span><span class="n">fr</span><span class="p">,</span> <span class="s1">&#39;fo&#39;</span><span class="p">:</span><span class="n">fo</span><span class="p">,</span> <span class="s1">&#39;ff&#39;</span><span class="p">:</span><span class="n">ff</span><span class="p">,</span> <span class="s1">&#39;phi&#39;</span><span class="p">:</span><span class="n">phi</span><span class="p">,</span> <span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span> <span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span> <span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span> <span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span> <span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_ring"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_ring">[docs]</a>    <span class="k">def</span> <span class="nf">add_ring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with infinitesimal thickness.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy)</span>
<span class="sd">               d (float): The diameter (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;ring&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_stretched_ring"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_stretched_ring">[docs]</a>    <span class="k">def</span> <span class="nf">add_stretched_ring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">stretch</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">stretch_PA</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a stretched ring model with infinitesimal thickness.</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy)</span>
<span class="sd">               d (float): The diameter (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               stretch (float): The stretch to apply (1.0 = no stretch)</span>
<span class="sd">               stretch_PA (float): Position angle of the stretch, east of north (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretched_ring&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;stretch&#39;</span><span class="p">:</span><span class="n">stretch</span><span class="p">,</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">:</span><span class="n">stretch_PA</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_thick_ring"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_thick_ring">[docs]</a>    <span class="k">def</span> <span class="nf">add_thick_ring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with finite thickness, determined by circular Gaussian convolution of a thin ring.</span>
<span class="sd">           For details, see Appendix G of https://iopscience.iop.org/article/10.3847/2041-8213/ab0e85/pdf</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy)</span>
<span class="sd">               d (float): The ring diameter (radians)</span>
<span class="sd">               alpha (float): The ring thickness (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;thick_ring&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_stretched_thick_ring"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_stretched_thick_ring">[docs]</a>    <span class="k">def</span> <span class="nf">add_stretched_thick_ring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">stretch</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">stretch_PA</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">pol_evpa</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">cpol_frac</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with finite thickness, determined by circular Gaussian convolution of a thin ring.</span>
<span class="sd">           For details, see Appendix G of https://iopscience.iop.org/article/10.3847/2041-8213/ab0e85/pdf</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy)</span>
<span class="sd">               d (float): The ring diameter (radians)</span>
<span class="sd">               alpha (float): The ring thickness (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               stretch (float): The stretch to apply (1.0 = no stretch)</span>
<span class="sd">               stretch_PA (float): Position angle of the stretch, east of north (radians)</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretched_thick_ring&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;stretch&#39;</span><span class="p">:</span><span class="n">stretch</span><span class="p">,</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">:</span><span class="n">stretch_PA</span><span class="p">,</span><span class="s1">&#39;pol_frac&#39;</span><span class="p">:</span><span class="n">pol_frac</span><span class="p">,</span><span class="s1">&#39;pol_evpa&#39;</span><span class="p">:</span><span class="n">pol_evpa</span><span class="p">,</span><span class="s1">&#39;cpol_frac&#39;</span><span class="p">:</span><span class="n">cpol_frac</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_mring"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_mring">[docs]</a>    <span class="k">def</span> <span class="nf">add_mring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with azimuthal brightness variations determined by a Fourier mode expansion.</span>
<span class="sd">           For details, see Eq. 18-20 of https://arxiv.org/abs/1907.04329</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy), which is also beta_0.</span>
<span class="sd">               d (float): The diameter (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               beta_list (list): List of complex Fourier coefficients, [beta_1, beta_2, ...]. </span>
<span class="sd">                                 Negative indices are determined by the condition beta_{-m} = beta_m*.</span>
<span class="sd">                                 Indices are all scaled by F0 = beta_0, so they are dimensionless. </span>
<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_cpol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;mring&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;beta_list&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_pol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_cpol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_stretched_mring"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_stretched_mring">[docs]</a>    <span class="k">def</span> <span class="nf">add_stretched_mring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stretch</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">stretch_PA</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a stretched ring model with azimuthal brightness variations determined by a Fourier mode expansion.</span>
<span class="sd">           For details, see Eq. 18-20 of https://arxiv.org/abs/1907.04329</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy), which is also beta_0.</span>
<span class="sd">               d (float): The diameter (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               beta_list (list): List of complex Fourier coefficients, [beta_1, beta_2, ...]. </span>
<span class="sd">                                 Negative indices are determined by the condition beta_{-m} = beta_m*.</span>
<span class="sd">                                 Indices are all scaled by F0 = beta_0, so they are dimensionless. </span>
<span class="sd">               stretch (float): The stretch to apply (1.0 = no stretch)</span>
<span class="sd">               stretch_PA (float): Position angle of the stretch, east of north (radians)</span>
<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_cpol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretched_mring&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;beta_list&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_pol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_cpol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;stretch&#39;</span><span class="p">:</span><span class="n">stretch</span><span class="p">,</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">:</span><span class="n">stretch_PA</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_thick_mring"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_thick_mring">[docs]</a>    <span class="k">def</span> <span class="nf">add_thick_mring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with azimuthal brightness variations determined by a Fourier mode expansion and thickness determined by circular Gaussian convolution.</span>
<span class="sd">           For details, see Eq. 18-20 of https://arxiv.org/abs/1907.04329</span>
<span class="sd">           The Gaussian convolution calculation is a trivial generalization of Appendix G of https://iopscience.iop.org/article/10.3847/2041-8213/ab0e85/pdf</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy), which is also beta_0.</span>
<span class="sd">               d (float): The ring diameter (radians)</span>
<span class="sd">               alpha (float): The ring thickness (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               beta_list (list): List of complex Fourier coefficients, [beta_1, beta_2, ...]. </span>
<span class="sd">                                 Negative indices are determined by the condition beta_{-m} = beta_m*.</span>
<span class="sd">                                 Indices are all scaled by F0 = beta_0, so they are dimensionless. </span>
<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_cpol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;thick_mring&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;beta_list&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_pol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_cpol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_thick_mring_floor"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_thick_mring_floor">[docs]</a>    <span class="k">def</span> <span class="nf">add_thick_mring_floor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">ff</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with azimuthal brightness variations determined by a Fourier mode expansion, thickness determined by circular Gaussian convolution, and a floor</span>
<span class="sd">           The floor is a blurred disk, with diameter d and blurred FWHM alpha</span>
<span class="sd">           For details, see Eq. 18-20 of https://arxiv.org/abs/1907.04329</span>
<span class="sd">           The Gaussian convolution calculation is a trivial generalization of Appendix G of https://iopscience.iop.org/article/10.3847/2041-8213/ab0e85/pdf</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy), which is also beta_0.</span>
<span class="sd">               d (float): The ring diameter (radians)</span>
<span class="sd">               alpha (float): The ring thickness (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               ff (float): The fraction of the total flux in the floor</span>
<span class="sd">               beta_list (list): List of complex Fourier coefficients, [beta_1, beta_2, ...]. </span>
<span class="sd">                                 Negative indices are determined by the condition beta_{-m} = beta_m*.</span>
<span class="sd">                                 Indices are all scaled by F0 = beta_0, so they are dimensionless. </span>
<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_cpol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;thick_mring_floor&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;beta_list&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_pol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_cpol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;ff&#39;</span><span class="p">:</span><span class="n">ff</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_thick_mring_Gfloor"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_thick_mring_Gfloor">[docs]</a>    <span class="k">def</span> <span class="nf">add_thick_mring_Gfloor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">ff</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">FWHM</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with azimuthal brightness variations determined by a Fourier mode expansion, thickness determined by circular Gaussian convolution, and a floor</span>
<span class="sd">           The floor is a circular Gaussian, with size FWHM</span>
<span class="sd">           For details, see Eq. 18-20 of https://arxiv.org/abs/1907.04329</span>
<span class="sd">           The Gaussian convolution calculation is a trivial generalization of Appendix G of https://iopscience.iop.org/article/10.3847/2041-8213/ab0e85/pdf</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the model</span>
<span class="sd">               d (float): The ring diameter (radians)</span>
<span class="sd">               alpha (float): The ring thickness (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               FWHM (float): The Gaussian FWHM</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               ff (float): The fraction of the total flux in the floor</span>
<span class="sd">               beta_list (list): List of complex Fourier coefficients, [beta_1, beta_2, ...]. </span>
<span class="sd">                                 Negative indices are determined by the condition beta_{-m} = beta_m*.</span>
<span class="sd">                                 Indices are all scaled by F0 = beta_0, so they are dimensionless. </span>
<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_cpol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;thick_mring_Gfloor&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;beta_list&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_pol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_cpol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;ff&#39;</span><span class="p">:</span><span class="n">ff</span><span class="p">,</span><span class="s1">&#39;FWHM&#39;</span><span class="p">:</span><span class="n">FWHM</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_stretched_thick_mring"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_stretched_thick_mring">[docs]</a>    <span class="k">def</span> <span class="nf">add_stretched_thick_mring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stretch</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">stretch_PA</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with azimuthal brightness variations determined by a Fourier mode expansion and thickness determined by circular Gaussian convolution.</span>
<span class="sd">           For details, see Eq. 18-20 of https://arxiv.org/abs/1907.04329</span>
<span class="sd">           The Gaussian convolution calculation is a trivial generalization of Appendix G of https://iopscience.iop.org/article/10.3847/2041-8213/ab0e85/pdf</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy), which is also beta_0.</span>
<span class="sd">               d (float): The ring diameter (radians)</span>
<span class="sd">               alpha (float): The ring thickness (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               beta_list (list): List of complex Fourier coefficients, [beta_1, beta_2, ...]. </span>
<span class="sd">                                 Negative indices are determined by the condition beta_{-m} = beta_m*.</span>
<span class="sd">                                 Indices are all scaled by F0 = beta_0, so they are dimensionless. </span>
<span class="sd">               stretch (float): The stretch to apply (1.0 = no stretch)</span>
<span class="sd">               stretch_PA (float): Position angle of the stretch, east of north (radians)</span>
<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_cpol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretched_thick_mring&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;beta_list&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_pol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_cpol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;stretch&#39;</span><span class="p">:</span><span class="n">stretch</span><span class="p">,</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">:</span><span class="n">stretch_PA</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.add_stretched_thick_mring_floor"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.add_stretched_thick_mring_floor">[docs]</a>    <span class="k">def</span> <span class="nf">add_stretched_thick_mring_floor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">F0</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">d</span> <span class="o">=</span> <span class="mf">50.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="mf">10.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">ff</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">x0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">y0</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">,</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">stretch</span> <span class="o">=</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">stretch_PA</span> <span class="o">=</span> <span class="mf">0.0</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a ring model with azimuthal brightness variations determined by a Fourier mode expansion and thickness determined by circular Gaussian convolution.</span>
<span class="sd">           For details, see Eq. 18-20 of https://arxiv.org/abs/1907.04329</span>
<span class="sd">           The Gaussian convolution calculation is a trivial generalization of Appendix G of https://iopscience.iop.org/article/10.3847/2041-8213/ab0e85/pdf</span>

<span class="sd">           Args:</span>
<span class="sd">               F0 (float): The total flux of the ring (Jy), which is also beta_0.</span>
<span class="sd">               d (float): The ring diameter (radians)</span>
<span class="sd">               alpha (float): The ring thickness (FWHM of Gaussian convolution) (radians)</span>
<span class="sd">               x0 (float): The x-coordinate (radians)</span>
<span class="sd">               y0 (float): The y-coordinate (radians)</span>
<span class="sd">               beta_list (list): List of complex Fourier coefficients, [beta_1, beta_2, ...]. </span>
<span class="sd">                                 Negative indices are determined by the condition beta_{-m} = beta_m*.</span>
<span class="sd">                                 Indices are all scaled by F0 = beta_0, so they are dimensionless. </span>
<span class="sd">               stretch (float): The stretch to apply (1.0 = no stretch)</span>
<span class="sd">               stretch_PA (float): Position angle of the stretch, east of north (radians)</span>
<span class="sd">           Returns:</span>
<span class="sd">                (Model): Updated Model</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_pol</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">beta_list_cpol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">beta_list_cpol</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">beta_list</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">beta_list</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.0</span><span class="p">]</span>
        <span class="n">out</span><span class="o">.</span><span class="n">models</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;stretched_thick_mring_floor&#39;</span><span class="p">)</span>
        <span class="n">out</span><span class="o">.</span><span class="n">params</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s1">&#39;F0&#39;</span><span class="p">:</span><span class="n">F0</span><span class="p">,</span><span class="s1">&#39;d&#39;</span><span class="p">:</span><span class="n">d</span><span class="p">,</span><span class="s1">&#39;beta_list&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_pol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_pol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;beta_list_cpol&#39;</span><span class="p">:</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">beta_list_cpol</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">complex_</span><span class="p">),</span><span class="s1">&#39;alpha&#39;</span><span class="p">:</span><span class="n">alpha</span><span class="p">,</span><span class="s1">&#39;x0&#39;</span><span class="p">:</span><span class="n">x0</span><span class="p">,</span><span class="s1">&#39;y0&#39;</span><span class="p">:</span><span class="n">y0</span><span class="p">,</span><span class="s1">&#39;stretch&#39;</span><span class="p">:</span><span class="n">stretch</span><span class="p">,</span><span class="s1">&#39;stretch_PA&#39;</span><span class="p">:</span><span class="n">stretch_PA</span><span class="p">,</span><span class="s1">&#39;ff&#39;</span><span class="p">:</span><span class="n">ff</span><span class="p">})</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.sample_xy"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.sample_xy">[docs]</a>    <span class="k">def</span> <span class="nf">sample_xy</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="mf">1.</span><span class="o">*</span><span class="n">RADPERUAS</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample model image on the specified x and y coordinates</span>

<span class="sd">           Args:</span>
<span class="sd">               x (float): x coordinate (dimensionless)</span>
<span class="sd">               y (float): y coordinate (dimensionless)</span>

<span class="sd">           Returns:</span>
<span class="sd">               (float): Image brightness (Jy/radian^2)</span>
<span class="sd">        &quot;&quot;&quot;</span>  
        <span class="k">return</span> <span class="n">sample_model_xy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.sample_uv"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.sample_uv">[docs]</a>    <span class="k">def</span> <span class="nf">sample_uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">polrep_obs</span><span class="o">=</span><span class="s1">&#39;Stokes&#39;</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample model visibility on the specified u and v coordinates</span>

<span class="sd">           Args:</span>
<span class="sd">               u (float): u coordinate (dimensionless)</span>
<span class="sd">               v (float): v coordinate (dimensionless)</span>

<span class="sd">           Returns:</span>
<span class="sd">               (complex): complex visibility (Jy)</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="k">return</span> <span class="n">sample_model_uv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.sample_graduv_uv"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.sample_graduv_uv">[docs]</a>    <span class="k">def</span> <span class="nf">sample_graduv_uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample model visibility gradient on the specified u and v coordinates wrt (u,v)</span>

<span class="sd">           Args:</span>
<span class="sd">               u (float): u coordinate (dimensionless)</span>
<span class="sd">               v (float): v coordinate (dimensionless)</span>

<span class="sd">           Returns:</span>
<span class="sd">               (complex): complex visibility (Jy)</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="k">return</span> <span class="n">sample_model_graduv_uv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.sample_grad_uv"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.sample_grad_uv">[docs]</a>    <span class="k">def</span> <span class="nf">sample_grad_uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample model visibility gradient on the specified u and v coordinates wrt all model parameters</span>

<span class="sd">           Args:</span>
<span class="sd">               u (float): u coordinate (dimensionless)</span>
<span class="sd">               v (float): v coordinate (dimensionless)</span>

<span class="sd">           Returns:</span>
<span class="sd">               (complex): complex visibility (Jy)</span>
<span class="sd">        &quot;&quot;&quot;</span>   
        <span class="k">return</span> <span class="n">sample_model_grad_uv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">,</span> <span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span> <span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span> <span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">,</span> <span class="n">fit_leakage</span><span class="o">=</span><span class="n">fit_leakage</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.centroid"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.centroid">[docs]</a>    <span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Compute the location of the image centroid (corresponding to the polarization pol)</span>
<span class="sd">           Note: This quantity is only well defined for total intensity</span>

<span class="sd">           Args:</span>
<span class="sd">                pol (str): The polarization for which to find the image centroid</span>

<span class="sd">           Returns:</span>
<span class="sd">               (np.array): centroid positions (x0,y0) in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> <span class="n">pol</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==</span><span class="si">%s</span><span class="s2">, pol must be in &quot;</span> <span class="o">%</span> 
                             <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_graduv_uv</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span><span class="o">/</span><span class="p">(</span><span class="mf">2.</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">*</span><span class="mi">1</span><span class="n">j</span><span class="p">))</span><span class="o">/</span><span class="bp">self</span><span class="o">.</span><span class="n">total_flux</span><span class="p">()</span></div>

    <span class="k">def</span> <span class="nf">default_prior</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">fit_pol</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span><span class="n">fit_cpol</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">default_prior</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">],</span><span class="n">fit_pol</span><span class="o">=</span><span class="n">fit_pol</span><span class="p">,</span><span class="n">fit_cpol</span><span class="o">=</span><span class="n">fit_cpol</span><span class="p">)</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_models</span><span class="p">())]</span>        

    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fov</span><span class="o">=</span><span class="n">FOV_DEFAULT</span><span class="p">,</span> <span class="n">npix</span><span class="o">=</span><span class="n">NPIX_DEFAULT</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_image</span><span class="p">(</span><span class="n">fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim</span><span class="p">,</span> <span class="n">pulse</span><span class="p">,</span> <span class="n">time</span><span class="p">)</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

<div class="viewcode-block" id="Model.make_image"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.make_image">[docs]</a>    <span class="k">def</span> <span class="nf">make_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Sample the model onto a square image.</span>

<span class="sd">           Args:</span>
<span class="sd">               fov (float): the field of view of each axis in radians</span>
<span class="sd">               npix (int): the number of pixels on each axis</span>
<span class="sd">               ra (float): The source Right Ascension in fractional hours</span>
<span class="sd">               dec (float): The source declination in fractional degrees</span>
<span class="sd">               rf (float): The image frequency in Hz</span>

<span class="sd">               source (str): The source name</span>
<span class="sd">               polrep (str): polarization representation, either &#39;stokes&#39; or &#39;circ&#39;</span>
<span class="sd">               pol_prim (str): The default image: I,Q,U or V for Stokes, RR,LL,LR,RL for Circular</span>
<span class="sd">               pulse (function): The function convolved with the pixel values for continuous image.</span>

<span class="sd">               mjd (int): The integer MJD of the image</span>
<span class="sd">               time (float): The observing time of the image (UTC hours)</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): an image object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">pdim</span> <span class="o">=</span> <span class="n">fov</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
        <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span><span class="n">npix</span><span class="p">))</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">pdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span>
                      <span class="n">polrep</span><span class="o">=</span><span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="n">pol_prim</span><span class="p">,</span>
                      <span class="n">rf</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">pulse</span><span class="p">)</span>
        
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_same</span><span class="p">(</span><span class="n">outim</span><span class="p">)</span></div>

<div class="viewcode-block" id="Model.image_same"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.image_same">[docs]</a>    <span class="k">def</span> <span class="nf">image_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Create an image of the model with parameters equal to a reference image.</span>

<span class="sd">           Args:</span>
<span class="sd">               im (Image): the reference image</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): image of the model</span>
<span class="sd">        &quot;&quot;&quot;</span>        
        <span class="n">out</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">*</span><span class="n">im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span><span class="o">/</span><span class="mf">2.0</span> <span class="o">-</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="o">/</span><span class="mf">2.0</span>

        <span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">xlist</span><span class="p">,</span> <span class="n">ylist</span><span class="p">)</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_xy</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span>    
        <span class="n">out</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">imarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span> <span class="c1"># Change this to init with image_args </span>

        <span class="c1"># Add the remaining polarizations</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">,</span><span class="s1">&#39;V&#39;</span><span class="p">]:</span>
            <span class="n">out</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">sample_xy</span><span class="p">(</span><span class="n">x_grid</span><span class="p">,</span> <span class="n">y_grid</span><span class="p">,</span> <span class="n">im</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">),</span> <span class="n">pol</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Model.observe_same_nonoise"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.observe_same_nonoise">[docs]</a>    <span class="k">def</span> <span class="nf">observe_same_nonoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Observe the model on the same baselines as an existing observation, without noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               obs (Obsdata): the existing observation </span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object with no noise</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Copy data to be safe</span>
        <span class="n">obsdata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Load optional parameters</span>
        <span class="n">jonesdict</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;jonesdict&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Compute visibilities and put them into the obsdata</span>
        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="o">==</span><span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;qvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;Q&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;uvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;U&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;vvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;V&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="o">==</span><span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;rrvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RR&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;rlvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;RL&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;lrvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LR&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;llvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">sample_uv</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">],</span> <span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">],</span> <span class="n">pol</span><span class="o">=</span><span class="s1">&#39;LL&#39;</span><span class="p">,</span> <span class="n">jonesdict</span><span class="o">=</span><span class="n">jonesdict</span><span class="p">)</span>

        <span class="n">obs_no_noise</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span>
                                             <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                             <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">,</span> <span class="n">scantable</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obs_no_noise</span></div>

<div class="viewcode-block" id="Model.observe_same"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.observe_same">[docs]</a>    <span class="k">def</span> <span class="nf">observe_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_in</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="c1"># Note: sgrscat and ttype are kept for consistency with comp_plots</span>
                           <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                           <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rlgaincal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                           <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">neggains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">tau</span><span class="o">=</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                           <span class="n">gain_offset</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                           <span class="n">dterm_offset</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">,</span>                            
                           <span class="n">rlratio_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">rlphase_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                           <span class="n">caltable_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Observe the image on the same baselines as an existing observation object and add noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               obs_in (Obsdata): the existing observation </span>

<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices. </span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to D-terms. </span>

<span class="sd">               stabilize_scan_phase (bool): if True, random phase errors are constant over scans</span>
<span class="sd">               stabilize_scan_amp (bool): if True, random amplitude errors are constant over scans</span>
<span class="sd">               neggains (bool): if True, force the applied gains to be &lt;1</span>
<span class="sd">                                meaning that you have overestimated your telescope&#39;s performance</span>


<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects </span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix </span>
<span class="sd">                                 (not including random terms) to a priori calibrate data</span>

<span class="sd">               tau (float): the base opacity at all sites, </span>
<span class="sd">                            or a dict giving one opacity per site</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">                              or a dict giving one std. dev. per site      </span>

<span class="sd">               gain_offset (float): the base gain offset at all sites,</span>
<span class="sd">                                    or a dict giving one gain offset per site</span>
<span class="sd">               dterm_offset (float): the base std. dev. of random additive error at all sites,</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>

<span class="sd">               rlratio_std (float): the fractional std. dev. of the R/L gain offset</span>
<span class="sd">                                    or a dict giving one std. dev. per site                                          </span>
<span class="sd">               rlphase_std (float): std. dev. of R/L phase offset, </span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>
<span class="sd">                                    a negative value samples from uniform                                          </span>

<span class="sd">               caltable_path (string): The path and prefix of a saved caltable</span>

<span class="sd">               seed (int): seeds the random component of the noise terms. DO NOT set to 0!</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">seed</span><span class="o">!=</span><span class="kc">False</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe_same_nonoise</span><span class="p">(</span><span class="n">obs_in</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Jones Matrix Corruption &amp; Calibration</span>
        <span class="k">if</span> <span class="n">jones</span><span class="p">:</span>
            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">add_jones_and_noise</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                                 <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span>
                                                 <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span> 
                                                 <span class="n">rlgaincal</span><span class="o">=</span><span class="n">rlgaincal</span><span class="p">,</span>
                                                 <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="n">stabilize_scan_phase</span><span class="p">,</span>
                                                 <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="n">stabilize_scan_amp</span><span class="p">,</span> 
                                                 <span class="n">neggains</span><span class="o">=</span><span class="n">neggains</span><span class="p">,</span>
                                                 <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span>
                                                 <span class="n">dterm_offset</span><span class="o">=</span><span class="n">dterm_offset</span><span class="p">,</span>
                                                 <span class="n">rlratio_std</span><span class="o">=</span><span class="n">rlratio_std</span><span class="p">,</span><span class="n">rlphase_std</span><span class="o">=</span><span class="n">rlphase_std</span><span class="p">,</span>
                                                 <span class="n">caltable_path</span><span class="o">=</span><span class="n">caltable_path</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

            <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span>
                                         <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">obs_in</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                         <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> 
                                         <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                         <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">,</span> <span class="n">scantable</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inv_jones</span><span class="p">:</span>
                <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">apply_jones_inverse</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> 
                                                     <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">)</span>

                <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span>
                                             <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">obs_in</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                             <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                             <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">,</span> <span class="n">scantable</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>
                                             <span class="c1">#these are always set to True after inverse jones call</span>


        <span class="c1"># No Jones Matrices, Add noise the old way</span>
        <span class="c1"># NOTE There is an asymmetry here - in the old way, we don&#39;t offer the ability to *not*  </span>
        <span class="c1"># unscale estimated noise.</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">caltable_path</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: the caltable is only saved if you apply noise with a Jones Matrix&#39;</span><span class="p">)</span>

            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">add_noise</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                       <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span>
                                       <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="n">stabilize_scan_phase</span><span class="p">,</span>
                                       <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="n">stabilize_scan_amp</span><span class="p">,</span>
                                       <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

            <span class="n">obs</span> <span class="o">=</span>  <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span>
                                         <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">obs_in</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                         <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                         <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                         <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">,</span> <span class="n">scantable</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>
                                         <span class="c1">#these are always set to True after inverse jones call</span>

        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Model.observe"><a class="viewcode-back" href="../../model.html#ehtim.model.Model.observe">[docs]</a>    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">tint</span><span class="p">,</span> <span class="n">tadv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span>
                      <span class="n">mjd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timetype</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span> <span class="n">polrep_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                      <span class="n">elevmin</span><span class="o">=</span><span class="n">ELEV_LOW</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="n">ELEV_HIGH</span><span class="p">,</span>
                      <span class="n">no_elevcut_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>                      
                      <span class="n">fix_theta_GMST</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
                      <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rlgaincal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                      <span class="n">tau</span><span class="o">=</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                      <span class="n">gainp</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gain_offset</span><span class="o">=</span><span class="n">GAINPDEF</span><span class="p">,</span>
                      <span class="n">dterm_offset</span><span class="o">=</span><span class="n">DTERMPDEF</span><span class="p">,</span> <span class="n">rlratio_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">rlphase_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                      <span class="n">seed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>

<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate baselines from an array object and observe the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               array (Array): an array object containing sites with which to generate baselines</span>
<span class="sd">               tint (float): the scan integration time in seconds</span>
<span class="sd">               tadv (float): the uniform cadence between scans in seconds</span>
<span class="sd">               tstart (float): the start time of the observation in hours</span>
<span class="sd">               tstop (float): the end time of the observation in hours</span>
<span class="sd">               bw (float): the observing bandwidth in Hz</span>

<span class="sd">               mjd (int): the mjd of the observation, if set as different from the image mjd</span>
<span class="sd">               timetype (str): how to interpret tstart and tstop; either &#39;GMST&#39; or &#39;UTC&#39;</span>
<span class="sd">               elevmin (float): station minimum elevation in degrees</span>
<span class="sd">               elevmax (float): station maximum elevation in degrees</span>
<span class="sd">               no_elevcut_space (bool): if True, do not apply elevation cut to orbiters</span>
<span class="sd">           </span>
<span class="sd">               polrep_obs (str): &#39;stokes&#39; or &#39;circ&#39; sets the data polarimetric representation</span>

<span class="sd">               fix_theta_GMST (bool): if True, stops earth rotation to sample fixed u,v </span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A*  kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added </span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added </span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices. </span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrices D-terms. </span>

<span class="sd">               stabilize_scan_phase (bool): if True, random phase errors are constant over scans</span>
<span class="sd">               stabilize_scan_amp (bool): if True, random amplitude errors are constant over scans</span>
<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects </span>
<span class="sd">                             otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix </span>
<span class="sd">                                 (not including random terms) to calibrate data</span>

<span class="sd">               tau (float): the base opacity at all sites, </span>
<span class="sd">                            or a dict giving one opacity per site</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">                              or a dict giving one std. dev. per site      </span>

<span class="sd">               gain_offset (float): the base gain offset at all sites,</span>
<span class="sd">                                    or a dict giving one gain offset per site</span>
<span class="sd">               dterm_offset (float): the base std. dev. of random additive error at all sites,</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>

<span class="sd">               rlratio_std (float): the fractional std. dev. of the R/L gain offset</span>
<span class="sd">                                    or a dict giving one std. dev. per site                                          </span>
<span class="sd">               rlphase_std (float): std. dev. of R/L phase offset, </span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>
<span class="sd">                                    a negative value samples from uniform                                          </span>

<span class="sd">               seed (int): seeds the random component of noise added. DO NOT set to 0!</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Generate empty observation</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating empty observation file . . . &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mjd</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mjd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span>
        <span class="k">if</span> <span class="n">polrep_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">polrep_obs</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">polrep</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">obsdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">tint</span><span class="p">,</span> <span class="n">tadv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span> 
                            <span class="n">polrep</span><span class="o">=</span><span class="n">polrep_obs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">timetype</span><span class="o">=</span><span class="n">timetype</span><span class="p">,</span> 
                            <span class="n">elevmin</span><span class="o">=</span><span class="n">elevmin</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="n">elevmax</span><span class="p">,</span> 
                            <span class="n">no_elevcut_space</span><span class="o">=</span><span class="n">no_elevcut_space</span><span class="p">,</span> <span class="n">fix_theta_GMST</span><span class="o">=</span><span class="n">fix_theta_GMST</span><span class="p">)</span>

        <span class="c1"># Observe on the same baselines as the empty observation and add noise</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe_same</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span> 
                                     <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span><span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span>
                                     <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span><span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span>
                                     <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span> <span class="n">rlgaincal</span><span class="o">=</span><span class="n">rlgaincal</span><span class="p">,</span>
                                     <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="n">stabilize_scan_phase</span><span class="p">,</span>
                                     <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="n">stabilize_scan_amp</span><span class="p">,</span>
                                     <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span><span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span>
                                     <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span>
                                     <span class="n">dterm_offset</span><span class="o">=</span><span class="n">dterm_offset</span><span class="p">,</span>
                                     <span class="n">rlratio_std</span><span class="o">=</span><span class="n">rlratio_std</span><span class="p">,</span><span class="n">rlphase_std</span><span class="o">=</span><span class="n">rlphase_std</span><span class="p">,</span>
                                     <span class="n">jones</span><span class="o">=</span><span class="n">jones</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="n">inv_jones</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="n">obs</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="n">mjd</span>

        <span class="k">return</span> <span class="n">obs</span></div>

    <span class="k">def</span> <span class="nf">save_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="c1"># Header</span>
        <span class="kn">import</span> <span class="nn">ehtim.observing.obs_helpers</span> <span class="k">as</span> <span class="nn">obshelp</span>
        <span class="n">mjd</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span>
        <span class="n">time</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span>
        <span class="n">mjd</span> <span class="o">+=</span> <span class="p">(</span><span class="n">time</span><span class="o">/</span><span class="mf">24.</span><span class="p">)</span>

        <span class="n">head</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;SRC: </span><span class="si">%s</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">+</span>
                <span class="s2">&quot;RA: &quot;</span> <span class="o">+</span> <span class="n">obshelp</span><span class="o">.</span><span class="n">rastring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> 
                <span class="s2">&quot;DEC: &quot;</span> <span class="o">+</span> <span class="n">obshelp</span><span class="o">.</span><span class="n">decstring</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span>
                <span class="s2">&quot;MJD: </span><span class="si">%.6f</span><span class="s2"> </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">mjd</span><span class="p">))</span> <span class="o">+</span>  
                <span class="s2">&quot;RF: </span><span class="si">%.4f</span><span class="s2"> GHz&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">/</span><span class="mf">1e9</span><span class="p">))</span>
        <span class="c1"># Models</span>
        <span class="n">out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">N_models</span><span class="p">()):</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">models</span><span class="p">[</span><span class="n">j</span><span class="p">])</span>
            <span class="n">out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">params</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;complex128&#39;</span><span class="p">,</span><span class="s1">&#39;np.complex128&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;array&#39;</span><span class="p">,</span><span class="s1">&#39;np.array&#39;</span><span class="p">))</span>
        <span class="n">np</span><span class="o">.</span><span class="n">savetxt</span><span class="p">(</span><span class="n">filename</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">head</span><span class="p">,</span> <span class="n">fmt</span><span class="o">=</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">load_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">filename</span><span class="p">):</span>
        <span class="n">lines</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
        
        <span class="n">src</span> <span class="o">=</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">:])</span>
        <span class="n">ra</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mf">60.0</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mf">3600.0</span>
        <span class="n">dec</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">*</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="mi">4</span><span class="p">])</span><span class="o">/</span><span class="mf">60.0</span> <span class="o">+</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">[</span><span class="mi">6</span><span class="p">])</span><span class="o">/</span><span class="mf">3600.0</span><span class="p">)</span>
        <span class="n">mjd_float</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mjd_float</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="p">(</span><span class="n">mjd_float</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">)</span> <span class="o">*</span> <span class="mi">24</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">lines</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">()[</span><span class="mi">2</span><span class="p">])</span> <span class="o">*</span> <span class="mf">1e9</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">models</span> <span class="o">=</span> <span class="n">lines</span><span class="p">[</span><span class="mi">5</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">params</span> <span class="o">=</span> <span class="p">[</span><span class="nb">eval</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">[</span><span class="mi">6</span><span class="p">::</span><span class="mi">2</span><span class="p">]]</span></div>

<span class="k">def</span> <span class="nf">load_txt</span><span class="p">(</span><span class="n">filename</span><span class="p">):</span>
    <span class="n">out</span> <span class="o">=</span> <span class="n">Model</span><span class="p">()</span>
    <span class="n">out</span><span class="o">.</span><span class="n">load_txt</span><span class="p">(</span><span class="n">filename</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">out</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andrew Chael.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>