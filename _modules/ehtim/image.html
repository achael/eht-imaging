<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ehtim.image &mdash; ehtim 1.2.6 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../index.html" class="icon icon-home"> ehtim
          </a>
              <div class="version">
                1.2.6
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../image.html">Image</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../array.html">Array</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../obsdata.html">Obsdata</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../movie.html">Movie</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../model.html">Model</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../imager.html">Imager</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../calibration.html">Calibration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plotting.html">Plotting</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../scattering.html">Scattering</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../statistics.html">Statistics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../survey.html">Survey</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../vex.html">Vex</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">ehtim</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../index.html">Module code</a> &raquo;</li>
      <li>ehtim.image</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ehtim.image</h1><div class="highlight"><pre>
<span></span><span class="c1"># image.py</span>
<span class="c1"># an interferometric image class</span>
<span class="c1">#</span>
<span class="c1">#    Copyright (C) 2018 Andrew Chael</span>
<span class="c1">#</span>
<span class="c1">#    This program is free software: you can redistribute it and/or modify</span>
<span class="c1">#    it under the terms of the GNU General Public License as published by</span>
<span class="c1">#    the Free Software Foundation, either version 3 of the License, or</span>
<span class="c1">#    (at your option) any later version.</span>
<span class="c1">#</span>
<span class="c1">#    This program is distributed in the hope that it will be useful,</span>
<span class="c1">#    but WITHOUT ANY WARRANTY; without even the implied warranty of</span>
<span class="c1">#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the</span>
<span class="c1">#    GNU General Public License for more details.</span>
<span class="c1">#</span>
<span class="c1">#    You should have received a copy of the GNU General Public License</span>
<span class="c1">#    along with this program.  If not, see &lt;http://www.gnu.org/licenses/&gt;.</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">division</span>
<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">str</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">range</span>
<span class="kn">from</span> <span class="nn">builtins</span> <span class="kn">import</span> <span class="nb">object</span>

<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">math</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">numpy.matlib</span> <span class="k">as</span> <span class="nn">matlib</span>
<span class="kn">import</span> <span class="nn">matplotlib</span> <span class="k">as</span> <span class="nn">mpl</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">import</span> <span class="nn">scipy.optimize</span> <span class="k">as</span> <span class="nn">opt</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage.filters</span> <span class="k">as</span> <span class="nn">filt</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span> <span class="k">as</span> <span class="n">ndi</span>


<span class="k">try</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">skimage.feature</span> <span class="kn">import</span> <span class="n">canny</span>
    <span class="kn">from</span> <span class="nn">skimage.transform</span> <span class="kn">import</span> <span class="n">hough_circle</span><span class="p">,</span> <span class="n">hough_circle_peaks</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: scikit-image not installed! Cannot use hough transform&quot;</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">ehtim.observing.obs_simulate</span> <span class="k">as</span> <span class="nn">simobs</span>
<span class="kn">import</span> <span class="nn">ehtim.observing.pulses</span> <span class="k">as</span> <span class="nn">pulses</span>
<span class="kn">import</span> <span class="nn">ehtim.io.save</span>
<span class="kn">import</span> <span class="nn">ehtim.io.load</span>
<span class="kn">import</span> <span class="nn">ehtim.const_def</span> <span class="k">as</span> <span class="nn">ehc</span>
<span class="kn">import</span> <span class="nn">ehtim.observing.obs_helpers</span> <span class="k">as</span> <span class="nn">obsh</span>

<span class="c1"># TODO : add time to all images</span>
<span class="c1"># TODO : add arbitrary center location</span>

<span class="c1">###################################################################################################</span>
<span class="c1"># Image object</span>
<span class="c1">###################################################################################################</span>


<div class="viewcode-block" id="Image"><a class="viewcode-back" href="../../image.html#ehtim.image.Image">[docs]</a><span class="k">class</span> <span class="nc">Image</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>

    <span class="sd">&quot;&quot;&quot;A polarimetric image (in units of Jy/pixel).</span>

<span class="sd">       Attributes:</span>
<span class="sd">           pulse (function): The function convolved with the pixel values for continuous image.</span>
<span class="sd">           psize (float): The pixel dimension in radians</span>
<span class="sd">           xdim (int): The number of pixels along the x dimension</span>
<span class="sd">           ydim (int): The number of pixels along the y dimension</span>
<span class="sd">           mjd (int): The integer MJD of the image</span>
<span class="sd">           time (float): The observing time of the image (UTC hours)</span>
<span class="sd">           source (str): The astrophysical source name</span>
<span class="sd">           ra (float): The source Right Ascension in fractional hours</span>
<span class="sd">           dec (float): The source declination in fractional degrees</span>
<span class="sd">           rf (float): The image frequency in Hz</span>

<span class="sd">           polrep (str): polarization representation, either &#39;stokes&#39; or &#39;circ&#39;</span>
<span class="sd">           pol_prim (str): The default image: I,Q,U or V for Stokes, or RR,LL,LR,RL for Circular</span>
<span class="sd">           _imdict (dict): The dictionary with the polarimetric images</span>
<span class="sd">           _mflist (list): List of spectral index images (and higher order terms)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">psize</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">pa</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                 <span class="n">polrep</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">rf</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">RF_DEFAULT</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">SOURCE_DEFAULT</span><span class="p">,</span>
                 <span class="n">mjd</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">MJD_DEFAULT</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;A polarimetric image (in units of Jy/pixel).</span>

<span class="sd">           Args:</span>
<span class="sd">               image (numpy.array): The 2D intensity values in a Jy/pixel array</span>
<span class="sd">               polrep (str): polarization representation, either &#39;stokes&#39; or &#39;circ&#39;</span>
<span class="sd">               pol_prim (str): The default image: I,Q,U or V for Stokes, RR,LL,LR,RL for Circular</span>

<span class="sd">               psize (float): The pixel dimension in radians</span>
<span class="sd">               ra (float): The source Right Ascension in fractional hours</span>
<span class="sd">               dec (float): The source declination in fractional degrees</span>
<span class="sd">               pa (float): logical positional angle of the image</span>
<span class="sd">               rf (float): The image frequency in Hz</span>
<span class="sd">               pulse (function): The function convolved with the pixel values for continuous image.</span>
<span class="sd">               source (str): The source name</span>
<span class="sd">               mjd (int): The integer MJD of the image</span>
<span class="sd">               time (float): The observing time of the image (UTC hours)</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): the Image object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;image must be a 2D numpy array&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">polrep</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="s1">&#39;circ&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;only &#39;stokes&#39; and &#39;circ&#39; are supported polreps!&quot;</span><span class="p">)</span>

        <span class="c1"># Save the image vector</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pol_prim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">pol_prim</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">if</span> <span class="n">pol_prim</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">imvec</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
            <span class="k">elif</span> <span class="n">pol_prim</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">imvec</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">pol_prim</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">imvec</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
            <span class="k">elif</span> <span class="n">pol_prim</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">imvec</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==&#39;stokes&#39;, pol_prim must be &#39;I&#39;,&#39;Q&#39;,&#39;U&#39;, or &#39;V&#39;!&quot;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pol_prim</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;polrep is &#39;circ&#39; and no pol_prim specified! Setting pol_prim=&#39;RR&#39;&quot;</span><span class="p">)</span>
                <span class="n">pol_prim</span> <span class="o">=</span> <span class="s1">&#39;RR&#39;</span>
            <span class="k">if</span> <span class="n">pol_prim</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="n">imvec</span><span class="p">,</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
            <span class="k">elif</span> <span class="n">pol_prim</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="n">imvec</span><span class="p">,</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([]),</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==&#39;circ&#39;, pol_prim must be &#39;RR&#39; or &#39;LL&#39;!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;polrep must be &#39;circ&#39; or &#39;stokes&#39;!&quot;</span><span class="p">)</span>

        <span class="c1"># multifrequency spectral index, curvature arrays</span>
        <span class="c1"># TODO -- higher orders?</span>
        <span class="c1"># TODO -- don&#39;t initialize to zero?</span>
        <span class="n">avec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>  <span class="c1"># np.zeros(imvec.shape)</span>
        <span class="n">bvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>  <span class="c1"># np.zeros(imvec.shape)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="p">[</span><span class="n">avec</span><span class="p">,</span> <span class="n">bvec</span><span class="p">]</span>

        <span class="c1"># Save the image dimension data</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span> <span class="o">=</span> <span class="n">pol_prim</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">=</span> <span class="n">polrep</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span> <span class="o">=</span> <span class="n">pulse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">psize</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Save the image metadata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">ra</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">dec</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pa</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">pa</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">source</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">source</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">mjd</span><span class="p">)</span>

        <span class="c1"># Cached FFT of the image</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cached_fft</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">time</span> <span class="o">&gt;</span> <span class="mi">24</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span> <span class="o">+=</span> <span class="nb">int</span><span class="p">((</span><span class="n">time</span> <span class="o">-</span> <span class="n">time</span> <span class="o">%</span> <span class="mi">24</span><span class="p">)</span> <span class="o">/</span> <span class="mi">24</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">time</span> <span class="o">%</span> <span class="mi">24</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">time</span> <span class="o">=</span> <span class="n">time</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">imvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">imvec</span>

    <span class="nd">@imvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">imvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;imvec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">specvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">specvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">specvec</span>

    <span class="nd">@specvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">specvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">curvvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">curvvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">return</span> <span class="n">curvvec</span>

    <span class="nd">@curvvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">curvvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">ivec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#        if self.polrep != &#39;stokes&#39;:</span>
<span class="c1">#            raise Exception(&quot;ivec is not defined unless self.polrep==&#39;stokes&#39;&quot;)</span>

        <span class="n">ivec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">ivec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">ivec</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">ivec</span>

    <span class="nd">@ivec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">ivec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ivec cannot be set unless self.polrep==&#39;stokes&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;I&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">qvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#        if self.polrep != &#39;stokes&#39;:</span>
<span class="c1">#            raise Exception(&quot;qvec is not defined unless self.polrep==&#39;stokes&#39;&quot;)</span>

        <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">qvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">qvec</span>

    <span class="nd">@qvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">qvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ivec cannot be set unless self.polrep==&#39;stokes&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">uvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#        if self.polrep != &#39;stokes&#39;:</span>
<span class="c1">#            raise Exception(&quot;qvec is not defined unless self.polrep==&#39;stokes&#39;&quot;)</span>

        <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">uvec</span>

    <span class="nd">@uvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">uvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;uvec cannot be set unless self.polrep==&#39;stokes&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">vvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#        if self.polrep != &#39;stokes&#39;:</span>
<span class="c1">#            raise Exception(&quot;vvec is not defined unless self.polrep==&#39;stokes&#39;&quot;)</span>

        <span class="n">vvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">vvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vvec</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">vvec</span>

    <span class="nd">@vvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">vvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vvec cannot be set unless self.polrep==&#39;stokes&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;V&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rrvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#        if self.polrep != &#39;circ&#39;:</span>
<span class="c1">#            raise Exception(&quot;rrvec is not defined unless self.polrep==&#39;circ&#39;&quot;)</span>

        <span class="n">rrvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">rrvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;RR&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rrvec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rrvec</span>

    <span class="nd">@rrvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rrvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;rrvec cannot be set unless self.polrep==&#39;circ&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;RR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">llvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#        if self.polrep != &#39;circ&#39;:</span>
<span class="c1">#            raise Exception(&quot;llvec is not defined unless self.polrep==&#39;circ&#39;&quot;)</span>

        <span class="n">llvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">llvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;LL&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">llvec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">llvec</span>

    <span class="nd">@llvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">llvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;llvec cannot be set unless self.polrep==&#39;circ&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;LL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">rlvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="c1">#        if self.polrep != &#39;circ&#39;:</span>
<span class="c1">#            raise Exception(&quot;rlvec is not defined unless self.polrep==&#39;circ&#39;&quot;)</span>

        <span class="n">rlvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">rlvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;RL&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">rlvec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">rlvec</span>

    <span class="nd">@rlvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">rlvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;rlvec cannot be set unless self.polrep==&#39;circ&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;RL&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">lrvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the imvec of LR&quot;&quot;&quot;</span>
<span class="c1">#        if self.polrep != &#39;circ&#39;:</span>
<span class="c1">#            raise Exception(&quot;lrvec is not defined unless self.polrep==&#39;circ&#39;&quot;)</span>

        <span class="n">lrvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">lrvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;LR&#39;</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lrvec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">lrvec</span>

    <span class="nd">@lrvec</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">lrvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vec</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Set the imvec&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;vec size is not consistent with xdim*ydim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;lrvec cannot be set unless self.polrep==&#39;circ&#39;&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;LR&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">vec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">pvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the polarization magnitude for each pixel&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">pvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">pvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pvec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">mvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the fractional polarization for each pixel&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">mvec</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">mvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivec</span>

        <span class="k">return</span> <span class="n">mvec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">chivec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the fractional polarization angle for each pixel&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">chivec</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">chivec</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">chivec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evpavec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the fractional polarization angle for each pixel&quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">chivec</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">evec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the E mode image vector&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">qvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span>

        <span class="n">qarr</span> <span class="o">=</span> <span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
        <span class="n">uarr</span> <span class="o">=</span> <span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
        <span class="n">qarr_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">qarr</span><span class="p">))</span>
        <span class="n">uarr_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">uarr</span><span class="p">))</span>

        <span class="c1"># TODO -- check conventions for u,v angle</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">))))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span>  <span class="c1"># .5 offset to reference to pixel center</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span>  <span class="c1"># .5 offset to reference to pixel center</span>
        <span class="n">uvangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># TODO -- these conventions for e,b are from kaminokowski aara 54:227-69 sec 4.1</span>
        <span class="c1"># TODO -- check!</span>
        <span class="n">cos2arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">uvangle</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">sin2arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">uvangle</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">earr_fft</span> <span class="o">=</span> <span class="p">(</span><span class="n">cos2arr</span> <span class="o">*</span> <span class="n">qarr_fft</span> <span class="o">+</span> <span class="n">sin2arr</span> <span class="o">*</span> <span class="n">uarr_fft</span><span class="p">)</span>

        <span class="n">earr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">earr_fft</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">earr</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">bvec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the B mode image vector&quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">qvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span>

        <span class="c1"># TODO -- check conventions for u,v angle</span>
        <span class="n">qarr</span> <span class="o">=</span> <span class="n">qvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
        <span class="n">uarr</span> <span class="o">=</span> <span class="n">uvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
        <span class="n">qarr_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">qarr</span><span class="p">))</span>
        <span class="n">uarr_fft</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">uarr</span><span class="p">))</span>

        <span class="c1"># TODO -- are these conventions for u,v right?</span>
        <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))),</span>
                           <span class="n">np</span><span class="o">.</span><span class="n">flip</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftshift</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">))))</span>
        <span class="n">s</span> <span class="o">=</span> <span class="n">s</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span>  <span class="c1"># .5 offset to reference to pixel center</span>
        <span class="n">t</span> <span class="o">=</span> <span class="n">t</span> <span class="o">+</span> <span class="o">.</span><span class="mi">5</span>  <span class="c1"># .5 offset to reference to pixel center</span>
        <span class="n">uvangle</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">t</span><span class="p">)</span>

        <span class="c1"># TODO -- check!</span>
        <span class="n">cos2arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">uvangle</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">sin2arr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">uvangle</span><span class="p">),</span> <span class="n">decimals</span><span class="o">=</span><span class="mi">10</span><span class="p">)</span>
        <span class="n">barr_fft</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">sin2arr</span> <span class="o">*</span> <span class="n">qarr_fft</span> <span class="o">+</span> <span class="n">cos2arr</span> <span class="o">*</span> <span class="n">uarr_fft</span><span class="p">)</span>

        <span class="n">barr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifftshift</span><span class="p">(</span><span class="n">barr_fft</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">barr</span><span class="o">.</span><span class="n">flatten</span><span class="p">())</span>

<div class="viewcode-block" id="Image.get_polvec"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.get_polvec">[docs]</a>    <span class="k">def</span> <span class="nf">get_polvec</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the imvec corresponding to the chosen polarization</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span> <span class="ow">and</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span> <span class="ow">and</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="s1">&#39;RR&#39;</span>

        <span class="k">if</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;i&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;q&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;u&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;v&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rr&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;ll&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;lr&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;rl&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;chi&#39;</span> <span class="ow">or</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span><span class="s1">&#39;evpa&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chivec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evec</span>
        <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
            <span class="n">outvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvec</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Requested polvec type not recognized!&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">outvec</span></div>

<div class="viewcode-block" id="Image.image_args"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.image_args">[docs]</a>    <span class="k">def</span> <span class="nf">image_args</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy arguments for making a  new Image into a list and dictonary</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">arglist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">imarr</span><span class="p">(),</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">]</span>
        <span class="n">argdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;rf&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="s1">&#39;pa&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pa</span><span class="p">,</span>
                   <span class="s1">&#39;polrep&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span> <span class="s1">&#39;pol_prim&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">,</span>
                   <span class="s1">&#39;pulse&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">,</span> <span class="s1">&#39;source&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                   <span class="s1">&#39;mjd&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="s1">&#39;time&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">time</span><span class="p">}</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.copy"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.copy">[docs]</a>    <span class="k">def</span> <span class="nf">copy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a copy of the Image object.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): copy of the Image.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Make new  image with primary polarization</span>
        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">newim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Copy over all polarization images</span>
        <span class="n">newim</span><span class="o">.</span><span class="n">copy_pol_images</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># Copy over spectral index information</span>
        <span class="n">newim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newim</span></div>

<div class="viewcode-block" id="Image.copy_pol_images"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.copy_pol_images">[docs]</a>    <span class="k">def</span> <span class="nf">copy_pol_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">old_image</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Copy polarization images from old_image over to self.</span>

<span class="sd">           Args:</span>
<span class="sd">               old_image (Image): image object to copy from</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>

            <span class="k">if</span> <span class="p">(</span><span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">):</span>
                <span class="k">continue</span>

            <span class="n">polvec</span> <span class="o">=</span> <span class="n">old_image</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="n">pol</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.add_pol_image"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_pol_image">[docs]</a>    <span class="k">def</span> <span class="nf">add_pol_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">image</span><span class="p">,</span> <span class="n">pol</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add another image polarization.</span>

<span class="sd">           Args:</span>
<span class="sd">               image (list): 2D image frame (possibly complex) in a Jy/pixel array</span>
<span class="sd">               pol (str): The image type: &#39;I&#39;,&#39;Q&#39;,&#39;U&#39;,&#39;V&#39; for stokes, &#39;RR&#39;,&#39;LL&#39;,&#39;RL&#39;,&#39;LR&#39; for circ</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;new pol in add_pol_image is the same as pol_prim!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;add_pol_image image shapes incompatible with primary image!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==</span><span class="si">%s</span><span class="s2">, pol in add_pol_image in &quot;</span> <span class="o">%</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ivec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RR&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">return</span></div>

    <span class="c1"># TODO deprecated -- replace with generic add_pol_image</span>
<div class="viewcode-block" id="Image.add_qu"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_qu">[docs]</a>    <span class="k">def</span> <span class="nf">add_qu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">qimage</span><span class="p">,</span> <span class="n">uimage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add Stokes Q and U images. self.polrep must be &#39;stokes&#39;</span>

<span class="sd">           Args:</span>
<span class="sd">               qimage (numpy.array): The 2D Stokes Q values in Jy/pixel array</span>
<span class="sd">               uimage (numpy.array): The 2D Stokes U values in Jy/pixel array</span>

<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;polrep must be &#39;stokes&#39; for add_qu() !&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">qimage</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">uimage</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

    <span class="c1"># TODO deprecated -- replace with generic add_pol_image</span>
<div class="viewcode-block" id="Image.add_v"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_v">[docs]</a>    <span class="k">def</span> <span class="nf">add_v</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vimage</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add Stokes V image. self.polrep must be &#39;stokes&#39;</span>

<span class="sd">           Args:</span>
<span class="sd">               vimage (numpy.array): The 2D Stokes Q values in Jy/pixel array</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;polrep must be &#39;stokes&#39; for add_v() !&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">vimage</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">)</span>

        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.switch_polrep"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.switch_polrep">[docs]</a>    <span class="k">def</span> <span class="nf">switch_polrep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">polrep_out</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim_out</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return a new image with the polarization representation changed</span>
<span class="sd">           Args:</span>
<span class="sd">               polrep_out (str):  the polrep of the output data</span>
<span class="sd">               pol_prim_out (str): The default image: I,Q,U or V for Stokes, RR,LL,LR,RL for circ</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): new Image object with potentially different polrep</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">polrep_out</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="s1">&#39;circ&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;polrep_out must be either &#39;stokes&#39; or &#39;circ&#39;&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pol_prim_out</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">polrep_out</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
                <span class="n">pol_prim_out</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
            <span class="k">elif</span> <span class="n">polrep_out</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
                <span class="n">pol_prim_out</span> <span class="o">=</span> <span class="s1">&#39;RR&#39;</span>

        <span class="c1"># Simply copy if the polrep is unchanged</span>
        <span class="k">if</span> <span class="n">polrep_out</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="ow">and</span> <span class="n">pol_prim_out</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Assemble a dictionary of new polarization vectors</span>
        <span class="k">if</span> <span class="n">polrep_out</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
                <span class="n">imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivec</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ivec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                    <span class="n">vvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">ivec</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span>
                    <span class="n">vvec</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                    <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>
                    <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="mf">0.5</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>

                <span class="n">imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">ivec</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">qvec</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">uvec</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">vvec</span><span class="p">}</span>

        <span class="k">elif</span> <span class="n">polrep_out</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
                <span class="n">imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span><span class="p">,</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">,</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">,</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">lrvec</span><span class="p">}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rrvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                    <span class="n">llvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rrvec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span>
                    <span class="n">llvec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span>

                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rlvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                    <span class="n">lrvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">rlvec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span>
                    <span class="n">lrvec</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">-</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span>

                <span class="n">imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;RR&#39;</span><span class="p">:</span> <span class="n">rrvec</span><span class="p">,</span> <span class="s1">&#39;LL&#39;</span><span class="p">:</span> <span class="n">llvec</span><span class="p">,</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span> <span class="n">rlvec</span><span class="p">,</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span> <span class="n">lrvec</span><span class="p">}</span>

        <span class="c1"># Assemble the new image</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="n">imdict</span><span class="p">[</span><span class="n">pol_prim_out</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for switch_polrep to </span><span class="si">%s</span><span class="s2"> with pol_prim_out=</span><span class="si">%s</span><span class="s2">, </span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span>
                            <span class="p">(</span><span class="n">polrep_out</span><span class="p">,</span> <span class="n">pol_prim_out</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;output image is not defined&quot;</span><span class="p">)</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">argdict</span><span class="p">[</span><span class="s1">&#39;polrep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">polrep_out</span>
        <span class="n">argdict</span><span class="p">[</span><span class="s1">&#39;pol_prim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">pol_prim_out</span>
        <span class="n">newim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Add in any other polarizations</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="n">newim</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="n">imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
                <span class="n">newim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Add in spectral index</span>
        <span class="n">newim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">newim</span></div>

<div class="viewcode-block" id="Image.flip_chi"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.flip_chi">[docs]</a>    <span class="k">def</span> <span class="nf">flip_chi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Flip between the different conventions for measuring the EVPA (E of N vs N of E).</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): image with flipped EVPA</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">im</span><span class="o">.</span><span class="n">qvec</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>

        <span class="k">elif</span> <span class="n">im</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">im</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">lrvec</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">rlvec</span> <span class="o">=</span> <span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">rlvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im</span></div>

<div class="viewcode-block" id="Image.orth_chi"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.orth_chi">[docs]</a>    <span class="k">def</span> <span class="nf">orth_chi</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rotate the EVPA 90 degrees</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): image with rotated EVPA</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">im</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">im</span><span class="o">.</span><span class="n">uvec</span> <span class="o">*=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">elif</span> <span class="n">im</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">im</span><span class="o">.</span><span class="n">lrvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">rlvec</span><span class="p">)</span>
            <span class="n">im</span><span class="o">.</span><span class="n">rlvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">conjugate</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">rlvec</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">im</span></div>

<div class="viewcode-block" id="Image.get_image_mf"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.get_image_mf">[docs]</a>    <span class="k">def</span> <span class="nf">get_image_mf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nu</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get image at a given frequency given the spectral information in self._mflist</span>

<span class="sd">           Args:</span>
<span class="sd">               nu (float): frequency in Hz</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): image at the desired frequency</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># TODO -- what to do about polarization? Faraday rotation?</span>

        <span class="n">nuref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span>
        <span class="n">log_nufrac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">nu</span> <span class="o">/</span> <span class="n">nuref</span><span class="p">)</span>
        <span class="n">log_imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">log_imvec</span> <span class="o">+=</span> <span class="n">mfvec</span> <span class="o">*</span> <span class="p">(</span><span class="n">log_nufrac</span><span class="o">**</span><span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">log_imvec</span><span class="p">)</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">argdict</span><span class="p">[</span><span class="s1">&#39;rf&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nu</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Copy over all polarization images -- unchanged for now</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">copy_pol_images</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

        <span class="c1"># DON&#39;T copy over spectral index information for now</span>
        <span class="c1"># outim._mflist = copy.deepcopy(self._mflist)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.imarr"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.imarr">[docs]</a>    <span class="k">def</span> <span class="nf">imarr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the 2D image array of a given pol parameter.</span>

<span class="sd">           Args:</span>
<span class="sd">               pol (str): I,Q,U or V for Stokes, or RR,LL,LR,RL for Circ</span>

<span class="sd">           Returns:</span>
<span class="sd">               (numpy.array): 2D image array of dimension (ydim, xdim)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span>

        <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polvec</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
        <span class="k">return</span>  <span class="n">imarr</span>

<span class="c1">#        imarr = np.array([])</span>
<span class="c1">#        if self.polrep == &#39;stokes&#39;:</span>
<span class="c1">#            if pol == &quot;I&quot; and len(self.ivec):</span>
<span class="c1">#                imarr = self.ivec.reshape(self.ydim, self.xdim)</span>
<span class="c1">#            elif pol == &quot;Q&quot; and len(self.qvec):</span>
<span class="c1">#                imarr = self.qvec.reshape(self.ydim, self.xdim)</span>
<span class="c1">#            elif pol == &quot;U&quot; and len(self.uvec):</span>
<span class="c1">#                imarr = self.uvec.reshape(self.ydim, self.xdim)</span>
<span class="c1">#            elif pol == &quot;V&quot; and len(self.vvec):</span>
<span class="c1">#                imarr = self.vvec.reshape(self.ydim, self.xdim)</span>
<span class="c1">#        elif self.polrep == &#39;circ&#39;:</span>
<span class="c1">#            if pol == &quot;RR&quot; and len(self.rrvec):</span>
<span class="c1">#                imarr = self.rrvec.reshape(self.ydim, self.xdim)</span>
<span class="c1">#            elif pol == &quot;LL&quot; and len(self.llvec):</span>
<span class="c1">#                imarr = self.llvec.reshape(self.ydim, self.xdim)</span>
<span class="c1">#            elif pol == &quot;RL&quot; and len(self.rlvec):</span>
<span class="c1">#                imarr = self.rlvec.reshape(self.ydim, self.xdim)</span>
<span class="c1">#            elif pol == &quot;LR&quot; and len(self.lrvec):</span>
<span class="c1">#                imarr = self.lrvec.reshape(self.ydim, self.xdim)</span>

        <span class="k">return</span> <span class="n">imarr</span></div>

<div class="viewcode-block" id="Image.sourcevec"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.sourcevec">[docs]</a>    <span class="k">def</span> <span class="nf">sourcevec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the source position vector in geocentric coordinates at 0h GMST.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (numpy.array): normal vector pointing to source in geocentric coordinates (m)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sourcevec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span><span class="p">),</span> <span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span><span class="p">)])</span>
        <span class="k">return</span> <span class="n">sourcevec</span></div>

<div class="viewcode-block" id="Image.fovx"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fovx">[docs]</a>    <span class="k">def</span> <span class="nf">fovx</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the image fov in x direction in radians.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image fov in x direction (radian)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span></div>

<div class="viewcode-block" id="Image.fovy"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fovy">[docs]</a>    <span class="k">def</span> <span class="nf">fovy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Returns the image fov in y direction in radians.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image fov in y direction (radian)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span></div>

<div class="viewcode-block" id="Image.total_flux"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.total_flux">[docs]</a>    <span class="k">def</span> <span class="nf">total_flux</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total flux of the image in Jy.</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image total flux (Jy)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span><span class="p">)</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">flux</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span><span class="p">)</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">flux</span></div>

<div class="viewcode-block" id="Image.lin_polfrac"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.lin_polfrac">[docs]</a>    <span class="k">def</span> <span class="nf">lin_polfrac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total fractional linear polarized flux</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image fractional linear polarized flux</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">frac</span></div>

<div class="viewcode-block" id="Image.evpa"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.evpa">[docs]</a>    <span class="k">def</span> <span class="nf">evpa</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total evpa</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image average evpa (E of N) in radian</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">uvec</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rlvec</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">frac</span></div>

<div class="viewcode-block" id="Image.circ_polfrac"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.circ_polfrac">[docs]</a>    <span class="k">def</span> <span class="nf">circ_polfrac</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the total fractional circular polarized flux</span>

<span class="sd">           Args:</span>

<span class="sd">           Returns:</span>
<span class="sd">                (float) : image fractional circular polarized flux</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ivec</span><span class="p">))</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">frac</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rrvec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">llvec</span><span class="p">))</span>

        <span class="k">return</span> <span class="n">frac</span></div>

<div class="viewcode-block" id="Image.center"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.center">[docs]</a>    <span class="k">def</span> <span class="nf">center</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Center the image based on the coordinates of the centroid().</span>
<span class="sd">           A non-integer shift is used, which wraps the image when rotating.</span>

<span class="sd">           Args:</span>
<span class="sd">                pol (str): The polarization for which to find the image centroid</span>

<span class="sd">           Returns:</span>
<span class="sd">               (np.array): centroid positions (x0,y0) in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">shift_fft</span><span class="p">(</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">(</span><span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">))</span></div>

<div class="viewcode-block" id="Image.centroid"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.centroid">[docs]</a>    <span class="k">def</span> <span class="nf">centroid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compute the location of the image centroid (corresponding to the polarization pol)</span>

<span class="sd">           Args:</span>
<span class="sd">                pol (str): The polarization for which to find the image centroid</span>

<span class="sd">           Returns:</span>
<span class="sd">               (np.array): centroid positions (x0,y0) in radians</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_polvec</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
        <span class="n">pdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>

<span class="c1">#        if not (pol in list(self._imdict.keys())):</span>
<span class="c1">#            raise Exception(&quot;for polrep==%s, pol must be in &quot; %</span>
<span class="c1">#                            self.polrep + &quot;,&quot;.join(list(self._imdict.keys())))</span>
<span class="c1">#        imvec = self._imdict[pol]</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
            <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">x0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">ylist</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="n">xlist</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">*</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
            <span class="n">y0</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">ylist</span><span class="p">,</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">xlist</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">*</span> <span class="n">imvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
            <span class="n">centroid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x0</span><span class="p">,</span> <span class="n">y0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;No </span><span class="si">%s</span><span class="s2"> image found!&quot;</span> <span class="o">%</span> <span class="n">pol</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">centroid</span></div>

<div class="viewcode-block" id="Image.pad"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.pad">[docs]</a>    <span class="k">def</span> <span class="nf">pad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fovx</span><span class="p">,</span> <span class="n">fovy</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Pad an image to new fov_x by fov_y in radian.</span>
<span class="sd">           Args:</span>
<span class="sd">                fovx  (float): new fov in x dimension (rad)</span>
<span class="sd">                fovy  (float): new fov in y dimension (rad)</span>

<span class="sd">           Returns:</span>
<span class="sd">                im_pad (Image): padded image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Find pad widths</span>
        <span class="n">fovoldx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovx</span><span class="p">()</span>
        <span class="n">fovoldy</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovy</span><span class="p">()</span>
        <span class="n">padx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">fovx</span> <span class="o">-</span> <span class="n">fovoldx</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span>
        <span class="n">pady</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="n">fovy</span> <span class="o">-</span> <span class="n">fovoldy</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span>

        <span class="c1"># Pad main image vector</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="p">((</span><span class="n">pady</span><span class="p">,</span> <span class="n">pady</span><span class="p">),</span> <span class="p">(</span><span class="n">padx</span><span class="p">,</span> <span class="n">padx</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>

        <span class="c1"># Make new image</span>
        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Pad all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="p">((</span><span class="n">pady</span><span class="p">,</span> <span class="n">pady</span><span class="p">),</span> <span class="p">(</span><span class="n">padx</span><span class="p">,</span> <span class="n">padx</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Add in spectral index</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">mfvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">mfarr</span><span class="p">,</span> <span class="p">((</span><span class="n">pady</span><span class="p">,</span> <span class="n">pady</span><span class="p">),</span> <span class="p">(</span><span class="n">padx</span><span class="p">,</span> <span class="n">padx</span><span class="p">)),</span> <span class="s1">&#39;constant&#39;</span><span class="p">)</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.resample_square"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.resample_square">[docs]</a>    <span class="k">def</span> <span class="nf">resample_square</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xdim_new</span><span class="p">,</span> <span class="n">ker_size</span><span class="o">=</span><span class="mi">5</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Exactly resample a square image to new dimensions using the pulse function.</span>

<span class="sd">           Args:</span>
<span class="sd">                xdim_new  (int): new pixel dimension</span>
<span class="sd">                ker_size  (int): kernel size for resampling</span>

<span class="sd">           Returns:</span>
<span class="sd">                im_resampled (Image): resampled image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">!=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Image must be square to use Image.resample_square!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span> <span class="o">==</span> <span class="n">pulses</span><span class="o">.</span><span class="n">deltaPulse2D</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Image.resample_squre does not work with delta pulses!&quot;</span><span class="p">)</span>

        <span class="n">ydim_new</span> <span class="o">=</span> <span class="n">xdim_new</span>
        <span class="n">fov</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">psize_new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">fov</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">xdim_new</span><span class="p">)</span>

        <span class="c1"># Define an interpolation function using the pulse</span>
        <span class="n">ij</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[[</span><span class="n">i</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span>
                         <span class="n">j</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">]</span>
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                        <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

        <span class="k">def</span> <span class="nf">im_new_val</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span><span class="p">):</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x_idx</span> <span class="o">*</span> <span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span> <span class="o">*</span> <span class="n">xdim_new</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y_idx</span> <span class="o">*</span> <span class="n">psize_new</span> <span class="o">+</span> <span class="p">(</span><span class="n">psize_new</span> <span class="o">*</span> <span class="n">ydim_new</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">psize_new</span> <span class="o">/</span> <span class="mf">2.0</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="p">(((</span><span class="n">x</span> <span class="o">-</span> <span class="n">ker_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span> <span class="o">*</span>
                    <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">ker_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span> <span class="o">*</span>
                    <span class="p">((</span><span class="n">y</span> <span class="o">-</span> <span class="n">ker_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">ij</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">])</span> <span class="o">*</span>
                    <span class="p">(</span><span class="n">ij</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">y</span> <span class="o">+</span> <span class="n">ker_size</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">))</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">([</span><span class="n">imvec</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">y</span> <span class="o">-</span> <span class="n">ij</span><span class="p">[</span><span class="n">n</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">dom</span><span class="o">=</span><span class="s2">&quot;I&quot;</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">))[</span><span class="n">mask</span><span class="p">]])</span>
            <span class="k">return</span> <span class="n">interp</span>

        <span class="k">def</span> <span class="nf">im_new</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
            <span class="n">imarr_new</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">im_new_val</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">x_idx</span><span class="p">,</span> <span class="n">y_idx</span><span class="p">)</span>
                                  <span class="k">for</span> <span class="n">x_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">xdim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)]</span>
                                  <span class="k">for</span> <span class="n">y_idx</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="n">ydim_new</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)])</span>
            <span class="k">return</span> <span class="n">imarr_new</span>

        <span class="c1"># Compute new primary image vector</span>
        <span class="n">imarr_new</span> <span class="o">=</span> <span class="n">im_new</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="c1"># Normalize</span>
        <span class="n">scaling</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">imarr_new</span><span class="p">)</span>
        <span class="n">imarr_new</span> <span class="o">*=</span> <span class="n">scaling</span>

        <span class="c1"># Make new image</span>
        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr_new</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psize_new</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Interpolate all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr_new</span> <span class="o">=</span> <span class="n">im_new</span><span class="p">(</span><span class="n">polvec</span><span class="p">)</span>
                <span class="n">polarr_new</span> <span class="o">*=</span> <span class="n">scaling</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr_new</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Interpolate spectral index and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;WARNING: resample_squre not debugged for spectral index resampling!&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">im_new</span><span class="p">(</span><span class="n">mfvec</span><span class="p">)</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.regrid_image"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.regrid_image">[docs]</a>    <span class="k">def</span> <span class="nf">regrid_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">targetfov</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;linear&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Resample the image to new (square) dimensions.</span>

<span class="sd">           Args:</span>
<span class="sd">                targetfov  (float): new field of view (radian)</span>
<span class="sd">                npix  (int): new pixel dimension</span>
<span class="sd">                interp (&#39;linear&#39;, &#39;cubic&#39;, &#39;quintic&#39;): type of interpolation. default is linear</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): resampled image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">psize_new</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">targetfov</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
        <span class="n">fov_x</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovx</span><span class="p">()</span>
        <span class="n">fov_y</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovy</span><span class="p">()</span>

        <span class="c1"># define an interpolation function</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">fov_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fov_x</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">fov_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">fov_y</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span>

        <span class="n">xtarget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">targetfov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">targetfov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
        <span class="n">ytarget</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="o">-</span><span class="n">targetfov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">targetfov</span> <span class="o">/</span> <span class="mi">2</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">interp_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="n">specind</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">interp_imvec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">interp_imvec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span>

            <span class="n">interpfunc</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">interpolate</span><span class="o">.</span><span class="n">interp2d</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">imvec</span><span class="p">,</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)),</span>
                                                    <span class="n">kind</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
            <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">interpfunc</span><span class="p">(</span><span class="n">ytarget</span><span class="p">,</span> <span class="n">xtarget</span><span class="p">)</span>
            <span class="n">tmpimg</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">xtarget</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fov_x</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">tmpimg</span><span class="p">[:,</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ytarget</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">fov_y</span> <span class="o">/</span> <span class="mf">2.</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">specind</span><span class="p">:</span> <span class="c1"># adjust pixel size if not a spectral index map</span>
                <span class="n">tmpimg</span> <span class="o">=</span> <span class="n">tmpimg</span> <span class="o">*</span> <span class="p">(</span><span class="n">psize_new</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">return</span> <span class="n">tmpimg</span>

        <span class="c1"># Make new image</span>
        <span class="n">imarr_new</span> <span class="o">=</span> <span class="n">interp_imvec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr_new</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">psize_new</span>

        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Interpolate all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr_new</span> <span class="o">=</span> <span class="n">interp_imvec</span><span class="p">(</span><span class="n">polvec</span><span class="p">)</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr_new</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Interpolate spectral index and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">interp_imvec</span><span class="p">(</span><span class="n">mfvec</span><span class="p">,</span> <span class="n">specind</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.rotate"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.rotate">[docs]</a>    <span class="k">def</span> <span class="nf">rotate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;cubic&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Rotate the image counterclockwise by the specified angle.</span>

<span class="sd">           Args:</span>
<span class="sd">                angle  (float): CCW angle to rotate the image (radian)</span>
<span class="sd">                interp (&#39;linear&#39;, &#39;cubic&#39;, &#39;quintic&#39;): type of interpolation. default is cubic</span>
<span class="sd">           Returns:</span>
<span class="sd">                (Image): resampled image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">order</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">if</span> <span class="n">interp</span> <span class="o">==</span> <span class="s1">&#39;linear&#39;</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="mi">1</span>
        <span class="k">elif</span> <span class="n">interp</span> <span class="o">==</span> <span class="s1">&#39;cubic&#39;</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="mi">3</span>
        <span class="k">elif</span> <span class="n">interp</span> <span class="o">==</span> <span class="s1">&#39;quintic&#39;</span><span class="p">:</span>
            <span class="n">order</span> <span class="o">=</span> <span class="mi">5</span>

        <span class="c1"># Define an interpolation function</span>
        <span class="k">def</span> <span class="nf">rot_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">rot_imvec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">rot_imvec</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span>
            <span class="n">imarr_rot</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">interpolation</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)),</span>
                                                           <span class="n">angle</span> <span class="o">*</span> <span class="mf">180.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">reshape</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                                                           <span class="n">order</span><span class="o">=</span><span class="n">order</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;constant&#39;</span><span class="p">,</span>
                                                           <span class="n">cval</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">prefilter</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">imarr_rot</span>

        <span class="c1"># pol_prim needs to be RR,LL,I,or V for a simple rotation to work!</span>
        <span class="k">if</span><span class="p">(</span><span class="ow">not</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;RR&#39;</span><span class="p">,</span> <span class="s1">&#39;LL&#39;</span><span class="p">,</span> <span class="s1">&#39;I&#39;</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">])):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;im.pol_prim must be a scalar (&#39;I&#39;,&#39;V&#39;,&#39;RR&#39;,&#39;LL&#39;) for simple rotation!&quot;</span><span class="p">)</span>

        <span class="c1"># Make new image</span>
        <span class="n">imarr_rot</span> <span class="o">=</span> <span class="n">rot_imvec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr_rot</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Rotate all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr_rot</span> <span class="o">=</span> <span class="n">rot_imvec</span><span class="p">(</span><span class="n">polvec</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;RL&#39;</span><span class="p">:</span>
                    <span class="n">polarr_rot</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">angle</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;LR&#39;</span><span class="p">:</span>
                    <span class="n">polarr_rot</span> <span class="o">*=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">angle</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
                    <span class="n">polarr_rot</span> <span class="o">=</span> <span class="n">polarr_rot</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">rot_imvec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;U&#39;</span><span class="p">])</span>
                    <span class="n">polarr_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">polarr_rot</span><span class="p">)</span>
                <span class="k">elif</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
                    <span class="n">polarr_rot</span> <span class="o">=</span> <span class="n">rot_imvec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="s1">&#39;Q&#39;</span><span class="p">])</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">polarr_rot</span>
                    <span class="n">polarr_rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">angle</span><span class="p">)</span> <span class="o">*</span> <span class="n">polarr_rot</span><span class="p">)</span>

                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr_rot</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Rotate spectral index and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">rot_imvec</span><span class="p">(</span><span class="n">mfvec</span><span class="p">)</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.shift"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shiftidx</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shift the image by a given number of pixels.</span>

<span class="sd">         Args:</span>
<span class="sd">             shiftidx (list): pixel offsets [x_offset, y_offset] for the image shift</span>

<span class="sd">         Returns:</span>
<span class="sd">             (Image): shifted images</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define shifting function</span>
        <span class="k">def</span> <span class="nf">shift_imvec</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
            <span class="n">im_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">),</span> <span class="n">shiftidx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">im_shift</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">im_shift</span><span class="p">,</span> <span class="n">shiftidx</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">im_shift</span>

        <span class="c1"># Make new image</span>
        <span class="n">imarr_shift</span> <span class="o">=</span> <span class="n">shift_imvec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr_shift</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Shift all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr_shift</span> <span class="o">=</span> <span class="n">shift_imvec</span><span class="p">(</span><span class="n">polvec</span><span class="p">)</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr_shift</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Shift spectral index and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">shift_imvec</span><span class="p">(</span><span class="n">mfvec</span><span class="p">)</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.shift_fft"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.shift_fft">[docs]</a>    <span class="k">def</span> <span class="nf">shift_fft</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">shift</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shift the image by a given vector in radians.</span>
<span class="sd">           This allows non-integer pixel shifts, via FFT.</span>

<span class="sd">         Args:</span>
<span class="sd">             shift (list): offsets [x_offset, y_offset] for the image shift in radians</span>

<span class="sd">         Returns:</span>
<span class="sd">             (Image): shifted image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">Nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span>
        <span class="n">Ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span>

        <span class="p">[</span><span class="n">dx_pixels</span><span class="p">,</span> <span class="n">dy_pixels</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">shift</span><span class="p">)</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>

        <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">Nx</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">Ny</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">Ny</span><span class="p">))</span>
        <span class="n">rotate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span> <span class="n">dx_pixels</span> <span class="o">+</span> <span class="n">t</span> <span class="o">*</span> <span class="n">dy_pixels</span><span class="p">)</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">Nx</span><span class="p">))</span>

        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>
        <span class="n">imarr_rotate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span> <span class="o">*</span> <span class="n">rotate</span><span class="p">))</span>

        <span class="c1"># make new Image</span>
        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr_rotate</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Shift all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">imarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>
                <span class="n">imarr_rotate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span> <span class="o">*</span> <span class="n">rotate</span><span class="p">))</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">imarr_rotate</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Shift spectral index and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">mfvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">mfarr</span><span class="p">)</span> <span class="o">*</span> <span class="n">rotate</span><span class="p">))</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.blur_gauss"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.blur_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">blur_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">1.</span><span class="p">,</span> <span class="n">frac_pol</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Blur image with a Gaussian beam w/ beamparams [fwhm_max, fwhm_min, theta] in radians.</span>

<span class="sd">           Args:</span>
<span class="sd">               beamparams (list): [fwhm_maj, fwhm_min, theta, x, y] in radians</span>
<span class="sd">               frac (float): fractional beam size for blurring the main image</span>
<span class="sd">               frac_pol (float): fractional beam size for blurring the other polarizations</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">frac</span> <span class="o">&lt;=</span> <span class="mf">0.0</span> <span class="ow">or</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Make a Gaussian image</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>

        <span class="k">def</span> <span class="nf">gaussim</span><span class="p">(</span><span class="n">blurfrac</span><span class="p">):</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">(</span><span class="n">j</span> <span class="o">*</span> <span class="n">cth</span> <span class="o">+</span> <span class="n">i</span> <span class="o">*</span> <span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">blurfrac</span> <span class="o">*</span> <span class="n">sigma_maj</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">-</span>
                                       <span class="p">(</span><span class="n">i</span> <span class="o">*</span> <span class="n">cth</span> <span class="o">-</span> <span class="n">j</span> <span class="o">*</span> <span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">blurfrac</span> <span class="o">*</span> <span class="n">sigma_min</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
                               <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                               <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">gauss</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gauss</span><span class="p">)</span>  <span class="c1"># normalize to 1</span>
            <span class="k">return</span> <span class="n">gauss</span>

        <span class="n">gauss</span> <span class="o">=</span> <span class="n">gaussim</span><span class="p">(</span><span class="n">frac</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">frac_pol</span><span class="p">:</span>
            <span class="n">gausspol</span> <span class="o">=</span> <span class="n">gaussim</span><span class="p">(</span><span class="n">frac_pol</span><span class="p">)</span>

        <span class="c1"># Define a convolution function</span>
        <span class="k">def</span> <span class="nf">blur</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">gauss</span><span class="p">):</span>
            <span class="n">imarr_blur</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">signal</span><span class="o">.</span><span class="n">fftconvolve</span><span class="p">(</span><span class="n">gauss</span><span class="p">,</span> <span class="n">imarr</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;same&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">imarr_blur</span>

        <span class="c1"># Convolve the primary image</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
        <span class="n">imarr_blur</span> <span class="o">=</span> <span class="n">blur</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span>

        <span class="c1"># Make new image object</span>
        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr_blur</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Blur all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">frac_pol</span><span class="p">:</span>
                    <span class="n">polarr</span> <span class="o">=</span> <span class="n">blur</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">gausspol</span><span class="p">)</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Blur spectral index and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">mfvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float64&#39;</span><span class="p">)</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">blur</span><span class="p">(</span><span class="n">mfarr</span><span class="p">,</span> <span class="n">gauss</span><span class="p">)</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.blur_circ"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.blur_circ">[docs]</a>    <span class="k">def</span> <span class="nf">blur_circ</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fwhm_i</span><span class="p">,</span> <span class="n">fwhm_pol</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">filttype</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a circular gaussian filter to the image, with FWHM in radians.</span>

<span class="sd">           Args:</span>
<span class="sd">               fwhm_i (float): circular beam size for Stokes I  blurring in  radian</span>
<span class="sd">               fwhm_pol (float): circular beam size for Stokes Q,U,V  blurring in  radian</span>
<span class="sd">               filttype (str): &quot;gauss&quot; or &quot;butter&quot; </span>
<span class="sd">               </span>
<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhm_i</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">sigmap</span> <span class="o">=</span> <span class="n">sigma</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">fwhmp</span> <span class="o">=</span> <span class="n">fwhm_i</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">fwhmp_pol</span> <span class="o">=</span> <span class="n">fwhm_pol</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        
        <span class="c1"># Define a convolution function</span>
        <span class="k">def</span> <span class="nf">blur_gauss</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">):</span>
            <span class="n">sigma</span> <span class="o">=</span> <span class="n">fwhmp</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">blur</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imarr</span><span class="p">),</span> <span class="n">sigma</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">blur</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imarr</span><span class="p">),</span> <span class="n">sigma</span><span class="p">)</span>
            <span class="n">imarr_blur</span> <span class="o">=</span> <span class="n">filt</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="p">(</span><span class="n">sigma</span><span class="p">,</span> <span class="n">sigma</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">imarr_blur</span>
            
        <span class="k">def</span> <span class="nf">blur_butter</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">size</span><span class="p">):</span>

            <span class="c1">#bfilt  = scipy.signal.butter(2,freq,btype=&#39;low&#39;,output=&#39;sos&#39;)</span>
            <span class="c1">#if np.any(np.imag(imarr) != 0):</span>
            <span class="c1">#    return blur(np.real(imarr), sigma) + 1j * blur(np.imag(imarr), sigma)</span>
                
            <span class="c1">#imarr_blur = scipy.signal.sosfilt(bfilt, imarr, axis=0)</span>
            <span class="c1">#imarr_blur = scipy.signal.sosfilt(bfilt, imarr_blur, axis=1)            </span>

            <span class="k">if</span> <span class="n">size</span><span class="o">==</span><span class="mi">0</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">imarr</span>
            
            <span class="n">cutoff</span> <span class="o">=</span> <span class="mi">1</span><span class="o">/</span><span class="n">size</span>    
            <span class="n">Nx</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span>
            <span class="n">Ny</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span>

            <span class="n">s</span><span class="p">,</span> <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">Nx</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">Ny</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.0</span> <span class="p">))</span>
            <span class="c1">#s, t = np.meshgrid(np.fft.fftfreq(Nx, d=1.0 / Nx), np.fft.fftfreq(Ny, d=1.0 / Ny))</span>
            <span class="n">r</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">s</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">t</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            
            <span class="n">bfilt</span> <span class="o">=</span> <span class="mf">1.</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="p">(</span><span class="n">r</span><span class="o">/</span><span class="n">cutoff</span><span class="p">)</span><span class="o">**</span><span class="mi">4</span><span class="p">)</span>

            <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">Ny</span><span class="p">,</span> <span class="n">Nx</span><span class="p">))</span>
            <span class="n">imarr_filt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span> <span class="o">*</span> <span class="n">bfilt</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">imarr_filt</span>
            
            
        <span class="k">if</span> <span class="n">filttype</span><span class="o">==</span><span class="s1">&#39;gauss&#39;</span><span class="p">:</span>
            <span class="n">blur</span> <span class="o">=</span> <span class="n">blur_gauss</span>
        <span class="k">elif</span> <span class="n">filttype</span><span class="o">==</span><span class="s1">&#39;butter&#39;</span><span class="p">:</span>
            <span class="n">blur</span> <span class="o">=</span> <span class="n">blur_butter</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;filttype not recognized in blur_circ!&quot;</span><span class="p">)</span>
            
        <span class="c1"># Blur the primary image</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="n">imarr_blur</span> <span class="o">=</span> <span class="n">blur</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">fwhmp</span><span class="p">)</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr_blur</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Blur spectral index and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">mfvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">blur</span><span class="p">(</span><span class="n">mfarr</span><span class="p">,</span> <span class="n">fwhmp</span><span class="p">)</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="c1"># Blur all polarizations and copy overi</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">fwhm_pol</span><span class="p">:</span>
                    <span class="c1">#print(&quot;Blurring polarization&quot;)</span>
                    <span class="n">polarr</span> <span class="o">=</span> <span class="n">blur</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">fwhmp_pol</span><span class="p">)</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>


        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.blur_mf"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.blur_mf">[docs]</a>    <span class="k">def</span> <span class="nf">blur_mf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">freqs</span><span class="p">,</span> <span class="n">fwhm</span><span class="p">,</span> <span class="n">fit_order</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">filttype</span><span class="o">=</span><span class="s1">&#39;gauss&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Blur image correctly across multiple frequencies</span>
<span class="sd">           WARNING: does not currently do polarization correctly!</span>

<span class="sd">           Args:</span>
<span class="sd">               freqs (float): Frequencies to include in the blurring &amp; spectral index fit</span>
<span class="sd">               fwhm (float): circular beam size </span>
<span class="sd">               fit_order (int): how many orders to fit spectrum: 1 or 2</span>
<span class="sd">               filttype (str): &quot;gauss&quot; or &quot;butter&quot; </span>
<span class="sd">               </span>
<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image          </span>
<span class="sd">           </span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">fit_order</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">]:</span> 
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;fit_order must be 1 or 2 in blur_mf!&quot;</span><span class="p">)</span>
           
        <span class="n">reffreq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span>

        <span class="c1"># remove any zeros in the images               </span>
        <span class="n">imlist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">get_image_mf</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">blur_circ</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">filttype</span><span class="o">=</span><span class="n">filttype</span><span class="p">)</span> <span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">:</span>
            <span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span>
            
        <span class="n">xfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span><span class="o">/</span><span class="n">reffreq</span><span class="p">)</span>
        <span class="n">yfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">]))</span>
        
        <span class="k">if</span> <span class="n">fit_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span><span class="n">yfit</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    
        <span class="k">elif</span> <span class="n">fit_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span><span class="n">yfit</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    
            <span class="n">beta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">alpha</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">yfit</span>
            <span class="n">beta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">yfit</span>
            
        <span class="n">outim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blur_circ</span><span class="p">(</span><span class="n">kernel</span><span class="p">,</span> <span class="n">filttype</span><span class="o">=</span><span class="n">filttype</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">specvec</span> <span class="o">=</span> <span class="n">alpha</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">curvvec</span> <span class="o">=</span> <span class="n">beta</span>
        <span class="k">return</span> <span class="n">outim</span></div>
        
<div class="viewcode-block" id="Image.grad"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.grad">[docs]</a>    <span class="k">def</span> <span class="nf">grad</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">gradtype</span><span class="o">=</span><span class="s1">&#39;abs&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return the gradient image</span>

<span class="sd">           Args:</span>
<span class="sd">               gradtype (str): &#39;x&#39;,&#39;y&#39;,or &#39;abs&#39; for the image gradient dimension</span>

<span class="sd">           Returns:</span>
<span class="sd">               Image : an image object containing the gradient image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Define the desired gradient function</span>
        <span class="k">def</span> <span class="nf">gradim</span><span class="p">(</span><span class="n">imvec</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">gradim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">gradim</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imvec</span><span class="p">))</span>

            <span class="n">imarr</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

            <span class="c1">#sx = ndi.sobel(imarr, axis=0, mode=&#39;constant&#39;)</span>
            <span class="c1">#sy = ndi.sobel(imarr, axis=1, mode=&#39;constant&#39;)</span>
            <span class="n">sx</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>
            <span class="n">sy</span> <span class="o">=</span> <span class="n">ndi</span><span class="o">.</span><span class="n">sobel</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;nearest&#39;</span><span class="p">)</span>

            <span class="c1"># TODO: are these in the right order??</span>
            <span class="k">if</span> <span class="n">gradtype</span> <span class="o">==</span> <span class="s1">&#39;x&#39;</span><span class="p">:</span>
                <span class="n">gradarr</span> <span class="o">=</span> <span class="n">sx</span>
            <span class="k">if</span> <span class="n">gradtype</span> <span class="o">==</span> <span class="s1">&#39;y&#39;</span><span class="p">:</span>
                <span class="n">gradarr</span> <span class="o">=</span> <span class="n">sy</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">gradarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">hypot</span><span class="p">(</span><span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">gradarr</span>

        <span class="c1"># Find the gradient for the primary image</span>
        <span class="n">gradarr</span> <span class="o">=</span> <span class="n">gradim</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">gradarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Find the gradient for all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">gradarr</span> <span class="o">=</span> <span class="n">gradim</span><span class="p">(</span><span class="n">polvec</span><span class="p">)</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">gradarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Find the spectral index gradients and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfarr</span> <span class="o">=</span> <span class="n">gradim</span><span class="p">(</span><span class="n">mfvec</span><span class="p">)</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">mfarr</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.mask"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.mask">[docs]</a>    <span class="k">def</span> <span class="nf">mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Produce an image mask that shows all pixels above the specified cutoff frac of the max</span>
<span class="sd">           Works off the primary image</span>

<span class="sd">           Args:</span>
<span class="sd">               cutoff (float): mask pixels with intensities greater than cuttoff * max</span>
<span class="sd">               beamparams (list): either [fwhm_maj, fwhm_min, pos_ang] or a single fwhm</span>
<span class="sd">               frac (float): the fraction of nominal beam to blur with</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output mask image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Blur the image</span>
        <span class="k">if</span> <span class="n">beamparams</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="nb">len</span><span class="p">(</span><span class="n">beamparams</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                <span class="n">beamparams</span> <span class="o">=</span> <span class="p">[</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">beamparams</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">frac</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;beamparams should be a length 3 array [maj, min, posang]!&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># Mask pixels outside the desired intensity range</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">intensityrange</span> <span class="o">=</span> <span class="n">maxval</span> <span class="o">-</span> <span class="n">minval</span>
        <span class="n">thresh</span> <span class="o">=</span> <span class="n">intensityrange</span> <span class="o">*</span> <span class="n">cutoff</span> <span class="o">+</span> <span class="n">minval</span>
        <span class="n">maskvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&gt;</span> <span class="n">thresh</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>

        <span class="c1"># make the primary image</span>
        <span class="n">maskarr</span> <span class="o">=</span> <span class="n">maskvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">mask</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">maskarr</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Replace all polarization imvecs with mask</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">mask</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">maskarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># No spectral index information in mask</span>

        <span class="k">return</span> <span class="n">mask</span></div>

    <span class="c1"># TODO make this work with a mask image of different dimensions &amp; fov</span>
<div class="viewcode-block" id="Image.apply_mask"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.apply_mask">[docs]</a>    <span class="k">def</span> <span class="nf">apply_mask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask_im</span><span class="p">,</span> <span class="n">fill_val</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a mask to the image</span>

<span class="sd">           Args:</span>
<span class="sd">               mask_im (Image): a mask image with the same dimensions as the Image</span>
<span class="sd">               fill_val (float): masked pixels of all polarizations are set to this value</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): the masked image</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">!=</span> <span class="n">mask_im</span><span class="o">.</span><span class="n">psize</span><span class="p">)</span> <span class="ow">or</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">!=</span> <span class="n">mask_im</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">!=</span> <span class="n">mask_im</span><span class="o">.</span><span class="n">ydim</span><span class="p">)):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;mask image does not match dimensions of the current image!&quot;</span><span class="p">)</span>

        <span class="c1"># Get the mask vector</span>
        <span class="n">maskvec</span> <span class="o">=</span> <span class="n">mask_im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">bool</span><span class="p">)</span>
        <span class="n">maskvec</span><span class="p">[</span><span class="n">maskvec</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">maskvec</span><span class="p">[</span><span class="n">maskvec</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">1</span>

        <span class="c1"># Mask the primary image</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span>
        <span class="n">imvec</span><span class="p">[</span><span class="o">~</span><span class="n">maskvec</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_val</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Apply mask to all polarizations and copy over</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polvec</span><span class="p">[</span><span class="o">~</span><span class="n">maskvec</span><span class="p">]</span> <span class="o">=</span> <span class="n">fill_val</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Apply mask to spectral index and copy over</span>
        <span class="n">mflist_out</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">mfvec</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">mfvec</span><span class="p">):</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">mfvec</span><span class="p">)</span>
                <span class="n">mfvec_out</span><span class="p">[</span><span class="o">~</span><span class="n">maskvec</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mfvec_out</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>
            <span class="n">mflist_out</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mfvec_out</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">mflist_out</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.threshold"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.threshold">[docs]</a>    <span class="k">def</span> <span class="nf">threshold</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cutoff</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">fill_val</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Apply a hard threshold to the primary polarization image.</span>
<span class="sd">           Leave other polarizations untouched.</span>

<span class="sd">           Args:</span>
<span class="sd">               cutoff (float): Mask pixels with intensities greater than cuttoff * max</span>
<span class="sd">               beamparams (list): either [fwhm_maj, fwhm_min, pos_ang] or a single fwhm</span>
<span class="sd">               frac (float): the fraction of nominal beam to blur with</span>
<span class="sd">               fill_val (float): masked pixels are set to this value.</span>
<span class="sd">                                 If fill_val==None, they are set to the min unmasked value</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output mask image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">fill_val</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">fill_val</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
            <span class="n">minval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
            <span class="n">intensityrange</span> <span class="o">=</span> <span class="n">maxval</span> <span class="o">-</span> <span class="n">minval</span>
            <span class="n">fill_val</span> <span class="o">=</span> <span class="p">(</span><span class="n">intensityrange</span> <span class="o">*</span> <span class="n">cutoff</span> <span class="o">+</span> <span class="n">minval</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mask</span><span class="p">(</span><span class="n">cutoff</span><span class="o">=</span><span class="n">cutoff</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">frac</span><span class="o">=</span><span class="n">frac</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_mask</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">fill_val</span><span class="o">=</span><span class="n">fill_val</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span></div>

<div class="viewcode-block" id="Image.add_flat"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_flat">[docs]</a>    <span class="k">def</span> <span class="nf">add_flat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a flat background flux to the main polarization image.</span>

<span class="sd">           Args:</span>
<span class="sd">                flux  (float): total flux to add to image</span>
<span class="sd">                pol (str): the polarization to add the flux to. None defaults to pol_prim.</span>
<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==</span><span class="si">%s</span><span class="s2">, pol must be in &quot;</span> <span class="o">%</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no image for pol </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Make a flat image array</span>
        <span class="n">flatarr</span> <span class="o">=</span> <span class="p">((</span><span class="n">flux</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)))</span>
        <span class="n">flatarr</span> <span class="o">=</span> <span class="n">flatarr</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

        <span class="c1"># Add to the main image and create the new image object</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">+=</span> <span class="n">flatarr</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Copy over the rest of the polarizations</span>
        <span class="k">for</span> <span class="n">pol2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="n">pol</span><span class="p">:</span>
                    <span class="n">polarr</span> <span class="o">+=</span> <span class="n">flatarr</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol2</span><span class="p">)</span>

        <span class="c1"># Copy the spectral index (unchanged)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.add_tophat"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_tophat">[docs]</a>    <span class="k">def</span> <span class="nf">add_tophat</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add centered tophat flux to the Stokes I image inside a given radius.</span>

<span class="sd">           Args:</span>
<span class="sd">                flux  (float): total flux to add to image</span>
<span class="sd">                radius  (float): radius of top hat flux in radians</span>
<span class="sd">                pol (str): the polarization to add the flux to. None defaults to pol_prim</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==</span><span class="si">%s</span><span class="s2">, pol must be in &quot;</span> <span class="o">%</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no image for pol </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Make a tophat image array</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="n">hatarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mf">1.0</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">i</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">j</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">radius</span> <span class="k">else</span> <span class="mf">0.</span>
                            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                           <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>

        <span class="n">hatarr</span> <span class="o">=</span> <span class="n">hatarr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
        <span class="n">hatarr</span> <span class="o">*=</span> <span class="n">flux</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">hatarr</span><span class="p">)</span>

        <span class="c1"># Add to the main image and create the new image object</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">+=</span> <span class="n">hatarr</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Copy over the rest of the polarizations</span>
        <span class="k">for</span> <span class="n">pol2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="n">pol</span><span class="p">:</span>
                    <span class="n">polarr</span> <span class="o">+=</span> <span class="n">hatarr</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol2</span><span class="p">)</span>

        <span class="c1"># Copy the spectral index (unchanged)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.add_gauss"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">add_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a gaussian to an image.</span>

<span class="sd">           Args:</span>
<span class="sd">               flux (float): the total flux contained in the Gaussian in Jy</span>
<span class="sd">               beamparams (list): [fwhm_maj, fwhm_min, theta, x, y], all in radians</span>
<span class="sd">               pol (str): the polarization to add the flux to. None defaults to pol_prim.</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==</span><span class="si">%s</span><span class="s2">, pol must be in &quot;</span> <span class="o">%</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no image for pol </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Make a Gaussian image</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">4</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">y</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">sigma_maj</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">sigma_min</span> <span class="o">=</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mf">2.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">)))</span>
        <span class="n">cth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">sth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">def</span> <span class="nf">gaussian</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
            <span class="n">gauss</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span><span class="p">((</span><span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cth</span> <span class="o">+</span> <span class="p">(</span><span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_maj</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">+</span>
                           <span class="o">-</span><span class="p">((</span><span class="n">x2</span><span class="p">)</span> <span class="o">*</span> <span class="n">cth</span> <span class="o">-</span> <span class="p">(</span><span class="n">y2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sth</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">sigma_min</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">return</span> <span class="n">gauss</span>

        <span class="n">gaussarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">gaussian</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>
        <span class="n">gaussarr</span> <span class="o">=</span> <span class="n">gaussarr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
        <span class="n">gaussarr</span> <span class="o">*=</span> <span class="n">flux</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">gaussarr</span><span class="p">)</span>

        <span class="c1"># TODO: if we want to add a gaussian to V, we might also want to make sure we add it to I</span>
        <span class="c1"># Add to the main image and create the new image object</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">+=</span> <span class="n">gaussarr</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Copy over the rest of the polarizations</span>
        <span class="k">for</span> <span class="n">pol2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="n">pol</span><span class="p">:</span>
                    <span class="n">polarr</span> <span class="o">+=</span> <span class="n">gaussarr</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol2</span><span class="p">)</span>

        <span class="c1"># Copy the spectral index (unchanged)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.add_crescent"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_crescent">[docs]</a>    <span class="k">def</span> <span class="nf">add_crescent</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">flux</span><span class="p">,</span> <span class="n">Rp</span><span class="p">,</span> <span class="n">Rn</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a crescent to an image; see Kamruddin &amp; Dexter (2013).</span>

<span class="sd">           Args:</span>
<span class="sd">               flux (float): the total flux contained in the crescent in Jy</span>
<span class="sd">               Rp (float): the larger radius in radians</span>
<span class="sd">               Rn (float): the smaller radius in radians</span>
<span class="sd">               a (float): the relative x offset of smaller disk in radians</span>
<span class="sd">               b (float): the relative y offset of smaller disk in radians</span>
<span class="sd">               x (float): the center x coordinate of the larger disk in radians</span>
<span class="sd">               y (float): the center y coordinate of the larger disk in radians</span>
<span class="sd">               pol (str): the polarization to add the flux to. None defaults to pol_prim.</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image add_gaus</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==</span><span class="si">%s</span><span class="s2">, pol must be in &quot;</span> <span class="o">%</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no image for pol </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Make a crescent image</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">def</span> <span class="nf">crescent</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x2</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">y2</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;</span> <span class="n">Rn</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span> <span class="o">&lt;</span> <span class="n">Rp</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">1.0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">crescarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">crescent</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span> <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>
        <span class="n">crescarr</span> <span class="o">=</span> <span class="n">crescarr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>
        <span class="n">crescarr</span> <span class="o">*=</span> <span class="n">flux</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">crescarr</span><span class="p">)</span>

        <span class="c1"># Add to the main image and create the new image object</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">+=</span> <span class="n">crescarr</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Copy over the rest of the polarizations</span>
        <span class="k">for</span> <span class="n">pol2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="n">pol</span><span class="p">:</span>
                    <span class="n">polarr</span> <span class="o">+=</span> <span class="n">crescarr</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol2</span><span class="p">)</span>

        <span class="c1"># Copy the spectral index (unchanged)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.add_ring_m1"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_ring_m1">[docs]</a>    <span class="k">def</span> <span class="nf">add_ring_m1</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">I0</span><span class="p">,</span> <span class="n">I1</span><span class="p">,</span> <span class="n">r0</span><span class="p">,</span> <span class="n">phi</span><span class="p">,</span> <span class="n">sigma</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a ring to an image with an m=1 mode</span>

<span class="sd">           Args:</span>
<span class="sd">               I0 (float):</span>
<span class="sd">               I1 (float):</span>
<span class="sd">               r0 (float): the radius</span>
<span class="sd">               phi (float): angle of m1 mode</span>
<span class="sd">               sigma (float): the blurring size</span>
<span class="sd">               x (float): the center x coordinate of the larger disk in radians</span>
<span class="sd">               y (float): the center y coordinate of the larger disk in radians</span>
<span class="sd">               pol (str): the polarization to add the flux to. None defaults to pol_prim.</span>
<span class="sd">           Returns:</span>
<span class="sd">               (Image): output image add_gaus</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;for polrep==</span><span class="si">%s</span><span class="s2">, pol must be in &quot;</span> <span class="o">%</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">+</span> <span class="s2">&quot;,&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">())))</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;no image for pol </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Make a ring image</span>
        <span class="n">flux</span> <span class="o">=</span> <span class="n">I0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">I1</span>
        <span class="n">phi</span> <span class="o">=</span> <span class="n">phi</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">psize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">+</span> \
            <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="k">def</span> <span class="nf">ringm1</span><span class="p">(</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&gt;</span> <span class="p">(</span><span class="n">r0</span> <span class="o">-</span> <span class="n">psize</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="ow">and</span> <span class="p">(</span><span class="n">x2</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">y2</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">r0</span> <span class="o">+</span> <span class="n">psize</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">:</span>
                <span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">y2</span><span class="p">,</span> <span class="n">x2</span><span class="p">)</span>
                <span class="n">flux</span> <span class="o">=</span> <span class="p">(</span><span class="n">I0</span> <span class="o">-</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">I1</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">theta</span> <span class="o">-</span> <span class="n">phi</span><span class="p">)))</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">r0</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">flux</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="mf">0.0</span>

        <span class="n">ringarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">ringm1</span><span class="p">(</span><span class="n">i</span> <span class="o">-</span> <span class="n">x</span><span class="p">,</span> <span class="n">j</span> <span class="o">-</span> <span class="n">y</span><span class="p">)</span>
                             <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xlist</span><span class="p">]</span>
                            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="n">ylist</span><span class="p">])</span>
        <span class="n">ringarr</span> <span class="o">=</span> <span class="n">ringarr</span><span class="p">[</span><span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="mi">0</span><span class="p">:</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">]</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ringarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="n">outim</span> <span class="o">=</span> <span class="n">outim</span><span class="o">.</span><span class="n">blur_circ</span><span class="p">(</span><span class="n">sigma</span><span class="p">)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">imvec</span> <span class="o">*=</span> <span class="n">flux</span> <span class="o">/</span> <span class="p">(</span><span class="n">outim</span><span class="o">.</span><span class="n">total_flux</span><span class="p">())</span>
        <span class="n">ringarr</span> <span class="o">=</span> <span class="n">outim</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

        <span class="c1"># Add to the main image and create the new image object</span>
        <span class="n">imarr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">+=</span> <span class="n">ringarr</span>

        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">imarr</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Copy over the rest of the polarizations</span>
        <span class="k">for</span> <span class="n">pol2</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol2</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pol2</span> <span class="o">==</span> <span class="n">pol</span><span class="p">:</span>
                    <span class="n">polarr</span> <span class="o">+=</span> <span class="n">ringarr</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol2</span><span class="p">)</span>

        <span class="c1"># Copy the spectral index (unchanged)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.add_const_pol"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_const_pol">[docs]</a>    <span class="k">def</span> <span class="nf">add_const_pol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">angle</span><span class="p">,</span> <span class="n">cmag</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">csign</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an with constant fractional linear and circular polarization</span>

<span class="sd">           Args:</span>
<span class="sd">               mag (float): constant polarization fraction to add to the image</span>
<span class="sd">               angle (float): constant EVPA</span>
<span class="sd">               cmag (float): constant circular polarization fraction to add to the image</span>
<span class="sd">               cmag (int): constant circular polarization sign +/- 1</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">mag</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;fractional polarization magnitude must be between 0 and 1!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">cmag</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;circular polarization magnitude must be between 0 and 1!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">im_stokes</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">im_stokes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_polrep</span><span class="p">(</span><span class="n">polrep_out</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">)</span>
        <span class="n">ivec</span> <span class="o">=</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">ivec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">qvec</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">qimage</span><span class="p">(</span><span class="n">ivec</span><span class="p">,</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ivec</span><span class="p">)),</span> <span class="n">angle</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ivec</span><span class="p">)))</span>
        <span class="n">uvec</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">uimage</span><span class="p">(</span><span class="n">ivec</span><span class="p">,</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ivec</span><span class="p">)),</span> <span class="n">angle</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">ivec</span><span class="p">)))</span>
        <span class="n">vvec</span> <span class="o">=</span> <span class="n">cmag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sign</span><span class="p">(</span><span class="n">csign</span><span class="p">)</span> <span class="o">*</span> <span class="n">ivec</span>

        <span class="c1"># create the new stokes image object</span>
        <span class="n">iarr</span> <span class="o">=</span> <span class="n">ivec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">iarr</span>
        <span class="n">argdict</span><span class="p">[</span><span class="s1">&#39;polrep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stokes&#39;</span>
        <span class="n">argdict</span><span class="p">[</span><span class="s1">&#39;pol_prim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Copy over the rest of the polarizations</span>
        <span class="n">imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">ivec</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">qvec</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">uvec</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">vvec</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="n">imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Copy the spectral index (unchanged)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.add_random_pol"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_random_pol">[docs]</a>    <span class="k">def</span> <span class="nf">add_random_pol</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mag</span><span class="p">,</span> <span class="n">corr</span><span class="p">,</span> <span class="n">cmag</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">ccorr</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Return an image random linear and circular polarizations with certain correlation lengths</span>

<span class="sd">           Args:</span>
<span class="sd">               mag   (float): linear polarization fraction</span>
<span class="sd">               corr  (float): EVPA correlation length (radians)</span>
<span class="sd">               cmag  (float): circular polarization fraction</span>
<span class="sd">               ccorr (float): CP correlation length (radians)</span>
<span class="sd">               seed    (int): Seed for random number generation</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="kn">import</span> <span class="nn">ehtim.scattering.stochastic_optics</span> <span class="k">as</span> <span class="nn">so</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">mag</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;fractional polarization magnitude must be between 0 and 1!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">cmag</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;circular polarization magnitude must be between 0 and 1!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">im_stokes</span> <span class="o">=</span> <span class="bp">self</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">im_stokes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_polrep</span><span class="p">(</span><span class="n">polrep_out</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">)</span>
        <span class="n">ivec</span> <span class="o">=</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">ivec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># create the new stokes image object</span>
        <span class="n">iarr</span> <span class="o">=</span> <span class="n">ivec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">arglist</span><span class="p">,</span> <span class="n">argdict</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">image_args</span><span class="p">()</span>
        <span class="n">arglist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">iarr</span>
        <span class="n">argdict</span><span class="p">[</span><span class="s1">&#39;polrep&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;stokes&#39;</span>
        <span class="n">argdict</span><span class="p">[</span><span class="s1">&#39;pol_prim&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="o">*</span><span class="n">arglist</span><span class="p">,</span> <span class="o">**</span><span class="n">argdict</span><span class="p">)</span>

        <span class="c1"># Make a random phase screen using the scattering tools</span>
        <span class="c1"># Use this screen to define the EVPA</span>
        <span class="n">dist</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="mf">3.086e21</span>
        <span class="n">rdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">corr</span><span class="p">)</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">/</span> <span class="mf">1e3</span>
        <span class="n">theta_mas</span> <span class="o">=</span> <span class="mf">0.37</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rdiff</span> <span class="o">*</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="mf">3600.</span> <span class="o">*</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
        <span class="n">sm</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">ScatteringModel</span><span class="p">(</span><span class="n">scatt_alpha</span><span class="o">=</span><span class="mf">1.67</span><span class="p">,</span> <span class="n">observer_screen_distance</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
                                <span class="n">source_screen_distance</span><span class="o">=</span><span class="mf">1.e5</span> <span class="o">*</span> <span class="n">dist</span><span class="p">,</span>
                                <span class="n">theta_maj_mas_ref</span><span class="o">=</span><span class="n">theta_mas</span><span class="p">,</span> <span class="n">theta_min_mas_ref</span><span class="o">=</span><span class="n">theta_mas</span><span class="p">,</span>
                                <span class="n">r_in</span><span class="o">=</span><span class="n">rdiff</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="mf">1e30</span><span class="p">)</span>
        <span class="n">ep</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">MakeEpsilonScreen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">rngseed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">MakePhaseScreen</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">outim</span><span class="p">,</span> <span class="n">obs_frequency_Hz</span><span class="o">=</span><span class="mf">29.979e9</span><span class="p">)</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">ps</span> <span class="o">=</span> <span class="n">ps</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="p">(</span><span class="mf">1.66</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
        <span class="n">qvec</span> <span class="o">=</span> <span class="n">ivec</span> <span class="o">*</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
        <span class="n">uvec</span> <span class="o">=</span> <span class="n">ivec</span> <span class="o">*</span> <span class="n">mag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>

        <span class="c1"># Make a random phase screen using the scattering tools</span>
        <span class="c1"># Use this screen to define the CP magnitude</span>
        <span class="k">if</span> <span class="n">cmag</span> <span class="o">!=</span> <span class="mf">0.0</span> <span class="ow">and</span> <span class="n">ccorr</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">dist</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">*</span> <span class="mf">3.086e21</span>
            <span class="n">rdiff</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">ccorr</span><span class="p">)</span> <span class="o">*</span> <span class="n">dist</span> <span class="o">/</span> <span class="mf">1e3</span>
            <span class="n">theta_mas</span> <span class="o">=</span> <span class="mf">0.37</span> <span class="o">*</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="n">rdiff</span> <span class="o">*</span> <span class="mf">1000.</span> <span class="o">*</span> <span class="mf">3600.</span> <span class="o">*</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
            <span class="n">sm</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">ScatteringModel</span><span class="p">(</span><span class="n">scatt_alpha</span><span class="o">=</span><span class="mf">1.67</span><span class="p">,</span> <span class="n">observer_screen_distance</span><span class="o">=</span><span class="n">dist</span><span class="p">,</span>
                                    <span class="n">source_screen_distance</span><span class="o">=</span><span class="mf">1.e5</span> <span class="o">*</span> <span class="n">dist</span><span class="p">,</span>
                                    <span class="n">theta_maj_mas_ref</span><span class="o">=</span><span class="n">theta_mas</span><span class="p">,</span> <span class="n">theta_min_mas_ref</span><span class="o">=</span><span class="n">theta_mas</span><span class="p">,</span>
                                    <span class="n">r_in</span><span class="o">=</span><span class="n">rdiff</span> <span class="o">*</span> <span class="mi">2</span><span class="p">,</span> <span class="n">r_out</span><span class="o">=</span><span class="mf">1e30</span><span class="p">)</span>
            <span class="n">ep</span> <span class="o">=</span> <span class="n">so</span><span class="o">.</span><span class="n">MakeEpsilonScreen</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">rngseed</span><span class="o">=</span><span class="n">seed</span> <span class="o">*</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">sm</span><span class="o">.</span><span class="n">MakePhaseScreen</span><span class="p">(</span><span class="n">ep</span><span class="p">,</span> <span class="n">outim</span><span class="p">,</span> <span class="n">obs_frequency_Hz</span><span class="o">=</span><span class="mf">29.979e9</span><span class="p">)</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
            <span class="n">ps</span> <span class="o">=</span> <span class="n">ps</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="p">(</span><span class="mf">1.66</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
            <span class="n">vvec</span> <span class="o">=</span> <span class="n">ivec</span> <span class="o">*</span> <span class="n">cmag</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">ps</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">vvec</span> <span class="o">=</span> <span class="n">ivec</span> <span class="o">*</span> <span class="n">cmag</span>

        <span class="c1"># Copy over the rest of the polarizations</span>
        <span class="n">imdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;I&#39;</span><span class="p">:</span> <span class="n">ivec</span><span class="p">,</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span> <span class="n">qvec</span><span class="p">,</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span> <span class="n">uvec</span><span class="p">,</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span> <span class="n">vvec</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">pol</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;I&#39;</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">polvec</span> <span class="o">=</span> <span class="n">imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">polvec</span><span class="p">):</span>
                <span class="n">polarr</span> <span class="o">=</span> <span class="n">polvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">outim</span><span class="o">.</span><span class="n">add_pol_image</span><span class="p">(</span><span class="n">polarr</span><span class="p">,</span> <span class="n">pol</span><span class="p">)</span>

        <span class="c1"># Copy the spectral index (unchanged)</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_mflist</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.add_const_mf"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_const_mf">[docs]</a>    <span class="k">def</span> <span class="nf">add_const_mf</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">alpha</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a constant spectral index and curvature term</span>

<span class="sd">           Args:</span>
<span class="sd">               alpha (float): spectral index (with no - sign)</span>
<span class="sd">               beta (float): curvature</span>

<span class="sd">           Returns:</span>
<span class="sd">                (Image): output image with constant mf information added</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">avec</span> <span class="o">=</span> <span class="n">alpha</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">))</span>
        <span class="n">bvec</span> <span class="o">=</span> <span class="n">beta</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">))</span>

        <span class="c1"># create the new image object</span>
        <span class="n">outim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">outim</span><span class="o">.</span><span class="n">_mflist</span> <span class="o">=</span> <span class="p">[</span><span class="n">avec</span><span class="p">,</span> <span class="n">bvec</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">outim</span></div>

<div class="viewcode-block" id="Image.add_zblterm"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.add_zblterm">[docs]</a>    <span class="k">def</span> <span class="nf">add_zblterm</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">uv_min</span><span class="p">,</span> <span class="n">zblval</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">new_fov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">gauss_sz</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">gauss_sz_factor</span><span class="o">=</span><span class="mf">0.75</span><span class="p">,</span> <span class="n">debias</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add a large Gaussian term to account for missing flux in the zero baseline.</span>

<span class="sd">            Args:</span>
<span class="sd">                obs : an Obsdata object to determine min non-zero baseline and 0-bl flux</span>
<span class="sd">                uv_min (float): The cutoff in Glambada used to determine what is a 0-bl</span>
<span class="sd">                new_fov (rad): The size of the padded image once the Gaussian is added</span>
<span class="sd">                                (if False it will be set to 3 x the gaussian fwhm)</span>
<span class="sd">                gauss_sz (rad): The size of the Gaussian added to add flux to the 0-bl.</span>
<span class="sd">                                (if False it is computed from the min non-zero baseline)</span>
<span class="sd">                gauss_sz_factor (float): The fraction of the min non-zero baseline</span>
<span class="sd">                                         used to caluclate the Gaussian FWHM.</span>
<span class="sd">                debias (bool): True if you use debiased amplitudes to caluclate the 0-bl flux in Jy</span>

<span class="sd">            Returns:</span>
<span class="sd">                (Image): a padded image with a large Gaussian component</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">gauss_sz</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">obs_flag</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">flag_uvdist</span><span class="p">(</span><span class="n">uv_min</span><span class="o">=</span><span class="n">uv_min</span><span class="p">)</span>
            <span class="n">minuvdist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">obs_flag</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;u&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">obs_flag</span><span class="o">.</span><span class="n">data</span><span class="p">[</span><span class="s1">&#39;v&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
            <span class="n">gauss_sz_sigma</span> <span class="o">=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="n">gauss_sz_factor</span> <span class="o">*</span> <span class="n">minuvdist</span><span class="p">))</span>
            <span class="n">gauss_sz</span> <span class="o">=</span> <span class="n">gauss_sz_sigma</span> <span class="o">*</span> <span class="mf">2.355</span>  <span class="c1"># convert from stdev to fwhm</span>

        <span class="n">factor</span> <span class="o">=</span> <span class="mf">5.0</span>
        <span class="k">if</span> <span class="n">new_fov</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">im_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">))</span>
            <span class="n">new_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">gauss_sz</span> <span class="o">/</span> <span class="mf">2.355</span><span class="p">),</span> <span class="n">im_fov</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">new_fov</span> <span class="o">&lt;</span> <span class="n">factor</span> <span class="o">*</span> <span class="p">(</span><span class="n">gauss_sz</span> <span class="o">/</span> <span class="mf">2.355</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING! The specified new fov may not be large enough&#39;</span><span class="p">)</span>

        <span class="c1"># calculate the amount of flux to include in the Gaussian</span>
        <span class="n">obs_zerobl</span> <span class="o">=</span> <span class="n">obs</span><span class="o">.</span><span class="n">flag_uvdist</span><span class="p">(</span><span class="n">uv_max</span><span class="o">=</span><span class="n">uv_min</span><span class="p">)</span>
        <span class="n">obs_zerobl</span><span class="o">.</span><span class="n">add_amp</span><span class="p">(</span><span class="n">debias</span><span class="o">=</span><span class="n">debias</span><span class="p">)</span>
        <span class="n">orig_totflux</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">obs_zerobl</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="s1">&#39;amp&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">obs_zerobl</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">orig_totflux</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">obs_zerobl</span><span class="o">.</span><span class="n">amp</span><span class="p">[</span><span class="s1">&#39;sigma&#39;</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">zblval</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">addedflux</span> <span class="o">=</span> <span class="n">orig_totflux</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">addedflux</span> <span class="o">=</span> <span class="n">orig_totflux</span> <span class="o">-</span> <span class="n">zblval</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Adding a &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">addedflux</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; Jy circular Gaussian of FWHM size &#39;</span> <span class="o">+</span>
              <span class="nb">str</span><span class="p">(</span><span class="n">gauss_sz</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39; uas&#39;</span><span class="p">)</span>

        <span class="n">im_new</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">im_new</span> <span class="o">=</span> <span class="n">im_new</span><span class="o">.</span><span class="n">pad</span><span class="p">(</span><span class="n">new_fov</span><span class="p">,</span> <span class="n">new_fov</span><span class="p">)</span>
        <span class="n">im_new</span> <span class="o">=</span> <span class="n">im_new</span><span class="o">.</span><span class="n">add_gauss</span><span class="p">(</span><span class="n">addedflux</span><span class="p">,</span> <span class="p">(</span><span class="n">gauss_sz</span><span class="p">,</span> <span class="n">gauss_sz</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">im_new</span></div>

<div class="viewcode-block" id="Image.sample_uv"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.sample_uv">[docs]</a>    <span class="k">def</span> <span class="nf">sample_uv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">polrep_obs</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span>
                  <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span>
                  <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                  <span class="n">zero_empty_pol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Sample the image on the selected uv points without creating an Obsdata object.</span>

<span class="sd">           Args:</span>
<span class="sd">               uv (ndarray): an array of uv points</span>
<span class="sd">               polrep_obs (str): &#39;stokes&#39; or &#39;circ&#39; sets the data polarimetric representation</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A*  kernel</span>

<span class="sd">               ttype (str):  &quot;fast&quot; or &quot;nfft&quot; or &quot;direct&quot;</span>
<span class="sd">               cache (bool): Use cached fft for &#39;fast&#39; mode -- deprecated, use nfft instead!</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>
<span class="sd">               zero_empty_pol (bool): if True, returns zero vec if the polarization doesn&#39;t exist.</span>
<span class="sd">                                      Otherwise return None</span>
<span class="sd">               verbose (bool): Boolean value controls output prints.</span>

<span class="sd">           Returns:</span>
<span class="sd">               (list): a list of [I,Q,U,V] visibilities</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">polrep_obs</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="s1">&#39;circ&#39;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;polrep_obs must be either &#39;stokes&#39; or &#39;circ&#39;&quot;</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">sample_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">polrep_obs</span><span class="o">=</span><span class="n">polrep_obs</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span>
                                 <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span>
                                 <span class="n">zero_empty_pol</span><span class="o">=</span><span class="n">zero_empty_pol</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span></div>

<div class="viewcode-block" id="Image.observe_same_nonoise"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_same_nonoise">[docs]</a>    <span class="k">def</span> <span class="nf">observe_same_nonoise</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s2">&quot;nfft&quot;</span><span class="p">,</span>
                             <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                             <span class="n">zero_empty_pol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Observe the image on the same baselines as an existing observation  without noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               obs (Obsdata): the existing observation</span>
<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A*  kernel</span>
<span class="sd">               ttype (str):  &quot;fast&quot; or &quot;nfft&quot; or &quot;direct&quot;</span>
<span class="sd">               cache (bool): Use cached fft for &#39;fast&#39; mode -- deprecated, use nfft instead!</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>
<span class="sd">               zero_empty_pol (bool): if True, returns zero vec if the polarization doesn&#39;t exist.</span>
<span class="sd">                                      Otherwise return None</span>
<span class="sd">               verbose (bool): Boolean value controls output prints.</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object with no noise</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Check for agreement in coordinates and frequency</span>
        <span class="n">tolerance</span> <span class="o">=</span> <span class="mf">1e-8</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span> <span class="o">-</span> <span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dec</span> <span class="o">-</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Image coordinates are not the same as observtion coordinates!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">-</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">)</span> <span class="o">/</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span> <span class="o">&gt;</span> <span class="n">tolerance</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Image frequency is not the same as observation frequency!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;direct&#39;</span> <span class="ow">or</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;fast&#39;</span> <span class="ow">or</span> <span class="n">ttype</span> <span class="o">==</span> <span class="s1">&#39;nfft&#39;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Producing clean visibilities from image with &quot;</span> <span class="o">+</span> <span class="n">ttype</span> <span class="o">+</span> <span class="s2">&quot; FT . . . &quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;ttype=</span><span class="si">%s</span><span class="s2">, options for ttype are &#39;direct&#39;, &#39;fast&#39;, &#39;nfft&#39;&quot;</span> <span class="o">%</span> <span class="n">ttype</span><span class="p">)</span>

        <span class="c1"># Copy data to be safe</span>
        <span class="n">obsdata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>

        <span class="c1"># Extract uv datasample</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">recarr_to_ndarr</span><span class="p">(</span><span class="n">obsdata</span><span class="p">[[</span><span class="s1">&#39;u&#39;</span><span class="p">,</span> <span class="s1">&#39;v&#39;</span><span class="p">]],</span> <span class="s1">&#39;f8&#39;</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">sample_vis</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">polrep_obs</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                 <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">cache</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span>
                                 <span class="n">zero_empty_pol</span><span class="o">=</span><span class="n">zero_empty_pol</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># put visibilities into the obsdata</span>
        <span class="k">if</span> <span class="n">obs</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;vis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;qvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;uvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;vvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="k">elif</span> <span class="n">obs</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
            <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;rrvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;llvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;rlvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span>
                <span class="n">obsdata</span><span class="p">[</span><span class="s1">&#39;lrvis&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span>

        <span class="n">obs_no_noise</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span>
                                             <span class="n">source</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                             <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                             <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">,</span> <span class="n">scantable</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obs_no_noise</span></div>

<div class="viewcode-block" id="Image.observe_same"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_same">[docs]</a>    <span class="k">def</span> <span class="nf">observe_same</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obs_in</span><span class="p">,</span>
                     <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                     <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="n">rlgaincal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                     <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">neggains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                     <span class="n">taup</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span>
                     <span class="n">gain_offset</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span>
                     <span class="n">phase_std</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                     <span class="n">dterm_offset</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">DTERMPDEF</span><span class="p">,</span>
                     <span class="n">rlratio_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">rlphase_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                     <span class="n">sigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phasesigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rlgsigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rlpsigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">caltable_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Observe the image on the same baselines as an existing observation object and add noise.</span>

<span class="sd">           Args:</span>
<span class="sd">               obs_in (Obsdata): the existing observation</span>
<span class="sd">               ttype (str):  &quot;fast&quot; or &quot;nfft&quot; or &quot;direct&quot;</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>

<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A*  kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added</span>

<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix</span>
<span class="sd">                                 (not including random terms) to a priori calibrate data</span>

<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrices.</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to D-terms.</span>
<span class="sd">               rlgaincal (bool): if False, time-dependent gains are not equal for R and L pol</span>
<span class="sd">               stabilize_scan_phase (bool): if True, random phase errors are constant over scans</span>
<span class="sd">               stabilize_scan_amp (bool): if True, random amplitude errors are constant over scans</span>
<span class="sd">               neggains (bool): if True, force the applied gains to be &lt;1</span>

<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">                              or a dict giving one std. dev. per site</span>

<span class="sd">               gain_offset (float): the base gain offset at all sites,</span>
<span class="sd">                                    or a dict giving one gain offset per site</span>
<span class="sd">               phase_std (float): std. dev. of LCP phase,</span>
<span class="sd">                                  or a dict giving one std. dev. per site</span>
<span class="sd">                                  a negative value samples from uniform</span>
<span class="sd">               dterm_offset (float): the base std. dev. of random additive error at all sites,</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>

<span class="sd">               rlratio_std (float): the fractional std. dev. of the R/L gain offset</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>
<span class="sd">               rlphase_std (float): std. dev. of R/L phase offset,</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>
<span class="sd">                                    a negative value samples from uniform</span>

<span class="sd">               sigmat (float): temporal std for a Gaussian Process used to generate gains.</span>
<span class="sd">                               If sigmat=None then an iid gain noise is applied.</span>
<span class="sd">               phasesigmat (float): temporal std for a Gaussian Process used to generate phases.</span>
<span class="sd">                                    If phasesigmat=None then an iid gain noise is applied.</span>
<span class="sd">               rlgsigmat (float): temporal std deviation for a Gaussian Process used to generate R/L gain ratios.</span>
<span class="sd">                               If rlgsigmat=None then an iid gain noise is applied.</span>
<span class="sd">               rlpsigmat (float): temporal std deviation for a Gaussian Process used to generate R/L phase diff.</span>
<span class="sd">                               If rlpsigmat=None then an iid gain noise is applied.</span>

<span class="sd">               caltable_path (string): If not None, path and prefix for saving the applied caltable</span>
<span class="sd">               seed (int): seeds the random component of the noise terms. DO NOT set to 0!</span>
<span class="sd">               verbose (bool): print updates and warnings</span>
<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">seed</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">)</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe_same_nonoise</span><span class="p">(</span><span class="n">obs_in</span><span class="p">,</span> <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span><span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span>
                                        <span class="n">cache</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span>
                                        <span class="n">zero_empty_pol</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Jones Matrix Corruption &amp; Calibration</span>
        <span class="k">if</span> <span class="n">jones</span><span class="p">:</span>
            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">add_jones_and_noise</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                                 <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span>
                                                 <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span>
                                                 <span class="n">rlgaincal</span><span class="o">=</span><span class="n">rlgaincal</span><span class="p">,</span>
                                                 <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="n">stabilize_scan_phase</span><span class="p">,</span>
                                                 <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="n">stabilize_scan_amp</span><span class="p">,</span>
                                                 <span class="n">neggains</span><span class="o">=</span><span class="n">neggains</span><span class="p">,</span>
                                                 <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span>
                                                 <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span>
                                                 <span class="n">phase_std</span><span class="o">=</span><span class="n">phase_std</span><span class="p">,</span>
                                                 <span class="n">dterm_offset</span><span class="o">=</span><span class="n">dterm_offset</span><span class="p">,</span>
                                                 <span class="n">rlratio_std</span><span class="o">=</span><span class="n">rlratio_std</span><span class="p">,</span> <span class="n">rlphase_std</span><span class="o">=</span><span class="n">rlphase_std</span><span class="p">,</span>
                                                 <span class="n">sigmat</span><span class="o">=</span><span class="n">sigmat</span><span class="p">,</span> <span class="n">phasesigmat</span><span class="o">=</span><span class="n">phasesigmat</span><span class="p">,</span>
                                                 <span class="n">rlgsigmat</span><span class="o">=</span><span class="n">rlgsigmat</span><span class="p">,</span><span class="n">rlpsigmat</span><span class="o">=</span><span class="n">rlpsigmat</span><span class="p">,</span>
                                                 <span class="n">caltable_path</span><span class="o">=</span><span class="n">caltable_path</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="n">obs</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span>
                                        <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">obs_in</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                        <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span>
                                        <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                        <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">,</span> <span class="n">scantable</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">inv_jones</span><span class="p">:</span>
                <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">apply_jones_inverse</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span>
                                                     <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span>
                                                     <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

                <span class="n">obs</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span>
                                            <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">obs_in</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                            <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                            <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                            <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">,</span> <span class="n">scantable</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>

        <span class="c1"># No Jones Matrices, Add noise the old way</span>
        <span class="c1"># NOTE There is an asymmetry here - in the old way, we don&#39;t offer the ability to</span>
        <span class="c1"># *not* unscale estimated noise.</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">caltable_path</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;WARNING: the caltable is only saved if you apply noise with a Jones Matrix&#39;</span><span class="p">)</span>

            <span class="c1"># TODO -- clean up arguments</span>
            <span class="n">obsdata</span> <span class="o">=</span> <span class="n">simobs</span><span class="o">.</span><span class="n">add_noise</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                       <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                       <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="n">stabilize_scan_phase</span><span class="p">,</span>
                                       <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="n">stabilize_scan_amp</span><span class="p">,</span>
                                       <span class="n">neggains</span><span class="o">=</span><span class="n">neggains</span><span class="p">,</span>
                                       <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span>
                                       <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span>
                                       <span class="n">sigmat</span><span class="o">=</span><span class="n">sigmat</span><span class="p">,</span>
                                       <span class="n">caltable_path</span><span class="o">=</span><span class="n">caltable_path</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span>
                                       <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="n">obs</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">Obsdata</span><span class="p">(</span><span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">bw</span><span class="p">,</span> <span class="n">obsdata</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">tarr</span><span class="p">,</span>
                                        <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">obs_in</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span>
                                        <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                                        <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                                        <span class="n">timetype</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">timetype</span><span class="p">,</span> <span class="n">scantable</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">scans</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Image.observe"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe">[docs]</a>    <span class="k">def</span> <span class="nf">observe</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">array</span><span class="p">,</span> <span class="n">tint</span><span class="p">,</span> <span class="n">tadv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span>
                <span class="n">mjd</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">timetype</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span> <span class="n">polrep_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">elevmin</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">ELEV_LOW</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">ELEV_HIGH</span><span class="p">,</span>
                <span class="n">no_elevcut_space</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>                
                <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">fix_theta_GMST</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rlgaincal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">neggains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">tau</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span>
                <span class="n">gain_offset</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span>
                <span class="n">phase_std</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">dterm_offset</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">DTERMPDEF</span><span class="p">,</span>
                <span class="n">rlratio_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">rlphase_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                <span class="n">sigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phasesigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rlgsigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rlpsigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">caltable_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate baselines from an array object and observe the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               array (Array): an array object containing sites with which to generate baselines</span>
<span class="sd">               tint (float): the scan integration time in seconds</span>
<span class="sd">               tadv (float): the uniform cadence between scans in seconds</span>
<span class="sd">               tstart (float): the start time of the observation in hours</span>
<span class="sd">               tstop (float): the end time of the observation in hours</span>
<span class="sd">               bw (float): the observing bandwidth in Hz</span>

<span class="sd">               mjd (int): the mjd of the observation, if set as different from the image mjd</span>
<span class="sd">               timetype (str): how to interpret tstart and tstop; either &#39;GMST&#39; or &#39;UTC&#39;</span>
<span class="sd">               polrep_obs (str): &#39;stokes&#39; or &#39;circ&#39; sets the data polarimetric representation</span>
<span class="sd">               elevmin (float): station minimum elevation in degrees</span>
<span class="sd">               elevmax (float): station maximum elevation in degrees</span>
<span class="sd">               no_elevcut_space (bool): if True, do not apply elevation cut to orbiters</span>
<span class="sd">           </span>
<span class="sd">               ttype (str): &quot;fast&quot;, &quot;nfft&quot; or &quot;dtft&quot;</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in the FFT</span>
<span class="sd">               fix_theta_GMST (bool): if True, stops earth rotation to sample fixed u,v</span>

<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A*  kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added</span>

<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects</span>
<span class="sd">                             otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix</span>
<span class="sd">                                 (not including random terms) to calibrate data</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrix.</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrix D-terms.</span>
<span class="sd">               rlgaincal (bool): if False, time-dependent gains are not equal for R and L pol</span>
<span class="sd">               stabilize_scan_phase (bool): if True, random phase errors are constant over scans</span>
<span class="sd">               stabilize_scan_amp (bool): if True, random amplitude errors are constant over scans</span>
<span class="sd">               neggains (bool): if True, force the applied gains to be &lt;1</span>

<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">                              or a dict giving one std. dev. per site</span>

<span class="sd">               gain_offset (float): the base gain offset at all sites,</span>
<span class="sd">                                    or a dict giving one gain offset per site</span>
<span class="sd">               phase_std (float): std. dev. of LCP phase,</span>
<span class="sd">                                  or a dict giving one std. dev. per site</span>
<span class="sd">                                  a negative value samples from uniform</span>
<span class="sd">               dterm_offset (float): the base std. dev. of random additive error at all sites,</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>

<span class="sd">               rlratio_std (float): the fractional std. dev. of the R/L gain offset</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>
<span class="sd">               rlphase_std (float): std. dev. of R/L phase offset,</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>
<span class="sd">                                    a negative value samples from uniform</span>

<span class="sd">               sigmat (float): temporal std for a Gaussian Process used to generate gains.</span>
<span class="sd">                               If sigmat=None then an iid gain noise is applied.</span>
<span class="sd">               phasesigmat (float): temporal std for a Gaussian Process used to generate phases.</span>
<span class="sd">                                    If phasesigmat=None then an iid gain noise is applied.</span>
<span class="sd">               rlgsigmat (float): temporal std deviation for a Gaussian Process used to generate R/L gain ratios.</span>
<span class="sd">                               If rlgsigmat=None then an iid gain noise is applied.</span>
<span class="sd">               rlpsigmat (float): temporal std deviation for a Gaussian Process used to generate R/L phase diff.</span>
<span class="sd">                               If rlpsigmat=None then an iid gain noise is applied.</span>


<span class="sd">               caltable_path (string): If not None, path and prefix for saving the applied caltable</span>
<span class="sd">               seed (int): seeds the random component of the noise terms. DO NOT set to 0!</span>

<span class="sd">               verbose (bool): print updates and warnings</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Generate empty observation</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span> <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Generating empty observation file . . . &quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">mjd</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mjd</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span>
        <span class="k">if</span> <span class="n">polrep_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">polrep_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span>

        <span class="n">obs</span> <span class="o">=</span> <span class="n">array</span><span class="o">.</span><span class="n">obsdata</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">bw</span><span class="p">,</span> <span class="n">tint</span><span class="p">,</span> <span class="n">tadv</span><span class="p">,</span> <span class="n">tstart</span><span class="p">,</span> <span class="n">tstop</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span>
                            <span class="n">polrep</span><span class="o">=</span><span class="n">polrep_obs</span><span class="p">,</span> <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> 
                            <span class="n">elevmin</span><span class="o">=</span><span class="n">elevmin</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="n">elevmax</span><span class="p">,</span> 
                            <span class="n">no_elevcut_space</span><span class="o">=</span><span class="n">no_elevcut_space</span><span class="p">,</span>                            
                            <span class="n">timetype</span><span class="o">=</span><span class="n">timetype</span><span class="p">,</span> <span class="n">fix_theta_GMST</span><span class="o">=</span><span class="n">fix_theta_GMST</span><span class="p">)</span>

        <span class="c1"># Observe on the same baselines as the empty observation and add noise</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe_same</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span>
                                <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                                <span class="n">jones</span><span class="o">=</span><span class="n">jones</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="n">inv_jones</span><span class="p">,</span>
                                <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span>
                                <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span>
                                <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span> <span class="n">rlgaincal</span><span class="o">=</span><span class="n">rlgaincal</span><span class="p">,</span>
                                <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="n">stabilize_scan_phase</span><span class="p">,</span>
                                <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="n">stabilize_scan_amp</span><span class="p">,</span>
                                <span class="n">neggains</span><span class="o">=</span><span class="n">neggains</span><span class="p">,</span>
                                <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span>
                                <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span>
                                <span class="n">phase_std</span><span class="o">=</span><span class="n">phase_std</span><span class="p">,</span>
                                <span class="n">dterm_offset</span><span class="o">=</span><span class="n">dterm_offset</span><span class="p">,</span>
                                <span class="n">rlratio_std</span><span class="o">=</span><span class="n">rlratio_std</span><span class="p">,</span><span class="n">rlphase_std</span><span class="o">=</span><span class="n">rlphase_std</span><span class="p">,</span>
                                <span class="n">sigmat</span><span class="o">=</span><span class="n">sigmat</span><span class="p">,</span><span class="n">phasesigmat</span><span class="o">=</span><span class="n">phasesigmat</span><span class="p">,</span>
                                <span class="n">rlgsigmat</span><span class="o">=</span><span class="n">rlgsigmat</span><span class="p">,</span><span class="n">rlpsigmat</span><span class="o">=</span><span class="n">rlpsigmat</span><span class="p">,</span>
                                <span class="n">caltable_path</span><span class="o">=</span><span class="n">caltable_path</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

        <span class="n">obs</span><span class="o">.</span><span class="n">mjd</span> <span class="o">=</span> <span class="n">mjd</span>

        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Image.observe_vex"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.observe_vex">[docs]</a>    <span class="k">def</span> <span class="nf">observe_vex</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">vex</span><span class="p">,</span> <span class="n">source</span><span class="p">,</span> <span class="n">t_int</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">tight_tadv</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">polrep_obs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ttype</span><span class="o">=</span><span class="s1">&#39;nfft&#39;</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                    <span class="n">fix_theta_GMST</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">sgrscat</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">add_th_noise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">opacitycal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">frcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">rlgaincal</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                    <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">neggains</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                    <span class="n">tau</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">TAUDEF</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span>
                    <span class="n">gain_offset</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">GAINPDEF</span><span class="p">,</span>
                    <span class="n">phase_std</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span>
                    <span class="n">dterm_offset</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">DTERMPDEF</span><span class="p">,</span>
                    <span class="n">rlratio_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span><span class="n">rlphase_std</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                    <span class="n">sigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">phasesigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">rlgsigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">rlpsigmat</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                    <span class="n">caltable_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate baselines from a vex file and observes the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               vex (Vex): an vex object containing sites and scan information</span>
<span class="sd">               source (str): the source to observe</span>

<span class="sd">               t_int (float): if not zero, overrides the vex scan lengths</span>
<span class="sd">               tight_tadv (float): if True, advance right after each integration,</span>
<span class="sd">                                   otherwise advance after 2x the scan length</span>

<span class="sd">               polrep_obs (str): &#39;stokes&#39; or &#39;circ&#39; sets the data polarimetric representation</span>
<span class="sd">               ttype (str): &quot;fast&quot; or &quot;nfft&quot; or &quot;dtft&quot;</span>
<span class="sd">               fft_pad_factor (float): zero pad the image to fft_pad_factor * image size in FFT</span>
<span class="sd">               fix_theta_GMST (bool): if True, stops earth rotation to sample fixed u,v</span>

<span class="sd">               sgrscat (bool): if True, the visibilites will be blurred by the Sgr A*  kernel</span>
<span class="sd">               add_th_noise (bool): if True, baseline-dependent thermal noise is added</span>
<span class="sd">               jones (bool): if True, uses Jones matrix to apply mis-calibration effects</span>
<span class="sd">                             otherwise uses old formalism without D-terms</span>
<span class="sd">               inv_jones (bool): if True, applies estimated inverse Jones matrix</span>
<span class="sd">                                 (not including random terms) to calibrate data</span>
<span class="sd">               opacitycal (bool): if False, time-dependent gaussian errors are added to opacities</span>
<span class="sd">               ampcal (bool): if False, time-dependent gaussian errors are added to station gains</span>
<span class="sd">               phasecal (bool): if False, time-dependent station-based random phases are added</span>
<span class="sd">               frcal (bool): if False, feed rotation angle terms are added to Jones matrix.</span>
<span class="sd">               dcal (bool): if False, time-dependent gaussian errors added to Jones matrix D-terms.</span>
<span class="sd">               rlgaincal (bool): if False, time-dependent gains are not equal for R and L pol</span>
<span class="sd">               stabilize_scan_phase (bool): if True, random phase errors are constant over scans</span>
<span class="sd">               stabilize_scan_amp (bool): if True, random amplitude errors are constant over scans</span>
<span class="sd">               neggains (bool): if True, force the applied gains to be &lt;1</span>

<span class="sd">               tau (float): the base opacity at all sites,</span>
<span class="sd">                            or a dict giving one opacity per site</span>
<span class="sd">               taup (float): the fractional std. dev. of the random error on the opacities</span>
<span class="sd">               gainp (float): the fractional std. dev. of the random error on the gains</span>
<span class="sd">                              or a dict giving one std. dev. per site</span>

<span class="sd">               gain_offset (float): the base gain offset at all sites,</span>
<span class="sd">                                    or a dict giving one gain offset per site</span>
<span class="sd">               phase_std (float): std. dev. of LCP phase,</span>
<span class="sd">                                  or a dict giving one std. dev. per site</span>
<span class="sd">                                  a negative value samples from uniform</span>
<span class="sd">               dterm_offset (float): the base std. dev. of random additive error at all sites,</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>

<span class="sd">               rlratio_std (float): the fractional std. dev. of the R/L gain offset</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>
<span class="sd">               rlphase_std (float): std. dev. of R/L phase offset,</span>
<span class="sd">                                    or a dict giving one std. dev. per site</span>
<span class="sd">                                    a negative value samples from uniform</span>

<span class="sd">               sigmat (float): temporal std for a Gaussian Process used to generate gains.</span>
<span class="sd">                               If sigmat=None then an iid gain noise is applied.</span>
<span class="sd">               phasesigmat (float): temporal std for a Gaussian Process used to generate phases.</span>
<span class="sd">                                    If phasesigmat=None then an iid gain noise is applied.</span>
<span class="sd">               rlgsigmat (float): temporal std deviation for a Gaussian Process used to generate R/L gain ratios.</span>
<span class="sd">                               If rlgsigmat=None then an iid gain noise is applied.</span>
<span class="sd">               rlpsigmat (float): temporal std deviation for a Gaussian Process used to generate R/L phase diff.</span>
<span class="sd">                               If rlpsigmat=None then an iid gain noise is applied.</span>

<span class="sd">               caltable_path (string): If not None, path and prefix for saving the applied caltable</span>
<span class="sd">               seed (int): seeds the random component of the noise terms. DO NOT set to 0!</span>
<span class="sd">               verbose (bool): print updates and warnings</span>

<span class="sd">           Returns:</span>
<span class="sd">               (Obsdata): an observation object</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">polrep_obs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">polrep_obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span>

        <span class="n">t_int_flag</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">t_int</span> <span class="o">==</span> <span class="mf">0.0</span><span class="p">:</span>
            <span class="n">t_int_flag</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Loop over all scans and assemble a list of scan observations</span>
        <span class="n">obs_List</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i_scan</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">)):</span>

            <span class="k">if</span> <span class="n">t_int_flag</span><span class="p">:</span>
                <span class="n">t_int</span> <span class="o">=</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">tight_tadv</span><span class="p">:</span>
                <span class="n">t_adv</span> <span class="o">=</span> <span class="n">t_int</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">t_adv</span> <span class="o">=</span> <span class="mf">2.0</span> <span class="o">*</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">]</span>

            <span class="c1"># If this scan doesn&#39;t observe the source, advance</span>
            <span class="k">if</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;source&#39;</span><span class="p">]</span> <span class="o">!=</span> <span class="n">source</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># What subarray is observing now?</span>
            <span class="n">scankeys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="n">subarray</span> <span class="o">=</span> <span class="n">vex</span><span class="o">.</span><span class="n">array</span><span class="o">.</span><span class="n">make_subarray</span><span class="p">([</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="n">key</span><span class="p">][</span><span class="s1">&#39;site&#39;</span><span class="p">]</span>
                                                <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">scankeys</span><span class="p">])</span>

            <span class="c1"># Observe with the subarray over the scan interval</span>
            <span class="n">t_start</span> <span class="o">=</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;start_hr&#39;</span><span class="p">]</span>
            <span class="n">t_stop</span> <span class="o">=</span> <span class="n">t_start</span> <span class="o">+</span> <span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;scan&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;scan_sec&#39;</span><span class="p">]</span><span class="o">/</span><span class="mf">3600.0</span> <span class="o">-</span> <span class="n">ehc</span><span class="o">.</span><span class="n">EP</span>

            <span class="n">obs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">observe</span><span class="p">(</span><span class="n">subarray</span><span class="p">,</span> <span class="n">t_int</span><span class="p">,</span> <span class="n">t_adv</span><span class="p">,</span> <span class="n">t_start</span><span class="p">,</span> <span class="n">t_stop</span><span class="p">,</span> <span class="n">vex</span><span class="o">.</span><span class="n">bw_hz</span><span class="p">,</span>
                               <span class="n">mjd</span><span class="o">=</span><span class="n">vex</span><span class="o">.</span><span class="n">sched</span><span class="p">[</span><span class="n">i_scan</span><span class="p">][</span><span class="s1">&#39;mjd_floor&#39;</span><span class="p">],</span> <span class="n">timetype</span><span class="o">=</span><span class="s1">&#39;UTC&#39;</span><span class="p">,</span>
                               <span class="n">polrep_obs</span><span class="o">=</span><span class="n">polrep_obs</span><span class="p">,</span>
                               <span class="n">elevmin</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">elevmax</span><span class="o">=</span><span class="mf">89.99</span><span class="p">,</span>
                               <span class="n">ttype</span><span class="o">=</span><span class="n">ttype</span><span class="p">,</span> <span class="n">fft_pad_factor</span><span class="o">=</span><span class="n">fft_pad_factor</span><span class="p">,</span>
                               <span class="n">fix_theta_GMST</span><span class="o">=</span><span class="n">fix_theta_GMST</span><span class="p">,</span>
                               <span class="n">sgrscat</span><span class="o">=</span><span class="n">sgrscat</span><span class="p">,</span>
                               <span class="n">add_th_noise</span><span class="o">=</span><span class="n">add_th_noise</span><span class="p">,</span>
                               <span class="n">jones</span><span class="o">=</span><span class="n">jones</span><span class="p">,</span> <span class="n">inv_jones</span><span class="o">=</span><span class="n">inv_jones</span><span class="p">,</span>
                               <span class="n">opacitycal</span><span class="o">=</span><span class="n">opacitycal</span><span class="p">,</span> <span class="n">ampcal</span><span class="o">=</span><span class="n">ampcal</span><span class="p">,</span> <span class="n">phasecal</span><span class="o">=</span><span class="n">phasecal</span><span class="p">,</span>
                               <span class="n">frcal</span><span class="o">=</span><span class="n">frcal</span><span class="p">,</span> <span class="n">dcal</span><span class="o">=</span><span class="n">dcal</span><span class="p">,</span> <span class="n">rlgaincal</span><span class="o">=</span><span class="n">rlgaincal</span><span class="p">,</span>
                               <span class="n">stabilize_scan_phase</span><span class="o">=</span><span class="n">stabilize_scan_phase</span><span class="p">,</span>
                               <span class="n">stabilize_scan_amp</span><span class="o">=</span><span class="n">stabilize_scan_amp</span><span class="p">,</span>
                               <span class="n">neggains</span><span class="o">=</span><span class="n">neggains</span><span class="p">,</span>
                               <span class="n">tau</span><span class="o">=</span><span class="n">tau</span><span class="p">,</span> <span class="n">taup</span><span class="o">=</span><span class="n">taup</span><span class="p">,</span>
                               <span class="n">gain_offset</span><span class="o">=</span><span class="n">gain_offset</span><span class="p">,</span> <span class="n">gainp</span><span class="o">=</span><span class="n">gainp</span><span class="p">,</span>
                               <span class="n">phase_std</span><span class="o">=</span><span class="n">phase_std</span><span class="p">,</span>
                               <span class="n">dterm_offset</span><span class="o">=</span><span class="n">dterm_offset</span><span class="p">,</span>
                               <span class="n">rlratio_std</span><span class="o">=</span><span class="n">rlratio_std</span><span class="p">,</span><span class="n">rlphase_std</span><span class="o">=</span><span class="n">rlphase_std</span><span class="p">,</span>
                               <span class="n">sigmat</span><span class="o">=</span><span class="n">sigmat</span><span class="p">,</span><span class="n">phasesigmat</span><span class="o">=</span><span class="n">phasesigmat</span><span class="p">,</span>
                               <span class="n">rlgsigmat</span><span class="o">=</span><span class="n">rlgsigmat</span><span class="p">,</span><span class="n">rlpsigmat</span><span class="o">=</span><span class="n">rlpsigmat</span><span class="p">,</span>
                               <span class="n">caltable_path</span><span class="o">=</span><span class="n">caltable_path</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="n">seed</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="n">verbose</span><span class="p">)</span>

            <span class="n">obs_List</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">obs</span><span class="p">)</span>

        <span class="c1"># Merge the scans together</span>
        <span class="n">obs</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">obsdata</span><span class="o">.</span><span class="n">merge_obs</span><span class="p">(</span><span class="n">obs_List</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">obs</span></div>

<div class="viewcode-block" id="Image.compare_images"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.compare_images">[docs]</a>    <span class="k">def</span> <span class="nf">compare_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_compare</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span><span class="n">target_fov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">blur_frac</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                       <span class="n">beamparams</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">metric</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;nxcorr&#39;</span><span class="p">,</span> <span class="s1">&#39;nrmse&#39;</span><span class="p">,</span> <span class="s1">&#39;rssd&#39;</span><span class="p">],</span>
                       <span class="n">blursmall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare to another image by computing normalized cross correlation,</span>
<span class="sd">           normalized root mean squared error, or square root of the sum of squared differences.</span>
<span class="sd">           Returns metrics only for the primary polarization imvec!</span>

<span class="sd">           Args:</span>
<span class="sd">               im_compare (Image): the image to compare to</span>
<span class="sd">               pol (str): which polarization image to compare. Default is self.pol_prim</span>
<span class="sd">               psize (float): pixel size of comparison image (rad).</span>
<span class="sd">                              If None it is the smallest of the input image pizel sizes</span>
<span class="sd">               target_fov (float): fov of the comparison image (rad).</span>
<span class="sd">                              If None it is twice the largest fov of the input images</span>

<span class="sd">               beamparams (list): the nominal Gaussian beam parameters [fovx, fovy, position angle]</span>
<span class="sd">               blur_frac (float): fractional beam to blur each image to before comparison</span>

<span class="sd">               metric (list) : a list of fidelity metrics from [&#39;nxcorr&#39;,&#39;nrmse&#39;,&#39;rssd&#39;]</span>
<span class="sd">               blursmall (bool) : True to blur the unpadded image rather than the large image.</span>
<span class="sd">               shift (int): manual image shift, otherwise use shift from maximum cross-correlation</span>

<span class="sd">           Returns:</span>
<span class="sd">               (tuple): [errormetric, im1_pad, im2_shift]</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">im2</span> <span class="o">=</span> <span class="n">im_compare</span><span class="o">.</span><span class="n">switch_polrep</span><span class="p">(</span><span class="n">polrep_out</span><span class="o">=</span><span class="n">im1</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim_out</span><span class="o">=</span><span class="n">im1</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">im1</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="n">im2</span><span class="o">.</span><span class="n">polrep</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;In find_shift, im1 and im2 must have the same polrep!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">im1</span><span class="o">.</span><span class="n">pol_prim</span> <span class="o">!=</span> <span class="n">im2</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;In find_shift, im1 and im2 must have the same pol_prim!&quot;</span><span class="p">)</span>

        <span class="c1"># Shift the comparison image to maximize normalized cross-corr.</span>
        <span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">xcorr</span><span class="p">,</span> <span class="n">im1_pad</span><span class="p">,</span> <span class="n">im2_pad</span><span class="p">]</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">find_shift</span><span class="p">(</span><span class="n">im2</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">target_fov</span><span class="o">=</span><span class="n">target_fov</span><span class="p">,</span>
                                                        <span class="n">beamparams</span><span class="o">=</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span>
                                                        <span class="n">blur_frac</span><span class="o">=</span><span class="n">blur_frac</span><span class="p">,</span> <span class="n">blursmall</span><span class="o">=</span><span class="n">blursmall</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">idx</span> <span class="o">=</span> <span class="n">shift</span>

        <span class="n">im2_shift</span> <span class="o">=</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># Compute error metrics</span>
        <span class="n">error</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">imvec1</span> <span class="o">=</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">get_polvec</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
        <span class="n">imvec2</span> <span class="o">=</span> <span class="n">im2_shift</span><span class="o">.</span><span class="n">get_polvec</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
        <span class="k">if</span> <span class="s1">&#39;nxcorr&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">xcorr</span><span class="p">[</span><span class="n">idx</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">idx</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">/</span> <span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">))</span>
        <span class="k">if</span> <span class="s1">&#39;nrmse&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imvec1</span> <span class="o">-</span> <span class="n">imvec2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span> <span class="o">/</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">imvec1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span><span class="p">)))</span>
        <span class="k">if</span> <span class="s1">&#39;rssd&#39;</span> <span class="ow">in</span> <span class="n">metric</span><span class="p">:</span>
            <span class="n">error</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">imvec1</span> <span class="o">-</span> <span class="n">imvec2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span> <span class="o">*</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">error</span><span class="p">,</span> <span class="n">im1_pad</span><span class="p">,</span> <span class="n">im2_shift</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.align_images"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.align_images">[docs]</a>    <span class="k">def</span> <span class="nf">align_images</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_list</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">final_fov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span>
                     <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.e3</span><span class="p">]):</span>
        <span class="sd">&quot;&quot;&quot;Align all the images in im_list to the current image (self)</span>
<span class="sd">           Aligns all images by comparison of the primary pol image.</span>

<span class="sd">           Args:</span>
<span class="sd">               im_list (list): list of images to align to the current image</span>
<span class="sd">               shift (list): list of manual image shifts,</span>
<span class="sd">                             otherwise use the shift from maximum cross-correlation</span>
<span class="sd">               pol (str): which polarization image to compare. Default is self.pol_prim</span>
<span class="sd">               final_fov (float): fov of the comparison image (rad).</span>
<span class="sd">                             If False it is the largestinput image fov</span>

<span class="sd">               scale (str) : compare images in &#39;log&#39;,&#39;lin&#39;,or &#39;gamma&#39; scale</span>
<span class="sd">               gamma (float): exponent for gamma scale comparison</span>
<span class="sd">               dynamic_range (float): dynamic range for log and gamma scale comparisons</span>

<span class="sd">           Returns:</span>
<span class="sd">               (tuple): (im_list_shift, shifts, im0_pad)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im0</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">im0</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">polrep</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">im_list</span><span class="p">])):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;In align_images, all images must have the same polrep!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">np</span><span class="o">.</span><span class="n">all</span><span class="p">(</span><span class="n">im0</span><span class="o">.</span><span class="n">pol_prim</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">pol_prim</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">im_list</span><span class="p">])):</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;In find_shift, all images must have the same pol_prim!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dynamic_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dynamic_range</span> <span class="o">=</span> <span class="n">dynamic_range</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">useshift</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">useshift</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="c1"># Find the minimum psize and the maximum field of view</span>
        <span class="n">psize</span> <span class="o">=</span> <span class="n">im0</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">im0</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im0</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im0</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im0</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)):</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">psize</span><span class="p">,</span> <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
            <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">max_fov</span><span class="p">,</span>
                              <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span>
                              <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_fov</span><span class="p">:</span>
            <span class="n">final_fov</span> <span class="o">=</span> <span class="n">max_fov</span>

        <span class="c1"># Shift all images in the list</span>
        <span class="n">im_list_shift</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">shifts</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)):</span>
            <span class="p">(</span><span class="n">idx</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">im0_pad_orig</span><span class="p">,</span> <span class="n">im_pad</span><span class="p">)</span> <span class="o">=</span> <span class="n">im0</span><span class="o">.</span><span class="n">find_shift</span><span class="p">(</span><span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">target_fov</span><span class="o">=</span><span class="mi">2</span> <span class="o">*</span> <span class="n">max_fov</span><span class="p">,</span>
                                                            <span class="n">psize</span><span class="o">=</span><span class="n">psize</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="n">pol</span><span class="p">,</span>
                                                            <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                                                            <span class="n">dynamic_range</span><span class="o">=</span><span class="n">dynamic_range</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">im0_pad_orig</span><span class="o">.</span><span class="n">xdim</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span>
                <span class="n">im0_pad</span> <span class="o">=</span> <span class="n">im0_pad_orig</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">final_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">useshift</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="n">shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>

            <span class="n">tmp</span> <span class="o">=</span> <span class="n">im_pad</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">shifts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>
            <span class="n">im_list_shift</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">tmp</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">final_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">im_list_shift</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">im0_pad</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.find_shift"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.find_shift">[docs]</a>    <span class="k">def</span> <span class="nf">find_shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_compare</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">psize</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_fov</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">beamparams</span><span class="o">=</span><span class="p">[</span><span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">],</span> <span class="n">blur_frac</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">blursmall</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                   <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="mf">1.e3</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Find image shift that maximizes normalized cross correlation with a second image im2.</span>
<span class="sd">           Finds shift only by comparison of the primary pol image.</span>

<span class="sd">           Args:</span>
<span class="sd">               im_compare (Image): image with respect with to switch</span>
<span class="sd">               pol (str): which polarization image to compare. Default is self.pol_prim</span>
<span class="sd">               psize (float): pixel size of comparison image (rad).</span>
<span class="sd">                              If None it is the smallest of the input image pizel sizes</span>
<span class="sd">               target_fov (float): fov of the comparison image (rad).</span>
<span class="sd">                                   If None it is twice the largest fov of the input images</span>

<span class="sd">               beamparams (list): the nominal Gaussian beam parameters [fovx, fovy, position angle]</span>
<span class="sd">               blur_frac (float): fractional beam to blur each image to before comparison</span>
<span class="sd">               blursmall (bool) : True to blur the unpadded image rather than the large image.</span>

<span class="sd">               scale (str) : compare images in &#39;log&#39;,&#39;lin&#39;,or &#39;gamma&#39; scale</span>
<span class="sd">               gamma (float): exponent for gamma scale comparison</span>
<span class="sd">               dynamic_range (float): dynamic range for log and gamma scale comparisons</span>

<span class="sd">           Returns:</span>
<span class="sd">               (tuple): (errormetric, im1_pad, im2_shift)</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">im1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">im2</span> <span class="o">=</span> <span class="n">im_compare</span><span class="o">.</span><span class="n">switch_polrep</span><span class="p">(</span><span class="n">polrep_out</span><span class="o">=</span><span class="n">im1</span><span class="o">.</span><span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim_out</span><span class="o">=</span><span class="n">im1</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">pol</span><span class="o">==</span><span class="s1">&#39;RL&#39;</span> <span class="ow">or</span> <span class="n">pol</span><span class="o">==</span><span class="s1">&#39;LR&#39;</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Find_shift currently doesn&#39;t work with complex RL or LR imvecs!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">im1</span><span class="o">.</span><span class="n">polrep</span> <span class="o">!=</span> <span class="n">im2</span><span class="o">.</span><span class="n">polrep</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;In find_shift, im1 and im2 must have the same polrep!&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">im1</span><span class="o">.</span><span class="n">pol_prim</span> <span class="o">!=</span> <span class="n">im2</span><span class="o">.</span><span class="n">pol_prim</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;In find_shift, im1 and im2 must have the same pol_prim!&quot;</span><span class="p">)</span>

        <span class="c1"># Find maximum FOV and minimum pixel size for comparison</span>
        <span class="k">if</span> <span class="n">target_fov</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">im1</span><span class="o">.</span><span class="n">fovx</span><span class="p">(),</span> <span class="n">im1</span><span class="o">.</span><span class="n">fovy</span><span class="p">(),</span> <span class="n">im2</span><span class="o">.</span><span class="n">fovx</span><span class="p">(),</span> <span class="n">im2</span><span class="o">.</span><span class="n">fovy</span><span class="p">()])</span>
            <span class="n">target_fov</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">max_fov</span>
        <span class="k">if</span> <span class="n">psize</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">im1</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="n">im2</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>

        <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">target_fov</span> <span class="o">/</span> <span class="n">psize</span><span class="p">)</span>

        <span class="c1"># Blur images, then pad</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">blur_frac</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blursmall</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">)):</span>
            <span class="n">im1</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>
            <span class="n">im2</span> <span class="o">=</span> <span class="n">im2</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>

        <span class="n">im1_pad</span> <span class="o">=</span> <span class="n">im1</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">target_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>
        <span class="n">im2_pad</span> <span class="o">=</span> <span class="n">im2</span><span class="o">.</span><span class="n">regrid_image</span><span class="p">(</span><span class="n">target_fov</span><span class="p">,</span> <span class="n">npix</span><span class="p">)</span>

        <span class="c1"># or, pad images, then blur</span>
        <span class="k">if</span> <span class="p">((</span><span class="n">blur_frac</span> <span class="o">&gt;</span> <span class="mf">0.0</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">blursmall</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">)):</span>
            <span class="n">im1_pad</span> <span class="o">=</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>
            <span class="n">im2_pad</span> <span class="o">=</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">blur_gauss</span><span class="p">(</span><span class="n">beamparams</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">,</span> <span class="n">blur_frac</span><span class="p">)</span>

        <span class="c1"># Rescale the image vectors into log or gamma scale</span>
        <span class="c1"># TODO -- what about negative values? complex values?</span>
        <span class="n">im1_pad_vec</span> <span class="o">=</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">get_polvec</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
        <span class="n">im2_pad_vec</span> <span class="o">=</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">get_polvec</span><span class="p">(</span><span class="n">pol</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="n">im1_pad_vec</span><span class="p">[</span><span class="n">im1_pad_vec</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">im1_pad_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">im1_pad_vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im1_pad_vec</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span>
            <span class="n">im2_pad_vec</span><span class="p">[</span><span class="n">im2_pad_vec</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">im2_pad_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">im2_pad_vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im2_pad_vec</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
            <span class="n">im1_pad_vec</span><span class="p">[</span><span class="n">im1_pad_vec</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">im1_pad_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">im1_pad_vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im1_pad_vec</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
            <span class="n">im2_pad_vec</span><span class="p">[</span><span class="n">im2_pad_vec</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
            <span class="n">im2_pad_vec</span> <span class="o">=</span> <span class="p">(</span><span class="n">im2_pad_vec</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im2_pad_vec</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

        <span class="c1"># Normalize images and compute cross correlation with FFT</span>
        <span class="n">im1_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">im1_pad_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im1_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im1_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im1_pad_vec</span><span class="p">))</span>
        <span class="n">im1_norm</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">im1_pad_vec</span><span class="p">)</span>
        <span class="n">im2_norm</span> <span class="o">=</span> <span class="p">(</span><span class="n">im2_pad_vec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im2_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im2_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im2_pad_vec</span><span class="p">))</span>
        <span class="n">im2_norm</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">std</span><span class="p">(</span><span class="n">im2_pad_vec</span><span class="p">)</span>

        <span class="n">fft_im1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">im1_norm</span><span class="p">)</span>
        <span class="n">fft_im2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">im2_norm</span><span class="p">)</span>

        <span class="n">xcorr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">fft</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fft_im1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">conj</span><span class="p">(</span><span class="n">fft_im2</span><span class="p">)))</span>

        <span class="c1"># Find idx of shift that maximized cross-correlation</span>
        <span class="n">idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">xcorr</span><span class="o">.</span><span class="n">argmax</span><span class="p">(),</span> <span class="n">xcorr</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">[</span><span class="n">idx</span><span class="p">,</span> <span class="n">xcorr</span><span class="p">,</span> <span class="n">im1_pad</span><span class="p">,</span> <span class="n">im2_pad</span><span class="p">]</span></div>

<div class="viewcode-block" id="Image.hough_ring"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.hough_ring">[docs]</a>    <span class="k">def</span> <span class="nf">hough_ring</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">edgetype</span><span class="o">=</span><span class="s1">&#39;canny&#39;</span><span class="p">,</span> <span class="n">thresh</span><span class="o">=</span><span class="mf">0.2</span><span class="p">,</span> <span class="n">num_circles</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">radius_range</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                   <span class="n">return_type</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">,</span> <span class="n">display_results</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Use a circular hough transform to find a circle in the image</span>
<span class="sd">           Returns metrics only for the primary polarization imvec!</span>

<span class="sd">           Args:</span>
<span class="sd">               num_circles (int) : number of circles to return</span>
<span class="sd">               radius_range (tuple): range of radii to search in Hough transform, in radian</span>
<span class="sd">               edgetype (str): edge detection type, &#39;gradient&#39; or &#39;canny&#39;</span>
<span class="sd">               thresh(float): fractional threshold for the gradient image</span>
<span class="sd">               display_results (bool): True to display results of the fit</span>
<span class="sd">               return_type (str): &#39;rad&#39; to return in radian, &#39;pixel&#39; to return in pixel units</span>

<span class="sd">           Returns:</span>
<span class="sd">               list : a list of fitted circles (xpos, ypos, radius, objFunc), in radian</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="s1">&#39;skimage&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;scikit-image not installed: cannot use hough_ring!&quot;</span><span class="p">)</span>

        <span class="c1"># coordinate values</span>
        <span class="n">pdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="c1"># normalize to range 0, 1</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">maxval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="n">meanval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="n">im_norm</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="o">/</span> <span class="p">(</span><span class="n">maxval</span> <span class="o">+</span> <span class="o">.</span><span class="mi">01</span> <span class="o">*</span> <span class="n">meanval</span><span class="p">)</span>
        <span class="n">im_norm</span> <span class="o">=</span> <span class="n">im_norm</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;float&#39;</span><span class="p">)</span>  <span class="c1"># is it a problem if it&#39;s double??</span>
        <span class="n">im_norm</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># mask nans to 0</span>
        <span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">im_norm</span>

        <span class="c1"># detect edges</span>
        <span class="k">if</span> <span class="n">edgetype</span> <span class="o">==</span> <span class="s1">&#39;canny&#39;</span><span class="p">:</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">edges</span> <span class="o">=</span> <span class="n">canny</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">high_threshold</span><span class="o">=</span><span class="n">thresh</span><span class="p">,</span> <span class="n">low_threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
            <span class="n">im_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">edges</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">edgetype</span> <span class="o">==</span> <span class="s1">&#39;grad&#39;</span><span class="p">:</span>
            <span class="n">im_edges</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grad</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">thresh_val</span> <span class="o">=</span> <span class="n">thresh</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&gt;</span> <span class="n">thresh_val</span>
                <span class="c1"># im_edges.imvec[mask] = 1</span>
                <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">edges</span> <span class="o">=</span> <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">im_edges</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">thresh</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">thresh_val</span> <span class="o">=</span> <span class="n">thresh</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&gt;</span> <span class="n">thresh_val</span>
                <span class="c1"># im_edges.imvec[mask] = 1f</span>
                <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="o">~</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">edges</span> <span class="o">=</span> <span class="n">im_edges</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

        <span class="c1"># define radius range for Hough transform search</span>
        <span class="k">if</span> <span class="n">radius_range</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">hough_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">10</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">),</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="mi">50</span> <span class="o">*</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">hough_radii</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span>
                <span class="n">radius_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span>
                <span class="n">radius_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span>
                <span class="mi">25</span><span class="p">)</span>

        <span class="c1"># perform the hough transform and select the most prominent circles</span>
        <span class="n">hough_res</span> <span class="o">=</span> <span class="n">hough_circle</span><span class="p">(</span><span class="n">edges</span><span class="p">,</span> <span class="n">hough_radii</span><span class="p">)</span>
        <span class="n">accums</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">radii</span> <span class="o">=</span> <span class="n">hough_circle_peaks</span><span class="p">(</span><span class="n">hough_res</span><span class="p">,</span> <span class="n">hough_radii</span><span class="p">,</span>
                                                   <span class="n">total_num_peaks</span><span class="o">=</span><span class="n">num_circles</span><span class="p">)</span>
        <span class="n">accum_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">accums</span><span class="p">)</span>

        <span class="c1"># print results, plot circles, and return</span>
        <span class="n">outlist</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="n">display_results</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>
            <span class="n">fig</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">colors</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="s1">&#39;lime&#39;</span><span class="p">,</span> <span class="s1">&#39;magenta&#39;</span><span class="p">,</span> <span class="s1">&#39;aqua&#39;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">accum</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">center_x</span><span class="p">,</span> <span class="n">radius</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">accums</span><span class="p">,</span> <span class="n">cy</span><span class="p">,</span> <span class="n">cx</span><span class="p">,</span> <span class="n">radii</span><span class="p">):</span>
            <span class="n">accum_frac</span> <span class="o">=</span> <span class="n">accum</span> <span class="o">/</span> <span class="n">accum_tot</span>
            <span class="k">if</span> <span class="n">return_type</span> <span class="o">==</span> <span class="s1">&#39;rad&#39;</span><span class="p">:</span>
                <span class="n">x_rad</span> <span class="o">=</span> <span class="n">xlist</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">center_x</span><span class="p">))]</span>
                <span class="n">y_rad</span> <span class="o">=</span> <span class="n">ylist</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">center_y</span><span class="p">))]</span>
                <span class="n">r_rad</span> <span class="o">=</span> <span class="n">radius</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
                <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">x_rad</span><span class="p">,</span> <span class="n">y_rad</span><span class="p">,</span> <span class="n">r_rad</span><span class="p">,</span> <span class="n">accum_frac</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">outlist</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">center_x</span><span class="p">,</span> <span class="n">center_y</span><span class="p">,</span> <span class="n">radius</span><span class="p">,</span> <span class="n">accum_frac</span><span class="p">])</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">accum_frac</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%i</span><span class="s2"> ring diameter: </span><span class="si">%0.1f</span><span class="s2"> microarcsec&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">radius</span> <span class="o">*</span> <span class="n">pdim</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">display_results</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">colors</span><span class="p">):</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">color</span> <span class="o">=</span> <span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>
                <span class="n">circ</span> <span class="o">=</span> <span class="n">mpl</span><span class="o">.</span><span class="n">patches</span><span class="o">.</span><span class="n">Circle</span><span class="p">((</span><span class="n">center_y</span><span class="p">,</span> <span class="n">center_x</span><span class="p">),</span> <span class="n">radius</span><span class="p">,</span> <span class="n">fill</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">color</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">add_patch</span><span class="p">(</span><span class="n">circ</span><span class="p">)</span>
            <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">outlist</span></div>

<div class="viewcode-block" id="Image.fit_gauss"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fit_gauss">[docs]</a>    <span class="k">def</span> <span class="nf">fit_gauss</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;rad&#39;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the Gaussian parameters that short baselines would measure for the source</span>
<span class="sd">           by diagonalizing the image covariance matrix.</span>
<span class="sd">           Returns parameters only for the primary polarization!</span>

<span class="sd">           Args:</span>
<span class="sd">               units (string): &#39;rad&#39; returns values in radians,</span>
<span class="sd">                               &#39;natural&#39; returns FWHM in uas and PA in degrees</span>

<span class="sd">           Returns:</span>
<span class="sd">               (tuple) : a tuple (fwhm_maj, fwhm_min, theta) of the fit Gaussian parameters</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="p">(</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">centroid</span><span class="p">()</span>
        <span class="n">pdim</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">im</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span>

        <span class="n">xlist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span> <span class="o">/</span> <span class="mf">2.0</span>
        <span class="n">ylist</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="n">pdim</span> <span class="o">+</span> <span class="p">(</span><span class="n">pdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">-</span> <span class="n">pdim</span> <span class="o">/</span> <span class="mf">2.0</span>

        <span class="n">x2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="mf">0.0</span> <span class="o">*</span> <span class="n">ylist</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">,</span> <span class="p">(</span><span class="n">xlist</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">*</span> <span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
        <span class="n">y2</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">((</span><span class="n">ylist</span> <span class="o">-</span> <span class="n">y1</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">xlist</span> <span class="o">+</span> <span class="mf">1.0</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">*</span> <span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>
        <span class="n">xy</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">outer</span><span class="p">(</span><span class="n">ylist</span> <span class="o">-</span> <span class="n">y1</span><span class="p">,</span> <span class="n">xlist</span> <span class="o">-</span> <span class="n">x1</span><span class="p">)</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span> <span class="o">*</span> <span class="n">im</span><span class="p">)</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">im</span><span class="p">))</span>

        <span class="n">eig</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">eigh</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(((</span><span class="n">x2</span><span class="p">,</span> <span class="n">xy</span><span class="p">),</span> <span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">y2</span><span class="p">))))</span>
        <span class="n">gauss_params</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">eig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">8.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span>
                                 <span class="n">eig</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mf">0.5</span> <span class="o">*</span> <span class="p">(</span><span class="mf">8.</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mf">2.</span><span class="p">))</span><span class="o">**</span><span class="mf">0.5</span><span class="p">,</span>
                                 <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">eig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span> <span class="n">eig</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)))</span>
        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s1">&#39;natural&#39;</span><span class="p">:</span>
            <span class="n">gauss_params</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span>
            <span class="n">gauss_params</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/=</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span>
            <span class="n">gauss_params</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*=</span> <span class="mf">180.</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>

        <span class="k">return</span> <span class="n">gauss_params</span></div>

<div class="viewcode-block" id="Image.fit_gauss_empirical"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.fit_gauss_empirical">[docs]</a>    <span class="k">def</span> <span class="nf">fit_gauss_empirical</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">paramguess</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Determine the Gaussian parameters that short baselines would measure</span>
<span class="sd">           Returns parameters only for the primary polarization!</span>

<span class="sd">           Args:</span>
<span class="sd">                paramguess (tuple): Initial guess (fwhm_maj, fwhm_min, theta) of fit parameters</span>

<span class="sd">           Returns:</span>
<span class="sd">               (tuple) : a tuple (fwhm_maj, fwhm_min, theta) of the fit Gaussian parameters.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># This could be done using moments of the intensity distribution (self.fit_gauss)</span>
        <span class="c1"># but we&#39;ll use the visibility approach</span>
        <span class="n">u_max</span> <span class="o">=</span> <span class="mf">1.0</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">/</span> <span class="mf">5.0</span>
        <span class="n">uv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">]</span>
                       <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">u_max</span><span class="p">,</span> <span class="n">u_max</span> <span class="o">*</span> <span class="mf">1.001</span><span class="p">,</span> <span class="n">u_max</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)</span>
                       <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">u_max</span><span class="p">,</span> <span class="n">u_max</span> <span class="o">*</span> <span class="mf">1.001</span><span class="p">,</span> <span class="n">u_max</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">)])</span>
        <span class="n">u</span> <span class="o">=</span> <span class="n">uv</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">v</span> <span class="o">=</span> <span class="n">uv</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">vis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">obsh</span><span class="o">.</span><span class="n">ftmatrix</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pulse</span><span class="p">),</span>
                     <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">paramguess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">paramguess</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">/</span> <span class="mf">4.0</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">errfunc</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
            <span class="n">vismodel</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">gauss_uv</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">total_flux</span><span class="p">(),</span> <span class="n">p</span><span class="p">,</span> <span class="n">x</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="mf">0.</span><span class="p">)</span>
            <span class="n">err</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vis</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">vismodel</span><span class="p">))</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">err</span>

        <span class="c1"># minimizer params</span>
        <span class="n">optdict</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;maxiter&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;maxfev&#39;</span><span class="p">:</span> <span class="mi">5000</span><span class="p">,</span> <span class="s1">&#39;xtol&#39;</span><span class="p">:</span> <span class="n">paramguess</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="s1">&#39;ftol&#39;</span><span class="p">:</span> <span class="mf">1e-10</span><span class="p">}</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">opt</span><span class="o">.</span><span class="n">minimize</span><span class="p">(</span><span class="n">errfunc</span><span class="p">,</span> <span class="n">paramguess</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;Nelder-Mead&#39;</span><span class="p">,</span> <span class="n">options</span><span class="o">=</span><span class="n">optdict</span><span class="p">)</span>

        <span class="c1"># Return in the form [maj, min, PA]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">res</span><span class="o">.</span><span class="n">x</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">maj</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">maj</span>
            <span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">x</span></div>

<div class="viewcode-block" id="Image.contour"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.contour">[docs]</a>    <span class="k">def</span> <span class="nf">contour</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">contour_levels</span><span class="o">=</span><span class="p">[</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.25</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.75</span><span class="p">],</span>
                <span class="n">contour_cfun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">legend</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">show_im</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">cfun</span><span class="o">=</span><span class="s1">&#39;afmhot&#39;</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="mf">1.e3</span><span class="p">,</span>
                <span class="n">plotp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">mcut</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">label_type</span><span class="o">=</span><span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="n">has_title</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">has_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cbar_lims</span><span class="o">=</span><span class="p">(),</span> <span class="n">cbar_unit</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel&#39;</span><span class="p">),</span>
                <span class="n">contour_im</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">beamcolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span>
                <span class="n">export_pdf</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cbar_orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span>
                <span class="n">scale_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beam_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbar_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the image in a contour plot.</span>

<span class="sd">           Args:</span>
<span class="sd">               contour_levels (arr): the fractional contour levels relative to the max flux plotted</span>
<span class="sd">               contour_cfun (pyplot colormap function): the function used to get the RGB colors</span>
<span class="sd">               legend (bool): True to show a legend that says what each contour line corresponds to</span>
<span class="sd">               cfun (str): matplotlib.pyplot color function</span>
<span class="sd">               scale (str): image scaling in [&#39;log&#39;,&#39;gamma&#39;,&#39;lin&#39;]</span>
<span class="sd">               interp (str): image interpolation &#39;gauss&#39; or &#39;lin&#39;</span>

<span class="sd">               gamma (float): index for gamma scaling</span>
<span class="sd">               dynamic_range (float): dynamic range for log and gamma scaling</span>

<span class="sd">               plotp (bool): True to plot linear polarimetic image</span>
<span class="sd">               nvec (int): number of polarimetric vectors to plot</span>
<span class="sd">               pcut (float): minimum stokes P value for displaying polarimetric vectors</span>
<span class="sd">                             as fraction of maximum Stokes I pixel</span>
<span class="sd">               mcut (float): minimum fractional polarization for plotting vectors</span>
<span class="sd">               label_type (string): specifies the type of axes labeling: &#39;ticks&#39;, &#39;scale&#39;, &#39;none&#39;</span>
<span class="sd">               has_title (bool): True if you want a title on the plot</span>
<span class="sd">               has_cbar (bool): True if you want a colorbar on the plot</span>
<span class="sd">               cbar_lims (tuple): specify the lower and upper limit of the colorbar</span>
<span class="sd">               cbar_unit (tuple of strings): the unit of each pixel for the colorbar:</span>
<span class="sd">                                             &#39;Jy&#39;, &#39;m-Jy&#39;, &#39;$\mu$Jy&#39;</span>

<span class="sd">               export_pdf (str): path to exported PDF with plot</span>
<span class="sd">               show (bool): Display the plot if true</span>
<span class="sd">               show_im (bool): Display the image with the contour plot if True</span>

<span class="sd">           Returns:</span>
<span class="sd">               (matplotlib.figure.Figure): figure object with image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">image</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="c1"># or some generalized version for image sizes</span>
        <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">)</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

        <span class="c1"># make the image grid</span>
        <span class="n">z</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="n">image</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">image</span><span class="o">.</span><span class="n">xdim</span><span class="p">))</span>
        <span class="n">maxz</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

        <span class="k">elif</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show_im</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">cfun</span><span class="o">=</span><span class="n">cfun</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                                     <span class="n">dynamic_range</span><span class="o">=</span><span class="n">dynamic_range</span><span class="p">,</span>
                                     <span class="n">plotp</span><span class="o">=</span><span class="n">plotp</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="n">nvec</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="n">pcut</span><span class="p">,</span> <span class="n">mcut</span><span class="o">=</span><span class="n">mcut</span><span class="p">,</span>
                                     <span class="n">label_type</span><span class="o">=</span><span class="n">label_type</span><span class="p">,</span> <span class="n">has_title</span><span class="o">=</span><span class="n">has_title</span><span class="p">,</span>
                                     <span class="n">has_cbar</span><span class="o">=</span><span class="n">has_cbar</span><span class="p">,</span> <span class="n">cbar_lims</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">,</span>
                                     <span class="n">cbar_unit</span><span class="o">=</span><span class="n">cbar_unit</span><span class="p">,</span>
                                     <span class="n">beamparams</span><span class="o">=</span><span class="n">beamparams</span><span class="p">,</span>
                                     <span class="n">cbar_orientation</span><span class="o">=</span><span class="n">cbar_orientation</span><span class="p">,</span> <span class="n">scale_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beam_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">cbar_fontsize</span><span class="o">=</span><span class="n">cbar_fontsize</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                                     <span class="n">scale_fontsize</span><span class="o">=</span><span class="n">scale_fontsize</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span>
                                     <span class="n">beamcolor</span><span class="o">=</span><span class="n">beamcolor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">cfun</span><span class="o">=</span><span class="n">cfun</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                              <span class="n">dynamic_range</span><span class="o">=</span><span class="n">dynamic_range</span><span class="p">,</span>
                              <span class="n">plotp</span><span class="o">=</span><span class="n">plotp</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="n">nvec</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="n">pcut</span><span class="p">,</span> <span class="n">mcut</span><span class="o">=</span><span class="n">mcut</span><span class="p">,</span> <span class="n">label_type</span><span class="o">=</span><span class="n">label_type</span><span class="p">,</span>
                              <span class="n">has_title</span><span class="o">=</span><span class="n">has_title</span><span class="p">,</span> <span class="n">has_cbar</span><span class="o">=</span><span class="n">has_cbar</span><span class="p">,</span>
                              <span class="n">cbar_lims</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">,</span> <span class="n">cbar_unit</span><span class="o">=</span><span class="n">cbar_unit</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="n">beamparams</span><span class="p">,</span>
                              <span class="n">cbar_orientation</span><span class="o">=</span><span class="n">cbar_orientation</span><span class="p">,</span> <span class="n">scale_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beam_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">cbar_fontsize</span><span class="o">=</span><span class="n">cbar_fontsize</span><span class="p">,</span>
                              <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scale_fontsize</span><span class="o">=</span><span class="n">scale_fontsize</span><span class="p">,</span>
                              <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span> <span class="n">beamcolor</span><span class="o">=</span><span class="n">beamcolor</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">contour_im</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="mf">0.0</span> <span class="o">*</span> <span class="n">image</span><span class="o">.</span><span class="n">imvec</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span> <span class="o">=</span> <span class="n">contour_im</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">axis</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">cfun</span><span class="o">=</span><span class="n">cfun</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                                     <span class="n">dynamic_range</span><span class="o">=</span><span class="n">dynamic_range</span><span class="p">,</span>
                                     <span class="n">plotp</span><span class="o">=</span><span class="n">plotp</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="n">nvec</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="n">pcut</span><span class="p">,</span> <span class="n">mcut</span><span class="o">=</span><span class="n">mcut</span><span class="p">,</span>
                                     <span class="n">label_type</span><span class="o">=</span><span class="n">label_type</span><span class="p">,</span> <span class="n">has_title</span><span class="o">=</span><span class="n">has_title</span><span class="p">,</span>
                                     <span class="n">has_cbar</span><span class="o">=</span><span class="n">has_cbar</span><span class="p">,</span> <span class="n">cbar_lims</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">,</span> <span class="n">cbar_unit</span><span class="o">=</span><span class="n">cbar_unit</span><span class="p">,</span>
                                     <span class="n">beamparams</span><span class="o">=</span><span class="n">beamparams</span><span class="p">,</span>
                                     <span class="n">cbar_orientation</span><span class="o">=</span><span class="n">cbar_orientation</span><span class="p">,</span> <span class="n">scale_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beam_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                                     <span class="n">cbar_fontsize</span><span class="o">=</span><span class="n">cbar_fontsize</span><span class="p">,</span>
                                     <span class="n">axis</span><span class="o">=</span><span class="n">axis</span><span class="p">,</span>
                                     <span class="n">scale_fontsize</span><span class="o">=</span><span class="n">scale_fontsize</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span>
                                     <span class="n">beamcolor</span><span class="o">=</span><span class="n">beamcolor</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">image</span><span class="o">.</span><span class="n">display</span><span class="p">(</span><span class="n">cfun</span><span class="o">=</span><span class="n">cfun</span><span class="p">,</span> <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                              <span class="n">dynamic_range</span><span class="o">=</span><span class="n">dynamic_range</span><span class="p">,</span>
                              <span class="n">plotp</span><span class="o">=</span><span class="n">plotp</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="n">nvec</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="n">pcut</span><span class="p">,</span> <span class="n">mcut</span><span class="o">=</span><span class="n">mcut</span><span class="p">,</span> <span class="n">label_type</span><span class="o">=</span><span class="n">label_type</span><span class="p">,</span>
                              <span class="n">has_title</span><span class="o">=</span><span class="n">has_title</span><span class="p">,</span>
                              <span class="n">has_cbar</span><span class="o">=</span><span class="n">has_cbar</span><span class="p">,</span> <span class="n">cbar_lims</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">,</span> <span class="n">cbar_unit</span><span class="o">=</span><span class="n">cbar_unit</span><span class="p">,</span>
                              <span class="n">beamparams</span><span class="o">=</span><span class="n">beamparams</span><span class="p">,</span>
                              <span class="n">cbar_orientation</span><span class="o">=</span><span class="n">cbar_orientation</span><span class="p">,</span> <span class="n">scale_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beam_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                              <span class="n">cbar_fontsize</span><span class="o">=</span><span class="n">cbar_fontsize</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                              <span class="n">scale_fontsize</span><span class="o">=</span><span class="n">scale_fontsize</span><span class="p">,</span> <span class="n">power</span><span class="o">=</span><span class="n">power</span><span class="p">,</span> <span class="n">beamcolor</span><span class="o">=</span><span class="n">beamcolor</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">axis</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>

        <span class="n">count</span> <span class="o">=</span> <span class="mf">0.</span>

        <span class="k">for</span> <span class="n">level</span> <span class="ow">in</span> <span class="n">contour_levels</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">contour_cfun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
                <span class="n">rgbval</span> <span class="o">=</span> <span class="n">contour_cfun</span><span class="p">(</span><span class="n">count</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">contour_levels</span><span class="p">))</span>
                <span class="n">rgbstring</span> <span class="o">=</span> <span class="s1">&#39;#</span><span class="si">%02x%02x%02x</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">rgbval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="n">rgbval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span><span class="p">,</span> <span class="n">rgbval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">*</span> <span class="mi">256</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rgbstring</span> <span class="o">=</span> <span class="n">color</span>
            <span class="n">cs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">z</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">level</span> <span class="o">*</span> <span class="n">maxz</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="n">rgbstring</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">cs</span><span class="o">.</span><span class="n">collections</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">level</span> <span class="o">*</span> <span class="mi">100</span><span class="p">))</span> <span class="o">+</span> <span class="s1">&#39;%&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">legend</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="c1">#plt.show(block=False)</span>
            <span class="n">ehc</span><span class="o">.</span><span class="n">show_noblock</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">export_pdf</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">export_pdf</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">axis</span>
        <span class="k">return</span> <span class="n">ax</span></div>

<div class="viewcode-block" id="Image.display"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.display">[docs]</a>    <span class="k">def</span> <span class="nf">display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pol</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">cfun</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
                <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="mf">1.e3</span><span class="p">,</span>
                <span class="n">plotp</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">plot_stokes</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">nvec</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span>
                <span class="n">vec_cfun</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">scut</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">pcut</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">mcut</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">scale_ticks</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">log_offset</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">label_type</span><span class="o">=</span><span class="s1">&#39;ticks&#39;</span><span class="p">,</span> <span class="n">has_title</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                <span class="n">has_cbar</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">only_cbar</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">cbar_lims</span><span class="o">=</span><span class="p">(),</span> <span class="n">cbar_unit</span><span class="o">=</span><span class="p">(</span><span class="s1">&#39;Jy&#39;</span><span class="p">,</span> <span class="s1">&#39;pixel&#39;</span><span class="p">),</span>
                <span class="n">export_pdf</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">pdf_pad_inches</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">beamparams</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">cbar_orientation</span><span class="o">=</span><span class="s2">&quot;vertical&quot;</span><span class="p">,</span> <span class="n">scinot</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                <span class="n">scale_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">beam_lw</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">cbar_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                <span class="n">scale_fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> 
                <span class="n">power</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> 
                <span class="n">beamcolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">beampos</span><span class="o">=</span><span class="s1">&#39;right&#39;</span><span class="p">,</span> <span class="n">scalecolor</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">dpi</span><span class="o">=</span><span class="mi">500</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Display the image.</span>

<span class="sd">           Args:</span>
<span class="sd">               pol (str): which polarization image to plot. Default is self.pol_prim</span>
<span class="sd">                          pol=&#39;spec&#39; will plot spectral index</span>
<span class="sd">                          pol=&#39;curv&#39; will plot spectral curvature</span>
<span class="sd">               cfun (str): matplotlib.pyplot color function.</span>
<span class="sd">                           False changes with &#39;pol&#39;,  but is &#39;afmhot&#39; for most</span>
<span class="sd">               interp (str): image interpolation &#39;gauss&#39; or &#39;lin&#39;</span>

<span class="sd">               scale (str): image scaling in [&#39;log&#39;,&#39;gamma&#39;,&#39;lin&#39;]</span>
<span class="sd">               gamma (float): index for gamma scaling</span>
<span class="sd">               dynamic_range (float): dynamic range for log and gamma scaling</span>

<span class="sd">               plotp (bool): True to plot linear polarimetic image</span>
<span class="sd">               plot_stokes (bool): True to plot stokes subplots along with plotp</span>
<span class="sd">               nvec (int): number of polarimetric vectors to plot</span>
<span class="sd">               vec_cfun (str): color function for vectors colored by lin pol frac</span>

<span class="sd">               scut (float): minimum stokes I value for displaying spectral index</span>
<span class="sd">               pcut (float): minimum stokes I value for displaying polarimetric vectors</span>
<span class="sd">                             (fraction of maximum Stokes I)</span>
<span class="sd">               mcut (float): minimum fractional polarization value for displaying vectors</span>
<span class="sd">               label_type (string): specifies the type of axes labeling: &#39;ticks&#39;, &#39;scale&#39;, &#39;none&#39;</span>
<span class="sd">               has_title (bool): True if you want a title on the plot</span>
<span class="sd">               has_cbar (bool): True if you want a colorbar on the plot</span>
<span class="sd">               cbar_lims (tuple): specify the lower and upper limit of the colorbar</span>
<span class="sd">               cbar_unit (tuple): specifies the unit of the colorbar: e.g.,</span>
<span class="sd">                                  (&#39;Jy&#39;,&#39;pixel&#39;),(&#39;m-Jy&#39;,&#39;$\mu$as$^2$&#39;),[&#39;Tb&#39;]</span>
<span class="sd">               beamparams (list): [fwhm_maj, fwhm_min, theta], set to plot beam contour</span>

<span class="sd">               export_pdf (str): path to exported PDF with plot</span>
<span class="sd">               show (bool): Display the plot if true</span>
<span class="sd">               scinot (bool): Display numbers/units in scientific notation</span>
<span class="sd">               scale_lw (float): Linewidth of the scale overlay</span>
<span class="sd">               beam_lw (float): Linewidth of the beam overlay</span>
<span class="sd">               cbar_fontsize (float): Fontsize of the text elements of the colorbar</span>
<span class="sd">               axis (matplotlib.axes.Axes): An axis object</span>
<span class="sd">               scale_fontsize (float): Fontsize of the scale label</span>

<span class="sd">               power (float): Passed to colorbar for division of ticks by 1e(power)</span>
<span class="sd">               beamcolor (str): color of the beam overlay</span>
<span class="sd">               scalecolor (str): color of the scale label overlay            </span>
<span class="sd">           Returns:</span>
<span class="sd">               (matplotlib.figure.Figure): figure object with image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">interp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;gauss&#39;</span><span class="p">,</span> <span class="s1">&#39;gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;Gaussian&#39;</span><span class="p">,</span> <span class="s1">&#39;Gauss&#39;</span><span class="p">]):</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;gaussian&#39;</span>
        <span class="k">elif</span> <span class="p">(</span><span class="n">interp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;linear&#39;</span><span class="p">,</span><span class="s1">&#39;bilinear&#39;</span><span class="p">]):</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;bilinear&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">interp</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>

        <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovx</span><span class="p">()</span> <span class="ow">or</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovx</span><span class="p">():</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;beam FWHM must be smaller than fov!&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span> <span class="ow">and</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="s1">&#39;I&#39;</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span> <span class="ow">and</span> <span class="n">pol</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pol</span> <span class="o">=</span> <span class="s1">&#39;RR&#39;</span>

        <span class="k">if</span> <span class="n">only_cbar</span><span class="p">:</span>
            <span class="n">has_cbar</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">label_type</span> <span class="o">=</span> <span class="s1">&#39;none&#39;</span>
            <span class="n">has_title</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">sca</span><span class="p">(</span><span class="n">axis</span><span class="p">)</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span>

        <span class="c1"># Get unit scale factor</span>
        <span class="n">factor</span> <span class="o">=</span> <span class="mf">1.</span>
        <span class="n">fluxunit</span> <span class="o">=</span> <span class="s1">&#39;Jy&#39;</span>
        <span class="n">areaunit</span> <span class="o">=</span> <span class="s1">&#39;pixel&#39;</span>

        <span class="k">if</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;m-Jy&#39;</span><span class="p">,</span> <span class="s1">&#39;mJy&#39;</span><span class="p">]:</span>
            <span class="n">fluxunit</span> <span class="o">=</span> <span class="s1">&#39;mJy&#39;</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="mf">1.e3</span>
        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;muJy&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\mu$-Jy&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\mu$Jy&#39;</span><span class="p">]:</span>
            <span class="n">fluxunit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mu$Jy&#39;</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="mf">1.e6</span>
        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Tb&#39;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mf">3.254e13</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">rf</span><span class="o">**</span><span class="mi">2</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">fluxunit</span> <span class="o">=</span> <span class="s1">&#39;Brightness Temperature (K)&#39;</span>
            <span class="n">areaunit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="k">if</span> <span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">fluxunit</span> <span class="o">=</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Brightness Temperature ($10^{{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}}$ K)&#39;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">fluxunit</span> <span class="o">=</span> <span class="s1">&#39;Brightness Temperature (K)&#39;</span>
        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;Jy&#39;</span><span class="p">]:</span>
            <span class="n">fluxunit</span> <span class="o">=</span> <span class="s1">&#39;Jy&#39;</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="mf">1.</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
            <span class="n">fluxunit</span> <span class="o">=</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">areaunit</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">cbar_unit</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;Tb&#39;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="mf">1.</span>

        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;pixel&#39;</span><span class="p">:</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="mf">1.</span>
            <span class="k">if</span> <span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">areaunit</span> <span class="o">=</span> <span class="n">areaunit</span> <span class="o">+</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39; ($10^{{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}}$ K)&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;$arcseconds$^2$&#39;</span><span class="p">,</span> <span class="s1">&#39;as$^2$&#39;</span><span class="p">,</span> <span class="s1">&#39;as2&#39;</span><span class="p">]:</span>
            <span class="n">areaunit</span> <span class="o">=</span> <span class="s1">&#39;as$^2$&#39;</span>
            <span class="n">fovfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERAS</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">fovfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">areaunit</span> <span class="o">=</span> <span class="n">areaunit</span> <span class="o">+</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39; ($10^{{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}}$ K)&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\m-arcseconds$^2$&#39;</span><span class="p">,</span> <span class="s1">&#39;mas$^2$&#39;</span><span class="p">,</span> <span class="s1">&#39;mas2&#39;</span><span class="p">]:</span>
            <span class="n">areaunit</span> <span class="o">=</span> <span class="s1">&#39;mas$^2$&#39;</span>
            <span class="n">fovfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1000.</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">fovfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">areaunit</span> <span class="o">=</span> <span class="n">areaunit</span> <span class="o">+</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39; ($10^{{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}}$ K)&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">r</span><span class="s1">&#39;$\mu$-arcseconds$^2$&#39;</span><span class="p">,</span> <span class="sa">r</span><span class="s1">&#39;$\mu$as$^2$&#39;</span><span class="p">,</span> <span class="s1">&#39;muas2&#39;</span><span class="p">]:</span>
            <span class="n">areaunit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\mu$as$^2$&#39;</span>
            <span class="n">fovfactor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">*</span> <span class="p">(</span><span class="mi">1</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span><span class="p">)</span>
            <span class="n">factor</span> <span class="o">*=</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="n">fovfactor</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">/</span> <span class="p">(</span><span class="mf">1.</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
            <span class="k">if</span> <span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">areaunit</span> <span class="o">=</span> <span class="n">areaunit</span> <span class="o">+</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39; ($10^{{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}}$ K)&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;beam&#39;</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Cannot convert to Jy/beam without beamparams!&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">areaunit</span> <span class="o">=</span> <span class="s1">&#39;beam&#39;</span>
                <span class="n">beamarea</span> <span class="o">=</span> <span class="p">(</span><span class="mf">2.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">8.0</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="mi">2</span><span class="p">)))</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="n">beamarea</span> <span class="o">/</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">power</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">areaunit</span> <span class="o">=</span> <span class="n">areaunit</span> <span class="o">+</span> <span class="p">(</span><span class="sa">r</span><span class="s1">&#39; ($10^{{&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">power</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;}}$ K)&#39;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;cbar_unit &#39;</span> <span class="o">+</span> <span class="n">cbar_unit</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39; is not a possible option&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">plotp</span><span class="p">:</span>  <span class="c1"># Plot a single polarization image</span>
            <span class="n">cbar_lims_p</span> <span class="o">=</span> <span class="p">()</span>

            <span class="k">if</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;spec&#39;</span><span class="p">:</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">specvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># mask out low total intensity values</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">scut</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">))</span>
                <span class="n">imvec</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\alpha$&#39;</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">cbar_lims_p</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
                <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;seismic&#39;</span>
            <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;curv&#39;</span><span class="p">:</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">curvvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

                <span class="c1"># mask out low total intensity values</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">imvec</span> <span class="o">&lt;</span> <span class="p">(</span><span class="n">scut</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">imvec</span><span class="p">))</span>
                <span class="n">imvec</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\beta$&#39;</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">cbar_lims_p</span> <span class="o">=</span> <span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
                <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;seismic&#39;</span>
            <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;m&#39;</span><span class="p">:</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\|\breve</span><span class="si">{m}</span><span class="s1">|$&#39;</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">cbar_lims_p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;cool&#39;</span>
            <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;p&#39;</span><span class="p">:</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">mvec</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">ivec</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\|P|$&#39;</span>
                <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;afmhot&#39;</span>
            <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;chi&#39;</span> <span class="ow">or</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;evpa&#39;</span><span class="p">:</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">chivec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">DEGREE</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\chi (^\circ)$&#39;</span>
                <span class="n">factor</span> <span class="o">=</span> <span class="mi">1</span>
                <span class="n">cbar_lims_p</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">]</span>
                <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;hsv&#39;</span>
            <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;e&#39;</span><span class="p">:</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">evec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$E$-mode&#39;</span>
                <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span>
            <span class="k">elif</span> <span class="n">pol</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s1">&#39;b&#39;</span><span class="p">:</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bvec</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$B$-mode&#39;</span>
                <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;Spectral&#39;</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pol</span> <span class="o">=</span> <span class="n">pol</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">pol</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>
                    <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;bwr&#39;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">cfun_p</span> <span class="o">=</span> <span class="s1">&#39;afmhot&#39;</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;stokes&#39;</span><span class="p">:</span>
                            <span class="n">im2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_polrep</span><span class="p">(</span><span class="s1">&#39;circ&#39;</span><span class="p">)</span>
                        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">polrep</span> <span class="o">==</span> <span class="s1">&#39;circ&#39;</span><span class="p">:</span>
                            <span class="n">im2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_polrep</span><span class="p">(</span><span class="s1">&#39;stokes&#39;</span><span class="p">)</span>
                        <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im2</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">pol</span><span class="p">])</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Cannot make pol </span><span class="si">%s</span><span class="s2"> image in display()!&quot;</span> <span class="o">%</span> <span class="n">pol</span><span class="p">)</span>

                <span class="n">unit</span> <span class="o">=</span> <span class="n">fluxunit</span>
                <span class="k">if</span> <span class="n">areaunit</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                    <span class="n">unit</span> <span class="o">+=</span> <span class="s1">&#39; / &#39;</span> <span class="o">+</span> <span class="n">areaunit</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">imag</span><span class="p">(</span><span class="n">imvec</span><span class="p">)):</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;casting complex image to abs value&#39;</span><span class="p">)</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">real</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>

            <span class="n">imvec</span> <span class="o">=</span> <span class="n">imvec</span> <span class="o">*</span> <span class="n">factor</span>
            <span class="n">imarr</span> <span class="o">=</span> <span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping values less than 0 in display&#39;</span><span class="p">)</span>
                    <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="k">if</span> <span class="n">log_offset</span><span class="p">:</span>
                    <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">log_offset</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">$(&#39;</span> <span class="o">+</span> <span class="n">unit</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

            <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping values less than 0 in display&#39;</span><span class="p">)</span>
                    <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">imarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">imarr</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">unit</span> <span class="o">+</span> <span class="s1">&#39;)^&#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cbar_lims</span> <span class="ow">and</span> <span class="n">cbar_lims_p</span><span class="p">:</span>
                <span class="n">cbar_lims</span> <span class="o">=</span> <span class="n">cbar_lims_p</span>

            <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
                <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
                <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span> <span class="o">&gt;</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">imarr</span><span class="p">[</span><span class="n">imarr</span> <span class="o">&lt;</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%.2f</span><span class="s2"> GHz </span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span> <span class="n">pol</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">16</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cfun</span><span class="p">:</span>
                <span class="n">cfun</span> <span class="o">=</span> <span class="n">cfun_p</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cfun</span><span class="p">)</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;whitesmoke&#39;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">beampos</span><span class="o">==</span><span class="s1">&#39;left&#39;</span><span class="p">:</span>
                    <span class="n">beamparams</span> <span class="o">=</span> <span class="p">[</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                  <span class="o">+.</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovx</span><span class="p">(),</span> <span class="o">-.</span><span class="mi">4</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovy</span><span class="p">()]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">beamparams</span> <span class="o">=</span> <span class="p">[</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                                  <span class="o">-.</span><span class="mi">35</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovx</span><span class="p">(),</span> <span class="o">-.</span><span class="mi">35</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovy</span><span class="p">()]</span>                              
                <span class="n">beamimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">beamimage</span><span class="o">.</span><span class="n">imvec</span> <span class="o">*=</span> <span class="mi">0</span>
                <span class="n">beamimage</span> <span class="o">=</span> <span class="n">beamimage</span><span class="o">.</span><span class="n">add_gauss</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">)</span>
                <span class="n">halflevel</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">beamimage</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
                <span class="n">beamimarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">beamimage</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">beamimage</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">beamimage</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">beamimarr</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">halflevel</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="n">beamcolor</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">beam_lw</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_cbar</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">only_cbar</span><span class="p">:</span>
                    <span class="n">im</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">cb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">cbar_orientation</span><span class="p">)</span>
                <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cbar_fontsize</span><span class="p">))</span>

                <span class="k">if</span> <span class="n">cbar_fontsize</span> <span class="o">!=</span> <span class="mi">12</span><span class="p">:</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">set_label</span><span class="p">(</span><span class="n">unit</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="nb">float</span><span class="p">(</span><span class="n">cbar_fontsize</span><span class="p">)</span> <span class="o">/</span> <span class="mf">1.5</span><span class="p">)</span>
                <span class="n">cb</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">cbar_fontsize</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">scinot</span><span class="p">:</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">formatter</span><span class="o">.</span><span class="n">set_powerlimits</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                    <span class="n">cb</span><span class="o">.</span><span class="n">update_ticks</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># plot polarization with ticks!</span>

            <span class="n">im_stokes</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">switch_polrep</span><span class="p">(</span><span class="n">polrep_out</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">)</span>
            <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
            <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">qvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
            <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">uvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
            <span class="n">vvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">vvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">10</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">qvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">qvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">uvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">uvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">vvec</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">vvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

            <span class="n">imvec</span> <span class="o">*=</span> <span class="n">factor</span>
            <span class="n">qvec</span> <span class="o">*=</span> <span class="n">factor</span>
            <span class="n">uvec</span> <span class="o">*=</span> <span class="n">factor</span>
            <span class="n">vvec</span> <span class="o">*=</span> <span class="n">factor</span>

            <span class="n">imarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">qarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">qvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">uarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">uvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">varr</span> <span class="o">=</span> <span class="p">(</span><span class="n">vvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im_stokes</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im_stokes</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

            <span class="n">unit</span> <span class="o">=</span> <span class="n">fluxunit</span>
            <span class="k">if</span> <span class="n">areaunit</span> <span class="o">!=</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="n">fluxunit</span> <span class="o">+</span> <span class="s1">&#39; / &#39;</span> <span class="o">+</span> <span class="n">areaunit</span>

            <span class="c1"># only the  stokes I image gets transformed! TODO</span>
            <span class="n">imarr2</span> <span class="o">=</span> <span class="n">imarr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">imarr2</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping values less than 0 in display&#39;</span><span class="p">)</span>
                    <span class="n">imarr2</span><span class="p">[</span><span class="n">imarr2</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">imarr2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">imarr2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr2</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;$\log_</span><span class="si">{10}</span><span class="s1">$(&#39;</span> <span class="o">+</span> <span class="n">unit</span> <span class="o">+</span> <span class="s1">&#39;)&#39;</span>

            <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">imarr2</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;clipping values less than 0 in display&#39;</span><span class="p">)</span>
                    <span class="n">imarr2</span><span class="p">[</span><span class="n">imarr2</span> <span class="o">&lt;</span> <span class="mf">0.0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="n">imarr2</span> <span class="o">=</span> <span class="p">(</span><span class="n">imarr2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imarr2</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
                <span class="n">unit</span> <span class="o">=</span> <span class="s1">&#39;(&#39;</span> <span class="o">+</span> <span class="n">unit</span> <span class="o">+</span> <span class="s1">&#39;)^gamma&#39;</span>

            <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
                <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="p">(</span><span class="mf">10.</span><span class="o">**</span><span class="n">power</span><span class="p">)</span>
                <span class="n">imarr2</span><span class="p">[</span><span class="n">imarr2</span> <span class="o">&gt;</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">imarr2</span><span class="p">[</span><span class="n">imarr2</span> <span class="o">&lt;</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span> <span class="o">=</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

            <span class="c1"># polarization ticks</span>
            <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">uvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

            <span class="n">thin</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">//</span> <span class="n">nvec</span>
            <span class="n">maska</span> <span class="o">=</span> <span class="p">(</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">pcut</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">imvec</span><span class="p">)</span>
            <span class="n">maskb</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">uvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span> <span class="o">&gt;</span> <span class="n">mcut</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">maska</span> <span class="o">*</span> <span class="n">maskb</span>
            <span class="n">mask2</span> <span class="o">=</span> <span class="n">mask</span><span class="p">[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">]</span>
            <span class="n">x</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)]</span>
                           <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)])[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">y</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">j</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)]</span>
                           <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">)])[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])</span>
            <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">uvec</span><span class="p">)</span> <span class="o">/</span>
                         <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])</span>
            <span class="n">a</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
            <span class="n">b</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">angle</span><span class="p">(</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">uvec</span><span class="p">)</span> <span class="o">/</span>
                        <span class="mi">2</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">])</span>
            <span class="n">b</span> <span class="o">=</span> <span class="n">b</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>

            <span class="n">m</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">uvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">p</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">uvec</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">m</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">p</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">qarr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">uarr</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="n">voi</span> <span class="o">=</span> <span class="p">(</span><span class="n">vvec</span> <span class="o">/</span> <span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="n">voi</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">logical_not</span><span class="p">(</span><span class="n">mask</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

            <span class="k">if</span> <span class="n">scale_ticks</span><span class="p">:</span>
                <span class="n">pticks</span> <span class="o">=</span> <span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qvec</span> <span class="o">+</span> <span class="mi">1</span><span class="n">j</span> <span class="o">*</span> <span class="n">uvec</span><span class="p">))</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">))[::</span><span class="n">thin</span><span class="p">,</span> <span class="p">::</span><span class="n">thin</span><span class="p">][</span><span class="n">mask2</span><span class="p">]</span>
                <span class="n">pscale</span> <span class="o">=</span> <span class="p">(</span><span class="n">pticks</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pticks</span><span class="p">))</span><span class="o">/</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pticks</span><span class="p">)</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">pticks</span><span class="p">))</span>
                <span class="n">a</span> <span class="o">*=</span> <span class="n">pscale</span>
                <span class="n">b</span> <span class="o">*=</span> <span class="n">pscale</span>

            <span class="c1"># Little pol plots</span>
            <span class="k">if</span> <span class="n">plot_stokes</span><span class="p">:</span>

                <span class="n">maxval</span> <span class="o">=</span> <span class="mf">1.1</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">uarr</span><span class="p">)),</span>
                                       <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qarr</span><span class="p">)),</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">varr</span><span class="p">))))</span>

                <span class="c1"># P Plot</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;bwr&#39;</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=-</span><span class="n">maxval</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxval</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;P&#39;</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">has_cbar</span><span class="p">:</span>
                    <span class="n">cbaxes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.2</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.6</span><span class="p">])</span>
                    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbaxes</span><span class="p">,</span>
                                        <span class="n">label</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;vertical&#39;</span><span class="p">)</span>
                    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">cbar_fontsize</span><span class="p">)</span>
                    <span class="n">cbaxes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                    <span class="n">cbaxes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;left&#39;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="o">-</span><span class="n">maxval</span><span class="p">,</span> <span class="n">maxval</span><span class="p">)</span>

                <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;bwr&#39;</span><span class="p">)</span>
                <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;whitesmoke&#39;</span><span class="p">)</span>
                <span class="c1"># V Plot</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">varr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span>
                           <span class="n">vmin</span><span class="o">=-</span><span class="n">maxval</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxval</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)</span>

                <span class="c1"># Q Plot</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">qarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span>
                           <span class="n">vmin</span><span class="o">=-</span><span class="n">maxval</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxval</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)</span>

                <span class="c1"># U Plot</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">uarr</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span>
                           <span class="n">vmin</span><span class="o">=-</span><span class="n">maxval</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">maxval</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)</span>

                <span class="c1"># V/I plot</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;seismic&#39;</span><span class="p">)</span>
                <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="s1">&#39;whitesmoke&#39;</span><span class="p">)</span>

                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">voi</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;V/I&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">has_cbar</span><span class="p">:</span>
                    <span class="n">cbaxes</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gcf</span><span class="p">()</span><span class="o">.</span><span class="n">add_axes</span><span class="p">([</span><span class="mf">0.125</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.425</span><span class="p">,</span> <span class="mf">0.01</span><span class="p">])</span>
                    <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span> <span class="n">cax</span><span class="o">=</span><span class="n">cbaxes</span><span class="p">,</span>
                                        <span class="n">label</span><span class="o">=</span><span class="s1">&#39;|m|&#39;</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">)</span>
                    <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">cbar_fontsize</span><span class="p">)</span>
                    <span class="n">cbaxes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_ticks_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>
                    <span class="n">cbaxes</span><span class="o">.</span><span class="n">yaxis</span><span class="o">.</span><span class="n">set_label_position</span><span class="p">(</span><span class="s1">&#39;right&#39;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                        <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>

                <span class="c1"># m plot</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;seismic&#39;</span><span class="p">),</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_xticks</span><span class="p">([])</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">set_yticks</span><span class="p">([])</span>
                <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=.</span><span class="mi">25</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                           <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">width</span><span class="o">=.</span><span class="mi">01</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span>
                           <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">thin</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                           <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">width</span><span class="o">=.</span><span class="mi">005</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span>
                           <span class="n">scale</span><span class="o">=</span><span class="mf">1.1</span> <span class="o">/</span> <span class="n">thin</span><span class="p">)</span>

                <span class="c1"># Big Stokes I plot --axis</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplot2grid</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span> <span class="mi">5</span><span class="p">),</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">),</span> <span class="n">rowspan</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">colspan</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">cfun</span><span class="p">:</span>
                <span class="n">cfun</span> <span class="o">=</span> <span class="s1">&#39;afmhot&#39;</span>
            <span class="n">cmap</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="n">cfun</span><span class="p">)</span>
            <span class="n">cmap</span><span class="o">.</span><span class="n">set_bad</span><span class="p">(</span><span class="n">color</span><span class="o">=</span><span class="s1">&#39;whitesmoke&#39;</span><span class="p">)</span>

            <span class="c1"># Big Stokes I plot</span>
            <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr2</span><span class="p">,</span> <span class="n">cmap</span><span class="o">=</span><span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">,</span>
                                <span class="n">vmin</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">vmax</span><span class="o">=</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">im</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">imarr2</span><span class="p">,</span> <span class="n">cmap</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">vec_cfun</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                           <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">width</span><span class="o">=.</span><span class="mi">01</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span>
                           <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">thin</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                           <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">width</span><span class="o">=.</span><span class="mi">005</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span>
                           <span class="n">scale</span><span class="o">=</span><span class="mf">1.1</span> <span class="o">/</span> <span class="n">thin</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mthin</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span>
                        <span class="n">qvec</span> <span class="o">+</span>
                        <span class="mi">1</span><span class="n">j</span> <span class="o">*</span>
                        <span class="n">uvec</span><span class="p">)</span> <span class="o">/</span>
                    <span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">)[</span>
                    <span class="p">::</span><span class="n">thin</span><span class="p">,</span>
                    <span class="p">::</span><span class="n">thin</span><span class="p">]</span>
                <span class="n">mthin</span> <span class="o">=</span> <span class="n">mthin</span><span class="p">[</span><span class="n">mask2</span><span class="p">]</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span>
                           <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">width</span><span class="o">=.</span><span class="mi">01</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span>
                           <span class="n">scale</span><span class="o">=</span><span class="mf">1.0</span> <span class="o">/</span> <span class="n">thin</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">quiver</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">mthin</span><span class="p">,</span>
                           <span class="n">norm</span><span class="o">=</span><span class="n">mpl</span><span class="o">.</span><span class="n">colors</span><span class="o">.</span><span class="n">Normalize</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1.</span><span class="p">),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">vec_cfun</span><span class="p">,</span>
                           <span class="n">headaxislength</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">headwidth</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">headlength</span><span class="o">=.</span><span class="mi">01</span><span class="p">,</span> <span class="n">minlength</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">minshaft</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
                           <span class="n">width</span><span class="o">=.</span><span class="mi">007</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">units</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span> <span class="n">pivot</span><span class="o">=</span><span class="s1">&#39;mid&#39;</span><span class="p">,</span> <span class="n">angles</span><span class="o">=</span><span class="s1">&#39;uv&#39;</span><span class="p">,</span>
                           <span class="n">scale</span><span class="o">=</span><span class="mf">1.1</span> <span class="o">/</span> <span class="n">thin</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span><span class="p">(</span><span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">beamparams</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">):</span>
                <span class="n">beamparams</span> <span class="o">=</span> <span class="p">[</span><span class="n">beamparams</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="n">beamparams</span><span class="p">[</span><span class="mi">2</span><span class="p">],</span>
                              <span class="o">-.</span><span class="mi">35</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovx</span><span class="p">(),</span> <span class="o">-.</span><span class="mi">35</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">fovy</span><span class="p">()]</span>
                <span class="n">beamimage</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">beamimage</span><span class="o">.</span><span class="n">imvec</span> <span class="o">*=</span> <span class="mi">0</span>
                <span class="n">beamimage</span> <span class="o">=</span> <span class="n">beamimage</span><span class="o">.</span><span class="n">add_gauss</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">beamparams</span><span class="p">)</span>
                <span class="n">halflevel</span> <span class="o">=</span> <span class="mf">0.5</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">beamimage</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span>
                <span class="n">beamimarr</span> <span class="o">=</span> <span class="p">(</span><span class="n">beamimage</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">beamimage</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">beamimage</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">beamimarr</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="p">[</span><span class="n">halflevel</span><span class="p">],</span> <span class="n">colors</span><span class="o">=</span><span class="n">beamcolor</span><span class="p">,</span> <span class="n">linewidths</span><span class="o">=</span><span class="n">beam_lw</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">has_cbar</span><span class="p">:</span>

                <span class="n">cbar</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">fraction</span><span class="o">=</span><span class="mf">0.046</span><span class="p">,</span> <span class="n">pad</span><span class="o">=</span><span class="mf">0.04</span><span class="p">,</span>
                                    <span class="n">label</span><span class="o">=</span><span class="n">unit</span><span class="p">,</span> <span class="n">orientation</span><span class="o">=</span><span class="n">cbar_orientation</span><span class="p">)</span>
                <span class="n">cbar</span><span class="o">.</span><span class="n">ax</span><span class="o">.</span><span class="n">tick_params</span><span class="p">(</span><span class="n">labelsize</span><span class="o">=</span><span class="n">cbar_fontsize</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">cbar_lims</span><span class="p">:</span>
                    <span class="n">plt</span><span class="o">.</span><span class="n">clim</span><span class="p">(</span><span class="n">cbar_lims</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cbar_lims</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">has_title</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> </span><span class="si">%.1f</span><span class="s2"> GHz : m=</span><span class="si">%.1f%%</span><span class="s2"> , v=</span><span class="si">%.1f%%</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">lin_polfrac</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">,</span>
                                                                 <span class="bp">self</span><span class="o">.</span><span class="n">circ_polfrac</span><span class="p">()</span> <span class="o">*</span> <span class="mi">100</span><span class="p">),</span>
                          <span class="n">fontsize</span><span class="o">=</span><span class="mi">12</span><span class="p">)</span>
            <span class="n">f</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">hspace</span><span class="o">=.</span><span class="mi">1</span><span class="p">,</span> <span class="n">wspace</span><span class="o">=</span><span class="mf">0.3</span><span class="p">)</span>

        <span class="c1"># Label the plot</span>
        <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s1">&#39;ticks&#39;</span><span class="p">:</span>
            <span class="n">xticks</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERAS</span> <span class="o">/</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">yticks</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERAS</span> <span class="o">/</span> <span class="mf">1e-6</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Relative RA ($\mu$as)&#39;</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Relative Dec ($\mu$as)&#39;</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s1">&#39;scale&#39;</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">fov_uas</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERUAS</span>  <span class="c1"># get the fov in uas</span>
            <span class="n">roughfactor</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">3.</span>  <span class="c1"># make the bar about 1/3 the fov</span>
            <span class="n">fov_scale</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">math</span><span class="o">.</span><span class="n">ceil</span><span class="p">(</span><span class="n">fov_uas</span> <span class="o">*</span> <span class="n">roughfactor</span> <span class="o">/</span> <span class="mf">10.0</span><span class="p">))</span> <span class="o">*</span> <span class="mi">10</span>
            <span class="n">start</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">roughfactor</span> <span class="o">/</span> <span class="mf">3.0</span>  <span class="c1"># select the start location</span>
            <span class="n">end</span> <span class="o">=</span> <span class="n">start</span> <span class="o">+</span> <span class="n">fov_scale</span> <span class="o">/</span> <span class="n">fov_uas</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">xdim</span>  <span class="c1"># determine the end location</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">([</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">],</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">-</span> <span class="n">start</span> <span class="o">-</span> <span class="mi">5</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">-</span> <span class="n">start</span> <span class="o">-</span> <span class="mi">5</span><span class="p">],</span>
                     <span class="n">color</span><span class="o">=</span><span class="n">scalecolor</span><span class="p">,</span> <span class="n">lw</span><span class="o">=</span><span class="n">scale_lw</span><span class="p">)</span>  <span class="c1"># plot a line</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">text</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="p">(</span><span class="n">start</span> <span class="o">+</span> <span class="n">end</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">-</span> <span class="n">start</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">/</span> <span class="mi">30</span><span class="p">,</span>
                     <span class="n">s</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">fov_scale</span><span class="p">)</span> <span class="o">+</span> <span class="sa">r</span><span class="s2">&quot; $\mu$as&quot;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">scalecolor</span><span class="p">,</span>
                     <span class="n">ha</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">va</span><span class="o">=</span><span class="s2">&quot;center&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="n">scale_fontsize</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">elif</span> <span class="n">label_type</span> <span class="o">==</span> <span class="s1">&#39;none&#39;</span> <span class="ow">or</span> <span class="n">label_type</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">axis</span><span class="p">(</span><span class="s1">&#39;off&#39;</span><span class="p">)</span>
            <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">gca</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_xaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>
                <span class="n">ax</span><span class="o">.</span><span class="n">axes</span><span class="o">.</span><span class="n">get_yaxis</span><span class="p">()</span><span class="o">.</span><span class="n">set_visible</span><span class="p">(</span><span class="kc">False</span><span class="p">)</span>

        <span class="c1"># Show or save to file</span>
        <span class="k">if</span> <span class="n">axis</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">axis</span>
        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="c1">#plt.show(block=False)</span>
            <span class="n">ehc</span><span class="o">.</span><span class="n">show_noblock</span><span class="p">()</span>
            
        <span class="k">if</span> <span class="n">export_pdf</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">export_pdf</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">,</span> <span class="n">pad_inches</span><span class="o">=</span><span class="n">pdf_pad_inches</span><span class="p">,</span> <span class="n">dpi</span><span class="o">=</span><span class="n">dpi</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">f</span></div>

<div class="viewcode-block" id="Image.overlay_display"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.overlay_display">[docs]</a>    <span class="k">def</span> <span class="nf">overlay_display</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">im_list</span><span class="p">,</span> <span class="n">color_coding</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">],</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">]]),</span>
                        <span class="n">export_pdf</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">show</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">shift</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">final_fov</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">interp</span><span class="o">=</span><span class="s1">&#39;gaussian&#39;</span><span class="p">,</span>
                        <span class="n">scale</span><span class="o">=</span><span class="s1">&#39;lin&#39;</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="p">[</span><span class="mf">1.e3</span><span class="p">],</span> <span class="n">rescale</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Overlay primary polarization images of a list of images to compare structures.</span>

<span class="sd">           Args:</span>
<span class="sd">               im_list (list): list of images to align to the current image</span>
<span class="sd">               color_coding (numpy.array): Color coding of each image in the composite</span>

<span class="sd">               f (matplotlib.pyplot.figure): Figure to overlay on top of</span>
<span class="sd">               export_pdf (str): path to exported PDF with plot</span>
<span class="sd">               show (bool): Display the plot if true</span>

<span class="sd">               shift (list): list of manual image shifts,</span>
<span class="sd">                             otherwise use the shift from maximum cross-correlation</span>
<span class="sd">               final_fov (float): fov of the comparison image (rad).</span>
<span class="sd">                                  If False it is the largestinput image fov</span>

<span class="sd">               scale (str) : compare images in &#39;log&#39;,&#39;lin&#39;,or &#39;gamma&#39; scale</span>
<span class="sd">               gamma (float): exponent for gamma scale comparison</span>
<span class="sd">               dynamic_range (float): dynamic range for log and gamma scale comparisons</span>

<span class="sd">           Returns:</span>
<span class="sd">               (matplotlib.figure.Figure): figure object with image</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">f</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dynamic_range</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">dynamic_range</span> <span class="o">=</span> <span class="n">dynamic_range</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ndarray</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="n">matlib</span><span class="o">.</span><span class="n">repmat</span><span class="p">(</span><span class="n">shift</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">),</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">psize</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span>
        <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="bp">self</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)):</span>
            <span class="n">psize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="n">psize</span><span class="p">,</span> <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>
            <span class="n">max_fov</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span><span class="n">max_fov</span><span class="p">,</span> <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">xdim</span> <span class="o">*</span> <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">,</span>
                              <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">ydim</span> <span class="o">*</span> <span class="n">im_list</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">psize</span><span class="p">])</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">final_fov</span><span class="p">:</span>
            <span class="n">final_fov</span> <span class="o">=</span> <span class="n">max_fov</span>

        <span class="p">(</span><span class="n">im_list_shift</span><span class="p">,</span> <span class="n">shifts</span><span class="p">,</span> <span class="n">im0_pad</span><span class="p">)</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">align_images</span><span class="p">(</span><span class="n">im_list</span><span class="p">,</span> <span class="n">shift</span><span class="o">=</span><span class="n">shift</span><span class="p">,</span>
                                                             <span class="n">final_fov</span><span class="o">=</span><span class="n">final_fov</span><span class="p">,</span>
                                                             <span class="n">scale</span><span class="o">=</span><span class="n">scale</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="n">gamma</span><span class="p">,</span>
                                                             <span class="n">dynamic_range</span><span class="o">=</span><span class="n">dynamic_range</span><span class="p">)</span>

        <span class="c1"># unit = &#39;Jy/pixel&#39;</span>
        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;log&#39;</span><span class="p">:</span>
            <span class="c1"># unit = &#39;log(Jy/pixel)&#39;</span>
            <span class="n">log_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="n">log_offset</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)):</span>
                <span class="n">log_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_list_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">im_list_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">im_list_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="n">log_offset</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scale</span> <span class="o">==</span> <span class="s1">&#39;gamma&#39;</span><span class="p">:</span>
            <span class="c1"># unit = &#39;(Jy/pixel)^gamma&#39;</span>
            <span class="n">log_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="n">log_offset</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)):</span>
                <span class="n">log_offset</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">im_list_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">im_list_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="p">(</span><span class="n">im_list_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span> <span class="o">+</span> <span class="n">log_offset</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="n">gamma</span><span class="p">)</span>

        <span class="n">composite_img</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">im_list</span><span class="p">)):</span>

            <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="n">immtx</span> <span class="o">=</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">immtx</span> <span class="o">=</span> <span class="n">im_list_shift</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">imvec</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">rescale</span><span class="p">:</span>
                <span class="n">immtx</span> <span class="o">=</span> <span class="n">immtx</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">immtx</span><span class="p">))</span>
                <span class="n">immtx</span> <span class="o">=</span> <span class="n">immtx</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">immtx</span><span class="p">))</span>

            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">):</span>
                <span class="n">composite_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">=</span> <span class="n">composite_img</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">c</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">color_coding</span><span class="p">[</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">c</span><span class="p">]</span> <span class="o">*</span> <span class="n">immtx</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">rescale</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">composite_img</span> <span class="o">=</span> <span class="n">composite_img</span> <span class="o">-</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">composite_img</span><span class="p">)))</span>
            <span class="n">composite_img</span> <span class="o">=</span> <span class="n">composite_img</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">composite_img</span><span class="p">)))</span>

        <span class="n">plt</span><span class="o">.</span><span class="n">subplot</span><span class="p">(</span><span class="mi">111</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%s</span><span class="s1">   MJD </span><span class="si">%i</span><span class="s1">  </span><span class="si">%.2f</span><span class="s1"> GHz&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">source</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">rf</span> <span class="o">/</span> <span class="mf">1e9</span><span class="p">),</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">composite_img</span><span class="p">,</span> <span class="n">interpolation</span><span class="o">=</span><span class="n">interp</span><span class="p">)</span>
        <span class="n">xticks</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">xdim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERAS</span> <span class="o">/</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">yticks</span> <span class="o">=</span> <span class="n">obsh</span><span class="o">.</span><span class="n">ticks</span><span class="p">(</span><span class="n">im0_pad</span><span class="o">.</span><span class="n">ydim</span><span class="p">,</span> <span class="n">im0_pad</span><span class="o">.</span><span class="n">psize</span> <span class="o">/</span> <span class="n">ehc</span><span class="o">.</span><span class="n">RADPERAS</span> <span class="o">/</span> <span class="mf">1e-6</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xticks</span><span class="p">(</span><span class="n">xticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">xticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">yticks</span><span class="p">(</span><span class="n">yticks</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">yticks</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Relative RA ($\mu$as)&#39;</span><span class="p">)</span>
        <span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;Relative Dec ($\mu$as)&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">show</span><span class="p">:</span>
            <span class="c1">#plt.show(block=False)</span>
            <span class="n">ehc</span><span class="o">.</span><span class="n">show_noblock</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">export_pdf</span> <span class="o">!=</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">savefig</span><span class="p">(</span><span class="n">export_pdf</span><span class="p">,</span> <span class="n">bbox_inches</span><span class="o">=</span><span class="s1">&#39;tight&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">shift</span><span class="p">)</span></div>

<div class="viewcode-block" id="Image.save_txt"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.save_txt">[docs]</a>    <span class="k">def</span> <span class="nf">save_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save image data to text file.</span>

<span class="sd">           Args:</span>
<span class="sd">                fname (str): path to output text file</span>

<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">save_im_txt</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span></div>

<div class="viewcode-block" id="Image.save_fits"><a class="viewcode-back" href="../../image.html#ehtim.image.Image.save_fits">[docs]</a>    <span class="k">def</span> <span class="nf">save_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save image data to a fits file.</span>

<span class="sd">           Args:</span>
<span class="sd">                fname (str): path to output fits file</span>

<span class="sd">           Returns:</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">save</span><span class="o">.</span><span class="n">save_im_fits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fname</span><span class="p">)</span>
        <span class="k">return</span></div></div>


<span class="c1">###################################################################################################</span>
<span class="c1"># Image creation functions</span>
<span class="c1">###################################################################################################</span>

<div class="viewcode-block" id="make_square"><a class="viewcode-back" href="../../image.html#ehtim.image.make_square">[docs]</a><span class="k">def</span> <span class="nf">make_square</span><span class="p">(</span><span class="n">obs</span><span class="p">,</span> <span class="n">npix</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make an empty square image.</span>

<span class="sd">       Args:</span>
<span class="sd">           obs (Obsdata): an obsdata object with the image metadata</span>
<span class="sd">           npix (int): the pixel size of each axis</span>
<span class="sd">           fov (float): the field of view of each axis in radians</span>
<span class="sd">           pulse (function): the function convolved with the pixel values for continuous image</span>

<span class="sd">           polrep (str): polarization representation, either &#39;stokes&#39; or &#39;circ&#39;</span>
<span class="sd">           pol_prim (str): The default image: I,Q,U or V for Stokes, or RR,LL,LR,RL for Circular</span>
<span class="sd">       Returns:</span>
<span class="sd">           (Image): an image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">outim</span> <span class="o">=</span> <span class="n">make_empty</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">ra</span><span class="p">,</span> <span class="n">obs</span><span class="o">.</span><span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">source</span><span class="p">,</span>
                       <span class="n">polrep</span><span class="o">=</span><span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="n">pol_prim</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">pulse</span><span class="p">,</span>
                       <span class="n">mjd</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">mjd</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">obs</span><span class="o">.</span><span class="n">tstart</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">outim</span></div>


<div class="viewcode-block" id="make_empty"><a class="viewcode-back" href="../../image.html#ehtim.image.make_empty">[docs]</a><span class="k">def</span> <span class="nf">make_empty</span><span class="p">(</span><span class="n">npix</span><span class="p">,</span> <span class="n">fov</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span> <span class="n">rf</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">RF_DEFAULT</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">SOURCE_DEFAULT</span><span class="p">,</span>
               <span class="n">polrep</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span>
               <span class="n">mjd</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">MJD_DEFAULT</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="mf">0.</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Make an empty square image.</span>

<span class="sd">       Args:</span>
<span class="sd">           npix (int): the pixel size of each axis</span>
<span class="sd">           fov (float): the field of view of each axis in radians</span>
<span class="sd">           ra (float): The source Right Ascension in fractional hours</span>
<span class="sd">           dec (float): The source declination in fractional degrees</span>
<span class="sd">           rf (float): The image frequency in Hz</span>

<span class="sd">           source (str): The source name</span>
<span class="sd">           polrep (str): polarization representation, either &#39;stokes&#39; or &#39;circ&#39;</span>
<span class="sd">           pol_prim (str): The default image: I,Q,U or V for Stokes, RR,LL,LR,RL for Circular</span>
<span class="sd">           pulse (function): The function convolved with the pixel values for continuous image.</span>

<span class="sd">           mjd (int): The integer MJD of the image</span>
<span class="sd">           time (float): The observing time of the image (UTC hours)</span>

<span class="sd">       Returns:</span>
<span class="sd">           (Image): an image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">pdim</span> <span class="o">=</span> <span class="n">fov</span> <span class="o">/</span> <span class="nb">float</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
    <span class="n">npix</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">npix</span><span class="p">)</span>
    <span class="n">imarr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">npix</span><span class="p">,</span> <span class="n">npix</span><span class="p">))</span>
    <span class="n">outim</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">imarr</span><span class="p">,</span> <span class="n">pdim</span><span class="p">,</span> <span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">,</span>
                  <span class="n">polrep</span><span class="o">=</span><span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="n">pol_prim</span><span class="p">,</span>
                  <span class="n">rf</span><span class="o">=</span><span class="n">rf</span><span class="p">,</span> <span class="n">source</span><span class="o">=</span><span class="n">source</span><span class="p">,</span> <span class="n">mjd</span><span class="o">=</span><span class="n">mjd</span><span class="p">,</span> <span class="n">time</span><span class="o">=</span><span class="n">time</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">pulse</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">outim</span></div>


<div class="viewcode-block" id="load_image"><a class="viewcode-back" href="../../image.html#ehtim.image.load_image">[docs]</a><span class="k">def</span> <span class="nf">load_image</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">display</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">aipscc</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in an image from a text, .fits, .h5, or ehtim.image.Image object</span>

<span class="sd">       Args:</span>
<span class="sd">            image (str/Image): path to input file</span>
<span class="sd">            display (boolean): determine whether to display the image default</span>
<span class="sd">            aipscc (boolean): if True, then AIPS CC table will be loaded instead</span>
<span class="sd">                              of the original brightness distribution.</span>
<span class="sd">       Returns:</span>
<span class="sd">            (Image):    loaded image object</span>
<span class="sd">            (boolean):  False if the image cannot be read</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">is_unicode</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">basestring</span><span class="p">):</span>
            <span class="n">is_unicode</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="ne">NameError</span><span class="p">:</span>  <span class="c1"># python 3</span>
        <span class="k">pass</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">or</span> <span class="n">is_unicode</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">image</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.fits&#39;</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_fits</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">aipscc</span><span class="o">=</span><span class="n">aipscc</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.txt&#39;</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_txt</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">image</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;.h5&#39;</span><span class="p">):</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_hdf5</span><span class="p">(</span><span class="n">image</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image format is not recognized. Was expecting .fits, .txt, or Image.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Got &lt;.</span><span class="si">{0}</span><span class="s2">&gt;. Returning False.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">image</span><span class="p">,</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">image</span><span class="o">.</span><span class="n">Image</span><span class="p">):</span>
        <span class="n">im</span> <span class="o">=</span> <span class="n">image</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image format is not recognized. Was expecting .fits, .txt, or Image.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot; Got </span><span class="si">{0}</span><span class="s2">. Returning False.&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">image</span><span class="p">)))</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">display</span><span class="p">:</span>
        <span class="n">im</span><span class="o">.</span><span class="n">display</span><span class="p">()</span>

    <span class="k">return</span> <span class="n">im</span></div>


<div class="viewcode-block" id="load_txt"><a class="viewcode-back" href="../../image.html#ehtim.image.load_txt">[docs]</a><span class="k">def</span> <span class="nf">load_txt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span> <span class="n">zero_pol</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in an image from a text file.</span>

<span class="sd">       Args:</span>
<span class="sd">            fname (str): path to input text file</span>
<span class="sd">            pulse (function): The function convolved with the pixel values for continuous image.</span>
<span class="sd">            polrep (str): polarization representation, either &#39;stokes&#39; or &#39;circ&#39;</span>
<span class="sd">            pol_prim (str): The default image: I,Q,U or V for Stokes, RR,LL,LR,RL for Circular</span>
<span class="sd">            zero_pol (bool): If True, loads any missing polarizations as zeros</span>

<span class="sd">       Returns:</span>
<span class="sd">            (Image): loaded image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_txt</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">pulse</span><span class="p">,</span> <span class="n">polrep</span><span class="o">=</span><span class="n">polrep</span><span class="p">,</span>
                                     <span class="n">pol_prim</span><span class="o">=</span><span class="n">pol_prim</span><span class="p">,</span> <span class="n">zero_pol</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></div>


<div class="viewcode-block" id="load_fits"><a class="viewcode-back" href="../../image.html#ehtim.image.load_fits">[docs]</a><span class="k">def</span> <span class="nf">load_fits</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">aipscc</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">ehc</span><span class="o">.</span><span class="n">PULSE_DEFAULT</span><span class="p">,</span>
              <span class="n">polrep</span><span class="o">=</span><span class="s1">&#39;stokes&#39;</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zero_pol</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read in an image from a FITS file.</span>

<span class="sd">       Args:</span>
<span class="sd">           fname (str): path to input fits file</span>
<span class="sd">           aipscc (bool): if True, then AIPS CC table will be loaded</span>
<span class="sd">           pulse (function): The function convolved with the pixel values for continuous image.</span>
<span class="sd">           polrep (str): polarization representation, either &#39;stokes&#39; or &#39;circ&#39;</span>
<span class="sd">           pol_prim (str): The default image: I,Q,U or V for Stokes, RR,LL,LR,RL for Circular</span>
<span class="sd">           zero_pol (bool): If True, loads any missing polarizations as zeros</span>

<span class="sd">       Returns:</span>
<span class="sd">           (Image): loaded image object</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">return</span> <span class="n">ehtim</span><span class="o">.</span><span class="n">io</span><span class="o">.</span><span class="n">load</span><span class="o">.</span><span class="n">load_im_fits</span><span class="p">(</span><span class="n">fname</span><span class="p">,</span> <span class="n">aipscc</span><span class="o">=</span><span class="n">aipscc</span><span class="p">,</span> <span class="n">pulse</span><span class="o">=</span><span class="n">pulse</span><span class="p">,</span>
                                      <span class="n">polrep</span><span class="o">=</span><span class="n">polrep</span><span class="p">,</span> <span class="n">pol_prim</span><span class="o">=</span><span class="n">pol_prim</span><span class="p">,</span> <span class="n">zero_pol</span><span class="o">=</span><span class="n">zero_pol</span><span class="p">)</span></div>
                                      
<div class="viewcode-block" id="avg_imlist"><a class="viewcode-back" href="../../image.html#ehtim.image.avg_imlist">[docs]</a><span class="k">def</span> <span class="nf">avg_imlist</span><span class="p">(</span><span class="n">imlist</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Average a list of images.</span>

<span class="sd">       Args:</span>
<span class="sd">           imlist (list): list of image objects</span>

<span class="sd">       Returns:</span>
<span class="sd">           (Image): average image object</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">imavg</span> <span class="o">=</span> <span class="n">imlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">polrep</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">])</span> <span class="o">!=</span> <span class="n">imavg</span><span class="o">.</span><span class="n">polrep</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;im.polrep in all images are not the same in avg_imlist!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">source</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">])</span> <span class="o">!=</span> <span class="n">imavg</span><span class="o">.</span><span class="n">source</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;im.source in all images are not the same in avg_imlist!&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">])</span> <span class="o">!=</span> <span class="n">imavg</span><span class="o">.</span><span class="n">rf</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;im.rf in all images are not the same in avg_imlist!&quot;</span><span class="p">)</span>
           
    <span class="n">keys</span> <span class="o">=</span> <span class="n">imavg</span><span class="o">.</span><span class="n">_imdict</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
                
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="n">imavg</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">+=</span> <span class="n">im</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

    <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
        <span class="n">imavg</span><span class="o">.</span><span class="n">_imdict</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">/=</span> <span class="nb">float</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">imlist</span><span class="p">))</span>

    
    <span class="k">return</span> <span class="n">imavg</span></div>

<div class="viewcode-block" id="get_specim"><a class="viewcode-back" href="../../image.html#ehtim.image.get_specim">[docs]</a><span class="k">def</span> <span class="nf">get_specim</span><span class="p">(</span><span class="n">imlist</span><span class="p">,</span> <span class="n">reffreq</span><span class="p">,</span> <span class="n">fit_order</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;get the spectral index/curvature from a list of images&quot;&quot;&quot;</span>
    <span class="n">freqs</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">rf</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">]</span>

    <span class="c1"># remove any zeros in the images</span>
    <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">:</span>
        <span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="c1"># fit</span>
    <span class="n">xfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span><span class="o">/</span><span class="n">reffreq</span><span class="p">)</span>
    <span class="n">yfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">]))</span>

    <span class="k">if</span> <span class="n">fit_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span><span class="n">yfit</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> 
        <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">2</span><span class="p">])</span>   
    <span class="k">elif</span> <span class="n">fit_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span><span class="n">yfit</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    
        <span class="n">beta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">alpha</span>
        <span class="n">imvec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
        
    <span class="n">outim</span> <span class="o">=</span> <span class="n">imlist</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span> <span class="c1">#TODO no polarization</span>
    <span class="n">outim</span><span class="o">.</span><span class="n">imvec</span> <span class="o">=</span> <span class="n">imvec</span>
    <span class="n">outim</span><span class="o">.</span><span class="n">rf</span> <span class="o">=</span> <span class="n">reffreq</span>
    <span class="n">outim</span><span class="o">.</span><span class="n">specvec</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">outim</span><span class="o">.</span><span class="n">curvvec</span> <span class="o">=</span> <span class="n">beta</span>
    
    <span class="k">return</span> <span class="n">outim</span></div>


<div class="viewcode-block" id="blur_mf"><a class="viewcode-back" href="../../image.html#ehtim.image.blur_mf">[docs]</a><span class="k">def</span> <span class="nf">blur_mf</span><span class="p">(</span><span class="n">im</span><span class="p">,</span><span class="n">freqs</span><span class="p">,</span><span class="n">kernel</span><span class="p">,</span><span class="n">fit_order</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;blur multifrequncy images with the same beam&quot;&quot;&quot;</span>
    <span class="n">reffreq</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">rf</span>

    <span class="c1"># remove any zeros in the images</span>

           
    <span class="n">imlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">im</span><span class="o">.</span><span class="n">get_image_mf</span><span class="p">(</span><span class="n">rf</span><span class="p">)</span><span class="o">.</span><span class="n">blur_circ</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span> <span class="k">for</span> <span class="n">rf</span> <span class="ow">in</span> <span class="n">freqs</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">image</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">:</span>
        <span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="o">&lt;=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="p">[</span><span class="n">image</span><span class="o">.</span><span class="n">imvec</span><span class="o">!=</span><span class="mi">0</span><span class="p">])</span>
        
    <span class="n">xfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">freqs</span><span class="p">)</span><span class="o">/</span><span class="n">reffreq</span><span class="p">)</span>
    <span class="n">yfit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">im</span><span class="o">.</span><span class="n">imvec</span> <span class="k">for</span> <span class="n">im</span> <span class="ow">in</span> <span class="n">imlist</span><span class="p">]))</span>
    
    <span class="k">if</span> <span class="n">fit_order</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span><span class="n">yfit</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>    
    <span class="k">elif</span> <span class="n">fit_order</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">coeffs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">polyfit</span><span class="p">(</span><span class="n">xfit</span><span class="p">,</span><span class="n">yfit</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="n">coeffs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>    
        <span class="n">beta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">alpha</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">alpha</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">yfit</span>
        <span class="n">beta</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">yfit</span>
        
    <span class="n">outim</span> <span class="o">=</span> <span class="n">im</span><span class="o">.</span><span class="n">blur_circ</span><span class="p">(</span><span class="n">kernel</span><span class="p">)</span>
    <span class="n">outim</span><span class="o">.</span><span class="n">specvec</span> <span class="o">=</span> <span class="n">alpha</span>
    <span class="n">outim</span><span class="o">.</span><span class="n">curvvec</span> <span class="o">=</span> <span class="n">beta</span>
    <span class="k">return</span> <span class="n">outim</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, Andrew Chael.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>